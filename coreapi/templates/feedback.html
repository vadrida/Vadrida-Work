{% extends "base.html" %}
{% load static %}
{% block title %}Site Feedback Form ‚Äî Vadrida{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="{% static 'css/feedback.css' %}">
{% endblock %}

{% block content %}
<!-- Navigation Bar -->
<nav class="feedback-nav">
  <div class="nav-content">
    <div class="nav-left">
      <a href="{% url 'coreapi:dashboard' %}" class="nav-link back-link">
        <i class="fas fa-arrow-left"></i> Back to Dashboard
      </a>
    </div>
    <div class="nav-center">
      <h1 class="page-title">Site Feedback Form</h1>
    </div>
    <div class="nav-right">
      <span class="user-info">{{ request.session.user_name }}</span>
    </div>
  </div>
</nav>

<div id="orientationBlocker" class="orientation-blocker hidden">
  <div class="orientation-box">
    <h2>Rotate Device</h2>
    <p>This page works only in <b>landscape mode</b> on tablets.</p>
  </div>
</div>

<div class="relative">
  <!-- Loading overlay for Analyse action -->
  <div id="analyseLoading" class="loading-overlay hidden">
    <div class="spinner"></div>
    <div class="text-lg font-semibold">Analyzing ‚Äî please wait...</div>
    <div class="text-sm">Processing your file...</div>
  </div>

  <div class="feedback-layout">
    <!-- LEFT COLUMN: File List + Preview -->
    <div class="left-column">
      <!-- FILE LIST SECTION -->
      <section class="file-section">
        <div class="section-header">
          <h3 class="section-title">Files</h3>
          <button id="refreshFolders" class="refresh-btn">üîÑ</button>
        </div>

        <div class="file-controls">
          <input id="fileSearch" type="text" placeholder="Search file id or name..." class="search-input" />
          <div class="path-nav">
            <button id="goBackBtn" class="nav-btn">‚¨Ö</button>
            <span id="currentPath">/</span>
          </div>
        </div>

        <div class="file-list-container">
          <ul id="fileList" class="file-list"></ul>
        </div>

        <div class="file-info-panel">
          <h4 class="info-title">File Info</h4>
          <div id="fileInfoBox" class="info-content">
            Select a file to see details.
          </div>
        </div>
      </section>

      <!-- PREVIEW SECTION -->
      <section class="preview-section">
        <div class="section-header">
          <h3 class="section-title">Preview</h3>
          <div class="preview-controls">
            <button id="analyseBtn" class="analyse-btn">Analyse</button>
            <button id="openFullBtn" class="control-btn">Open Full</button>
          </div>
        </div>

        <div id="thumbs" class="thumbs-strip"></div>

        <div class="preview-container">
          <div class="preview-header">
            <div id="bigPreviewTitle" class="preview-title">No file selected</div>
            <button hidden id="downloadPdfBtn" class="download-btn hidden">
            
            </button>
          </div>

          <div id="bigViewer" class="preview-viewer">
            <div id="noSelection" class="no-selection">
              Select a file to preview
            </div>
            <div id="pdfWrapper" class="hidden pdf-container">
              <div id="pdfMain" class="pdf-scroll-container"></div>
            </div>
            <img id="bigImageFrame" class="hidden preview-image" src="" alt="preview" />
          </div>
        </div>
      </section>
    </div>

    <!-- RIGHT COLUMN: Comprehensive Feedback Form -->
    <div class="right-column">
      <div class="form-section">
        <div class="form-header">
          <h3 class="section-title">Site Feedback Form</h3>
        </div>

        <form id="siteFeedbackForm" class="feedback-form">
          
          <!-- Valuers Checklist -->
          <div class="form-section-group">
            <h4 class="form-section-title">Valuers Checklist</h4>
            
            <div class="form-row">
              <div class="form-group">
                <label class="form-label">1. Office File No.</label>
                <input type="number" data-path="Valuers_Checklist.Office_file_no" class="form-input">
              </div>
              <div class="form-group">
                <label class="form-label">2. Applicant Name</label>
                <input type="text" data-path="Valuers_Checklist.applicant_name" class="form-input">
              </div>
            </div>

            <div class="form-row">
              <div class="form-group">
                <label class="form-label">3. Inspection Date</label>
                <input type="date" data-path="Valuers_Checklist.inspection_date" class="form-input">
              </div>
              <div class="form-group">
                <label class="form-label">4. Name of the person met at site</label>
                <input type="text" data-path="Valuers_Checklist.person_met" class="form-input">
              </div>
            </div>

            <div class="form-group">
              <label class="form-label">5. Product</label>
              <select data-path="Valuers_Checklist.product" class="form-select">
                <option value="notselected">Select Product</option>
                <option value="1st purchase">1st Purchase</option>
                <option value="construction">Construction</option>
                <option value="topup">Top Up</option>
                <option value="pd">PD</option>
                <option value="resale">Resale</option>
                <option value="renovation">Renovation</option>
                <option value="takeover">Takeover</option>
                <option value="lap">LAP</option>
                <option value="extension">Extension</option>
                <option value="npa">NPA</option>
              </select>
            </div>

            <div class="form-group">
              <label class="form-label">6. Documents Received</label>
              <div class="checkbox-grid">
                <label class="checkbox-label"><input type="checkbox" data-array="Valuers_Checklist.documents_received" value="Agreement"> Agreement</label>
                <label class="checkbox-label"><input type="checkbox" data-array="Valuers_Checklist.documents_received" value="Encumbrance"> Encumbrance</label>
                <label class="checkbox-label"><input type="checkbox" data-array="Valuers_Checklist.documents_received" value="Building Permit"> Building Permit</label>
                <label class="checkbox-label"><input type="checkbox" data-array="Valuers_Checklist.documents_received" value="Declaration"> Declaration</label>
                <label class="checkbox-label"><input type="checkbox" data-array="Valuers_Checklist.documents_received" value="Location Sketch"> Location Sketch</label>
                <label class="checkbox-label"><input type="checkbox" data-array="Valuers_Checklist.documents_received" value="Development Permit"> Development Permit</label>
                <label class="checkbox-label"><input type="checkbox" data-array="Valuers_Checklist.documents_received" value="Title Deed"> Title Deed</label>
                <label class="checkbox-label"><input type="checkbox" data-array="Valuers_Checklist.documents_received" value="Survey Sketch"> Survey Sketch</label>
                <label class="checkbox-label"><input type="checkbox" data-array="Valuers_Checklist.documents_received" value="Building Certificate"> Building Certificate</label>
                <label class="checkbox-label"><input type="checkbox" data-array="Valuers_Checklist.documents_received" value="LTR"> LTR</label>
                <label class="checkbox-label"><input type="checkbox" data-array="Valuers_Checklist.documents_received" value="Building Tax receipt"> Building Tax Receipt</label>
                <label class="checkbox-label"><input type="checkbox" data-array="Valuers_Checklist.documents_received" value="Approved plan"> Approved Plan</label>
                <label class="checkbox-label"><input type="checkbox" data-array="Valuers_Checklist.documents_received" value="Possession"> Possession</label>
                <label class="checkbox-label"><input type="checkbox" data-array="Valuers_Checklist.documents_received" value="Engineers plan"> Engineers Plan</label>
              </div>
            </div>
          </div>

          <!-- I. Ownership Analysis -->
          <div class="form-section-group">
            <h4 class="form-section-title">I. Ownership Analysis</h4>
            
            <div class="form-group">
              <label class="form-label">1. Owner(s) Name</label>
              <input type="text" data-path="Ownership_Analysis.owners_name" class="form-input">
            </div>
            
            <div class="form-group">
              <label class="form-label">Document Verification</label>
              <div class="checkbox-group">
                <label class="checkbox-label"><input type="checkbox" data-array="Ownership_Analysis.document_verification" value="same in all documents"> Same in all documents</label>
                <label class="checkbox-label"><input type="checkbox" data-array="Ownership_Analysis.document_verification" value="discrepancy noted"> Discrepancy noted</label>
              </div>
            </div>


          <div class="form-group mt-3">
              <label class="form-label">Notes</label>
              <textarea data-path="Ownership_Analysis.Ownership_Analysis_notes" class="form-textarea" rows="4"></textarea>
            </div>

          <!-- II. Survey Number and Land Extend Analysis -->
          <div class="form-section-group">
            <h4 class="form-section-title">II. Survey Number and Land Extend Analysis</h4>
            
            <div class="table-container" style="overflow-x: auto;">
                <table class="analysis-table survey-table" id="surveyTable">
                    <thead>
                        <tr id="surveyHeader">
                            <th style="min-width: 150px; position: sticky; left: 0; z-index: 10;">Doc Name</th>
                            </tr>
                    </thead>
                    <tbody id="surveyBody">
                        <tr data-row-key="scedule_no"><td>Scedule No</td></tr>
                        <tr data-row-key="re_sy_block_no"><td>Re-Sy Block No</td></tr>
                        <tr data-row-key="re_sy_no"><td>Re-Sy No</td></tr>
                        <tr data-row-key="re_sy_subdiv_no"><td>Re-Sy Subdiv No</td></tr>
                        <tr data-row-key="sy_block_no"><td>Sy Block No</td></tr>
                        <tr data-row-key="sy_no"><td>Sy No</td></tr>
                        <tr data-row-key="sy_subdiv_no"><td>Sy Subdiv No</td></tr>
                        <tr data-row-key="land_extent"><td>Land Extent (Ares)</td></tr>
                        <tr data-row-key="land_classification"><td>Land Classification</td></tr>
                    </tbody>
                </table>
            </div>

            <button type="button" class="add-row-btn" onclick="addSurveyColumn()">
                + Add Survey Document Column
            </button>

      
            <div class="form-group mt-4">
                <label class="form-label">Notes, % of wetland and dry lands...</label>
                <textarea data-path="Survey.survey_notes" class="form-textarea" rows="4"></textarea>
            </div>


        </div>
          <!-- III. Boundary Analysis and Property Identification -->
          <div class="form-section-group">
            <h4 class="form-section-title">III. Boundary Analysis and Property Identification</h4>
            
            <div class="table-container">
              <table class="analysis-table">
                <thead>
                  <tr>
                    <th style="width: 10%;">Direction</th>
                    
                    <th style="width: 25%;">
                      <label class="text-xs font-bold block mb-1">Ref Doc 1</label>
                      <select data-path="Boundary_analysis_property_identification.ref_doc_1_name" class="form-select dynamic-doc-dropdown" style="width: 100%; color: #000;">
                          <option value="">Select Document</option>
                      </select>
                    </th>

                    <th style="width: 25%;">
                      <label class="text-xs font-bold block mb-1">Ref Doc 2</label>
                      <select data-path="Boundary_analysis_property_identification.ref_doc_2_name" class="form-select dynamic-doc-dropdown" style="width: 100%; color:#000">
                          <option value="">Select Document</option>
                      </select>
                    </th>

                    <th style="width: 20%;">Translation Reason if any</th>
                    <th style="width: 20%;">Site</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td>North</td>
                    <td><input type="text" data-path="Boundary_analysis_property_identification.north_doc1" class="table-input" placeholder="Val as per Doc 1"></td>
                    <td><input type="text" data-path="Boundary_analysis_property_identification.north_doc2" class="table-input" placeholder="Val as per Doc 2"></td>
                    
                    <td><input type="text" data-path="Boundary_analysis_property_identification.north_translation" class="table-input"></td>
                    <td><input type="text" data-path="Boundary_analysis_property_identification.north_site" class="table-input"></td>
                  </tr>
                  
                  <tr>
                      <td>East</td>
                      <td><input type="text" data-path="Boundary_analysis_property_identification.east_doc1" class="table-input" placeholder="Val as per Doc 1"></td>
                      <td><input type="text" data-path="Boundary_analysis_property_identification.east_doc2" class="table-input" placeholder="Val as per Doc 2"></td>

                      <td><input type="text" data-path="Boundary_analysis_property_identification.east_translation" class="table-input"></td>
                      <td><input type="text" data-path="Boundary_analysis_property_identification.east_site" class="table-input"></td>
                  </tr>
                  
                  <tr>
                      <td>South</td>
                      <td><input type="text" data-path="Boundary_analysis_property_identification.south_doc1" class="table-input" placeholder="Val as per Doc 1"></td>
                      <td><input type="text" data-path="Boundary_analysis_property_identification.south_doc2" class="table-input" placeholder="Val as per Doc 2"></td>

                      <td><input type="text" data-path="Boundary_analysis_property_identification.south_translation" class="table-input"></td>
                      <td><input type="text" data-path="Boundary_analysis_property_identification.south_site" class="table-input"></td>
                  </tr>
                  
                  <tr>
                      <td>West</td>
                      <td><input type="text" data-path="Boundary_analysis_property_identification.west_doc1" class="table-input" placeholder="Val as per Doc 1"></td>
                      <td><input type="text" data-path="Boundary_analysis_property_identification.west_doc2" class="table-input" placeholder="Val as per Doc 2"></td>

                      <td><input type="text" data-path="Boundary_analysis_property_identification.west_translation" class="table-input"></td>
                      <td><input type="text" data-path="Boundary_analysis_property_identification.west_site" class="table-input"></td>
                  </tr>
                </tbody>
              </table>
            </div>


            <div class="form-group mt-3">
              <label class="form-label">Notes if any/property identified with respect to documents..?</label>
              <textarea data-path="Boundary_analysis_property_identification.Boundary_property_notes" class="form-textarea" rows="4"></textarea>
            </div>


          </div>
          <!-- IV. Demarcations -->
          <div class="form-section-group">
            <h4 class="form-section-title">IV. Demarcations</h4>
            
            <div class="table-container">
              <table class="analysis-table">
                <thead>
                  <tr>
                    <th>Direction</th>
                    <th>Demarcation Type</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td>North</td>
                    <td class="checkbox-cell">
                      <label class="checkbox-label-small"><input type="checkbox" data-array="Demarcation.north" value="no demarcation"> No demarcation</label>
                      <label class="checkbox-label-small"><input type="checkbox" data-array="Demarcation.north" value="gi sheet fence"> GI sheet fence</label>
                      <label class="checkbox-label-small"><input type="checkbox" data-array="Demarcation.north" value="barbed wire"> Barbed wire</label>
                      <label class="checkbox-label-small"><input type="checkbox" data-array="Demarcation.north" value="steel pegs"> Steel pegs</label>
                      <label class="checkbox-label-small"><input type="checkbox" data-array="Demarcation.north" value="compound wall"> Compound wall</label>
                      <label class="checkbox-label-small"><input type="checkbox" data-array="Demarcation.north" value="bio fence"> Bio fence</label>
                      <label class="checkbox-label-small"><input type="checkbox" data-array="Demarcation.north" value="survey stone"> Survey stone</label>
                      <label class="checkbox-label-small"><input type="checkbox" data-array="Demarcation.north" value="wooden pegs"> Wooden pegs</label>
                    </td>
                  </tr>
                  <tr>
                    <td>East</td>
                    <td class="checkbox-cell">
                      <label class="checkbox-label-small"><input type="checkbox" data-array="Demarcation.east" value="no demarcation"> No demarcation</label>
                      <label class="checkbox-label-small"><input type="checkbox" data-array="Demarcation.east" value="gi sheet fence"> GI sheet fence</label>
                      <label class="checkbox-label-small"><input type="checkbox" data-array="Demarcation.east" value="barbed wire"> Barbed wire</label>
                      <label class="checkbox-label-small"><input type="checkbox" data-array="Demarcation.east" value="steel pegs"> Steel pegs</label>
                      <label class="checkbox-label-small"><input type="checkbox" data-array="Demarcation.east" value="compound wall"> Compound wall</label>
                      <label class="checkbox-label-small"><input type="checkbox" data-array="Demarcation.east" value="bio fence"> Bio fence</label>
                      <label class="checkbox-label-small"><input type="checkbox" data-array="Demarcation.east" value="survey stone"> Survey stone</label>
                      <label class="checkbox-label-small"><input type="checkbox" data-array="Demarcation.east" value="wooden pegs"> Wooden pegs</label>
                    </td>
                  </tr>
                  <tr>
                    <td>South</td>
                    <td class="checkbox-cell">
                      <label class="checkbox-label-small"><input type="checkbox" data-array="Demarcation.south" value="no demarcation"> No demarcation</label>
                      <label class="checkbox-label-small"><input type="checkbox" data-array="Demarcation.south" value="gi sheet fence"> GI sheet fence</label>
                      <label class="checkbox-label-small"><input type="checkbox" data-array="Demarcation.south" value="barbed wire"> Barbed wire</label>
                      <label class="checkbox-label-small"><input type="checkbox" data-array="Demarcation.south" value="steel pegs"> Steel pegs</label>
                      <label class="checkbox-label-small"><input type="checkbox" data-array="Demarcation.south" value="compound wall"> Compound wall</label>
                      <label class="checkbox-label-small"><input type="checkbox" data-array="Demarcation.south" value="bio fence"> Bio fence</label>
                      <label class="checkbox-label-small"><input type="checkbox" data-array="Demarcation.south" value="survey stone"> Survey stone</label>
                      <label class="checkbox-label-small"><input type="checkbox" data-array="Demarcation.south" value="wooden pegs"> Wooden pegs</label>
                    </td>
                  </tr>
                  <tr>
                    <td>West</td>
                    <td class="checkbox-cell">
                      <label class="checkbox-label-small"><input type="checkbox" data-array="Demarcation.west" value="no demarcation"> No demarcation</label>
                      <label class="checkbox-label-small"><input type="checkbox" data-array="Demarcation.west" value="gi sheet fence"> GI sheet fence</label>
                      <label class="checkbox-label-small"><input type="checkbox" data-array="Demarcation.west" value="barbed wire"> Barbed wire</label>
                      <label class="checkbox-label-small"><input type="checkbox" data-array="Demarcation.west" value="steel pegs"> Steel pegs</label>
                      <label class="checkbox-label-small"><input type="checkbox" data-array="Demarcation.west" value="compound wall"> Compound wall</label>
                      <label class="checkbox-label-small"><input type="checkbox" data-array="Demarcation.west" value="bio fence"> Bio fence</label>
                      <label class="checkbox-label-small"><input type="checkbox" data-array="Demarcation.west" value="survey stone"> Survey stone</label>
                      <label class="checkbox-label-small"><input type="checkbox" data-array="Demarcation.west" value="wooden pegs"> Wooden pegs</label>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>

            <div class="form-group">
              <label class="form-label">Notes if any</label>
              <textarea data-path="Demarcation.demarcation_notes" class="form-textarea" rows="3"></textarea>
            </div>


            <div class="form-group">
              <label class="form-label">Encroachment of subject building to neighbouring property, if any..?</label>
              <textarea data-path="Demarcation.enroachment_subject_to_neighbour" class="form-textarea" rows="3"></textarea>
            </div>


            <div class="form-group">
              <label class="form-label">Encroachment of neighbour's building to subject property, if any..?</label>
              <textarea data-path="Demarcation.enroachment_neighbour_to_subject" class="form-textarea" rows="3"></textarea>
            </div>
          </div>

          <!-- V. Access Nature/Right of Access -->
          <div class="form-section-group">
            <h4 class="form-section-title">V. Access Nature/Right of Access</h4>
            
            <div class="table-container">
              <table class="analysis-table access-table">
                <tbody>
                  <tr>
                    <td>1. Type of access as per title deed</td>
                    <td class="checkbox-cell">
                      <label class="checkbox-label-small"><input type="checkbox" data-array="Access.typeofaccess_titledeed" value="footway"> Footway</label>
                      <label class="checkbox-label-small"><input type="checkbox" data-array="Access.typeofaccess_titledeed" value="panchayat rd"> Panchayat Rd</label>
                      <label class="checkbox-label-small"><input type="checkbox" data-array="Access.typeofaccess_titledeed" value="corporation rd"> Corporation Rd</label>
                      <label class="checkbox-label-small"><input type="checkbox" data-array="Access.typeofaccess_titledeed" value="national highway"> National Highway</label>
                      <label class="checkbox-label-small"><input type="checkbox" data-array="Access.typeofaccess_titledeed" value="private way"> Private Way</label>
                      <label class="checkbox-label-small"><input type="checkbox" data-array="Access.typeofaccess_titledeed" value="municipal rd"> Municipal Rd</label>
                      <label class="checkbox-label-small"><input type="checkbox" data-array="Access.typeofaccess_titledeed" value="pwd road"> PWD Road</label>
                      <label class="checkbox-label-small"><input type="checkbox" data-array="Access.typeofaccess_titledeed" value="land locked"> Land Locked</label>
                    </td>
                  </tr>
                  <tr>
                    <td>2. Type of access as per site visit</td>
                    <td class="checkbox-cell">
                      <label class="checkbox-label-small"><input type="checkbox" data-array="Access.typeofaccess_sitevisit" value="footway"> Footway</label>
                      <label class="checkbox-label-small"><input type="checkbox" data-array="Access.typeofaccess_sitevisit" value="panchayat rd"> Panchayat Rd</label>
                      <label class="checkbox-label-small"><input type="checkbox" data-array="Access.typeofaccess_sitevisit" value="corporation rd"> Corporation Rd</label>
                      <label class="checkbox-label-small"><input type="checkbox" data-array="Access.typeofaccess_sitevisit" value="national highway"> National Highway</label>
                      <label class="checkbox-label-small"><input type="checkbox" data-array="Access.typeofaccess_sitevisit" value="private way"> Private Way</label>
                      <label class="checkbox-label-small"><input type="checkbox" data-array="Access.typeofaccess_sitevisit" value="municipal rd"> Municipal Rd</label>
                      <label class="checkbox-label-small"><input type="checkbox" data-array="Access.typeofaccess_sitevisit" value="pwd road"> PWD Road</label>
                      <label class="checkbox-label-small"><input type="checkbox" data-array="Access.typeofaccess_sitevisit" value="land locked"> Land Locked</label>
                    </td>
                  </tr>
                  <tr>
                    <td>3. If private way, no of users..?</td>
                    <td class="checkbox-cell">
                      <label class="checkbox-label-small"><input type="checkbox" data-array="Access.private_no_user" value="self use"> Self use</label>
                      <label class="checkbox-label-small"><input type="checkbox" data-array="Access.private_no_user" value="self & 1 user"> Self & 1 user</label>
                      <label class="checkbox-label-small"><input type="checkbox" data-array="Access.private_no_user" value="self & 2 user"> Self & 2 user</label>
                      <label class="checkbox-label-small"><input type="checkbox" data-array="Access.private_no_user" value="self + family"> Self + family</label>
                    </td>
                  </tr>
                  <tr>
                    <td>4. Demarcation of private road</td>
                    <td class="checkbox-cell">
                      <label class="checkbox-label-small"><input type="checkbox" data-array="Access.private_rd_demarcation" value="no demarcation"> No demarcation</label>
                      <label class="checkbox-label-small"><input type="checkbox" data-array="Access.private_rd_demarcation" value="gi sheet fence"> GI sheet fence</label>
                      <label class="checkbox-label-small"><input type="checkbox" data-array="Access.private_rd_demarcation" value="barbed wire"> Barbed wire</label>
                      <label class="checkbox-label-small"><input type="checkbox" data-array="Access.private_rd_demarcation" value="steel pegs"> Steel pegs</label>
                      <label class="checkbox-label-small"><input type="checkbox" data-array="Access.private_rd_demarcation" value="compound wall"> Compound wall</label>
                      <label class="checkbox-label-small"><input type="checkbox" data-array="Access.private_rd_demarcation" value="bio fence"> Bio fence</label>
                      <label class="checkbox-label-small"><input type="checkbox" data-array="Access.private_rd_demarcation" value="survey stone"> Survey stone</label>
                      <label class="checkbox-label-small"><input type="checkbox" data-array="Access.private_rd_demarcation" value="wooden pegs"> Wooden pegs</label>
                    </td>
                  </tr>
                  <tr>
                    <td>5. Least width of main access in M</td>
                    <td><input type="number" step="0.01" data-path="Access.main_access_width" class="table-input"></td>
                  </tr>
                  <tr>
                    <td>6. Vehicular access</td>
                    <td class="checkbox-cell">
                      <label class="checkbox-label-small"><input type="checkbox" data-array="Access.vehicular_access" value="pedestrian"> Pedestrian</label>
                      <label class="checkbox-label-small"><input type="checkbox" data-array="Access.vehicular_access" value="2-wheeler"> 2-wheeler</label>
                      <label class="checkbox-label-small"><input type="checkbox" data-array="Access.vehicular_access" value="3-wheeler"> 3-wheeler</label>
                      <label class="checkbox-label-small"><input type="checkbox" data-array="Access.vehicular_access" value="4-wheeler"> 4-wheeler</label>
                    </td>
                  </tr>
                  <tr>
                    <td>7. Least width of internal roads,<br> in case of plot development</td>
                    <td><input type="number" step="0.01" data-path="Access.internal_road_width" class="table-input"></td>
                  </tr>
                  <tr>
                    <td>8. Weather the internal rd. <br> abutting the subject plot has <br> connectivity to main access <br> as per deed..?</td>
                    <td><input type="text" data-path="Access.internal_to_main_connectivity" class="table-input"></td>
                  </tr>
                  <tr>
                    <td>9. Material of road</td>
                    <td class="checkbox-cell">
                      <label class="checkbox-label-small"><input type="checkbox" data-array="Access.road_material" value="mud road"> Mud road</label>
                      <label class="checkbox-label-small"><input type="checkbox" data-array="Access.road_material" value="gravel road"> Gravel road</label>
                      <label class="checkbox-label-small"><input type="checkbox" data-array="Access.road_material" value="concrete road"> Concrete road</label>
                      <label class="checkbox-label-small"><input type="checkbox" data-array="Access.road_material" value="paving tile rd"> Paving tile rd</label>
                      <label class="checkbox-label-small"><input type="checkbox" data-array="Access.road_material" value="tar road"> Tar road</label>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
           
            <div class="form-group">
              <label class="form-label">Notes/Discrepancy if any..</label>
              <textarea data-path="Access.access_notes" class="form-textarea" rows="4"></textarea>
            </div>
          </div>

          <!-- VI. For Purchase and Resale cases -->
          <div class="form-section-group">
            <h4 class="form-section-title">VI. For Purchase and Resale cases</h4>
            
            <div class="table-container">
              <table class="analysis-table">
                <tbody>
                  <tr>
                    <td>1. Buyer name</td>
                    <td><input type="text" data-path="Purchase_resale.buyer_name" class="table-input"></td>
                  </tr>
                  <tr>
                    <td>2. Seller name</td>
                    <td><input type="text" data-path="Purchase_resale.seller_name" class="table-input"></td>
                  </tr>
                  <tr>
                    <td>3. Relation b/w buyer and seller, if any</td>
                    <td><input type="text" data-path="Purchase_resale.buyer_seller_relation" class="table-input"></td>
                  </tr>
                  <tr>
                    <td>4. Since how long the property is up for sale..?</td>
                    <td><input type="text" data-path="Purchase_resale.property_sale_duration" class="table-input"></td>
                  </tr>
                  <tr>
                    <td>5. Brockers/OLX/99acers etc involved or how transaction happened..?</td>
                    <td><input type="text" data-path="Purchase_resale.transaction_method" class="table-input"></td>
                  </tr>
                  <tr>
                    <td>6. Land extend proposed for purchase..?</td>
                    <td><input type="text" data-path="Purchase_resale.purchase_land_extent" class="table-input"></td>
                  </tr>
                  <tr>
                    <td>7. Price asked</td>
                    <td><input type="number" data-path="Purchase_resale.price_asked" class="table-input"></td>
                  </tr>
                  <tr>
                    <td>8. Deal breaker value</td>
                    <td><input type="number" data-path="Purchase_resale.deal_breaker_value" class="table-input"></td>
                  </tr>
                </tbody>
              </table>
            </div>


            <div class="form-group">
              <label class="form-label">Notes/discrepancy if any..</label>
              <textarea data-path="Purchase_resale.purchase_resale_notes" class="form-textarea" rows="4"></textarea>
            </div>
          </div>

          <!-- VII. Building Analysis -->
          <div class="form-section-group">
            <h4 class="form-section-title">VII. Building Analysis</h4>
            
            <div class="table-container">
              <table class="analysis-table">
                <thead>
                  <tr>
                    <th>Floor No</th>
                    <th>Builtup Area (measured at site)</th>
                    <th>No. of Rooms</th>
                    <th>No. of Kitchen</th>
                    <th>No. of Bathrooms</th>
                    <th>Usage (Residential/Commercial/Industrial)</th>
                    <th>Occupancy (Owner/Applicant/Rented/Vacant)</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td>BF-2</td>
                    <td><input type="number" data-path="Building_analysis.BF_2_Builtup_area" step="0.01" class="table-input"></td>
                    <td><input type="number" data-path="Building_analysis.BF_2_Rooms_no" class="table-input"></td>
                    <td><input type="number" data-path="Building_analysis.BF_2_Kitchen_no" class="table-input"></td>
                    <td><input type="number" data-path="Building_analysis.BF_2_Bathrooms_no" class="table-input"></td>
                    <td><input type="text" data-path="Building_analysis.BF_2_Usage" class="table-input"></td>
                    <td><input type="text" data-path="Building_analysis.BF_2_Occupancy" class="table-input"></td>
                  </tr>
                  <tr>
                    <td>BF-1</td>
                    <td><input type="number" data-path="Building_analysis.BF_1_Builtup_area" step="0.01" class="table-input"></td>
                    <td><input type="number" data-path="Building_analysis.BF_1_Rooms_no" class="table-input"></td>
                    <td><input type="number" data-path="Building_analysis.BF_1_Kitchen_no" class="table-input"></td>
                    <td><input type="number" data-path="Building_analysis.BF_1_Bathrooms_no" class="table-input"></td>
                    <td><input type="text" data-path="Building_analysis.BF_1_Usage" class="table-input"></td>
                    <td><input type="text" data-path="Building_analysis.BF_1_Occupancy" class="table-input"></td>
                  </tr>
                  <tr>
                    <td>GF</td>
                    <td><input type="number" data-path="Building_analysis.GF_Builtup_area" step="0.01" class="table-input"></td>
                    <td><input type="number" data-path="Building_analysis.GF_Rooms_no" class="table-input"></td>
                    <td><input type="number" data-path="Building_analysis.GF_Kitchen_no" class="table-input"></td>
                    <td><input type="number" data-path="Building_analysis.GF_Bathrooms_no" class="table-input"></td>
                    <td><input type="text" data-path="Building_analysis.GF_Usage" class="table-input"></td>
                    <td><input type="text" data-path="Building_analysis.GF_Occupancy" class="table-input"></td>
                  </tr>
                  <tr>
                    <td>1st Floor</td>
                    <td><input type="number" data-path="Building_analysis.first_flr_Builtup_area" step="0.01" class="table-input"></td>
                    <td><input type="number" data-path="Building_analysis.first_flr_Rooms_no" class="table-input"></td>
                    <td><input type="number" data-path="Building_analysis.first_flr_Kitchen_no" class="table-input"></td>
                    <td><input type="number" data-path="Building_analysis.first_flr_Bathrooms_no" class="table-input"></td>
                    <td><input type="text" data-path="Building_analysis.first_flr_Usage" class="table-input"></td>
                    <td><input type="text" data-path="Building_analysis.first_flr_Occupancy" class="table-input"></td>
                  </tr>
                  <tr>
                    <td>2nd Floor</td>
                    <td><input type="number" data-path="Building_analysis.second_flr_Builtup_area" step="0.01" class="table-input"></td>
                    <td><input type="number" data-path="Building_analysis.second_flr_Rooms_no" class="table-input"></td>
                    <td><input type="number" data-path="Building_analysis.second_flr_Kitchen_no" class="table-input"></td>
                    <td><input type="number" data-path="Building_analysis.second_flr_Bathrooms_no" class="table-input"></td>
                    <td><input type="text" data-path="Building_analysis.second_flr_Usage" class="table-input"></td>
                    <td><input type="text" data-path="Building_analysis.second_flr_Occupancy" class="table-input"></td>
                  </tr>
                  <tr>
                    <td>3rd Floor</td>
                    <td><input type="number" data-path="Building_analysis.third_flr_Builtup_area" step="0.01" class="table-input"></td>
                    <td><input type="number" data-path="Building_analysis.third_flr_Rooms_no" class="table-input"></td>
                    <td><input type="number" data-path="Building_analysis.third_flr_Kitchen_no" class="table-input"></td>
                    <td><input type="number" data-path="Building_analysis.third_flr_Bathrooms_no" class="table-input"></td>
                    <td><input type="text" data-path="Building_analysis.third_flr_Usage"  class="table-input"></td>
                    <td><input type="text" data-path="Building_analysis.third_flr_Occupancy" class="table-input"></td>
                  </tr>
                  <tr>
                    <td>4th Floor</td>
                    <td><input type="number" data-path="Building_analysis.fourth_flr_Builtup_area" step="0.01" class="table-input"></td>
                    <td><input type="number" data-path="Building_analysis.fourth_flr_Rooms_no" class="table-input"></td>
                    <td><input type="number" data-path="Building_analysis.fourth_flr_Kitchen_no" class="table-input"></td>
                    <td><input type="number" data-path="Building_analysis.fourth_flr_Bathrooms_no" class="table-input"></td>
                    <td><input type="text" data-path="Building_analysis.fourth_flr_Usage" class="table-input"></td>
                    <td><input type="text" data-path="Building_analysis.fourth_flr_Occupancy" class="table-input"></td>
                  </tr>
                  <tr>
                    <td>5th Floor</td>
                    <td><input type="number" data-path="Building_analysis.fifth_flr_Builtup_area" step="0.01" class="table-input"></td>
                    <td><input type="number" data-path="Building_analysis.fifth_flr_Rooms_no" class="table-input"></td>
                    <td><input type="number" data-path="Building_analysis.fifth_flr_Kitchen_no" class="table-input"></td>
                    <td><input type="number" data-path="Building_analysis.fifth_flr_Bathrooms_no" class="table-input"></td>
                    <td><input type="text" data-path="Building_analysis.fifth_flr_Usage" class="table-input"></td>
                    <td><input type="text" data-path="Building_analysis.fifth_flr_Occupancy" class="table-input"></td>
                  </tr>
                </tbody>
              </table>
            </div>
          
            <div class="form-group">
              <label class="form-label">Notes/discrepancy in BUA/occupancy comparing site with respect to approved plan/permit etc if any..</label>
              <textarea data-path="Building_analysis.building_analysis_notes" class="form-textarea" rows="4"></textarea>
            </div>

            <!-- Roof Type Table -->
            <div class="table-container">
              <table class="analysis-table">
                <thead>
                  <tr>
                    <th>Roof Type</th>
                    <th> <label class="checkbox-label-small"><input type="checkbox" data-array="Building_analysis.roof_type" value="RCC"> RCC</label>
                     </th>
                    <th> <label class="checkbox-label-small"><input type="checkbox" data-array="Building_analysis.roof_type" value="Tiled">Tiled</label>
                     </th>
                    <th> <label class="checkbox-label-small"><input type="checkbox" data-array="Building_analysis.roof_type" value="Sheet"> Sheet</label>
                     </th>
                    <th> <label class="checkbox-label-small"><input type="checkbox" data-array="Building_analysis.roof_type" value="Other"> Other</label>
                     </th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td>Roof Percentage</td>
                    <td><input type="number" data-path="Building_analysis.RCC_Percentage" step="0.01" class="table-input" placeholder="%"></td>
                    <td><input type="number" data-path="Building_analysis.Tiled_Percentage" step="0.01" class="table-input" placeholder="%"></td>
                    <td><input type="number" data-path="Building_analysis.Sheet_Percentage" step="0.01" class="table-input" placeholder="%"></td>
                    <td><input type="number" data-path="Building_analysis.Other_Percentage" step="0.01" class="table-input" placeholder="%"></td>
                  </tr>
                </tbody>
              </table>
            </div>

            <!-- Setback Table -->
            <div class="table-container">
                <table class="analysis-table">
                    <thead>
                    <tr>
                        <!-- Single column -->
                        <th rowspan="2">Setback (m)</th>

                        <!-- Yard headers -->
                        <th colspan="2">Front Yard</th>
                        <th colspan="2">Side-1 Yard</th>
                        <th colspan="2">Side-2 Yard</th>
                        <th colspan="2">Rear Yard</th>
                    </tr>
                    <tr>
                        <!-- Sub headers -->
                        <th>Min</th>
                        <th>Max</th>

                        <th>Min</th>
                        <th>Max</th>

                        <th>Min</th>
                        <th>Max</th>

                        <th>Min</th>
                        <th>Max</th>
                    </tr>
                    </thead>

                    <tbody>
                    <tr>
                        <!-- SINGLE setback input -->
                        <td>
                        <input
                            type="number"
                            data-path="Building_analysis.setback"
                            step="0.01"
                            class="table-input"
                            placeholder="Setback"
                        />
                        </td>

                        <!-- Front yard -->
                        <td><input type="number" data-path="Building_analysis.front_yard_min" step="0.01" class="table-input" /></td>
                        <td><input type="number" data-path="Building_analysis.front_yard_max" step="0.01" class="table-input" /></td>

                        <!-- Side-1 -->
                        <td><input type="number" data-path="Building_analysis.side1_yard_min" step="0.01" class="table-input" /></td>
                        <td><input type="number" data-path="Building_analysis.side1_yard_max" step="0.01" class="table-input" /></td>

                        <!-- Side-2 -->
                        <td><input type="number" data-path="Building_analysis.side2_yard_min" step="0.01" class="table-input" /></td>
                        <td><input type="number" data-path="Building_analysis.side2_yard_max" step="0.01" class="table-input" /></td>

                        <!-- Rear -->
                        <td><input type="number" data-path="Building_analysis.rear_yard_min" step="0.01" class="table-input" /></td>
                        <td><input type="number" data-path="Building_analysis.rear_yard_max" step="0.01" class="table-input" /></td>
                    </tr>
                    </tbody>
                </table>
            </div>

            <!-- Construction Timeline Table -->
            <div class="table-container">
              <table class="analysis-table">
                <tbody>
                  <tr>
                    <td>Year of construction of foundation, other floors etc, if constructed in different timelines</td>
                    <td><input type="text" data-path="Building_analysis.construction_year" class="table-input"></td>
                  </tr>
                </tbody>
              </table>
            </div>

            <div class="form-group">
              <label class="form-label">Notes/no of carparks/wardrobes/kitchen cabinets/flooring material/interior decorations, any other amenities..?</label>
              <textarea data-path="Building_analysis.amenities_notes" class="form-textarea" rows="4"></textarea>
            </div>
          </div>

          <!-- VIII. Landmark and Layout (Handsketch) -->
          <div class="form-section-group">
            <h4 class="form-section-title">VIII. Landmark and Layout (Handsketch)</h4>
            
            <div class="form-group">
              <label class="form-label">Landmark Description</label>
              <textarea data-path="Sketch.landmark_description" class="form-textarea" rows="3"></textarea>
            </div>

            <div class="form-group mt-4">
              <label class="form-label font-bold">Site Layout Sketch</label>
              
              <button type="button" class="modal-btn primary" style="width: 100%; margin-bottom: 10px;" onclick="openSketchPad('Sketch.main_layout')">
                  <i class="fas fa-drafting-compass mr-2"></i> Open Sketch Pad
              </button>

              <div class="main-sketch-preview" style="position: relative; border: 2px dashed #ccc; min-height: 300px; display: flex; align-items: center; justify-content: center; background: #f9fafb;">
                  <img id="img_preview_Sketch_main_layout" class="hidden" style="max-width: 100%; max-height: 400px; z-index: 1;">
                  
              </div>
            </div>
          </div>

         <div class="form-group mt-4" style="gap: 10px;">
          <button type="button" id="triggerSubmitBtn" class="submit-btn" style="width: 100%;">
            Submit Feedback
          </button>

          <button type="button" id="triggerResetBtn" 
                  style="background: #ef4444; color: white; padding: 12px; border-radius: 8px; border:none; width: 100%; cursor: pointer; font-weight: 600;">
              ‚ö†Ô∏è Reset Form Data
          </button>
        </div>
        </form>

      </div>
    </div>
  </div>
</div>

<!-- All modals remain the same -->
<div id="fullscreenModal" aria-hidden="true">
  <div class="modal-box">
    <div class="modal-header">
      <div id="modalTitle" class="modal-title">Preview</div>
      <div class="modal-controls">
        <div id="shareButtonsContainer" class="share-buttons hidden">
          <a href="#" id="shareWhatsapp" class="share-btn">
            <i class="fab fa-whatsapp mr-2"></i>WhatsApp
          </a>
          <a href="#" id="shareTelegram" class="share-btn">
            <i class="fab fa-telegram mr-2"></i>Telegram
          </a>
          <a href="#" id="shareEmail" class="share-btn">
            <i class="fas fa-envelope mr-2"></i>Email
          </a>
          <a href="#" id="shareCopy" class="share-btn">
            <i class="fas fa-link mr-2"></i>Copy Link
          </a>
        </div>
        <a id="modalShare" href="#" class="share-btn">
          <i class="fas fa-share-alt mr-2"></i>Share
        </a>
        <button id="modalDownloadBtn" class="download-btn">
          <i class="fas fa-file-download mr-2"></i>Download
        </button>
        <button id="modalClose" class="control-btn">Close</button>
      </div>
    </div>
    <div id="modalBody" class="modal-body">
      <iframe id="modalFrame" class="hidden" src=""></iframe>
      <img id="modalImage" class="hidden" src="" alt="preview" />
    </div>
  </div>
</div>

<div id="analyseModal" class="modal hidden">
  <div class="modal-content">
    <h2 class="modal-title">Analyse Files</h2>
    <p class="modal-text">Choose files for analysis</p>
    <button id="analyseSelectFiles" class="modal-btn primary">Select Files</button>
    <button id="analyseSelectAll" class="modal-btn success">Select All Files</button>
    <button id="analyseClose" class="modal-btn">Cancel</button>
  </div>
</div>

<div id="fileSelectModal" class="modal hidden">
  <div class="modal-content">
    <h2 class="modal-title">Select Files</h2>
    <div id="fileSelectList" class="file-select-list"></div>
    <button id="confirmFileSelection" class="modal-btn primary">Confirm Selection</button>
    <button id="fileSelectClose" class="modal-btn">Cancel</button>
  </div>
</div>
<div id="sketchModal" class="sketch-modal-overlay hidden">
    <div class="sketch-toolbar">
        <div class="group">
          <button type="button" class="tool-btn" onclick="setTool('select')" title="Select & Move"><i class="fas fa-mouse-pointer"></i></button>
          
          <button type="button" class="tool-btn active" onclick="setTool('brush')" title="Brush"><i class="fas fa-paint-brush"></i></button>
          
          <button type="button" class="tool-btn" onclick="setTool('eraser')" title="Rubber / Eraser"><i class="fas fa-eraser"></i></button>

          <button type="button" class="tool-btn" onclick="setTool('line')" title="Line"><i class="fas fa-slash"></i></button>
          <button type="button" class="tool-btn" onclick="setTool('rect')" title="Rectangle"><i class="far fa-square"></i></button>
          <button type="button" class="tool-btn" onclick="setTool('circle')" title="Circle"><i class="far fa-circle"></i></button>
          <button type="button" class="tool-btn" onclick="setTool('text')" title="Text"><i class="fas fa-font"></i></button>
        </div>
        
        <div class="group border-l pl-2 ml-2">
            <input type="color" id="sketchColor" value="#000000" class="h-8 w-8 cursor-pointer" title="Color">
            <input type="range" id="sketchSize" min="1" max="20" value="2" class="w-24 align-middle" title="Brush Size">
        </div>

        <div class="group border-l pl-2 ml-2">
            <button type="button" class="tool-btn" onclick="undoSketch()" title="Undo"><i class="fas fa-undo"></i></button>
            <button type="button" class="tool-btn" onclick="triggerClearSketch()" title="Clear All">
                <i class="fas fa-trash"></i>
            </button>
        </div>

        <div class="group border-l pl-2 ml-2 flex-grow text-right">
            <button type="button" class="modal-btn" onclick="closeSketchModal()">Cancel</button>
            <button type="button" class="modal-btn primary" onclick="saveSketchModal()">Save Sketch</button>
        </div>
    </div>

    <div class="sketch-canvas-container" id="sketchContainer">
        <canvas id="proCanvas" class="canvas-layer"></canvas>
    </div>
</div>

<div id="confirmationModal" class="modal hidden">
  <div class="modal-content" style="max-width: 400px; text-align: center;">
    <div style="margin-bottom: 15px; font-size: 40px; color: #f59e0b;">
      <i class="fas fa-exclamation-circle"></i>
    </div>
    <h2 id="confirmTitle" class="modal-title">Are you sure?</h2>
    <p id="confirmMessage" class="modal-text">Do you really want to proceed?</p>
    
    <div style="display: flex; gap: 10px; margin-top: 20px;">
      <button id="confirmYesBtn" class="modal-btn primary" style="background: #ef4444; border-color: #ef4444;">Yes, do it</button>
      <button id="confirmNoBtn" class="modal-btn">No, Cancel</button>
    </div>
  </div>
</div>

<script>
/* =========================
   1. UTILITIES & CONFIG
========================= */
function getCookie(name) {
  let v = null;
  if (document.cookie && document.cookie !== '') {
    document.cookie.split(';').forEach(c => {
      c = c.trim();
      if (c.startsWith(name + '=')) v = decodeURIComponent(c.substring(name.length + 1));
    });
  }
  return v;
}
const csrftoken = getCookie("csrftoken");
const STORAGE_KEY = 'vadrida_site_feedback_autosave';

/* =========================
   2. STATE MANAGEMENT
========================= */
let currentFolder = "";
let currentFile = null;
let analysisController = null;
let currentFolderFiles = [];
let selectedAnalysisFiles = [];
let rootFoldersCache = null;
let isSearching = false;
let currentPreviewUrl = null;
let activeSketchPath = null;

// Unified Form State
let formState = {
    Valuers_Checklist: {
        documents_received: [], 
        product: "",
        Office_file_no: "",
        applicant_name: "",
        inspection_date: "",
        person_met: ""
    },
    Ownership_Analysis : { document_verification : [], Ownership_Analysis_notes : "", owners_name : "" },
    Survey: { docs: [], survey_notes: "" },

    Boundary_analysis_property_identification: { 
        ref_doc_1_name: "", ref_doc_2_name: "",
        north_doc1: "", north_doc2: "", east_doc1: "", east_doc2: "",
        south_doc1: "", south_doc2: "", west_doc1: "", west_doc2: "",
        north_translation:"", north_site:"", east_translation:"", east_site:"", 
        south_translation:"", south_site:"", west_translation:"", west_site:"", 
        Boundary_property_notes : ""
    },
    Demarcation: {north: [],east:[],south:[],west:[],demarcation_notes:"",enroachment_subject_to_neighbour:"",enroachment_neighbour_to_subject:""},
    Access : {
        access_notes:"", typeofaccess_titledeed : [], typeofaccess_sitevisit : [], private_no_user :[],
        private_rd_demarcation:[], main_access_width:"", vehicular_access:[], internal_road_width:"",
        internal_to_main_connectivity:"", road_material:[]
    },
    Purchase_resale : {
        Purchase_resale_notes:"", buyer_name:"", seller_name:"", buyer_seller_relation:"",
        property_sale_duration:"", transaction_method:"", purchase_land_extent:"", price_asked:"", deal_breaker_value:""
    },
    Building_analysis: { 
        Building_analysis_notes:"", roof_type: [], setback: "", construction_year:"", amenities_notes:"" ,
        Bf_2_Builtup_area:"",Bf_2_Rooms_no:"",Bf_2_Kitchen_no:"",Bf_2_Bathrooms_no:"",Bf_2_Usage:"",Bf_2_Occupancy:"",
        Bf_1_Builtup_area:"",Bf_1_Rooms_no:"",Bf_1_Kitchen_no:"",Bf_1_Bathrooms_no:"",Bf_1_Usage:"",Bf_1_Occupancy:"",
        Gf_Builtup_area:"",Gf_Rooms_no:"",Gf_Kitchen_no:"",Gf_Bathrooms_no:"",Gf_Usage:"",Gf_Occupancy:"",
        first_flr_Builtup_area:"",first_flr_Rooms_no:"",first_flr_Kitchen_no:"",first_flr_Bathrooms_no:"",first_flr_Usage:"",first_flr_Occupancy:"",
        second_flr_Builtup_area:"",second_flr_Rooms_no:"",second_flr_Kitchen_no:"",second_flr_Bathrooms_no:"",second_flr_Usage:"",second_flr_Occupancy:"",
        third_flr_Builtup_area:"",third_flr_Rooms_no:"",third_flr_Kitchen_no:"",third_flr_Bathrooms_no:"",third_flr_Usage:"",third_flr_Occupancy:"",
        fourth_flr_Builtup_area:"",fourth_flr_Rooms_no:"",fourth_flr_Kitchen_no:"",fourth_flr_Bathrooms_no:"",fourth_flr_Usage:"",fourth_flr_Occupancy:"",
        fifth_flr_Builtup_area:"",fifth_flr_Rooms_no:"",fifth_flr_Kitchen_no:"",fifth_flr_Bathrooms_no:"",fifth_flr_Usage:"",fifth_flr_Occupancy:"",
        front_yard_min:"", front_yard_max:"", side1_yard_min:"", side1_yard_max:"", 
        side2_yard_min:"", side2_yard_max:"", rear_yard_min:"", rear_yard_max:""
    },
    Sketch: { landmark_description: "", main_layout: "" }, 
    images: {} ,
    vectors : {}
};

/* =========================
   3. DOM ELEMENTS
========================= */
const fileList = document.getElementById("fileList");
const thumbsContainer = document.getElementById("thumbs");
const bigImageFrame = document.getElementById("bigImageFrame");
const noSelection = document.getElementById("noSelection");
const bigPreviewTitle = document.getElementById("bigPreviewTitle");
const fileInfoBox = document.getElementById("fileInfoBox");
const pdfWrapper = document.getElementById("pdfWrapper");
const pdfMain = document.getElementById("pdfMain");

// Sketch Elements - Pointing to PRO CANVAS (Modal)
const sketchModal = document.getElementById('sketchModal');
const canvas = document.getElementById("proCanvas"); 
const ctx = canvas ? canvas.getContext("2d") : null;

/* =========================
   4. FILE EXPLORER LOGIC
========================= */
function loadFolder(path = "") {
  currentFolder = path;
  document.getElementById("currentPath").textContent = "/" + (path || "");
  fileList.innerHTML = `<li class="file-item loading">Loading...</li>`;
  thumbsContainer.innerHTML = `<div class="no-thumbs">Loading...</div>`;

  fetch(`/coreapi/api/folder-contents/?path=${encodeURIComponent(path)}`)
    .then(r => {
      if (!r.ok) throw new Error(`HTTP ${r.status}`);
      return r.json();
    })
    .then(data => {
      currentFolderFiles = data.files || [];
      renderFileList(data.folders || [], data.files || []);
      renderThumbs(data.files || []);
    })
    .catch(error => {
      fileList.innerHTML = `<li class="file-item error">Error: ${error.message}</li>`;
      thumbsContainer.innerHTML = `<div class="no-thumbs">Error loading</div>`;
    });
}

document.getElementById("goBackBtn").onclick = () => {
  if (!currentFolder) return;
  const parts = currentFolder.split("/");
  parts.pop();
  loadFolder(parts.join("/"));
};

function renderFileList(folders, files) {
  fileList.innerHTML = "";
  folders.forEach(folder => {
    const li = document.createElement("li");
    li.className = "file-item folder-item";
    li.innerHTML = `üìÅ <strong>${folder.name}</strong>`;
    li.onclick = () => loadFolder(folder.path);
    fileList.appendChild(li);
  });

  files.forEach(file => {
    const li = document.createElement("li");
    li.className = "file-item";
    li.innerHTML = `<div class="file-details"><div class="file-name">${file.name}</div><div class="file-ext">${file.extension || ""}</div></div>`;
    li.onclick = () => {
      document.querySelectorAll(".file-item").forEach(el => el.classList.remove("selected"));
      li.classList.add("selected");
      loadBigPreview(file);
      setFileInfo(file);
    };
    fileList.appendChild(li);
  });

  if (!folders.length && !files.length) {
    fileList.innerHTML = `<li class="no-results">No files or folders found</li>`;
  }
}

/* =========================
   5. THUMBNAILS & PREVIEWS
========================= */
/* =========================
   UPDATED THUMBNAIL RENDERER
========================= */

async function renderThumbs(files) {
  console.log("Rendering thumbnails for", files.length, "files"); // Debug log
  
  thumbsContainer.innerHTML = "";

  if (!files.length) {
    thumbsContainer.innerHTML = `<div class="no-thumbs">No files to preview</div>`;
    return;
  }

  for (const file of files) {
    const card = document.createElement("div");
    card.className = "thumb-item";

    const ext = file.name.split(".").pop().toLowerCase();

    if (["jpg","jpeg","png","gif","bmp","webp"].includes(ext)) {
      const img = document.createElement("img");
      img.src = `/coreapi/serve-file/?path=${encodeURIComponent(file.path)}`;
      img.loading = "lazy";
      img.onerror = () => {
        card.innerHTML = `
          <div class="file-icon">
            <i class="fas fa-image"></i><br>${ext.toUpperCase()}
          </div>
        `;
      };
      card.appendChild(img);
    }
    else if (ext === "pdf") {
      await renderPdfThumbnail(file, card);
    }
    else {
      card.innerHTML = `
        <div class="file-icon">
          <i class="fas fa-file"></i><br>${ext.toUpperCase()}
        </div>
      `;
    }

    card.onclick = () => {
      console.log("Clicking thumbnail for:", file.name); // Debug log
      loadBigPreview(file);
    };
    thumbsContainer.appendChild(card);
  }
}

function loadBigPreview(file) {
  currentFile = file;
  const url = `/coreapi/serve-file/?path=${encodeURIComponent(file.path)}`;
  currentPreviewUrl = url;
  bigPreviewTitle.textContent = file.name;

  pdfMain.innerHTML = "";
  pdfWrapper.classList.add("hidden");
  bigImageFrame.classList.add("hidden");
  noSelection.classList.add("hidden");

  const ext = file.name.split(".").pop().toLowerCase();

  if (["jpg","jpeg","png","gif","bmp","webp"].includes(ext)) {
    bigImageFrame.src = url;
    bigImageFrame.onload = () => {
      bigImageFrame.classList.remove("hidden");
      document.getElementById("downloadPdfBtn").classList.remove("hidden");
    };
  } else if (ext === "pdf") {
    pdfWrapper.classList.remove("hidden");
    document.getElementById("downloadPdfBtn").classList.remove("hidden");
    renderFullPdf(url);
  } else {
    noSelection.textContent = "Preview not available";
    noSelection.classList.remove("hidden");
  }
}

function setFileInfo(file) {
  fileInfoBox.innerHTML = `
    <div class="info-row"><strong>Name:</strong> <span>${file.name}</span></div>
    <div class="info-row"><strong>Type:</strong> ${file.extension || "Unknown"}</div>
    <div class="info-row"><strong>Size:</strong> ${file.size || "N/A"}</div>
  `;
}

/* =========================
   6. PDF & ANALYSIS TOOLS
========================= */
async function renderFullPdf(url) {
  try {
    await loadPdfJsIfNeeded();
    const pdf = await pdfjsLib.getDocument(url).promise;
    pdfMain.innerHTML = "";
    for (let i = 1; i <= pdf.numPages; i++) {
      const page = await pdf.getPage(i);
      const viewport = page.getViewport({ scale: window.innerWidth < 768 ? 1.2 : 1.5 });
      const cvs = document.createElement("canvas");
      cvs.width = viewport.width;
      cvs.height = viewport.height;
      cvs.style.marginBottom = "10px";
      cvs.style.display = "block";
      cvs.style.border = "1px solid #e5e7eb";
      await page.render({ canvasContext: cvs.getContext("2d"), viewport }).promise;
      pdfMain.appendChild(cvs);
    }
    pdfMain.style.overflowY = "auto";
  } catch (error) {
    pdfMain.innerHTML = `<div class="error">Error loading PDF</div>`;
  }
}

function loadPdfJsIfNeeded() {
  if (window.pdfjsLib) return Promise.resolve();
  return new Promise((resolve) => {
    const script = document.createElement("script");
    script.src = "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js";
    script.onload = () => {
      pdfjsLib.GlobalWorkerOptions.workerSrc = "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js";
      resolve();
    };
    document.head.appendChild(script);
  });
}

// Analysis Controls
const analyseBtn = document.getElementById("analyseBtn");
const analyseModal = document.getElementById("analyseModal");
const fileSelectModal = document.getElementById("fileSelectModal");
const fileSelectList = document.getElementById("fileSelectList");

function startAnalysis(files) {
  if (analysisController) analysisController.abort();
  analysisController = new AbortController();
  document.getElementById("analyseLoading").classList.remove("hidden");

  fetch("/coreapi/api/analyze/", {
    method: "POST",
    headers: { "Content-Type": "application/json", "X-CSRFToken": csrftoken },
    body: JSON.stringify({ files, folder: currentFolder }),
    signal: analysisController.signal
  })
  .then(r => r.json())
  .then(() => loadFolder(currentFolder))
  .catch(e => { if (e.name !== 'AbortError') alert("Analysis failed"); })
  .finally(() => {
    document.getElementById("analyseLoading").classList.add("hidden");
    analysisController = null;
  });
}

analyseBtn.onclick = () => {
  if (!currentFolder && currentFolderFiles.length === 0) return alert("No files");
  analyseModal.classList.remove("hidden");
};

document.getElementById("analyseSelectAll").onclick = () => {
  if (!currentFolderFiles.length) return alert("No files");
  const files = currentFolderFiles.map(f => ({ file_path: f.path }));
  analyseModal.classList.add("hidden");
  startAnalysis(files);
};

document.getElementById("analyseSelectFiles").onclick = () => {
  if (!currentFolderFiles.length) return alert("No files");
  fileSelectList.innerHTML = "";
  selectedAnalysisFiles = [];
  currentFolderFiles.forEach(file => {
    const row = document.createElement("label");
    row.className = "flex items-center gap-2 mb-2 cursor-pointer";
    row.innerHTML = `<input type="checkbox" value="${file.path}" /> <span class="truncate">${file.name}</span>`;
    row.querySelector("input").onchange = (e) => {
      if (e.target.checked) selectedAnalysisFiles.push({ file_path: e.target.value });
      else selectedAnalysisFiles = selectedAnalysisFiles.filter(f => f.file_path !== e.target.value);
    };
    fileSelectList.appendChild(row);
  });
  analyseModal.classList.add("hidden");
  fileSelectModal.classList.remove("hidden");
};

document.getElementById("confirmFileSelection").onclick = () => {
  if (!selectedAnalysisFiles.length) return alert("Select a file");
  fileSelectModal.classList.add("hidden");
  startAnalysis(selectedAnalysisFiles);
};

document.getElementById("analyseClose").onclick = () => analyseModal.classList.add("hidden");
document.getElementById("fileSelectClose").onclick = () => fileSelectModal.classList.add("hidden");

// Search
const searchInput = document.getElementById("fileSearch");
let searchTimer = null;
searchInput.addEventListener("input", e => {
  const q = e.target.value.trim();
  clearTimeout(searchTimer);
  searchTimer = setTimeout(() => {
    if (!q) { loadFolder(currentFolder); return; }
    globalSearch(q);
  }, 300);
});

function globalSearch(query) {
  fileList.innerHTML = `<li class="file-item loading">Searching...</li>`;
  fetch(`/coreapi/api/search/?q=${encodeURIComponent(query)}`)
    .then(r => r.json())
    .then(data => {
      renderFileList(data.folders || [], data.files || []);
      renderThumbs(data.files || []);
    });
}

document.getElementById("refreshFolders").onclick = () => {
  fetch("/coreapi/api/refresh/", { method: "POST", headers: { "X-CSRFToken": csrftoken } })
    .then(() => {
      searchInput.value = "";
      loadFolder("");
    });
};

/* =========================
   7. MODAL & PREVIEW UI
========================= */
const fullscreenModal = document.getElementById("fullscreenModal");
const modalFrame = document.getElementById("modalFrame");
const modalImage = document.getElementById("modalImage");

document.getElementById("openFullBtn").onclick = () => {
  if (!currentFile) return alert("Select a file");
  if (window.innerWidth < 768) {
    window.open(currentPreviewUrl, "_blank");
    return;
  }
  fullscreenModal.setAttribute("aria-hidden", "false");
  modalFrame.classList.add("hidden");
  modalImage.classList.add("hidden");
  const ext = currentFile.name.split(".").pop().toLowerCase();
  if (["jpg","jpeg","png","gif","bmp","webp"].includes(ext)) {
    modalImage.src = currentPreviewUrl;
    modalImage.classList.remove("hidden");
  } else {
    modalFrame.src = currentPreviewUrl;
    modalFrame.classList.remove("hidden");
  }
};
document.getElementById("modalClose").onclick = () => {
  fullscreenModal.setAttribute("aria-hidden", "true");
  modalFrame.src = ""; modalImage.src = "";
};

const modalDownloadBtn = document.getElementById("modalDownloadBtn");
modalDownloadBtn.onclick = () => {
  if (currentFile) window.location.href = `/coreapi/serve-file/?path=${encodeURIComponent(currentFile.path)}&download=true`;
};


// Enforce Landscape
/* =========================
   UPDATED ORIENTATION LOGIC
========================= */
function enforceTabletLandscape() {
  const sketchModal = document.getElementById('sketchModal');
  
  // 1. If Sketch Modal is Open, ALLOW Portrait (Do not block)
  if (sketchModal && !sketchModal.classList.contains('hidden')) {
      document.getElementById("orientationBlocker").classList.add("hidden");
      document.body.style.overflow = "hidden"; // Keep scrolling locked
      return; 
  }

  // 2. Standard Logic for Dashboard
  const isTablet = window.innerWidth >= 768 && window.innerWidth <= 1024;
  const isPortrait = window.innerHeight > window.innerWidth;
  const blocker = document.getElementById("orientationBlocker");

  if (isTablet && isPortrait) {
    blocker.classList.remove("hidden");
    document.body.style.overflow = "hidden";
  } else {
    blocker.classList.add("hidden");
    document.body.style.overflow = "";
  }
}

// Add a specific resize listener to handle canvas resizing when rotating
window.addEventListener("resize", () => {
    enforceTabletLandscape();
    // If sketch modal is open, resize the canvas to fit the new orientation
    if (!document.getElementById('sketchModal').classList.contains('hidden')) {
        resizeCanvas();
    }
});

window.addEventListener("resize", enforceTabletLandscape);
window.addEventListener("orientationchange", enforceTabletLandscape);

/* =========================
   8. SKETCH PAD & DRAWING LOGIC
========================= */
/* =========================
   ADVANCED SKETCH LOGIC (Vector Based)
========================= */

// STATE
let elements = []; // Stores all shapes
let historyStack = []; // For Undo
let selectedElement = null; // The shape currently being moved/edited

// INTERACTION STATE
let isDrawing = false;
let isDragging = false;
let isResizing = false;
let isPromptOpen = false; // Prevents double text boxes

let startX, startY;
let currentTool = 'brush';

// CANVAS SETUP

function resizeCanvas() {
    if(!canvas) return;
    // Save current drawing
    const saved = JSON.stringify(elements);
    
    canvas.width = window.innerWidth - 40;
    canvas.height = window.innerHeight - 100;
    
    // Restore
    if(saved) elements = JSON.parse(saved);
    renderScene();
}

function openSketchPad(path) {
    activeSketchPath = path;
    sketchModal.classList.remove('hidden');

    // 1. Request Full Screen
    const elem = document.documentElement;
    if (elem.requestFullscreen) elem.requestFullscreen().catch(err => console.log(err));
    else if (elem.webkitRequestFullscreen) elem.webkitRequestFullscreen();

    // 2. Handle Compass Overlay (Only for Main Layout)
    const container = document.getElementById('sketchContainer');
    const existingCompass = document.getElementById('sketchCompassOverlay');
    if (existingCompass) existingCompass.remove();

    if (path === 'Sketch.main_layout') {
        const compass = document.createElement('img');
        compass.id = 'sketchCompassOverlay';
        compass.src = "{% static 'images/compass-icon.png' %}";
        compass.alt = "N";
        Object.assign(compass.style, {
            position: 'absolute', top: '20px', right: '25px', width: '60px',
            opacity: '0.8', pointerEvents: 'none', zIndex: '100'
        });
        container.appendChild(compass);
    }

    // 3. Initialize Canvas & Restore Data
    setTimeout(() => {
        resizeCanvas();
        
        // CRITICAL FIX: Restore the Vector Elements
        if (formState.vectors && formState.vectors[path]) {
            // Restore saved shapes
            elements = JSON.parse(JSON.stringify(formState.vectors[path]));
        } else {
            // Start fresh
            elements = []; 
        }
        
        // Force a redraw immediately so the user sees their old sketch
        renderScene();
    }, 100); 
}

function closeSketchModal() {
    sketchModal.classList.add('hidden');
    activeSketchPath = null;

    // Exit Full Screen
    if (document.exitFullscreen) {
        document.exitFullscreen().catch(err => console.log(err));
    } else if (document.webkitExitFullscreen) { /* Safari */
        document.webkitExitFullscreen();
    }
    
    // Re-check orientation (put blocker back if needed)
    enforceTabletLandscape();
}
// ================= TOOLBAR FUNCTIONS =================
function setTool(tool) {
    currentTool = tool;
    selectedElement = null; // Deselect when changing tools
    document.querySelectorAll('.tool-btn').forEach(b => b.classList.remove('active'));
    // Find the button that called this (hacky but works)
    const btn = document.querySelector(`button[onclick="setTool('${tool}')"]`);
    if(btn) btn.classList.add('active');
    renderScene();
}


function triggerClearSketch() {
   
    if (elements.length === 0) return; 
    showConfirm(
        "Clear Drawing?", 
        "Are you sure you want to delete the entire drawing? This cannot be undone.", 
        performClearSketch
    );
}

function performClearSketch() {
    elements = [];
    renderScene();
}

function undoSketch() {
    if (elements.length > 0) {
        elements.pop();
        renderScene();
    }
}

// ================= CORE RENDERING ENGINE =================
function renderScene() {
    // 1. Clear Canvas
    ctx.fillStyle = "white";
    ctx.fillRect(0, 0, canvas.width, canvas.height);
    
    // 2. Draw All Elements
    elements.forEach(el => {
        ctx.beginPath();
        ctx.strokeStyle = el.color;
        ctx.lineWidth = el.size;
        ctx.fillStyle = el.color;
        ctx.lineCap = 'round';
        ctx.lineJoin = 'round';

        if (el.type === 'brush') {
            if(el.points.length > 0) {
                ctx.moveTo(el.points[0].x, el.points[0].y);
                el.points.forEach(p => ctx.lineTo(p.x, p.y));
                ctx.stroke();
            }
        } 
        else if (el.type === 'line') {
            ctx.moveTo(el.x, el.y);
            ctx.lineTo(el.endX, el.endY);
            ctx.stroke();
        } 
        else if (el.type === 'rect') {
            ctx.strokeRect(el.x, el.y, el.w, el.h);
            // Text inside Rect
            if(el.text) {
                ctx.font = "16px Arial";
                ctx.textAlign = "center";
                ctx.textBaseline = "middle";
                ctx.fillText(el.text, el.x + el.w/2, el.y + el.h/2);
            }
        } 
        else if (el.type === 'circle') {
            ctx.arc(el.x, el.y, el.r, 0, 2 * Math.PI);
            ctx.stroke();
             // Text inside Circle
             if(el.text) {
                ctx.font = "16px Arial";
                ctx.textAlign = "center";
                ctx.textBaseline = "middle";
                ctx.fillText(el.text, el.x, el.y);
            }
        } 
        else if (el.type === 'text') {
            ctx.font = (el.size * 5) + "px Arial";
            ctx.fillText(el.text, el.x, el.y);
        }
    });

    // 3. Draw Selection Box (if something is selected)
    if (selectedElement) {
        ctx.strokeStyle = "#3b82f6"; // Blue selection color
        ctx.lineWidth = 1;
        ctx.setLineDash([5, 5]); // Dotted line
        
        // Draw bounding box based on type
        if(selectedElement.type === 'rect') {
            ctx.strokeRect(selectedElement.x - 5, selectedElement.y - 5, selectedElement.w + 10, selectedElement.h + 10);
            // Draw Resize Handle
            ctx.fillStyle = "#3b82f6";
            ctx.fillRect(selectedElement.x + selectedElement.w - 5, selectedElement.y + selectedElement.h - 5, 10, 10);
        } 
        // (Simplified selection logic for brevity)
        
        ctx.setLineDash([]); // Reset dash
    }
}

// ================= INTERACTION HANDLERS =================

// Helper: Get X/Y from Touch or Mouse
const getPos = (e) => {
    const rect = canvas.getBoundingClientRect();
    let cx, cy;
    if (e.touches && e.touches.length > 0) { cx = e.touches[0].clientX; cy = e.touches[0].clientY; }
    else if (e.changedTouches && e.changedTouches.length > 0) { cx = e.changedTouches[0].clientX; cy = e.changedTouches[0].clientY; }
    else { cx = e.clientX; cy = e.clientY; }
    return { x: cx - rect.left, y: cy - rect.top };
};

// Helper: Check if point is inside an element
function isHit(el, x, y) {
    if (el.type === 'rect') {
        return (x >= el.x && x <= el.x + el.w && y >= el.y && y <= el.y + el.h);
    }
    if (el.type === 'circle') {
        const dist = Math.sqrt((x-el.x)**2 + (y-el.y)**2);
        return dist <= el.r;
    }
    if (el.type === 'text') {
        // Approximate text hit box
        return (x >= el.x && x <= el.x + 100 && y >= el.y - 20 && y <= el.y);
    }
    // Lines and Brush are harder to select, skipping for simplicity in this version
    return false;
}

const handleStart = (e) => {
    if(e.type === 'touchstart') e.preventDefault();
    const pos = getPos(e);
    startX = pos.x;
    startY = pos.y;

    // SELECT TOOL LOGIC (Keep as is)
    if (currentTool === 'select') {
        selectedElement = null; isResizing = false;
        for (let i = elements.length - 1; i >= 0; i--) {
            if (isHit(elements[i], startX, startY)) {
                selectedElement = elements[i];
                isDragging = true;
                if(selectedElement.type === 'rect' && 
                   Math.abs(startX - (selectedElement.x + selectedElement.w)) < 20 && 
                   Math.abs(startY - (selectedElement.y + selectedElement.h)) < 20) {
                    isResizing = true; isDragging = false;
                }
                break;
            }
        }
        renderScene();
        return;
    }

    // DRAWING LOGIC
    isDrawing = true;
    
    // 1. Get Base Values from UI
    let uiColor = document.getElementById('sketchColor').value;
    let uiSize = document.getElementById('sketchSize').value;
    
    // 2. Override for Eraser
    let finalColor = uiColor;
    let finalSize = uiSize;
    
    if (currentTool === 'eraser') {
        finalColor = '#FFFFFF'; // Force White
        finalSize = 30;         // Force Thick
    }

    // 3. Create Element with FINAL values
    if (currentTool === 'brush' || currentTool === 'eraser') {
        // Treat eraser as just a white brush
        elements.push({ 
            type: 'brush', 
            points: [{x: startX, y: startY}], 
            color: finalColor, 
            size: finalSize 
        });
    } 
    else if (currentTool === 'line') {
        elements.push({ type: 'line', x: startX, y: startY, endX: startX, endY: startY, color: finalColor, size: finalSize });
    } 
    else if (currentTool === 'rect') {
        elements.push({ type: 'rect', x: startX, y: startY, w: 0, h: 0, color: finalColor, size: finalSize, text: '' });
    } 
    else if (currentTool === 'circle') {
        elements.push({ type: 'circle', x: startX, y: startY, r: 0, color: finalColor, size: finalSize, text: '' });
    }
};

const handleMove = (e) => {
    if(e.type === 'touchmove') e.preventDefault();
    const pos = getPos(e);

    // 1. Dragging / Resizing
    if (currentTool === 'select' && selectedElement) {
        const dx = pos.x - startX;
        const dy = pos.y - startY;

        if (isDragging) {
            // Move Logic
            if(selectedElement.type === 'brush') {
                selectedElement.points.forEach(p => { p.x += dx; p.y += dy; });
            } else if (selectedElement.type === 'line') {
                selectedElement.x += dx; selectedElement.y += dy;
                selectedElement.endX += dx; selectedElement.endY += dy;
            } else {
                selectedElement.x += dx;
                selectedElement.y += dy;
            }
            startX = pos.x;
            startY = pos.y;
            renderScene();
        } 
        else if (isResizing && selectedElement.type === 'rect') {
            // Resize Logic (Rect only)
            selectedElement.w = pos.x - selectedElement.x;
            selectedElement.h = pos.y - selectedElement.y;
            renderScene();
        }
        return;
    }

    // 2. Creating
    if (!isDrawing) return;
    
    // Get the element we are currently drawing (it's the last one)
    const activeEl = elements[elements.length - 1];

    if (currentTool === 'brush' || currentTool === 'eraser') {
        activeEl.points.push({x: pos.x, y: pos.y});
    } else if (currentTool === 'line') {
        activeEl.endX = pos.x;
        activeEl.endY = pos.y;
    } else if (currentTool === 'rect') {
        activeEl.w = pos.x - startX;
        activeEl.h = pos.y - startY;
    } else if (currentTool === 'circle') {
        activeEl.r = Math.sqrt(Math.pow(pos.x - startX, 2) + Math.pow(pos.y - startY, 2));
    }

    renderScene();
};

const handleEnd = (e) => {
    if(e.type === 'touchend') e.preventDefault();
    isDrawing = false;
    isDragging = false;
    isResizing = false;

    // Handle Text Tool Click (Single click to add text)
    if (currentTool === 'text' && !isDragging) {
        addText(startX, startY);
    }
};

// ================= TEXT HANDLING =================

// Single click to add new text
function addText(x, y) {
    if (isPromptOpen) return;
    isPromptOpen = true;
    
    setTimeout(() => {
        const text = prompt("Enter text:", "");
        if (text) {
            const color = document.getElementById('sketchColor').value;
            const size = document.getElementById('sketchSize').value;
            elements.push({ type: 'text', text, x, y, color, size });
            renderScene();
        }
        isPromptOpen = false;
    }, 100);
}

// Double Click to Edit Text inside shapes
canvas.addEventListener('dblclick', (e) => {
    const pos = getPos(e);
    
    // Find clicked element
    for (let i = elements.length - 1; i >= 0; i--) {
        if (isHit(elements[i], pos.x, pos.y)) {
            const el = elements[i];
            
            // Edit existing text inside shape
            if (isPromptOpen) return;
            isPromptOpen = true;

            setTimeout(() => {
                const currentTxt = el.text || "";
                const newText = prompt("Edit Text:", currentTxt);
                if (newText !== null) {
                    el.text = newText;
                    renderScene();
                }
                isPromptOpen = false;
            }, 100);
            return; // Stop searching
        }
    }
});

// ================= LISTENERS =================
if (canvas) {
    canvas.addEventListener('mousedown', handleStart);
    canvas.addEventListener('mousemove', handleMove);
    canvas.addEventListener('mouseup', handleEnd);
    
    canvas.addEventListener('touchstart', handleStart, {passive: false});
    canvas.addEventListener('touchmove', handleMove, {passive: false});
    canvas.addEventListener('touchend', handleEnd, {passive: false});
}

function saveSketchModal() {
    if (!activeSketchPath) return;
    
    // 1. Save Image (For the Preview Thumbnail on the main page)
    // Optional: Draw Compass onto canvas context temporarily if needed, 
    // but usually the HTML overlay is enough for the user context.
    const dataUrl = canvas.toDataURL('image/png');
    
    if (!formState.images) formState.images = {};
    formState.images[activeSketchPath] = dataUrl;

    // 2. SAVE VECTORS (The Critical Fix)
    // This remembers every line and shape you drew so you can edit them later.
    if (!formState.vectors) formState.vectors = {};
    // We use JSON.parse/stringify to create a clean copy of the array
    formState.vectors[activeSketchPath] = JSON.parse(JSON.stringify(elements));
    
    // 3. Update UI Preview
    const safeId = activeSketchPath.replace(/\./g, '_');
    const previewImg = document.getElementById(`img_preview_${safeId}`);
    if (previewImg) {
        previewImg.src = dataUrl;
        previewImg.classList.remove('hidden');
    }
    
    // Hide placeholder text for main layout
    if(activeSketchPath === 'Sketch.main_layout') {
        const ph = document.getElementById(`placeholder_${safeId}`);
        if(ph) ph.classList.add('hidden');
    }
    
    saveLocal();
    closeSketchModal();
}

/* =========================
   9. DATA SYNC & SUBMISSION
========================= */
function updateNestedState(obj, path, value) {
    if (!path) return;
    const keys = path.split('.');
    let current = obj;
    for (let i = 0; i < keys.length - 1; i++) {
        if (!current[keys[i]]) current[keys[i]] = {};
        current = current[keys[i]];
    }
    current[keys[keys.length - 1]] = value;
}

function getNestedValue(obj, path) {
    if (!path) return undefined;
    return path.split('.').reduce((acc, part) => (acc && acc[part] !== undefined) ? acc[part] : undefined, obj);
}

function updateArrayState(obj, path, value, isChecked) {
    if (!path) return;
    const keys = path.split('.');
    let current = obj;
    for (let i = 0; i < keys.length - 1; i++) {
        if (!current[keys[i]]) current[keys[i]] = {};
        current = current[keys[i]];
    }
    const lastKey = keys[keys.length - 1];
    if (!Array.isArray(current[lastKey])) current[lastKey] = [];
    if (isChecked) { if (!current[lastKey].includes(value)) current[lastKey].push(value); } 
    else { current[lastKey] = current[lastKey].filter(v => v !== value); }
}

function saveLocal() {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(formState));
}

function syncStateToUI() {
    // Inputs
    document.querySelectorAll('[data-path]').forEach(el => {
        const val = getNestedValue(formState, el.getAttribute('data-path'));
        if (val !== undefined) el.value = val;
    });
    // Checkboxes
    document.querySelectorAll('[data-array]').forEach(el => {
        const arr = getNestedValue(formState, el.getAttribute('data-array'));
        if (Array.isArray(arr) && arr.includes(el.value)) el.checked = true;
    });
}

function injectPencilIcons() {
    const textareas = document.querySelectorAll('textarea[data-path]');
    textareas.forEach(textarea => {
        if (textarea.parentElement.classList.contains('input-wrapper')) return;
        const path = textarea.getAttribute('data-path');
        const safeId = path.replace(/\./g, '_');
        
        const wrapper = document.createElement('div');
        wrapper.className = 'input-wrapper';
        textarea.parentNode.insertBefore(wrapper, textarea);
        wrapper.appendChild(textarea);
        
        const btn = document.createElement('div');
        btn.className = 'edit-icon';
        btn.innerHTML = '<i class="fas fa-pencil-alt"></i>';
        btn.onclick = () => openSketchPad(path);
        wrapper.appendChild(btn);

        const img = document.createElement('img');
        img.id = `img_preview_${safeId}`; 
        img.className = 'sketch-thumb hidden';
        img.onclick = () => openSketchPad(path);
        wrapper.parentNode.insertBefore(img, wrapper.nextSibling);
    });
}

function renderSurveyColumns() {
    const headerRow = document.getElementById('surveyHeader');
    const bodyRows = document.querySelectorAll('#surveyBody tr');
    if (!headerRow) return;

    headerRow.querySelectorAll('.dyn-col').forEach(el => el.remove());
    bodyRows.forEach(row => row.querySelectorAll('.dyn-cell').forEach(el => el.remove()));

    const availableDocs = formState.Valuers_Checklist.documents_received || [];
    const surveyDocs = formState.Survey.docs || [];

    surveyDocs.forEach((docObj, index) => {
        const th = document.createElement('th');
        th.className = 'dyn-col';
        th.style.minWidth = "150px";
        let optionsHtml = `<option value="">Select Doc</option>`;
        availableDocs.forEach(d => {
            const sel = (d === docObj.name) ? "selected" : "";
            optionsHtml += `<option value="${d}" ${sel}>${d}</option>`;
        });
        th.innerHTML = `<select class="form-select" style="width: 100%; color:black;" onchange="updateSurveyDocName(${index}, this.value)">${optionsHtml}</select>`;
        headerRow.appendChild(th);

        bodyRows.forEach(row => {
            const key = row.getAttribute('data-row-key');
            if(key) {
                const td = document.createElement('td');
                td.className = 'dyn-cell';
                td.innerHTML = `<input type="text" class="table-input" value="${docObj[key] || ''}" oninput="updateSurveyDocData(${index}, '${key}', this.value)">`;
                row.appendChild(td);
            }
        });
    });
}

window.updateSurveyDocName = (index, value) => {
    formState.Survey.docs[index].name = value;
    saveLocal();
};

window.updateSurveyDocData = (index, key, value) => {
    formState.Survey.docs[index][key] = value;
    saveLocal();
};

function addSurveyColumn() {
    if (!formState.Survey.docs) formState.Survey.docs = [];
    formState.Survey.docs.push({ name: "", scedule_no: "" });
    renderSurveyColumns();
    saveLocal();
}

function updateAllDocumentDropdowns() {
    const docs = formState.Valuers_Checklist.documents_received || [];
    document.querySelectorAll('.dynamic-doc-dropdown').forEach(select => {
        const currentSelection = select.value;
        select.innerHTML = '<option value="">Select Document</option>';
        docs.forEach(docName => {
            const opt = document.createElement('option');
            opt.value = docName; opt.textContent = docName;
            select.appendChild(opt);
        });
        if (docs.includes(currentSelection)) select.value = currentSelection;
    });
}

// Global Event Listeners
document.getElementById('siteFeedbackForm').addEventListener('input', (e) => {
    const target = e.target;
    const path = target.getAttribute('data-path');
    const arrayPath = target.getAttribute('data-array');
    if (path) {
        updateNestedState(formState, path, target.value);
    } else if (arrayPath) {
        updateArrayState(formState, arrayPath, target.value, target.checked);
        if (arrayPath === 'Valuers_Checklist.documents_received') {
            renderSurveyColumns();
            updateAllDocumentDropdowns();
        }
    }
    saveLocal();
});


let pendingAction = null;
const confirmModal = document.getElementById('confirmationModal');
const confirmTitle = document.getElementById('confirmTitle');
const confirmMessage = document.getElementById('confirmMessage');

function showConfirm(title, message, actionCallback) {
    confirmTitle.textContent = title;
    confirmMessage.textContent = message;
    pendingAction = actionCallback;
    confirmModal.classList.remove('hidden');
}

document.getElementById('confirmNoBtn').onclick = () => {
    confirmModal.classList.add('hidden');
    pendingAction = null;
};

document.getElementById('confirmYesBtn').onclick = () => {
    if (pendingAction) pendingAction();
    confirmModal.classList.add('hidden');
};

// 1. TRIGGER SUBMIT
document.getElementById('triggerSubmitBtn').onclick = (e) => {
    e.preventDefault();
    showConfirm(
        "Submit Report?", 
        "Are you sure you want to submit this feedback? This cannot be undone.", 
        performSubmit
    );
};

// 2. TRIGGER RESET
document.getElementById('triggerResetBtn').onclick = (e) => {
    e.preventDefault();
    showConfirm(
        "Clear All Data?", 
        "This will delete all your text, checkboxes, and sketches. Are you sure?", 
        performReset
    );
};

// ACTUAL SUBMIT FUNCTION
async function performSubmit() {
    // Save Canvas state one last time before sending
    if(canvas) formState.sketch_data = canvas.toDataURL();
    
    try {
        // Show a loading text on the button
        const btn = document.getElementById('triggerSubmitBtn');
        const originalText = btn.textContent;
        btn.textContent = "Submitting...";
        btn.disabled = true;

        const response = await fetch('/coreapi/api/save-feedback/', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrftoken },
            body: JSON.stringify(formState)
        });
        const res = await response.json();
        
        btn.textContent = originalText;
        btn.disabled = false;

        if(res.success) {
            alert("‚úÖ Report Saved Successfully! ID: " + res.report_id);
            performReset(); // Clear local storage and reload
        } else {
            alert("‚ùå Error: " + (res.error || "Unknown error"));
        }
    } catch (err) {
        console.error(err);
        alert("‚ùå Network Error. Please check your connection.");
        document.getElementById('triggerSubmitBtn').disabled = false;
        document.getElementById('triggerSubmitBtn').textContent = "Submit Feedback";
    }
}

// ACTUAL RESET FUNCTION
function performReset() {
    localStorage.removeItem(STORAGE_KEY);
    location.reload();
}

/* =========================
   10. APP INIT
========================= */
document.addEventListener("DOMContentLoaded", () => {

  
    console.log("App Initializing...");
    loadFolder("");
    enforceTabletLandscape();

    // Load LocalStorage
    const saved = localStorage.getItem(STORAGE_KEY);
    if (saved) {
        try {
            const parsed = JSON.parse(saved);
            formState = { ...formState, ...parsed };
            if(!formState.images) formState.images = {};
            if(!formState.vectors) formState.vectors = {};
        } catch(e) { console.error(e); }
    }
    const confirmModal = document.getElementById('confirmationModal');
    if (confirmModal && confirmModal.parentNode !== document.body) {
        document.body.appendChild(confirmModal);
    }

    // Setup UI
    injectPencilIcons();
    syncStateToUI();
    renderSurveyColumns();
    updateAllDocumentDropdowns();

    // Load saved images
    Object.keys(formState.images).forEach(path => {
        const safeId = path.replace(/\./g, '_');
        const previewImg = document.getElementById(`img_preview_${safeId}`);
        if (previewImg) {
            previewImg.src = formState.images[path];
            previewImg.classList.remove('hidden');
            if(path === 'Sketch.main_layout') {
                const ph = document.getElementById(`placeholder_${safeId}`);
                if(ph) ph.classList.add('hidden');
            }
        }
    });
});


</script>

{% endblock %}