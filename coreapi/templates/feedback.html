{% extends "base.html" %}
{% load static %}
{% block title %}Site Feedback Form — Vadrida{% endblock %}
{% block extra_head %}

<link rel="stylesheet" href="{% static 'css/feedback.css' %}">

<style>
    .left-column {
        width: 400px;
        /* Starting Width */
        min-width: 250px;
        /* Limit: Don't get smaller than this */
        max-width: 60%;
        /* Limit: Don't get bigger than 60% of screen */

        display: flex;
        flex-direction: column;
        flex-shrink: 0;
        /* CRITICAL: Prevents auto-shrinking */
        gap: 16px;
        padding: 16px;

        overflow-y: auto;
        /* Scroll inside this column */
        border-right: 1px solid #e5e7eb;
    }

    .resizer-gutter {
        width: 12px;
        background: #f1f5f9;
        cursor: col-resize;
        /* Cursor looks like <-> */
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
        /* Keep handle size fixed */
        z-index: 50;
        transition: background 0.2s;
    }

    .resizer-gutter:hover,
    .resizer-gutter.active {
        background: #3b82f6;
        /* Blue when hovering/dragging */
    }

    .resizer-icon {
        font-size: 10px;
        color: #9ca3af;
        user-select: none;
        /* Cannot select text inside */
        pointer-events: none;
    }

    .right-column {
        flex-grow: 1;
        /* Fill all remaining space */
        min-width: 0;
        /* CRITICAL: Allows flex children to shrink/scroll */

        display: flex;
        flex-direction: column;
        padding: 16px;

        overflow-y: auto;
        /* Scroll inside this column */
    }

    /* Helper to freeze selection while dragging */
    body.resizing {
        cursor: col-resize !important;
        user-select: none !important;
    }

    /* Add this inside your <style> tag */
    body.resizing iframe,
    body.resizing .preview-container {
        pointer-events: none;
        /* Mouse ignores map/pdf while dragging */
    }

    /* 1. Ensure inputs fill their container but don't overflow */
    .form-input,
    .form-select,
    .form-textarea {
        width: 100%;
        /* Force full width */
        max-width: 100%;
        /* Prevent overflowing parent */
        min-width: 0;
        /* Allow shrinking in flex containers */
        box-sizing: border-box;
        /* Include padding in width calculation */
    }

    /* 2. Ensure labels wrap text instead of pushing layout */
    .form-label {
        white-space: normal;
        /* Allow text wrapping */
        word-break: break-word;
        /* Break long words if necessary */
        display: block;
        /* Ensure it sits on its own line */
        max-width: 100%;
    }

    /* 3. Make the "Rented Duration" row stack on mobile */
    .duration-row {
        display: flex;
        gap: 15px;
        margin-bottom: 15px;
    }

    @media (max-width: 768px) {
        .feedback-layout {
            flex-direction: column;
            height: auto;
        }

        .resizer-gutter {
            display: none;
        }

        .left-column,
        .right-column {
            width: 100%;
            max-width: 100%;
            height: auto;
            overflow: visible;
        }

        .duration-row {
            flex-direction: column;
            gap: 10px;
        }

        /* Ensure the "Years/Months" labels sit correctly */
        .duration-input-group {
            width: 100%;
        }

        .form-row {
            grid-template-columns: 1fr !important;
            /* Force single column */
            gap: 12px;
        }
    }

    .right-column.fullscreen-active {
        position: fixed !important;
        top: 0 !important;
        left: 0 !important;
        width: 100vw !important;
        height: 100vh !important;

        /* SUPER HIGH Z-INDEX to cover Navbar (which is usually 1000) */
        z-index: 100 !important;

        background: #ffffff;
        overflow-y: auto !important;
        /* The DIV handles scrolling now */
        padding: 0 !important;
        margin: 0 !important;
    }

    /* Ensure the form inside scrolls properly when full screen */
    .right-column.fullscreen-active .form-section {
        height: 100%;
        display: flex;
        flex-direction: column;
        padding: 0;
        border: none;
        box-shadow: none;
    }

    /* Make the actual form scrollable, keeping the header fixed at top */
    .right-column.fullscreen-active .feedback-form {
        flex: 1;
        overflow-y: auto;
        padding: 0 20px 40px 20px;
        /* Add bottom padding for submit buttons */
    }

    .form-header {
        flex-shrink: 0;
        /* Never shrink */
        z-index: 10;
        background-color: #ffffff;
        border-bottom: 1px solid #e5e7eb;
        padding: 15px 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    }

    .right-column.fullscreen-active .form-header {
        margin: -20px -20px 20px -20px;
        padding: 15px 25px;
        background-color: #f8f9fa;
        border-radius: 0;
        z-index: 9999;
    }

    .feedback-form {
        flex-grow: 1;
        /* Take up all remaining space */
        overflow-y: auto;
        /* ENABLE SCROLLING here */
        padding: 20px;
        padding-bottom: 100px;
        /* Space for buttons */
    }

    .form-section {
        display: flex;
        flex-direction: column;
        height: 100%;
    }

    .feedback-layout {
        display: flex;
        /* Side-by-side layout */
        flex-direction: row;
        width: 100%;
        height: calc(100vh - 70px);
        /* Full height minus Navbar */
        overflow: hidden;
        /* Prevent page-wide scrollbars */
        background: #f8fafc;
    }
</style>
{% endblock %}

{% block content %}
<!-- Navigation Bar -->
<nav class="feedback-nav" style="height: 70px;">
    <div class="nav-content" style="display: flex; justify-content: space-between; align-items: center; height: 100%;">

        <div class="nav-left" style="width: 200px; flex-shrink: 0;"> <a href="{% url 'coreapi:dashboard' %}"
                class="nav-link back-link">
                <i class="fas fa-arrow-left"></i> Back to Dashboard
            </a>
        </div>

        <div class="nav-center"
            style="flex-grow: 1; display: flex; flex-direction: column; align-items: center; justify-content: center;">
            <h1 class="page-title" style="margin: 0; line-height: 1.2;">Site Feedback Form</h1>

            <div style="width: 250px; margin-top: 4px;">
                <div style="display: flex; justify-content: space-between; align-items: flex-end; margin-bottom: 2px;">
                    <span
                        style="font-size: 10px; color: #6b7280; font-weight: 600; text-transform: uppercase;">Completion</span>
                    <span id="progressText" style="font-size: 11px; font-weight: bold; color: #2563eb;">0%</span>
                </div>
                <div style="width: 100%; height: 4px; background: #e5e7eb; border-radius: 2px; overflow: hidden;">
                    <div id="progressBar"
                        style="width: 0%; height: 100%; background: #2563eb; transition: width 0.3s ease; border-radius: 2px;">
                    </div>
                </div>
            </div>
        </div>

        <div class="nav-right" style="width: 200px; flex-shrink: 0; display: flex; justify-content: flex-end;"> <span
                class="user-info">{{ request.session.user_name }}</span>
        </div>

    </div>
</nav>

<div id="orientationBlocker" class="orientation-blocker hidden">
    <div class="orientation-box">
        <h2>Rotate Device</h2>
        <p>This page works only in <b>landscape mode</b> on tablets.</p>
    </div>
</div>

<div class="relative">
    <!-- Loading overlay for Analyse action -->
    <div id="analyseLoading" class="loading-overlay hidden">
        <div class="spinner"></div>
        <div class="text-lg font-semibold">Analyzing — please wait...</div>
        <div class="text-sm">Processing your file...</div>
    </div>
    <div class="sticky top-[90px] z-40 bg-white border-b border-gray-200 px-4 py-3 mb-4 shadow-sm flex items-center">
        <div class="text-gray-500 mr-2 text-sm">
            <i class="fas fa-folder-open text-yellow-500"></i> Current Location:
        </div>
        <div id="topBannerPath" class="font-mono text-sm text-blue-700 font-semibold tracking-wide truncate">
            /
        </div>
    </div>
    <div class="feedback-layout" id="mainLayout">
        <!-- LEFT COLUMN: File List + Preview -->
        <div class="left-column" id="leftColumn">
            <section class="search-dashboard-section"
                style="padding: 10px; display: flex; flex-direction: column; gap: 12px; background: #fff;">
                <h3 class="section-title">Case Finder</h3>

                <div class="search-filters" style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px;">
                    <div class="form-group">
                        <label class="text-xs font-bold text-gray-500 uppercase">Bank</label>
                        <select id="bank_select" class="form-select search-trigger">
                            <option value="1000" data-name="HDFC">1000. HDFC</option>
                            <option value="2000" data-name="Muthoot">2000. Muthoot</option>
                            <option value="3000" data-name="Bajaj">3000. Bajaj</option>
                            <option value="4000" data-name="DCB">4000. DCB</option>
                            <option value="5000" data-name="PNBHFL">5000. PNBHFL</option>
                            <option value="6000" data-name="SBI">6000. SBI</option>
                            <option value="7000" data-name="CSB">7000. CSB</option>
                            <option value="8000" data-name="Chola">8000. Chola</option>
                            <option value="9000" data-name="SIB">9000. SIB</option>
                            <option value="10000" data-name="CHOLA SME">10000. CHOLA SME</option>
                            <option value="11000" data-name="ICICI">11000. ICICI</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="text-xs font-bold text-gray-500 uppercase">District</label>
                        <select id="district_select" class="form-select search-trigger">
                            <option value="01" data-name="TVM">KL01. TVM</option>
                            <option value="02" data-name="KLM">KL02. Kollam</option>
                            <option value="03" data-name="PTA">KL03. Pathanamthitta</option>
                            <option value="04" data-name="ALP">KL04. Alappuzha</option>
                            <option value="05" data-name="KTM">KL05. Kottayam</option>
                            <option value="06" data-name="IDK">KL06. Idukki</option>
                            <option value="07" data-name="EKM">KL07. Ernakulam</option>
                            <option value="08" data-name="TSR">KL08. Thrissur</option>
                            <option value="09" data-name="PKD">KL09. Palakkad</option>
                            <option value="10" data-name="MLP">KL10. Malappuram</option>
                            <option value="11" data-name="KKD">KL11. Kozhikode</option>
                            <option value="12" data-name="WYD">KL12. Wayanad</option>
                            <option value="13" data-name="KNR">KL13. Kannur</option>
                            <option value="14" data-name="KSD">KL14. Kasargod</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="text-xs font-bold text-gray-500 uppercase">Year</label>
                        <select id="year_select" class="form-select search-trigger">
                            <option value="25">2025</option>
                            <option value="26" selected>2026</option>
                        </select>
                    </div>
                </div>

                <div class="search-input-group" style="margin-top: 15px;">
                    <label class="text-xs font-bold text-gray-500 uppercase block mb-2">Search File No or Applicant
                        Name</label>
                    <div style="display: flex; align-items: center; gap: 8px; width: 100%;">
                        <input id="caseSearchInput" type="text" placeholder="Type ID (e.g. 23) or Name..."
                            class="form-input" style="flex-grow: 1; min-width: 150px; height: 40px; margin: 0;"
                            autocomplete="off">

                        <button id="searchCaseBtn" type="button"
                            style="margin: 0; height: 40px; flex-shrink: 0; padding: 0 20px; background: #2563eb; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; display: flex; align-items: center; gap: 8px;">
                            <i class="fas fa-search"></i> Search
                        </button>
                    </div>
                </div>
                <div class="file-list-container" style="flex: 1; border-top: 1px solid #eee; margin-top: 10px;">
                    <ul id="searchResultsList" class="file-list">
                        <li class="p-4 text-center text-gray-400 text-sm">Fill details to find a case</li>
                    </ul>
                </div>
            </section>

            <section class="preview-section">
                <div class="section-header">
                    <h3 class="section-title">Preview</h3>
                    <div class="preview-controls">
                        <button id="analyseBtn" class="analyse-btn">Analyse</button>
                        <button id="openFullBtn" class="control-btn">Open Full</button>
                    </div>
                </div>

                <div id="thumbs" class="thumbs-strip"></div>

                <div class="preview-container">
                    <div class="preview-header"
                        style="height: auto; min-height: 50px; padding: 10px; display: flex; justify-content: space-between; align-items: center; background: #f3f4f6; border-bottom: 1px solid #ddd;">
                        <div id="bigPreviewTitle" class="preview-title break-all whitespace-normal leading-tight"
                            style="flex: 1; padding-right: 10px; font-family: monospace; font-weight: 600; color: #374151;">
                            Home / Root
                        </div>
                        <button hidden id="downloadPdfBtn" class="download-btn hidden">
                            <i class="fas fa-file-download"></i>
                        </button>
                    </div>

                    <div id="bigViewer" class="relative h-full flex flex-col bg-gray-100" style="overflow: hidden;">

                        <div id="noSelection" class="flex items-center justify-center h-full text-gray-400">
                            Select a file to preview
                        </div>

                        <iframe id="nativePdfViewer" class="hidden w-full h-full border-none" src=""></iframe>
                        <div id="scrollContainer"
                            class="hidden flex-1 overflow-auto p-4 flex flex-col items-center gap-4 bg-gray-200/50">
                            <div id="scrollSentinel" class="w-full h-16 flex items-center justify-center text-gray-500">
                                <div
                                    class="spinner border-4 border-gray-400 border-t-blue-600 rounded-full w-6 h-6 animate-spin">
                                </div>
                            </div>
                        </div>

                        <div id="bigImageContainer"
                            class="hidden w-full h-full flex items-center justify-center overflow-hidden relative z-20">
                            <img id="bigImageFrame" class="max-w-full max-h-full object-contain" src="" alt="Preview" />
                        </div>

                    </div>
                </div>
            </section>
        </div>

        <div id="dragHandle" class="resizer-gutter">
            <div class="resizer-icon">||</div>
        </div>

        <!-- RIGHT COLUMN: Comprehensive Feedback Form -->
        <div class="right-column" id="rightColumnContainer">
            <div class="form-section">

                <div class="form-header" style="display: flex; justify-content: space-between; align-items: center;">
                    <h3 class="section-title">Site Feedback Form</h3>

                    <div style="display: flex; align-items: center; gap: 15px;">

                        <div id="sitePhotoUploadContainer" class="hidden" style="display: flex; align-items: center;">
                            <input type="file" id="sitePhotoInput" multiple accept="image/*" style="display: none;"
                                onchange="handleSitePhotoUpload(this)">

                            <button type="button" onclick="document.getElementById('sitePhotoInput').click()"
                                class="control-btn" title="Upload Site Photos to '/p' folder"
                                style="background: #e0f2fe; color: #0284c7; border: 1px solid #bae6fd; font-size: 0.9rem; cursor: pointer; padding: 6px 12px; border-radius: 6px; display: flex; align-items: center; gap: 6px;">
                                <i class="fas fa-camera"></i>
                                <span style="font-size: 12px; font-weight: 600;">Upload Photos</span>
                            </button>
                            <span id="uploadStatusText"
                                style="font-size: 10px; color: green; margin-left: 8px; font-weight: bold;"></span>
                        </div>

                        <button type="button" id="toggleFormFullscreenBtn" class="control-btn" title="Toggle Fullscreen"
                            style="background: transparent; position:sticky; border: none; color: #374151; font-size: 1.1rem; cursor: pointer; padding: 5px;">
                            <i class="fas fa-expand"></i>
                        </button>
                    </div>
                </div>

                <form id="siteFeedbackForm" class="feedback-form">

                    <!-- Valuers Checklist -->
                    <div class="form-section-group">
                        <h4 class="form-section-title">Site Inspection Report</h4>

                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">1. Office File No.</label>
                                <input type="text" data-path="Valuers_Checklist.Office_file_no" class="form-input"
                                    readonly style="background-color: #f3f4f6; font-weight: bold; cursor: not-allowed;">
                            </div>
                            <div class="form-group">
                                <label class="form-label">2. Applicant Name</label>
                                <input type="text" data-path="Valuers_Checklist.applicant_name" class="form-input"
                                    style="display: flex; flex-wrap: wrap;">
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">3. Inspection Date</label>
                                <input type="date" data-path="Valuers_Checklist.inspection_date" class="form-input">
                            </div>
                            <div class="form-group">
                                <label class="form-label">4. Name of the person met at site</label>
                                <input type="text" data-path="Valuers_Checklist.person_met" class="form-input">
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">5. Product</label>
                            <select data-path="Valuers_Checklist.product" class="form-select">
                                <option value="notselected">Select Product</option>
                                <option value="1st purchase">1st Purchase</option>
                                <option value="construction">Construction</option>
                                <option value="topup">Top Up</option>
                                <option value="pd">PD</option>
                                <option value="resale">Resale</option>
                                <option value="renovation">Renovation</option>
                                <option value="takeover">Takeover</option>
                                <option value="lap">LAP</option>
                                <option value="extension">Extension</option>
                                <option value="npa">NPA</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label class="form-label">6. Documents Received</label>
                            <div class="checkbox-grid">
                                <label class="checkbox-label"><input type="checkbox"
                                        data-array="Valuers_Checklist.documents_received" value="Agreement">
                                    Agreement</label>
                                <label class="checkbox-label"><input type="checkbox"
                                        data-array="Valuers_Checklist.documents_received" value="Encumbrance">
                                    Encumbrance</label>
                                <label class="checkbox-label"><input type="checkbox"
                                        data-array="Valuers_Checklist.documents_received" value="Building Permit">
                                    Building Permit</label>
                                <label class="checkbox-label"><input type="checkbox"
                                        data-array="Valuers_Checklist.documents_received" value="Declaration">
                                    Declaration</label>
                                <label class="checkbox-label"><input type="checkbox"
                                        data-array="Valuers_Checklist.documents_received" value="Location Sketch">
                                    Location Sketch</label>
                                <label class="checkbox-label"><input type="checkbox"
                                        data-array="Valuers_Checklist.documents_received" value="Development Permit">
                                    Development Permit</label>
                                <label class="checkbox-label"><input type="checkbox"
                                        data-array="Valuers_Checklist.documents_received" value="Title Deed"> Title
                                    Deed</label>
                                <label class="checkbox-label"><input type="checkbox"
                                        data-array="Valuers_Checklist.documents_received" value="Survey Sketch"> Survey
                                    Sketch</label>
                                <label class="checkbox-label"><input type="checkbox"
                                        data-array="Valuers_Checklist.documents_received" value="Building Certificate">
                                    Building Certificate</label>
                                <label class="checkbox-label"><input type="checkbox"
                                        data-array="Valuers_Checklist.documents_received" value="LTR"> LTR</label>
                                <label class="checkbox-label"><input type="checkbox"
                                        data-array="Valuers_Checklist.documents_received" value="Building Tax receipt">
                                    Building Tax Receipt</label>
                                <label class="checkbox-label"><input type="checkbox"
                                        data-array="Valuers_Checklist.documents_received" value="Approved plan">
                                    Approved Plan</label>
                                <label class="checkbox-label"><input type="checkbox"
                                        data-array="Valuers_Checklist.documents_received" value="Possession">
                                    Possession</label>
                                <label class="checkbox-label"><input type="checkbox"
                                        data-array="Valuers_Checklist.documents_received" value="Engineers plan">
                                    Engineers Plan</label>
                            </div>
                        </div>
                    </div>

                    <!-- I. Ownership Analysis -->
                    <div class="form-section-group">
                        <h4 class="form-section-title">I. Ownership Analysis</h4>

                        <div class="form-group">
                            <label class="form-label">1. Owner(s) Name</label>
                            <input type="text" data-path="Ownership_Analysis.owners_name" class="form-input">
                        </div>

                        <div class="form-group">
                            <label class="form-label">Document Verification</label>
                            <div class="checkbox-group">
                                <label class="checkbox-label">
                                    <input type="radio" name="doc_verification"
                                        data-path="Ownership_Analysis.document_verification"
                                        value="same in all documents" onchange="toggleOwnershipNotes()">
                                    Same in all documents
                                </label>

                                <label class="checkbox-label">
                                    <input type="radio" name="doc_verification"
                                        data-path="Ownership_Analysis.document_verification" value="discrepancy noted"
                                        onchange="toggleOwnershipNotes()">
                                    Discrepancy noted
                                </label>
                            </div>
                        </div>

                        <div id="ownershipNotesBox" class="form-group mt-3 hidden">
                            <label class="form-label">Notes on discrepancy</label>
                            <textarea data-path="Ownership_Analysis.Ownership_Analysis_notes" class="form-textarea"
                                rows="4" style="width: 100%;"></textarea>
                        </div>
                    </div>
                    <!-- II. Survey Number and Land Extend Analysis -->
                    <div class="form-section-group">
                        <h4 class="form-section-title">II. Survey Number and Land Extend Analysis</h4>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">District</label>
                                <select data-path="Survey.district" class="form-select" id="districtSelect">
                                    <option value="">Select District</option>
                                    <option value="Thiruvananthapuram">Thiruvananthapuram</option>
                                    <option value="Kollam">Kollam</option>
                                    <option value="Pathanamthitta">Pathanamthitta</option>
                                    <option value="Alappuzha">Alappuzha</option>
                                    <option value="Kottayam">Kottayam</option>
                                    <option value="Idukki">Idukki</option>
                                    <option value="Ernakulam">Ernakulam</option>
                                    <option value="Thrissur">Thrissur</option>
                                    <option value="Palakkad">Palakkad</option>
                                    <option value="Malappuram">Malappuram</option>
                                    <option value="Kozhikode">Kozhikode</option>
                                    <option value="Wayanad">Wayanad</option>
                                    <option value="Kannur">Kannur</option>
                                    <option value="Kasaragod">Kasaragod</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Taluk</label>
                                <input type="text" data-path="Survey.taluk" class="form-input"
                                    placeholder="Enter Taluk">
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Village</label>
                                <input type="text" data-path="Survey.village" class="form-input"
                                    placeholder="Enter Village">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Local Body Type</label>
                                <select data-path="Survey.local_body_type" class="form-select" id="localBodySelect"
                                    onchange="togglePanchayatField()">
                                    <option value="">Select Type</option>
                                    <option value="Municipal Corporation">Municipal Corporation</option>
                                    <option value="Corporation">Corporation</option>
                                    <option value="Municipality">Municipality</option>
                                    <option value="Grama Panchayat">Grama Panchayat</option>
                                </select>
                            </div>
                        </div>

                        <div class="form-group hidden" id="panchayatWrapper">
                            <label class="form-label">Grama Panchayat Name</label>
                            <input type="text" data-path="Survey.grama_panchayat" class="form-input"
                                id="panchayatSelect" placeholder="Enter Panchayat Name">
                        </div>
                        <div class="table-container" style="overflow-x: auto;">
                            <table class="analysis-table survey-table" id="surveyTable">
                                <thead>
                                    <tr id="surveyHeader">
                                        <th style="min-width: 150px; position: sticky; left: 0; z-index: 10;">Doc Name
                                        </th>
                                    </tr>
                                </thead>
                                <tbody id="surveyBody">
                                    <tr data-row-key="scedule_no">
                                        <td>Scedule No</td>
                                    </tr>
                                    <tr data-row-key="re_sy_block_no">
                                        <td>Re-Sy Block No</td>
                                    </tr>
                                    <tr data-row-key="re_sy_no">
                                        <td>Re-Sy No</td>
                                    </tr>
                                    <tr data-row-key="re_sy_subdiv_no">
                                        <td>Re-Sy Subdiv No</td>
                                    </tr>
                                    <tr data-row-key="sy_block_no">
                                        <td>Sy Block No</td>
                                    </tr>
                                    <tr data-row-key="sy_no">
                                        <td>Sy No</td>
                                    </tr>
                                    <tr data-row-key="sy_subdiv_no">
                                        <td>Sy Subdiv No</td>
                                    </tr>
                                    <tr data-row-key="land_extent">
                                        <td>Land Extent (Ares)</td>
                                    </tr>
                                    <tr data-row-key="land_classification">
                                        <td>Land Classification</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>

                        <button type="button" class="timeline-btn add-btn" onclick="addSurveyColumn()"
                            title="Add Column">
                            <i class="fas fa-plus"></i>
                        </button>


                        <div id="surveyTotalsContainer"
                            class="mt-4 mb-4 p-3 bg-blue-50 border border-blue-100 rounded-lg hidden">
                            <h5 class="font-bold text-sm text-blue-800 mb-2">Land Extent Total (Ares)</h5>

                            <div class="grid grid-cols-2 gap-4">
                                <div id="ltr_total_wrapper" class="form-group mb-0 hidden">
                                    <label class="text-xs font-semibold text-gray-500 uppercase">1. LTR Total</label>
                                    <input type="text" id="total_ltr_extent" data-path="Survey.total_ltr_extent"
                                        class="form-input font-bold text-gray-700 bg-white" readonly>
                                </div>

                                <div id="deed_total_wrapper" class="form-group mb-0 hidden">
                                    <label class="text-xs font-semibold text-gray-500 uppercase">2. Title Deed
                                        Total</label>
                                    <input type="text" id="total_deed_extent" data-path="Survey.total_deed_extent"
                                        class="form-input font-bold text-gray-700 bg-white" readonly>
                                </div>
                            </div>
                        </div>
                        <div id="wetLandQuestions"
                            class="mt-3 p-3 bg-orange-50 border border-orange-100 rounded-lg hidden">
                            <h5 class="font-bold text-sm text-orange-800 mb-2">Wet Land Verification (LTR)</h5>

                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div class="form-group mb-0">
                                    <label class="text-xs font-semibold text-gray-700">Are 3 sides Paddy land
                                        (Paadam)?</label>
                                    <div class="flex gap-4 mt-1">
                                        <label class="inline-flex items-center">
                                            <input type="radio" name="paddy_land_check"
                                                data-path="Survey.paddy_land_check" value="Yes"
                                                class="form-radio h-4 w-4 text-orange-600">
                                            <span class="ml-2 text-sm">Yes</span>
                                        </label>
                                        <label class="inline-flex items-center">
                                            <input type="radio" name="paddy_land_check"
                                                data-path="Survey.paddy_land_check" value="No"
                                                class="form-radio h-4 w-4 text-orange-600">
                                            <span class="ml-2 text-sm">No</span>
                                        </label>
                                    </div>
                                </div>

                                <div class="form-group mb-0">
                                    <label class="text-xs font-semibold text-gray-700">Are there trees/buildings
                                        existing before 2008?</label>
                                    <div class="flex gap-4 mt-1">
                                        <label class="inline-flex items-center">
                                            <input type="radio" name="trees_2008_check"
                                                data-path="Survey.trees_2008_check" value="Yes"
                                                class="form-radio h-4 w-4 text-orange-600">
                                            <span class="ml-2 text-sm">Yes</span>
                                        </label>
                                        <label class="inline-flex items-center">
                                            <input type="radio" name="trees_2008_check"
                                                data-path="Survey.trees_2008_check" value="No"
                                                class="form-radio h-4 w-4 text-orange-600">
                                            <span class="ml-2 text-sm">No</span>
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="form-group mt-4">
                            <label class="form-label">Deviations in Survey no, land extend, land Classification ... etc.
                                if any.</label>
                            <textarea data-path="Survey.survey_notes" class="form-textarea" rows="4"
                                style="width: 100%;"></textarea>
                        </div>


                    </div>
                    <!-- III. Boundary Analysis and Property Identification -->
                    <div class="form-section-group">
                        <h4 class="form-section-title">III. Boundary Analysis and Property Identification</h4>

                        <div class="table-container">
                            <table class="analysis-table">
                                <thead>
                                    <tr>
                                        <th style="width: 10%;">Direction</th>

                                        <th style="width: 25%;">
                                            <label class="text-xs font-bold block mb-1">Ref Doc 1</label>
                                            <select data-path="Boundary_analysis_property_identification.ref_doc_1_name"
                                                class="form-select dynamic-doc-dropdown"
                                                style="width: 100%; color: #000;">
                                                <option value="">Select Document</option>
                                            </select>
                                        </th>

                                        <th style="width: 25%;">
                                            <label class="text-xs font-bold block mb-1">Ref Doc 2</label>
                                            <select data-path="Boundary_analysis_property_identification.ref_doc_2_name"
                                                class="form-select dynamic-doc-dropdown"
                                                style="width: 100%; color:#000">
                                                <option value="">Select Document</option>
                                            </select>
                                        </th>

                                        <th style="width: 20%;">Translation Reason if any</th>

                                        <th style="width: 20%;">
                                            Site
                                            <div style="margin-top: 5px;">
                                                <label
                                                    style="font-size: 11px; font-weight: normal; color: white; display: flex; align-items: center; gap: 6px; cursor: pointer; background: rgba(255,255,255,0.2); padding: 2px 6px; border-radius: 4px;">
                                                    <input type="checkbox" onchange="copyAllDocsToSites(this)"
                                                        style="width: 12px; height: 12px;">
                                                    Same as in doc (All)
                                                </label>
                                            </div>
                                        </th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>East</td>
                                        <td><input type="text"
                                                data-path="Boundary_analysis_property_identification.east_doc1"
                                                class="table-input" placeholder="Val as per Doc 1"></td>
                                        <td><input type="text"
                                                data-path="Boundary_analysis_property_identification.east_doc2"
                                                class="table-input" placeholder="Val as per Doc 2"></td>
                                        <td><input type="text"
                                                data-path="Boundary_analysis_property_identification.east_translation"
                                                class="table-input"></td>
                                        <td><input type="text"
                                                data-path="Boundary_analysis_property_identification.east_site"
                                                class="table-input"></td>
                                    </tr>
                                    <tr>
                                        <td>North</td>
                                        <td><input type="text"
                                                data-path="Boundary_analysis_property_identification.north_doc1"
                                                class="table-input" placeholder="Val as per Doc 1"></td>
                                        <td><input type="text"
                                                data-path="Boundary_analysis_property_identification.north_doc2"
                                                class="table-input" placeholder="Val as per Doc 2"></td>
                                        <td><input type="text"
                                                data-path="Boundary_analysis_property_identification.north_translation"
                                                class="table-input"></td>
                                        <td><input type="text"
                                                data-path="Boundary_analysis_property_identification.north_site"
                                                class="table-input"></td>
                                    </tr>

                                    <tr>
                                        <td>West</td>
                                        <td><input type="text"
                                                data-path="Boundary_analysis_property_identification.west_doc1"
                                                class="table-input" placeholder="Val as per Doc 1"></td>
                                        <td><input type="text"
                                                data-path="Boundary_analysis_property_identification.west_doc2"
                                                class="table-input" placeholder="Val as per Doc 2"></td>
                                        <td><input type="text"
                                                data-path="Boundary_analysis_property_identification.west_translation"
                                                class="table-input"></td>
                                        <td><input type="text"
                                                data-path="Boundary_analysis_property_identification.west_site"
                                                class="table-input"></td>
                                    </tr>


                                    <tr>
                                        <td>South</td>
                                        <td><input type="text"
                                                data-path="Boundary_analysis_property_identification.south_doc1"
                                                class="table-input" placeholder="Val as per Doc 1"></td>
                                        <td><input type="text"
                                                data-path="Boundary_analysis_property_identification.south_doc2"
                                                class="table-input" placeholder="Val as per Doc 2"></td>
                                        <td><input type="text"
                                                data-path="Boundary_analysis_property_identification.south_translation"
                                                class="table-input"></td>
                                        <td><input type="text"
                                                data-path="Boundary_analysis_property_identification.south_site"
                                                class="table-input"></td>
                                    </tr>

                                </tbody>
                            </table>
                        </div>

                        <div class="form-group mt-3">
                            <label class="form-label">Deviations in boundary if any ?</label>
                            <textarea data-path="Boundary_analysis_property_identification.Boundary_property_notes"
                                class="form-textarea" rows="4"></textarea>
                        </div>


                    </div>
                    <!-- IV. Demarcations -->
                    <div class="form-section-group">
                        <h4 class="form-section-title">IV. Demarcations</h4>

                        <div class="table-container">
                            <table class="analysis-table">
                                <thead>
                                    <tr>
                                        <th>Direction</th>
                                        <th>Demarcation Type</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>North</td>
                                        <td class="checkbox-cell">
                                            <label class="checkbox-label-small"><input type="checkbox"
                                                    data-array="Demarcation.north" value="no demarcation"> No
                                                demarcation</label>
                                            <label class="checkbox-label-small"><input type="checkbox"
                                                    data-array="Demarcation.north" value="gi sheet fence"> GI sheet
                                                fence</label>
                                            <label class="checkbox-label-small"><input type="checkbox"
                                                    data-array="Demarcation.north" value="Foundation">
                                                Foundation</label>
                                            <label class="checkbox-label-small"><input type="checkbox"
                                                    data-array="Demarcation.north" value="barbed wire"> Barbed
                                                wire</label>
                                            <label class="checkbox-label-small"><input type="checkbox"
                                                    data-array="Demarcation.north" value="steel pegs"> Steel
                                                pegs</label>
                                            <label class="checkbox-label-small"><input type="checkbox"
                                                    data-array="Demarcation.north" value="compound wall"> Compound
                                                wall</label>
                                            <label class="checkbox-label-small"><input type="checkbox"
                                                    data-array="Demarcation.north" value="bio fence"> Bio fence</label>
                                            <label class="checkbox-label-small"><input type="checkbox"
                                                    data-array="Demarcation.north" value="survey stone"> Survey
                                                stone</label>
                                            <label class="checkbox-label-small"><input type="checkbox"
                                                    data-array="Demarcation.north" value="wooden pegs"> Wooden
                                                pegs</label>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td>East</td>
                                        <td class="checkbox-cell">
                                            <label class="checkbox-label-small"><input type="checkbox"
                                                    data-array="Demarcation.east" value="no demarcation"> No
                                                demarcation</label>
                                            <label class="checkbox-label-small"><input type="checkbox"
                                                    data-array="Demarcation.east" value="gi sheet fence"> GI sheet
                                                fence</label>
                                            <label class="checkbox-label-small"><input type="checkbox"
                                                    data-array="Demarcation.east" value="Foundation"> Foundation</label>
                                            <label class="checkbox-label-small"><input type="checkbox"
                                                    data-array="Demarcation.east" value="barbed wire"> Barbed
                                                wire</label>
                                            <label class="checkbox-label-small"><input type="checkbox"
                                                    data-array="Demarcation.east" value="steel pegs"> Steel pegs</label>
                                            <label class="checkbox-label-small"><input type="checkbox"
                                                    data-array="Demarcation.east" value="compound wall"> Compound
                                                wall</label>
                                            <label class="checkbox-label-small"><input type="checkbox"
                                                    data-array="Demarcation.east" value="bio fence"> Bio fence</label>
                                            <label class="checkbox-label-small"><input type="checkbox"
                                                    data-array="Demarcation.east" value="survey stone"> Survey
                                                stone</label>
                                            <label class="checkbox-label-small"><input type="checkbox"
                                                    data-array="Demarcation.east" value="wooden pegs"> Wooden
                                                pegs</label>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td>South</td>
                                        <td class="checkbox-cell">
                                            <label class="checkbox-label-small"><input type="checkbox"
                                                    data-array="Demarcation.south" value="no demarcation"> No
                                                demarcation</label>
                                            <label class="checkbox-label-small"><input type="checkbox"
                                                    data-array="Demarcation.south" value="gi sheet fence"> GI sheet
                                                fence</label>
                                            <label class="checkbox-label-small"><input type="checkbox"
                                                    data-array="Demarcation.south" value="Foundation">
                                                Foundation</label>
                                            <label class="checkbox-label-small"><input type="checkbox"
                                                    data-array="Demarcation.south" value="barbed wire"> Barbed
                                                wire</label>
                                            <label class="checkbox-label-small"><input type="checkbox"
                                                    data-array="Demarcation.south" value="steel pegs"> Steel
                                                pegs</label>
                                            <label class="checkbox-label-small"><input type="checkbox"
                                                    data-array="Demarcation.south" value="compound wall"> Compound
                                                wall</label>
                                            <label class="checkbox-label-small"><input type="checkbox"
                                                    data-array="Demarcation.south" value="bio fence"> Bio fence</label>
                                            <label class="checkbox-label-small"><input type="checkbox"
                                                    data-array="Demarcation.south" value="survey stone"> Survey
                                                stone</label>
                                            <label class="checkbox-label-small"><input type="checkbox"
                                                    data-array="Demarcation.south" value="wooden pegs"> Wooden
                                                pegs</label>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td>West</td>
                                        <td class="checkbox-cell">
                                            <label class="checkbox-label-small"><input type="checkbox"
                                                    data-array="Demarcation.west" value="no demarcation"> No
                                                demarcation</label>
                                            <label class="checkbox-label-small"><input type="checkbox"
                                                    data-array="Demarcation.west" value="gi sheet fence"> GI sheet
                                                fence</label>
                                            <label class="checkbox-label-small"><input type="checkbox"
                                                    data-array="Demarcation.west" value="Foundation"> Foundation</label>
                                            <label class="checkbox-label-small"><input type="checkbox"
                                                    data-array="Demarcation.west" value="barbed wire"> Barbed
                                                wire</label>
                                            <label class="checkbox-label-small"><input type="checkbox"
                                                    data-array="Demarcation.west" value="steel pegs"> Steel pegs</label>
                                            <label class="checkbox-label-small"><input type="checkbox"
                                                    data-array="Demarcation.west" value="compound wall"> Compound
                                                wall</label>
                                            <label class="checkbox-label-small"><input type="checkbox"
                                                    data-array="Demarcation.west" value="bio fence"> Bio fence</label>
                                            <label class="checkbox-label-small"><input type="checkbox"
                                                    data-array="Demarcation.west" value="survey stone"> Survey
                                                stone</label>
                                            <label class="checkbox-label-small"><input type="checkbox"
                                                    data-array="Demarcation.west" value="wooden pegs"> Wooden
                                                pegs</label>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Encroachment if any</label>
                            <div class="checkbox-group">
                                <label class="checkbox-label">
                                    <input type="radio" name="encroachment_check"
                                        data-path="Demarcation.encroachment_check" value="Yes"
                                        onchange="toggleEncroachmentFields()">
                                    Yes
                                </label>

                                <label class="checkbox-label">
                                    <input type="radio" name="encroachment_check"
                                        data-path="Demarcation.encroachment_check" value="No"
                                        onchange="toggleEncroachmentFields()">
                                    No
                                </label>
                            </div>
                        </div>

                        <div id="encroachmentDetails" class="hidden border-l-2 border-orange-200 pl-4 ml-1 mt-2">

                            <div class="form-group">
                                <label class="form-label">Notes if any</label>
                                <textarea data-path="Demarcation.demarcation_notes" class="form-textarea"
                                    rows="3"></textarea>
                            </div>

                            <div class="form-group">
                                <label class="form-label">Encroachment of subject building to neighbouring property, if
                                    any..?</label>
                                <textarea data-path="Demarcation.enroachment_subject_to_neighbour" class="form-textarea"
                                    rows="3"></textarea>
                            </div>

                            <div class="form-group">
                                <label class="form-label">Encroachment of neighbour's building to subject property, if
                                    any..?</label>
                                <textarea data-path="Demarcation.enroachment_neighbour_to_subject" class="form-textarea"
                                    rows="3"></textarea>
                            </div>

                        </div>

                        <!-- V. Access Nature/Right of Access -->
                        <div class="form-section-group">
                            <h4 class="form-section-title">V. Access Nature/Right of Access</h4>

                            <div class="table-container">
                                <table class="analysis-table access-table">
                                    <tbody>
                                        <tr>
                                            <td>1. Type of access as per title deed</td>
                                            <td class="checkbox-cell">
                                                <label class="checkbox-label-small"><input type="checkbox"
                                                        data-array="Access.typeofaccess_titledeed" value="footway">
                                                    Footway</label>
                                                <label class="checkbox-label-small"><input type="checkbox"
                                                        data-array="Access.typeofaccess_titledeed" value="panchayat rd">
                                                    Panchayat Rd</label>
                                                <label class="checkbox-label-small"><input type="checkbox"
                                                        data-array="Access.typeofaccess_titledeed"
                                                        value="corporation rd"> Corporation Rd</label>
                                                <label class="checkbox-label-small"><input type="checkbox"
                                                        data-array="Access.typeofaccess_titledeed"
                                                        value="national highway"> National Highway</label>
                                                <label class="checkbox-label-small"><input type="checkbox"
                                                        data-array="Access.typeofaccess_titledeed" value="private way">
                                                    Private Way</label>
                                                <label class="checkbox-label-small"><input type="checkbox"
                                                        data-array="Access.typeofaccess_titledeed" value="municipal rd">
                                                    Municipal Rd</label>
                                                <label class="checkbox-label-small"><input type="checkbox"
                                                        data-array="Access.typeofaccess_titledeed" value="pwd road"> PWD
                                                    Road</label>
                                                <label class="checkbox-label-small"><input type="checkbox"
                                                        data-array="Access.typeofaccess_titledeed" value="land locked">
                                                    Land Locked</label>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td>2. Type of access as per site visit</td>
                                            <td class="checkbox-cell">
                                                <label class="checkbox-label-small"><input type="checkbox"
                                                        data-array="Access.typeofaccess_sitevisit" value="footway">
                                                    Footway</label>
                                                <label class="checkbox-label-small"><input type="checkbox"
                                                        data-array="Access.typeofaccess_sitevisit" value="panchayat rd">
                                                    Panchayat Rd</label>
                                                <label class="checkbox-label-small"><input type="checkbox"
                                                        data-array="Access.typeofaccess_sitevisit"
                                                        value="corporation rd"> Corporation Rd</label>
                                                <label class="checkbox-label-small"><input type="checkbox"
                                                        data-array="Access.typeofaccess_sitevisit"
                                                        value="national highway"> National Highway</label>
                                                <label class="checkbox-label-small"><input type="checkbox"
                                                        data-array="Access.typeofaccess_sitevisit" value="private way">
                                                    Private Way</label>
                                                <label class="checkbox-label-small"><input type="checkbox"
                                                        data-array="Access.typeofaccess_sitevisit" value="municipal rd">
                                                    Municipal Rd</label>
                                                <label class="checkbox-label-small"><input type="checkbox"
                                                        data-array="Access.typeofaccess_sitevisit" value="pwd road"> PWD
                                                    Road</label>
                                                <label class="checkbox-label-small"><input type="checkbox"
                                                        data-array="Access.typeofaccess_sitevisit" value="land locked">
                                                    Land Locked</label>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td>3. If private way, no of users..?</td>
                                            <td class="checkbox-cell">
                                                <label class="checkbox-label-small"><input type="checkbox"
                                                        data-array="Access.private_no_user" value="self use"> Self
                                                    use</label>
                                                <label class="checkbox-label-small"><input type="checkbox"
                                                        data-array="Access.private_no_user" value="self & 1 user"> Self
                                                    & 1 user</label>
                                                <label class="checkbox-label-small"><input type="checkbox"
                                                        data-array="Access.private_no_user" value="self & 2 user"> Self
                                                    & 2 user</label>
                                                <label class="checkbox-label-small"><input type="checkbox"
                                                        data-array="Access.private_no_user" value="self + family"> Self
                                                    + family</label>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td>4. Demarcation of private road</td>
                                            <td class="checkbox-cell">
                                                <label class="checkbox-label-small"><input type="checkbox"
                                                        data-array="Access.private_rd_demarcation"
                                                        value="no demarcation"> No demarcation</label>
                                                <label class="checkbox-label-small"><input type="checkbox"
                                                        data-array="Access.private_rd_demarcation"
                                                        value="gi sheet fence"> GI sheet fence</label>
                                                <label class="checkbox-label-small"><input type="checkbox"
                                                        data-array="Access.private_rd_demarcation" value="barbed wire">
                                                    Barbed wire</label>
                                                <label class="checkbox-label-small"><input type="checkbox"
                                                        data-array="Access.private_rd_demarcation" value="steel pegs">
                                                    Steel pegs</label>
                                                <label class="checkbox-label-small"><input type="checkbox"
                                                        data-array="Access.private_rd_demarcation"
                                                        value="compound wall"> Compound wall</label>
                                                <label class="checkbox-label-small"><input type="checkbox"
                                                        data-array="Access.private_rd_demarcation" value="bio fence">
                                                    Bio fence</label>
                                                <label class="checkbox-label-small"><input type="checkbox"
                                                        data-array="Access.private_rd_demarcation" value="survey stone">
                                                    Survey stone</label>
                                                <label class="checkbox-label-small"><input type="checkbox"
                                                        data-array="Access.private_rd_demarcation" value="wooden pegs">
                                                    Wooden pegs</label>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td>5. Least width of main access in M</td>
                                            <td><input type="number" step="0.01" data-path="Access.main_access_width"
                                                    class="table-input"></td>
                                        </tr>
                                        <tr>
                                            <td>6. Vehicular access</td>
                                            <td class="checkbox-cell">
                                                <label class="checkbox-label-small"><input type="checkbox"
                                                        data-array="Access.vehicular_access" value="pedestrian">
                                                    Pedestrian</label>
                                                <label class="checkbox-label-small"><input type="checkbox"
                                                        data-array="Access.vehicular_access" value="2-wheeler">
                                                    2-wheeler</label>
                                                <label class="checkbox-label-small"><input type="checkbox"
                                                        data-array="Access.vehicular_access" value="3-wheeler">
                                                    3-wheeler</label>
                                                <label class="checkbox-label-small"><input type="checkbox"
                                                        data-array="Access.vehicular_access" value="4-wheeler">
                                                    4-wheeler</label>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td>7. Material of road</td>
                                            <td class="checkbox-cell">
                                                <label class="checkbox-label-small"><input type="checkbox"
                                                        data-array="Access.road_material" value="mud road"> Mud
                                                    road</label>
                                                <label class="checkbox-label-small"><input type="checkbox"
                                                        data-array="Access.road_material" value="gravel road"> Gravel
                                                    road</label>
                                                <label class="checkbox-label-small"><input type="checkbox"
                                                        data-array="Access.road_material" value="concrete road">
                                                    Concrete road</label>
                                                <label class="checkbox-label-small"><input type="checkbox"
                                                        data-array="Access.road_material" value="paving tile rd"> Paving
                                                    tile rd</label>
                                                <label class="checkbox-label-small"><input type="checkbox"
                                                        data-array="Access.road_material" value="tar road"> Tar
                                                    road</label>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td>8. Least width of internal roads,<br> in case of plot development</td>
                                            <td><input type="number" step="0.01" data-path="Access.internal_road_width"
                                                    class="table-input"></td>
                                        </tr>
                                        <tr>
                                            <td>9. Weather the internal rd. <br> abutting the subject plot has <br>
                                                connectivity to main access <br> as per deed..?</td>
                                            <td><input type="text" data-path="Access.internal_to_main_connectivity"
                                                    class="table-input h-20"></td>
                                        </tr>

                                    </tbody>
                                </table>
                            </div>

                            <div class="form-group">
                                <label class="form-label">Notes on Discrepancy if any...</label>
                                <textarea data-path="Access.access_notes" class="form-textarea" rows="4"></textarea>
                            </div>
                        </div>

                        <!-- VI. For Purchase and Resale cases -->
                        <div class="form-section-group">
                            <h4 class="form-section-title">VI. For Purchase and Resale cases</h4>

                            <div class="table-container">
                                <table class="analysis-table">
                                    <tbody>
                                        <tr>
                                            <td>1. Buyer name</td>
                                            <td><input type="text" data-path="Purchase_resale.buyer_name"
                                                    class="table-input"></td>
                                        </tr>
                                        <tr>
                                            <td>2. Seller name</td>
                                            <td><input type="text" data-path="Purchase_resale.seller_name"
                                                    class="table-input"></td>
                                        </tr>
                                        <tr>
                                            <td>3. Relation b/w buyer <br> and seller, if any</td>
                                            <td><input type="text" data-path="Purchase_resale.buyer_seller_relation"
                                                    class="table-input"></td>
                                        </tr>
                                        <tr>
                                            <td>4. Since how long the <br> property is up for sale..? (months)</td>
                                            <td><input type="number" data-path="Purchase_resale.property_sale_duration"
                                                    class="table-input"></td>
                                        </tr>
                                        <tr>
                                            <td>5. Brockers/OLX/99acers etc <br> involved or how transaction happened..?
                                            </td>
                                            <td><input type="text" data-path="Purchase_resale.transaction_method"
                                                    class="table-input"></td>
                                        </tr>
                                        <tr>
                                            <td>6. Land extend proposed <br> for purchase..?</td>
                                            <td><input type="text" data-path="Purchase_resale.purchase_land_extent"
                                                    class="table-input"></td>
                                        </tr>
                                        <tr>
                                            <td>7. Price asked</td>
                                            <td><input type="number" data-path="Purchase_resale.price_asked"
                                                    class="table-input"></td>
                                        </tr>
                                        <tr>
                                            <td>8. Deal breaker value</td>
                                            <td><input type="number" data-path="Purchase_resale.deal_breaker_value"
                                                    class="table-input"></td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>


                            <div class="form-group">
                                <label class="form-label">Notes</label>
                                <textarea data-path="Purchase_resale.purchase_resale_notes" class="form-textarea"
                                    rows="4"></textarea>
                            </div>
                        </div>

                        <!-- VII. Building Analysis -->
                        <div class="form-section-group">
                            <h4 class="form-section-title">VII. Building Analysis</h4>

                            <div class="mb-2 flex justify-end gap-2">
                                <button type="button"
                                    class="px-3 py-1 bg-green-100 text-green-700 rounded text-sm hover:bg-green-200"
                                    onclick="addApartment()">
                                    <i class="fas fa-plus mr-1"></i> Add Apartment
                                </button>

                                <button type="button"
                                    class="px-3 py-1 bg-blue-100 text-blue-700 rounded text-sm hover:bg-blue-200"
                                    onclick="addFloor('above')">
                                    <i class="fas fa-arrow-up mr-1"></i> Add Floor Above
                                </button>
                            </div>

                            <div class="table-container">
                                <table class="analysis-table">
                                    <thead>
                                        <tr>
                                            <th>Floor No / Unit</th>
                                            <th>Builtup Area (measured at site)</th>
                                            <th>No. of Rooms</th>
                                            <th>No. of Kitchen</th>
                                            <th>No. of Bathrooms</th>
                                            <th>Usage (Residential/Commercial/Industrial)</th>
                                            <th>Occupancy (Owner/Applicant/Rented/Vacant)</th>
                                            <th style="width: 10px;"></th>
                                        </tr>
                                    </thead>
                                    <tbody id="buildingTableBody"></tbody>
                                </table>
                            </div>

                            <div class="mt-2 flex justify-end">
                                <button type="button"
                                    class="px-3 py-1 bg-blue-100 text-blue-700 rounded text-sm hover:bg-blue-200"
                                    onclick="addFloor('below')">
                                    <i class="fas fa-arrow-down mr-1"></i> Add Floor Below
                                </button>
                            </div>
                            <label class="form-label" style="font-size: 15px; font-weight: bolder;">Details if
                                Rented</label> <br> <br>

                            <label class="form-label">Rented Amount&nbsp;&nbsp;</label>
                            <input type="text" data-path="Building_analysis.rent_amt" class="form-input"> <br>

                            <label class="form-label">Rented Duration</label>
                            <input type="hidden" id="rent_duration_master" data-path="Building_analysis.rent_duration">

                            <div class="duration-row">
                                <div class="duration-input-group" style="flex: 1;">
                                    <input type="number" id="rent_years" class="form-input" placeholder="0" min="0"
                                        oninput="handleRentDurationChange()">
                                    <label style="font-size: 11px; color: gray;">Years</label>
                                </div>
                                <div class="duration-input-group" style="flex: 1;">
                                    <input type="number" id="rent_months" class="form-input" placeholder="0" min="0"
                                        max="11" oninput="handleRentDurationChange()">
                                    <label style="font-size: 11px; color: gray;">Months</label>
                                </div>
                            </div>
                            <label class="form-label" style="font-size: 15px; font-weight: bolder;">Building
                                Details</label> <br> <br>

                            <label class="form-label">Building No</label>
                            <input type="text" data-path="Boundary_analysis.Building_no" class="form-input"> <br>

                            <label class="form-label">Ward no&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</label>
                            <input type="text" data-path="Boundary_analysis.Ward" class="form-input">


                            <div class="form-group mt-3">
                                <label class="form-label">Notes(Discrepancy respect to BUA, occupancy, alignment,
                                    orientation etc...)</label>
                                <textarea data-path="Building_analysis.building_analysis_notes" class="form-textarea"
                                    rows="4"></textarea>
                            </div>
                        </div>
                        <!-- Roof Type Table -->
                        <div class="table-container">
                            <table class="analysis-table">
                                <thead>
                                    <tr>
                                        <th>Roof Type</th>
                                        <th> <label class="checkbox-label-small"><input type="checkbox"
                                                    data-array="Building_analysis.roof_type" value="RCC"> RCC</label>
                                        </th>
                                        <th> <label class="checkbox-label-small"><input type="checkbox"
                                                    data-array="Building_analysis.roof_type" value="Tiled">Tiled</label>
                                        </th>
                                        <th> <label class="checkbox-label-small"><input type="checkbox"
                                                    data-array="Building_analysis.roof_type" value="Sheet">
                                                Sheet</label>
                                        </th>
                                        <th> <label class="checkbox-label-small"><input type="checkbox"
                                                    data-array="Building_analysis.roof_type" value="Other">
                                                Other</label>
                                        </th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>Roof Percentage</td>
                                        <td><input type="number" data-path="Building_analysis.RCC_Percentage"
                                                step="0.01" class="table-input" placeholder="%"></td>
                                        <td><input type="number" data-path="Building_analysis.Tiled_Percentage"
                                                step="0.01" class="table-input" placeholder="%"></td>
                                        <td><input type="number" data-path="Building_analysis.Sheet_Percentage"
                                                step="0.01" class="table-input" placeholder="%"></td>
                                        <td><input type="number" data-path="Building_analysis.Other_Percentage"
                                                step="0.01" class="table-input" placeholder="%"></td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>

                        <!-- Setback Table -->
                        <div class="table-container">
                            <table class="analysis-table">
                                <thead>
                                    <tr>
                                        <!-- Single column -->
                                        <th rowspan="2">Setback (m)</th>

                                        <!-- Yard headers -->
                                        <th colspan="2">Front Yard</th>
                                        <th colspan="2">Side-1 Yard</th>
                                        <th colspan="2">Side-2 Yard</th>
                                        <th colspan="2">Rear Yard</th>
                                    </tr>
                                    <tr>
                                        <!-- Sub headers -->
                                        <th style="z-index: auto;">Min</th>
                                        <th>Max</th>

                                        <th>Min</th>
                                        <th>Max</th>

                                        <th>Min</th>
                                        <th>Max</th>

                                        <th>Min</th>
                                        <th>Max</th>
                                    </tr>
                                </thead>

                                <tbody>
                                    <tr>
                                        <!-- SINGLE setback input -->
                                        <td>
                                            <input type="number" data-path="Building_analysis.setback" step="0.01"
                                                class="table-input" placeholder="Setback" />
                                        </td>

                                        <!-- Front yard -->
                                        <td><input type="number" data-path="Building_analysis.front_yard_min"
                                                step="0.01" class="table-input" /></td>
                                        <td><input type="number" data-path="Building_analysis.front_yard_max"
                                                step="0.01" class="table-input" /></td>

                                        <!-- Side-1 -->
                                        <td><input type="number" data-path="Building_analysis.side1_yard_min"
                                                step="0.01" class="table-input" /></td>
                                        <td><input type="number" data-path="Building_analysis.side1_yard_max"
                                                step="0.01" class="table-input" /></td>

                                        <!-- Side-2 -->
                                        <td><input type="number" data-path="Building_analysis.side2_yard_min"
                                                step="0.01" class="table-input" /></td>
                                        <td><input type="number" data-path="Building_analysis.side2_yard_max"
                                                step="0.01" class="table-input" /></td>

                                        <!-- Rear -->
                                        <td><input type="number" data-path="Building_analysis.rear_yard_min" step="0.01"
                                                class="table-input" /></td>
                                        <td><input type="number" data-path="Building_analysis.rear_yard_max" step="0.01"
                                                class="table-input" /></td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>

                        <!-- Construction Timeline Table -->
                        <div class="form-group">
                            <label class="form-label">Year of Construction</label>
                            <div class="table-container">
                                <table class="analysis-table" id="timelineTable"
                                    style="table-layout: fixed; width: 100%;">
                                    <tbody>
                                        <tr id="row_year">
                                            <td style="width: 100px; background: #f0f0f0; font-weight: bold;">Year</td>

                                            <td rowspan="2" id="controlCell"
                                                style="width: 40px; text-align: center; vertical-align: middle; background: #e8f0fe; border-left: 2px solid #ccc;">
                                                <div
                                                    style="display: flex; flex-direction: column; gap: 5px; align-items: center;">
                                                    <button type="button" class="timeline-btn add-btn"
                                                        onclick="manualAddColumn()" title="Add Column">
                                                        <i class="fas fa-plus"></i>
                                                    </button>
                                                    <button type="button" class="timeline-btn remove-btn"
                                                        onclick="removeLastColumn()" title="Remove Last">
                                                        <i class="fas fa-minus"></i>
                                                    </button>
                                                </div>
                                            </td>
                                        </tr>

                                        <tr id="row_percent">
                                            <td style="width: 100px; background: #f0f0f0; font-weight: bold;">% Area
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            <input type="hidden" data-path="Building_analysis.construction_year"
                                id="finalConstructionString">
                        </div>

                        <div class="form-group">
                            <label class="form-label">Notes on number of carparks, wardrobes, kitchen cabinets, flooring
                                material, interior decorations or any other amenities...</label>
                            <textarea data-path="Building_analysis.amenities_notes" class="form-textarea"
                                rows="4"></textarea>
                        </div>

                        <div class="form-section-group">
                            <h4 class="form-section-title">IX. Land Inspection Details</h4>
                            <table class="analysis-table" id="land_inspection_table"
                                style="table-layout: fixed; width: 100%;">
                                <tr>
                                    <td>
                                        <label class="form-label">Nearest City (KM) &nbsp;&nbsp;</label>
                                    </td>
                                    <td>
                                        <input type="text" class="table-input"
                                            data-path="land_inspection_details.nearest_city">
                                    </td>
                                </tr>
                                <tr>
                                    <td>
                                        <label class="form-label">Nearest Highway &nbsp;&nbsp;</label>
                                    </td>
                                    <td>
                                        <input type="text" class="table-input"
                                            data-path="land_inspection_details.nearest_Highway">
                                    </td>
                                </tr>
                                <tr>
                                    <td>
                                        <label class="form-label">Nearest School &nbsp;&nbsp;</label>
                                    </td>
                                    <td>
                                        <input type="text" class="table-input"
                                            data-path="land_inspection_details.nearest_school">
                                    </td>
                                </tr>
                                <tr>
                                    <td>
                                        <label class="form-label">Nearest Railway &nbsp;&nbsp;</label>
                                    </td>
                                    <td>
                                        <input type="text" class="table-input"
                                            data-path="land_inspection_details.nearest_railway">
                                    </td>
                                </tr>
                                <tr>
                                    <td>
                                        <label class="form-label">Nearest Bus stop &nbsp;&nbsp;</label>
                                    </td>
                                    <td>
                                        <input type="text" class="table-input"
                                            data-path="land_inspection_details.nearest_busstop">
                                    </td>
                                </tr>
                                <tr>
                                    <td>
                                        <label class="form-label">Nearest Hospital &nbsp;&nbsp;</label>
                                    </td>
                                    <td>
                                        <input type="text" class="table-input"
                                            data-path="land_inspection_details.nearest_hospital">
                                    </td>
                                </tr>
                                <tr>
                                    <td>
                                        <div class="form-group">
                                            <label class="form-label">CRZ</label>
                                    </td>
                                    <td>
                                        <input type="radio" name="crz" data-path="land_inspection_details.crz"
                                            value="Yes"> Yes
                                        <input type="radio" name="crz" data-path="land_inspection_details.crz"
                                            value="No"> No
                                    </td>
                                </tr>
                                <tr>
                                    <td>
                                        <div class="form-group">
                                            <label class="form-label">Crematoriums</label>
                                    </td>
                                    <td>
                                        <input type="radio" name="Crematoriums"
                                            data-path="land_inspection_details.crematoriums" value="Yes"> Yes
                                        <input type="radio" name="Crematoriums"
                                            data-path="land_inspection_details.crematoriums" value="No"> No
                                    </td>
                                </tr>
                                <tr>
                                    <td>
                                        <div class="form-group">
                                            <label class="form-label">Stigma</label>
                                    </td>
                                    <td>
                                        <input type="radio" name="stigma" data-path="land_inspection_details.stigma"
                                            value="Yes"> Yes
                                        <input type="radio" name="stigma" data-path="land_inspection_details.stigma"
                                            value="No"> No
                                    </td>
                                </tr>
                                <tr>
                                    <td>
                                        <div class="form-group">
                                            <label class="form-label">Slums</label>
                                    </td>
                                    <td>
                                        <input type="radio" name="slums" data-path="land_inspection_details.slums"
                                            value="Yes"> Yes
                                        <input type="radio" name="slums" data-path="land_inspection_details.slums"
                                            value="No"> No
                                    </td>
                                </tr>
                                <tr>
                                    <td>
                                        <div class="form-group">
                                            <label class="form-label">Communial Area</label>
                                    </td>
                                    <td>
                                        <input type="radio" name="Comm"
                                            data-path="land_inspection_details.communial_area" value="Yes"> Yes
                                        <input type="radio" name="Comm"
                                            data-path="land_inspection_details.communial_area" value="No"> No
                                    </td>
                                </tr>
                                <tr>
                                    <td>
                                        <div class="form-group">
                                            <label class="form-label">Factory Abutting</label>
                                    </td>
                                    <td>
                                        <input type="radio" name="factory"
                                            data-path="land_inspection_details.factory_abutting" value="Yes"> Yes
                                        <input type="radio" name="factory"
                                            data-path="land_inspection_details.factory_abutting" value="No"> No
                                    </td>
                                </tr>
                                <tr>
                                    <td>
                                        <div class="form-group">
                                            <label class="form-label">Defence Area</label>
                                    </td>
                                    <td>
                                        <input type="radio" name="Defence"
                                            data-path="land_inspection_details.defence_area" value="Yes"> Yes
                                        <input type="radio" name="Defence"
                                            data-path="land_inspection_details.defence_area" value="No"> No
                                    </td>
                                </tr>
                                <tr>
                                    <td>
                                        <div class="form-group">
                                            <label class="form-label">Heritage Property</label>
                                    </td>
                                    <td>
                                        <input type="radio" name="heritage"
                                            data-path="land_inspection_details.heritage_property" value="Yes"> Yes
                                        <input type="radio" name="heritage"
                                            data-path="land_inspection_details.heritage_property" value="No"> No
                                    </td>
                                </tr>
                                <tr>
                                    <td>
                                        <div class="form-group">
                                            <label class="form-label">Rubber Plantations</label>
                                    </td>
                                    <td>
                                        <input type="radio" name="plantations"
                                            data-path="land_inspection_details.rubber_plantations" value="Yes"> Yes
                                        <input type="radio" name="plantations"
                                            data-path="land_inspection_details.rubber_plantations" value="No"> No
                                    </td>
                                </tr>
                                <tr>
                                    <td>
                                        <div class="form-group">
                                            <label class="form-label">Coconut Thope</label>
                                    </td>
                                    <td>
                                        <input type="radio" name="coconut"
                                            data-path="land_inspection_details.coconut_thope" value="Yes"> Yes
                                        <input type="radio" name="coconut"
                                            data-path="land_inspection_details.coconut_thope" value="No"> No
                                    </td>
                                </tr>
                                <tr>
                                    <td>
                                        <div class="form-group">
                                            <label class="form-label">Buffer Zone</label>
                                    </td>
                                    <td>
                                        <input type="radio" name="buffer"
                                            data-path="land_inspection_details.buffer_zone" value="Yes"> Yes
                                        <input type="radio" name="buffer"
                                            data-path="land_inspection_details.buffer_zone" value="No"> No
                                    </td>
                                </tr>
                                <tr>
                                    <td>
                                        <div class="form-group">
                                            <label class="form-label">Telecommunication Tower</label>
                                    </td>
                                    <td>
                                        <input type="radio" name="tele"
                                            data-path="land_inspection_details.telecommunication_tower" value="Yes"> Yes
                                        <input type="radio" name="tele"
                                            data-path="land_inspection_details.telecommunication_tower" value="No"> No
                                    </td>
                                </tr>
                                <tr>
                                    <td>
                                        <div class="form-group">
                                            <label class="form-label">High Tension Wire/Electrical Line</label>
                                    </td>
                                    <td>
                                        <input type="radio" name="high_tens"
                                            data-path="land_inspection_details.high_tension_wire_electrical_line"
                                            value="Yes"> Yes
                                        <input type="radio" name="high_tens"
                                            data-path="land_inspection_details.high_tension_wire_electrical_line"
                                            value="No"> No
                                    </td>
                                </tr>
                                <tr>
                                    <td>
                                        <div class="form-group">
                                            <label class="form-label">Enroachment of subject <br> building to other
                                                prop</label>
                                    </td>
                                    <td>
                                        <input type="radio" name="enroachment"
                                            data-path="land_inspection_details.enroachment_subject_to_prop" value="Yes">
                                        Yes
                                        <input type="radio" name="enroachment"
                                            data-path="land_inspection_details.enroachment_subject_to_prop" value="No">
                                        No
                                    </td>
                                </tr>
                                <tr>
                                    <td>
                                        <div class="form-group">
                                            <label class="form-label">Intrusion of other buildings <br> to the subject
                                                prop</label>
                                    </td>
                                    <td>
                                        <input type="radio" name="intrusion"
                                            data-path="land_inspection_details.intrusion_other_to_subject" value="Yes">
                                        Yes
                                        <input type="radio" name="intrusion"
                                            data-path="land_inspection_details.intrusion_other_to_subject" value="No">
                                        No
                                    </td>
                                </tr>
                                <tr>
                                    <td>
                                        <div class="form-group">
                                            <label class="form-label">Railway Line passing <br> through property</label>
                                        </div>
                                    </td>
                                    <td>
                                        <div style="display: flex; gap: 15px;">
                                            <label style="display: flex; align-items: center; gap: 5px;">
                                                <input type="radio" name="railway"
                                                    data-path="land_inspection_details.railway_pass" value="Yes"
                                                    onchange="toggleRailwayDistance()">
                                                Yes
                                            </label>
                                            <label style="display: flex; align-items: center; gap: 5px;">
                                                <input type="radio" name="railway"
                                                    data-path="land_inspection_details.railway_pass" value="No"
                                                    onchange="toggleRailwayDistance()">
                                                No
                                            </label>
                                        </div>
                                    </td>
                                </tr>

                                <tr id="railwayDistanceRow" class="hidden">
                                    <td>
                                        <label class="form-label" style="color: #c2410c;">Railway Line Distance
                                            (m)</label>
                                    </td>
                                    <td>
                                        <input type="text" class="table-input"
                                            data-path="land_inspection_details.railway_distance" style="height: 50px;"
                                            placeholder="Enter distance...">
                                    </td>
                                </tr>
                                <tr>
                                    <td>
                                        <div class="form-group">
                                            <label class="form-label">Sarpakkavu, Small-Temple, <br> Church, Mosque <br>
                                                in the property</label>
                                    </td>
                                    <td>
                                        <input type="radio" name="sarppam"
                                            data-path="land_inspection_details.STCM_in_property" value="Yes"> Yes
                                        <input type="radio" name="sarppam"
                                            data-path="land_inspection_details.STCM_in_property" value="No"> No
                                    </td>
                                </tr>
                            </table>



                            <div class="form-group">
                                <label class="form-label">Inspection Notes</label>
                                <textarea data-path="land_inspection_details.inspection_notes" class="form-textarea"
                                    rows="3"></textarea>
                            </div>


                            <!-- VIII. Landmark and Layout (Handsketch) -->
                            <div class="form-section-group">
                                <h4 class="form-section-title">VIII. Landmark and Layout (Handsketch)</h4>

                                <div class="form-group">
                                    <label class="form-label">Landmark Description</label>
                                    <textarea data-path="Sketch.landmark_description" class="form-textarea"
                                        rows="3"></textarea>
                                </div>

                                <div class="form-group mt-4">
                                    <label class="form-label font-bold" style="font-size: 14px;">📍 Property Location
                                        (Pinpoint)</label>

                                    <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                                        <div style="flex: 1;">
                                            <label class="text-xs text-gray-500">Latitude</label>
                                            <input type="text" id="input_lat"
                                                data-path="land_inspection_details.latitude"
                                                class="table-input bg-gray-50" readonly>
                                        </div>
                                        <div style="flex: 1;">
                                            <label class="text-xs text-gray-500">Longitude</label>
                                            <input type="text" id="input_lng"
                                                data-path="land_inspection_details.longitude"
                                                class="table-input bg-gray-50" readonly>
                                        </div>
                                        <button type="button" onclick="getCurrentLocation()" class="modal-btn success"
                                            style="width: auto; padding: 0 15px;">
                                            <i class="fas fa-crosshairs"></i> Use My GPS
                                        </button>
                                    </div>

                                    <div
                                        style="height: 400px; border: 2px solid #ccc; border-radius: 8px; overflow: hidden;">
                                        <div id="googleMap" style="width: 100%; height: 100%;"></div>
                                    </div>
                                    <div class="text-xs text-gray-500 mt-1">* Drag marker to pinpoint subject property.
                                    </div>
                                </div>
                                <div class="form-group mt-4">
                                    <label class="form-label font-bold">Site Layout Sketch</label>

                                    <div style="display: flex; gap: 10px; margin-bottom: 10px;">

                                        <button type="button" class="modal-btn primary"
                                            style="flex: 1; margin-bottom: 0;"
                                            onclick="openSketchPad('Sketch.main_layout')">
                                            <i class="fas fa-drafting-compass mr-2"></i> Open Pad
                                        </button>

                                        <button type="button" class="modal-btn success"
                                            style="flex: 1; margin-bottom: 0; background-color: #10b981; border-color: #10b981;"
                                            onclick="document.getElementById('mainLayoutUpload').click()">
                                            <i class="fas fa-camera mr-2"></i> Upload Photo
                                        </button>

                                        <input type="file" id="mainLayoutUpload" class="hidden" accept="image/*"
                                            onchange="if(this.files[0]) handleImageUpload('Sketch.main_layout', this.files[0])">
                                    </div>

                                    <div class="main-sketch-preview"
                                        style="position: relative; border: 2px dashed #ccc; min-height: 300px; display: flex; align-items: center; justify-content: center; background: #f9fafb; border-radius: 8px; overflow: hidden;">

                                        <div class="main-sketch-preview"
                                            style="position: relative; border: 2px dashed #ccc; min-height: 300px; display: flex; align-items: center; justify-content: center; background: #f9fafb;">
                                            <img id="img_preview_Sketch_main_layout" class="hidden"
                                                style="width: 100%; max-height: 100%; z-index: 1;">

                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="form-group">
                                <label class="form-label">Overall Remarks (Comments on land extend, sold value, sold
                                    date etc... comparing with the subject property)</label>
                                <textarea data-path="Building_analysis.extra_remarks" class="form-textarea"
                                    rows="4"></textarea>
                            </div>
                            <div class="form-group mt-4">
                                <label class="form-label font-bold" style="color: #374151;">Reference Map for
                                    Valuation</label>
                                <div
                                    style="height: 500px; border: 2px solid #ccc; border-radius: 8px; overflow: hidden; background: #f9fafb;">

                                    <iframe
                                        src="https://www.google.com/maps/d/embed?mid=15OuH_GkSrkwCsOjfWzmnvMcVciD445M&ehbc=2E312F"
                                        width="100%" height="100%" style="border:0;" allowfullscreen="" loading="lazy"
                                        referrerpolicy="no-referrer-when-downgrade">
                                    </iframe>

                                </div>
                                <div class="text-xs text-gray-500 mt-1">* Use this map to check comparable land values
                                    in the area.</div>
                            </div>
                            <div class="form-group">
                                <label class="form-label" style="font-size: large;">Recommented Land Value</label>
                                <input type="text" class="form-input" data-path="land_inspection_details.land_value">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Notes on Land Value References Received</label>
                                <textarea data-path="Building_analysis.val_references" class="form-textarea"
                                    rows="4"></textarea>
                            </div>
                            <div class="form-group mt-4" style="gap: 10px;">
                                <button type="button" id="triggerSubmitBtn" class="submit-btn" style="width: 100%;">
                                    Submit Feedback
                                </button>

                                <button type="button" id="triggerResetBtn"
                                    style="background: #ef4444; color: white; padding: 12px; border-radius: 8px; border:none; width: 100%; cursor: pointer; font-weight: 600;">
                                    ⚠️ Reset Form Data
                                </button>
                            </div>
                </form>

            </div>
        </div>
    </div>
</div>

<!-- All modals remain the same -->
<div id="fullscreenModal" class="fixed inset-0 z-50 hidden items-center justify-center bg-black bg-opacity-90"
    aria-hidden="true">
    <div class="modal-box">
        <div class="modal-header">
            <div id="modalTitle" class="modal-title">Preview</div>
            <div class="modal-controls">
                <div id="shareButtonsContainer" class="share-buttons hidden">
                    <a href="#" id="shareWhatsapp" class="share-btn">
                        <i class="fab fa-whatsapp mr-2"></i>WhatsApp
                    </a>
                    <a href="#" id="shareTelegram" class="share-btn">
                        <i class="fab fa-telegram mr-2"></i>Telegram
                    </a>
                    <a href="#" id="shareEmail" class="share-btn">
                        <i class="fas fa-envelope mr-2"></i>Email
                    </a>
                    <a href="#" id="shareCopy" class="share-btn">
                        <i class="fas fa-link mr-2"></i>Copy Link
                    </a>
                </div>
                <a id="modalShare" href="#" class="share-btn">
                    <i class="fas fa-share-alt mr-2"></i>Share
                </a>
                <button id="modalDownloadBtn" class="download-btn">
                    <i class="fas fa-file-download mr-2"></i>Download
                </button>
                <button id="modalClose" class="control-btn">Close</button>
            </div>
        </div>
        <div id="modalBody" class="modal-body"
            style="overflow: hidden; display: flex; justify-content: center; background: #f0f0f0;">
            <iframe id="modalFrame" class="hidden" src="" style="width: 100%; height: 100%; border: none;"></iframe>

            <img id="modalImage" class="hidden" src="" alt="preview"
                style="max-width: 100%; max-height: 100%; object-fit: contain;" />

            <div id="modalPdfContainer" class="hidden pdf-scroll-container"
                style="width: 100%; height: 100%; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; align-items: center;">
            </div>
        </div>
    </div>
</div>

<div id="analyseModal" class="modal hidden">
    <div class="modal-content">
        <h2 class="modal-title">Analyse Files</h2>
        <p class="modal-text">Choose files for analysis</p>
        <button id="analyseSelectFiles" class="modal-btn primary">Select Files</button>
        <button id="analyseSelectAll" class="modal-btn success">Select All Files</button>
        <button id="analyseClose" class="modal-btn">Cancel</button>
    </div>
</div>

<div id="fileSelectModal" class="modal hidden">
    <div class="modal-content">
        <h2 class="modal-title">Select Files</h2>
        <div id="fileSelectList" class="file-select-list"></div>
        <button id="confirmFileSelection" class="modal-btn primary">Confirm Selection</button>
        <button id="fileSelectClose" class="modal-btn">Cancel</button>
    </div>
</div>

<!-- folderchat  -->


<div id="folderChatModal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-[60]"
    style="display: none; justify-content: center; align-items: center;">
    <div class="bg-white rounded-lg w-[500px] h-[500px] flex flex-col shadow-2xl"
        style="width: 500px; height: 500px; background: white; display: flex; flex-direction: column; border-radius: 8px;">
        <div class="p-4 border-b flex justify-between items-center bg-blue-600 text-white rounded-t-lg"
            style="padding: 15px; background: #2563eb; color: white; display: flex; justify-content: space-between;">
            <h3 class="font-bold break-all whitespace-normal pr-4 text-sm leading-tight" id="folderChatTitle">Case Chat
            </h3>
            <button onclick="closeFolderChat()" class="hover:text-gray-200"
                style="background: none; border: none; color: white; cursor: pointer; font-size: 1.2rem;">&times;</button>
        </div>

        <div id="folderChatMessages" class="flex-1 overflow-y-auto p-4 space-y-3 bg-gray-50"
            style="flex: 1; overflow-y: auto; padding: 15px; background: #f9fafb; display: flex; flex-direction: column; gap: 10px;">
        </div>

        <form id="folderChatForm" class="p-3 border-t bg-white flex gap-2"
            style="padding: 10px; border-top: 1px solid #eee; display: flex; gap: 10px;">
            <input type="text" id="folderChatInput" class="flex-1 border rounded-full px-4 py-2 focus:outline-none"
                style="flex: 1; padding: 8px 15px; border-radius: 20px; border: 1px solid #ddd;"
                placeholder="Type a note..." autocomplete="off">
            <button type="submit"
                class="bg-blue-600 text-white rounded-full w-10 h-10 hover:bg-blue-700 flex items-center justify-center"
                style="width: 40px; height: 40px; border-radius: 50%; background: #2563eb; color: white; border: none; cursor: pointer;">
                <i class="fas fa-paper-plane"></i>
            </button>
        </form>
    </div>
</div>


<div id="sketchModal" class="sketch-modal-overlay hidden">

    <div id="sketchSidebar" class="sketch-toolbar-container">

        <button onclick="toggleSketchSidebar()" class="sidebar-toggle-btn" title="Toggle Toolbar">
            <i id="toggleIcon" class="fas fa-chevron-left"></i>
        </button>

        <div class="toolbar-section tools-section">
            <div class="section-label">Tools</div>
            <div class="tools-grid">
                <button onclick="setTool('select')" class="tool-btn" title="Select (V)"><i
                        class="fas fa-hand-paper"></i></button>

                <button onclick="setTool('brush')" class="tool-btn active keep-visible" title="Pencil (P)"><i
                        class="fas fa-pencil-alt"></i></button>

                <button onclick="setEraserMode('object')" class="tool-btn" id="btn_erase_object" title="Object Eraser">
                    <i class="fas fa-trash-alt"></i>
                </button>

                <button onclick="setEraserMode('rub')" class="tool-btn" id="btn_erase_rub" title="Rubbing Eraser">
                    <i class="fas fa-eraser"></i>
                </button>

                <button onclick="setTool('text')" class="tool-btn" title="Text (T)"><i class="fas fa-font"></i></button>
                <button onclick="fillSelected()" class="tool-btn" title="Fill Shape"><i
                        class="fas fa-fill-drip"></i></button>
            </div>
        </div>

        <div class="toolbar-section">
            <div class="section-label">Shapes</div>
            <div class="tools-grid">
                <button onclick="setTool('line')" class="tool-btn"><i class="fas fa-slash"></i></button>
                <button onclick="setTool('rect')" class="tool-btn"><i class="far fa-square"></i></button>
                <button onclick="setTool('circle')" class="tool-btn"><i class="far fa-circle"></i></button>
                <button onclick="setTool('arrow')" class="tool-btn"><i class="fas fa-long-arrow-alt-right"></i></button>
                <button onclick="setTool('triangle')" class="tool-btn"><i class="fas fa-caret-up"></i></button>
            </div>
        </div>

        <div class="toolbar-section">
            <div class="section-label">Properties</div>

            <div id="penSizeControl" class="prop-row"
                style="display:flex; align-items:center; justify-content:space-between; width:100%;">
                <span style="font-size:11px;">Size:</span>
                <div style="display:flex; align-items:center; gap:5px;">
                    <input type="range" id="strokeSize" min="1" max="50" value="3"
                        oninput="updateProp('size', this.value)" style="width: 70px;">
                    <span id="strokeVal" style="width: 25px; text-align:right; font-size:10px;">3px</span>
                    <input type="number" id="pencilSize" value="3" min="1" max="100"
                        oninput="updateProp('size', this.value)"
                        class="border border-gray-300 rounded px-1 py-1 w-12 text-xs focus:outline-none">
                </div>
            </div>

            <div id="eraserSizeControl" class="prop-row"
                style="display:none; align-items:center; justify-content:space-between; width:100%; margin-top:5px; border-top:1px solid #eee; padding-top:5px;">
                <span style="font-size:11px; font-weight:bold; color:#555;">Rubber Size:</span>
                <div style="display:flex; align-items:center; gap:5px;">
                    <input type="range" id="eraserSizeSlider" min="5" max="100" value="20" style="width: 80px;"
                        oninput="document.getElementById('eraserVal').innerText = this.value + 'px'">
                    <span id="eraserVal" style="width: 35px; text-align:right; font-size:10px;">20px</span>
                </div>
            </div>

            <div class="prop-row" style="margin-top: 5px;">
                <span>Style:</span>
                <select id="lineStyle" onchange="updateProp('style', this.value)" class="form-select"
                    style="padding: 2px; width: 90px; font-size:11px;">
                    <option value="solid">Solid</option>
                    <option value="dashed">Dashed</option>
                    <option value="dotted">Dotted</option>
                </select>
            </div>

            <div class="prop-row parallel-box" style="margin-top: 5px;">
                <label
                    style="color: #d97706; font-weight:bold; font-size: 11px; display:flex; align-items:center; gap:5px;">
                    <input type="checkbox" id="parallelToggle"> Parallel
                </label>
                <input type="number" id="parallelDist" value="20" class="tiny-input" style="width:40px;">
            </div>
        </div>
        <div class="toolbar-section">
            <div class="section-label">Colors</div>
            <div class="color-picker-row">
                <input type="color" id="mainColor" value="#000000" onchange="updateProp('color', this.value)"
                    style="width:40px; height:30px; border:none; padding:0;">
                <div class="quick-colors">
                    <div class="c-swatch" style="background:black" onclick="setColor('#000000')"></div>
                    <div class="c-swatch" style="background:red" onclick="setColor('#ff0000')"></div>
                    <div class="c-swatch" style="background:blue" onclick="setColor('#0000ff')"></div>
                    <div class="c-swatch" style="background:green" onclick="setColor('#008000')"></div>
                </div>
            </div>
        </div>

        <div class="toolbar-section action-buttons-row" style="margin-top: auto;">
            <div class="section-label">Actions</div>

            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 5px; margin-bottom: 10px;">
                <button onclick="undoSketch()" class="tool-btn" title="Undo"><i class="fas fa-undo"></i></button>
                <button onclick="redoSketch()" class="tool-btn" title="Redo"><i class="fas fa-redo"></i></button>
                <button onclick="resetZoom()" class="tool-btn" title="Reset View"><i
                        class="fas fa-compress"></i></button>
            </div>

            <button onclick="triggerClearSketch()" class="tool-btn"
                style="width:100%; height:30px; background:#fee2e2; color:#dc2626; border-color:#fca5a5; margin-bottom: 10px;">
                <i class="fas fa-trash mr-2"></i> Clear Canvas
            </button>

            <div style="display:flex; gap:5px; margin-bottom: 100px;">
                <button class="modal-btn primary small" style="flex:1;" onclick="triggerSaveSketch()">Save</button>
                <button class="modal-btn small" style="flex:1;" onclick="closeSketchModal()">Exit</button>
            </div>
        </div>

    </div>

    <div class="sketch-canvas-container" id="sketchContainer">
        <canvas id="proCanvas" class="canvas-layer"></canvas>
    </div>
</div>
<div id="confirmationModal" class="modal hidden">
    <div class="modal-content" style="max-width: 400px; text-align: center;">
        <div style="margin-bottom: 15px; font-size: 40px; color: #f59e0b;">
            <i class="fas fa-exclamation-circle"></i>
        </div>
        <h2 id="confirmTitle" class="modal-title">Are you sure?</h2>
        <p id="confirmMessage" class="modal-text">Do you really want to proceed?</p>

        <div style="display: flex; gap: 10px; margin-top: 20px;">
            <button id="confirmYesBtn" class="modal-btn primary"
                style="background: #ef4444; border-color: #ef4444;">Yes, do it</button>
            <button id="confirmNoBtn" class="modal-btn">No, Cancel</button>
        </div>
    </div>
</div>
<div id="dataLoadingOverlay"
    class="fixed inset-0 z-[2000] hidden flex flex-col items-center justify-center bg-white bg-opacity-95 backdrop-blur-sm transition-opacity duration-300">
    <div class="spinner border-4 border-gray-200 border-t-blue-600 rounded-full w-12 h-12 animate-spin mb-4"></div>
    <h3 class="text-lg font-bold text-gray-800 mb-2" id="loadingStatusText">Loading Case Data...</h3>

    <div class="w-64 h-2 bg-gray-200 rounded-full overflow-hidden mb-2">
        <div id="loadingProgressBar" class="h-full bg-blue-600 transition-all duration-300 ease-out" style="width: 0%;">
        </div>
    </div>

    <p class="text-xs text-gray-500 font-medium">Please wait while we populate the form...</p>
</div>

<script>
    const forcePaint = () => new Promise(resolve => requestAnimationFrame(() => setTimeout(resolve, 0)));
    /* =========================
       1. UTILITIES & CONFIG
    ========================= */
    function getCookie(name) {
        let v = null;
        if (document.cookie && document.cookie !== '') {
            document.cookie.split(';').forEach(c => {
                c = c.trim();
                if (c.startsWith(name + '=')) v = decodeURIComponent(c.substring(name.length + 1));
            });
        }
        return v;
    }
    const csrftoken = getCookie("csrftoken");
    /* =========================
       2. STATE MANAGEMENT
    ========================= */
    let currentFolder = "";
    let currentFile = null;
    let currentPage = 1;
    let isLoadingMore = false;
    let hasMoreFiles = true;
    const PAGE_LIMIT = 50; // Load 50 items at a time
    let analysisController = null;
    let currentFolderFiles = [];
    let selectedAnalysisFiles = [];
    let rootFoldersCache = null;
    let isSearching = false;
    let currentPreviewUrl = null;
    let activeSketchPath = null;
    const folderScrollHistory = {};
    let folderChatSocket = null;
    let currentChatFolder = null;
    let autoSaveTimer = null;
    const SAVE_DELAY_MS = 5000; // 10 Seconds
    function getEmptyState() {
        return {
            report_id: null,
            Valuers_Checklist: {
                documents_received: [],
                product: "",
                Office_file_no: "",
                applicant_name: "",
                inspection_date: "",
                person_met: ""
            },
            Ownership_Analysis: { document_verification: "", Ownership_Analysis_notes: "", owners_name: "" },
            Survey: {
                docs: [], survey_notes: "", paddy_land_check: "",
                trees_2008_check: "", total_ltr_extent: "",
                total_deed_extent: "",
                district: "",
                taluk: "",
                village: "",
                local_body_type: "",
                grama_panchayat: ""
            },

            Boundary_analysis_property_identification: {
                ref_doc_1_name: "", ref_doc_2_name: "",
                north_doc1: "", north_doc2: "", east_doc1: "", east_doc2: "",
                south_doc1: "", south_doc2: "", west_doc1: "", west_doc2: "",
                north_translation: "", north_site: "", east_translation: "", east_site: "",
                south_translation: "", south_site: "", west_translation: "", west_site: "",
                Boundary_property_notes: ""
            },
            Demarcation: { north: [], east: [], south: [], west: [], demarcation_notes: "", enroachment_subject_to_neighbour: "", enroachment_neighbour_to_subject: "", enroachment_check: "" },
            Access: {
                access_notes: "", typeofaccess_titledeed: [], typeofaccess_sitevisit: [], private_no_user: [],
                private_rd_demarcation: [], main_access_width: "", vehicular_access: [], internal_road_width: "",
                internal_to_main_connectivity: "", road_material: []
            },
            Purchase_resale: {
                Purchase_resale_notes: "", buyer_name: "", seller_name: "", buyer_seller_relation: "",
                property_sale_duration: "", transaction_method: "", purchase_land_extent: "", price_asked: "", deal_breaker_value: ""
            },
            // --- CORRECTION HERE: Keys now match HTML "data-path" (e.g., BF, GF) ---
            Building_analysis: {
                Building_analysis_notes: "", roof_type: [], setback: "", construction_year: "", amenities_notes: ""
                , Building_no: "", Ward: "",

                // Corrected Casing (BF instead of Bf)
                BF_2_Builtup_area: "", BF_2_Rooms_no: "", BF_2_Kitchen_no: "", BF_2_Bathrooms_no: "", BF_2_Usage: [], BF_2_Occupancy: [],
                BF_1_Builtup_area: "", BF_1_Rooms_no: "", BF_1_Kitchen_no: "", BF_1_Bathrooms_no: "", BF_1_Usage: [], BF_1_Occupancy: [],
                GF_Builtup_area: "", GF_Rooms_no: "", GF_Kitchen_no: "", GF_Bathrooms_no: "", GF_Usage: [], GF_Occupancy: [],
                apartments: [],

                first_flr_Builtup_area: "", first_flr_Rooms_no: "", first_flr_Kitchen_no: "", first_flr_Bathrooms_no: "", first_flr_Usage: [], first_flr_Occupancy: [],
                second_flr_Builtup_area: "", second_flr_Rooms_no: "", second_flr_Kitchen_no: "", second_flr_Bathrooms_no: "", second_flr_Usage: [], second_flr_Occupancy: [],
                third_flr_Builtup_area: "", third_flr_Rooms_no: "", third_flr_Kitchen_no: "", third_flr_Bathrooms_no: "", third_flr_Usage: [], third_flr_Occupancy: [],
                fourth_flr_Builtup_area: "", fourth_flr_Rooms_no: "", fourth_flr_Kitchen_no: "", fourth_flr_Bathrooms_no: "", fourth_flr_Usage: [], fourth_flr_Occupancy: [],
                fifth_flr_Builtup_area: "", fifth_flr_Rooms_no: "", fifth_flr_Kitchen_no: "", fifth_flr_Bathrooms_no: "", fifth_flr_Usage: [], fifth_flr_Occupancy: [],

                front_yard_min: "", front_yard_max: "", side1_yard_min: "", side1_yard_max: "",
                side2_yard_min: "", side2_yard_max: "", rear_yard_min: "", rear_yard_max: "",
                rent_amt: "", rent_duration: "", extra_remarks: "", val_references: "",

                RCC_Percentage: "", Tiled_Percentage: "", Sheet_Percentage: "", Other_Percentage: ""
            },
            land_inspection_details: {
                nearest_city: "", crz: "", stigma: "", nearest_Highway: "", nearest_school: "", nearest_railway: "", nearest_busstop: "",
                nearest_hospital: "", crematoriums: "", slums: "", communial_area: "", factory_abutting: "", defence_area: "", heritage_property: "", rubber_plantations: "",
                coconut_thope: "", buffer_zone: "", telecommunication_tower: "", high_tension_wire_electrical_line: "", enroachment_subject_to_prop: "",
                intrusion_other_to_subject: "", railway_distance: "", STCM_in_property: "", inspection_notes: "", land_value: "", railway_pass: "",
                latitude: "",
                longitude: ""
            },
            Sketch: { landmark_description: "", main_layout: "" },
            images: {},
            vectors: {},
            completion_metrics: {
                percent: 0,
                filled: 0,
                total: 0,
                last_updated: ""
            },
        };
    }
    let formState = getEmptyState();
    let visibleFloorIndices = [2, 3];
    const floorConfig = [
        { label: "BF-2", key: "BF_2" },
        { label: "BF-1", key: "BF_1" },
        { label: "GF", key: "GF" },
        { label: "1st Floor", key: "first_flr" },
        { label: "2nd Floor", key: "second_flr" },
        { label: "3rd Floor", key: "third_flr" },
        { label: "4th Floor", key: "fourth_flr" },
        { label: "5th Floor", key: "fifth_flr" }
    ];
    /* =========================
       3. DOM ELEMENTS
    ========================= */
    // Removed 'fileList' constant to prevent crashes
    const thumbsContainer = document.getElementById("thumbs");
    const bigImageFrame = document.getElementById("bigImageFrame");
    const noSelection = document.getElementById("noSelection");
    const bigPreviewTitle = document.getElementById("bigPreviewTitle");
    const fileInfoBox = document.getElementById("fileInfoBox");
    const pdfWrapper = document.getElementById("pdfWrapper");
    const pdfMain = document.getElementById("pdfMain");

    // Sketch Elements - Pointing to PRO CANVAS (Modal)
    const sketchModal = document.getElementById('sketchModal');
    const canvas = document.getElementById("proCanvas");
    const ctx = canvas ? canvas.getContext("2d") : null;

    function initBuildingTable() {
        const data = formState.Building_analysis || {};
        floorConfig.forEach((floor, index) => {
            const hasData = data[`${floor.key}_Builtup_area`] || data[`${floor.key}_Rooms_no`];
            if (hasData && !visibleFloorIndices.includes(index)) {
                visibleFloorIndices.push(index);
            }
        });
        visibleFloorIndices.sort((a, b) => a - b);
        renderBuildingRows();
    }

    function renderBuildingRows() {
        const tbody = document.getElementById("buildingTableBody");
        if (!tbody) return;
        tbody.innerHTML = "";

        visibleFloorIndices.forEach(index => {
            const floor = floorConfig[index];
            const key = floor.key;
            const getVal = (suffix) => (formState.Building_analysis && formState.Building_analysis[`${key}_${suffix}`]) || "";
            const getChecked = (arraySuffix, val) => {
                const arr = (formState.Building_analysis && formState.Building_analysis[`${key}_${arraySuffix}`]) || [];
                return Array.isArray(arr) && arr.includes(val) ? "checked" : "";
            };

            const tr = document.createElement("tr");
            tr.innerHTML = `
            <td class="font-bold bg-gray-50">${floor.label}</td>
            <td><input type="number" data-path="Building_analysis.${key}_Builtup_area" step="0.01" class="table-input" value="${getVal('Builtup_area')}"></td>
            <td><input type="number" data-path="Building_analysis.${key}_Rooms_no" class="table-input" value="${getVal('Rooms_no')}"></td>
            <td><input type="number" data-path="Building_analysis.${key}_Kitchen_no" class="table-input" value="${getVal('Kitchen_no')}"></td>
            <td><input type="number" data-path="Building_analysis.${key}_Bathrooms_no" class="table-input" value="${getVal('Bathrooms_no')}"></td>
            <td>
                <div class="radio-cell-group">
                  <label class="radio-cell-label"><input type="checkbox" data-array="Building_analysis.${key}_Usage" value="Residential" ${getChecked('Usage', 'Residential')}> Res</label>
                  <label class="radio-cell-label"><input type="checkbox" data-array="Building_analysis.${key}_Usage" value="Commercial" ${getChecked('Usage', 'Commercial')}> Com</label>
                  <label class="radio-cell-label"><input type="checkbox" data-array="Building_analysis.${key}_Usage" value="Industrial" ${getChecked('Usage', 'Industrial')}> Ind</label>
                </div>
            </td>
            <td>
                <div class="radio-cell-group">
                  <label class="radio-cell-label"><input type="checkbox" data-array="Building_analysis.${key}_Occupancy" value="Owner" ${getChecked('Occupancy', 'Owner')}> Owner</label>
                  <label class="radio-cell-label"><input type="checkbox" data-array="Building_analysis.${key}_Occupancy" value="Applicant" ${getChecked('Occupancy', 'Applicant')}> App</label>
                  <label class="radio-cell-label"><input type="checkbox" data-array="Building_analysis.${key}_Occupancy" value="Rented" ${getChecked('Occupancy', 'Rented')}> Rent</label>
                  <label class="radio-cell-label"><input type="checkbox" data-array="Building_analysis.${key}_Occupancy" value="Vacant" ${getChecked('Occupancy', 'Vacant')}> Vac</label>
                </div>
            </td>
            <td>
                ${(floor.label !== 'GF' && floor.label !== '1st Floor') ? `<button onclick="removeFloor(${index})" class="text-red-500 hover:text-red-700" title="Remove Row"><i class="fas fa-trash"></i></button>` : ''}
            </td>
        `;
            tbody.appendChild(tr);
        });

        const apts = formState.Building_analysis.apartments || [];
        apts.forEach((apt, idx) => {
            const basePath = `Building_analysis.apartments.${idx}`;
            const getAptVal = (key) => apt[key] || "";
            const getAptChecked = (key, val) => (Array.isArray(apt[key]) && apt[key].includes(val)) ? "checked" : "";

            const tr = document.createElement("tr");
            tr.innerHTML = `
            <td class="font-bold bg-green-50 text-green-800">
                <input type="text" data-path="${basePath}.label" class="table-input font-bold" value="${getAptVal('label') || 'Apartment ' + (idx + 1)}" placeholder="Unit Name">
            </td>
            <td><input type="number" data-path="${basePath}.Builtup_area" step="0.01" class="table-input" value="${getAptVal('Builtup_area')}"></td>
            <td><input type="number" data-path="${basePath}.Rooms_no" class="table-input" value="${getAptVal('Rooms_no')}"></td>
            <td><input type="number" data-path="${basePath}.Kitchen_no" class="table-input" value="${getAptVal('Kitchen_no')}"></td>
            <td><input type="number" data-path="${basePath}.Bathrooms_no" class="table-input" value="${getAptVal('Bathrooms_no')}"></td>
            <td>
                <div class="radio-cell-group">
                  <label class="radio-cell-label"><input type="checkbox" data-array="${basePath}.Usage" value="Residential" ${getAptChecked('Usage', 'Residential')}> Res</label>
                  <label class="radio-cell-label"><input type="checkbox" data-array="${basePath}.Usage" value="Commercial" ${getAptChecked('Usage', 'Commercial')}> Com</label>
                  <label class="radio-cell-label"><input type="checkbox" data-array="${basePath}.Usage" value="Industrial" ${getAptChecked('Usage', 'Industrial')}> Ind</label>
                </div>
            </td>
            <td>
                <div class="radio-cell-group">
                  <label class="radio-cell-label"><input type="checkbox" data-array="${basePath}.Occupancy" value="Owner" ${getAptChecked('Occupancy', 'Owner')}> Owner</label>
                  <label class="radio-cell-label"><input type="checkbox" data-array="${basePath}.Occupancy" value="Applicant" ${getAptChecked('Occupancy', 'Applicant')}> App</label>
                  <label class="radio-cell-label"><input type="checkbox" data-array="${basePath}.Occupancy" value="Rented" ${getAptChecked('Occupancy', 'Rented')}> Rent</label>
                  <label class="radio-cell-label"><input type="checkbox" data-array="${basePath}.Occupancy" value="Vacant" ${getAptChecked('Occupancy', 'Vacant')}> Vac</label>
                </div>
            </td>
            <td>
                <button onclick="removeApartment(${idx})" class="text-red-500 hover:text-red-700" title="Remove Apartment"><i class="fas fa-trash"></i></button>
            </td>
        `;
            tbody.appendChild(tr);
        });
    }

    function addFloor(direction) {
        const min = Math.min(...visibleFloorIndices);
        const max = Math.max(...visibleFloorIndices);
        let newIndex;
        if (direction === 'above') {
            newIndex = max + 1;
            if (newIndex >= floorConfig.length) return alert("Max floor limit reached (5th Floor)");
        } else {
            newIndex = min - 1;
            if (newIndex < 0) return alert("Min floor limit reached (BF-2)");
        }
        if (!visibleFloorIndices.includes(newIndex)) {
            visibleFloorIndices.push(newIndex);
            visibleFloorIndices.sort((a, b) => a - b);
            renderBuildingRows();
            updateCompletionStats();
        }
    }

    function removeFloor(indexToRemove) {
        visibleFloorIndices = visibleFloorIndices.filter(i => i !== indexToRemove);
        renderBuildingRows();
        updateCompletionStats();
    }

    function addApartment() {
        if (!formState.Building_analysis.apartments) formState.Building_analysis.apartments = [];
        if (formState.Building_analysis.apartments.length >= 1) return alert("You can only add one apartment.");
        formState.Building_analysis.apartments.push({ label: "Apartment", Builtup_area: "", Rooms_no: "", Kitchen_no: "", Bathrooms_no: "", Usage: [], Occupancy: [] });
        renderBuildingRows();
        saveLocal();
        updateCompletionStats();
    }

    function removeApartment(index) {
        if (!formState.Building_analysis.apartments) return;
        formState.Building_analysis.apartments.splice(index, 1);
        renderBuildingRows();
        saveLocal();
        updateCompletionStats();
    }

    /* =========================
       4. FILE EXPLORER LOGIC (SMART RESTORE)
    ========================= */
    let loadingTimer = null;
    let progressInterval = null;

    async function loadFolder(path = "", isKnownCase = null) {
        const overlay = document.getElementById("dataLoadingOverlay");
        const bar = document.getElementById("loadingProgressBar");
        const txt = document.getElementById("loadingStatusText");

        if (loadingTimer) clearTimeout(loadingTimer);
        if (progressInterval) clearInterval(progressInterval);

        let shouldShowOverlay = false;
        if (isKnownCase !== null) {
            shouldShowOverlay = isKnownCase;
        } else {
            const name = path.split('/').pop() || "";
            const hasDatePattern = /^\d+_.*\d{2}\.\d{2}\.\d{4}/.test(name);
            const hasHash = name.includes('#');
            shouldShowOverlay = (hasDatePattern || hasHash);
        }

        if (overlay) {
            if (shouldShowOverlay) {
                overlay.classList.remove("hidden");
                overlay.style.display = "flex";
                if (bar) bar.style.width = "10%";
                if (txt) txt.innerText = "Accessing Case Data...";
            } else {
                overlay.classList.add("hidden");
                overlay.style.display = "none";
            }
        }

        await forcePaint();

        if (currentFolder && currentFolder !== path) {
            saveToServer(true);
            clearTimeout(autoSaveTimer);
        }

        // Safely hide elements
        const statsBox = document.getElementById("folderStatsBox");
        if (statsBox) statsBox.classList.add("hidden");
        // Safely hide the new native viewer and image containers
        const nativeViewer = document.getElementById("nativePdfViewer");
        if (nativeViewer) nativeViewer.classList.add("hidden");

        const bigImgContainer = document.getElementById("bigImageContainer");
        if (bigImgContainer) bigImgContainer.classList.add("hidden");

        const noSel = document.getElementById("noSelection");
        if (noSel) noSel.classList.remove("hidden");

        if (!shouldShowOverlay) {
            formState = getEmptyState();
            syncStateToUI();
            localStorage.removeItem(STORAGE_KEY);
        }

        currentPage = 1;
        hasMoreFiles = true;
        isLoadingMore = false;

        thumbsContainer.innerHTML = "";
        currentFolder = path;
        formState.target_folder = path;

        // --- THIS IS THE FIX: Safely check if elements exist before updating them ---
        const pathText = document.getElementById("currentPath");
        if (pathText) pathText.textContent = "/" + (path || "");

        const topBanner = document.getElementById("topBannerPath");
        if (topBanner) topBanner.textContent = path ? "/" + path : "/";

        try {
            const response = await fetch(`/coreapi/api/folder-contents/?path=${encodeURIComponent(path)}`);
            const data = await response.json();

            localStorage.setItem('vadrida_active_folder', path);

            if (shouldShowOverlay) {
                if (txt) txt.innerText = "Showing Files...";
                if (bar) bar.style.width = "50%";
            }
            await forcePaint();

            currentFolderFiles = data.files || [];
            // NOTE: Removed appendFileList call from here so it doesn't overwrite your search!
            renderThumbs(data.files || []);
            hasMoreFiles = data.has_next;

            await forcePaint();

            if (shouldShowOverlay) {
                if (txt) txt.innerText = "Loading Form...";
                if (bar) bar.style.width = "80%";
                await forcePaint();

                try {
                    formState = getEmptyState();

                    // 1. Check Server DB
                    const serverDraft = data.saved_draft || {};
                    const hasServerData = Object.keys(serverDraft).length > 0;

                    // 2. Check Local Browser Memory (Using Dynamic Key!)
                    const newDraftKey = getDraftKey(path);
                    const localDataString = localStorage.getItem(newDraftKey);
                    let localData = null;
                    if (localDataString) {
                        try { localData = JSON.parse(localDataString); } catch (e) { }
                    }
                    const hasLocalData = localData && Object.keys(localData).length > 0;

                    // ==========================================
                    // INSTANT LOAD FOR NEW FILES
                    // ==========================================
                    if (!hasServerData && !hasLocalData) {
                        // Hide loader instantly! No delays!
                        if (overlay) {
                            overlay.classList.add("hidden");
                            overlay.style.display = "none";
                        }

                        // Inject Auto-Fill
                        if (data.auto_fill) {
                            updateNestedState(formState, 'Valuers_Checklist.Office_file_no', data.auto_fill.file_no);
                            updateNestedState(formState, 'Valuers_Checklist.applicant_name', data.auto_fill.applicant_name);
                            updateNestedState(formState, 'Valuers_Checklist.product', data.auto_fill.product);
                        }

                        // Paint screen immediately
                        syncStateToUI();
                    }
                    // ==========================================
                    // HEAVY LOAD FOR SAVED FILES
                    // ==========================================
                    else {
                        if (txt) txt.innerText = "Populating Form...";
                        await forcePaint(); // Give browser a split second to render the text

                        if (hasServerData) {
                            // DB is Boss. Erase local storage so they don't clash.
                            formState = { ...formState, ...serverDraft };
                            localStorage.removeItem(newDraftKey);
                        }
                        else if (hasLocalData) {
                            // DB empty, load <20% local draft
                            formState = { ...formState, ...localData };
                        }

                        // Aggressive Auto-Fill to enforce ID accuracy
                        if (data.auto_fill) {
                            updateNestedState(formState, 'Valuers_Checklist.Office_file_no', data.auto_fill.file_no);
                            updateNestedState(formState, 'Valuers_Checklist.applicant_name', data.auto_fill.applicant_name);
                        }

                        if (!formState.images) formState.images = {};
                        if (!formState.vectors) formState.vectors = {};

                        initBuildingTable();
                        renderSurveyColumns();
                        updateAllDocumentDropdowns();
                        injectPencilIcons();
                        parseTimelineString(getNestedValue(formState, "Building_analysis.construction_year"));

                        syncStateToUI();
                        renderAllSavedImages();
                        updateMapFromState();

                        if (data.folder_info) renderFolderStats(data.folder_info);
                        updateCompletionStats();

                        // Everything is painted. Hide Loader.
                        setTimeout(() => {
                            if (overlay) {
                                overlay.classList.add("hidden");
                                overlay.style.display = "none";
                            }
                        }, 50);
                    }

                } catch (formErr) {
                    console.error("Form Logic Error:", formErr);
                }
            }
            if (shouldShowOverlay) {
                if (bar) bar.style.width = "100%";
                if (txt) txt.innerText = "Ready!";
            }

            setTimeout(() => {
                const listContainer = document.getElementById('searchResultsList');
                const savedListScroll = parseInt(localStorage.getItem('vadrida_file_list_scroll') || '0');
                if (listContainer && savedListScroll > 0) listContainer.scrollTop = savedListScroll;

                if (overlay) {
                    overlay.classList.add("hidden");
                    overlay.style.display = "none";
                }
            }, 50);

        } catch (err) {
            console.error("Load failed", err);
            if (overlay && shouldShowOverlay) {
                overlay.classList.remove("hidden");
                overlay.style.display = "flex";
                if (txt) {
                    txt.innerText = "Error loading folder.";
                    txt.style.color = "red";
                }
            }
            setTimeout(() => { if (overlay) overlay.style.display = "none"; }, 2000);
        }
    }

    function getStatusDotHtml(statusColor) {
        let colorClass = "";
        if (statusColor === "green") colorClass = "bg-green-500";
        else if (statusColor === "yellow") colorClass = "bg-yellow-400";
        else if (statusColor === "red") colorClass = "bg-red-500";
        else if (statusColor === "pending" || statusColor === "grey" || statusColor === "gray") colorClass = "bg-gray-400";
        else return `<span class="block w-2 h-2 mt-1 flex-shrink-0"></span>`;
        return `<span class="block w-2 h-2 rounded-full ${colorClass} mt-1 flex-shrink-0"></span>`;
    }

    function renderAllSavedImages() {
        if (!formState.images) return;
        Object.keys(formState.images).forEach(path => {
            const base64Data = formState.images[path];
            if (!base64Data) return;
            const safeId = path.replace(/\./g, '_');
            const imgId = `img_preview_${safeId}`;
            let imgElement = document.getElementById(imgId);

            if (!imgElement) {
                const targetInput = document.querySelector(`[data-path="${path}"]`);
                if (targetInput) {
                    imgElement = document.createElement('img');
                    imgElement.id = imgId;
                    imgElement.className = 'sketch-thumb';
                    imgElement.style.marginTop = '10px';
                    imgElement.style.maxHeight = '150px';
                    imgElement.style.maxWidth = '100%';
                    imgElement.style.borderRadius = '8px';
                    imgElement.style.border = '1px solid #e5e7eb';
                    imgElement.style.cursor = 'pointer';
                    imgElement.style.display = 'block';
                    imgElement.onclick = (e) => { e.stopPropagation(); openSketchPad(path); };
                    const container = targetInput.closest('.input-wrapper') || targetInput;
                    if (container.parentNode) {
                        if (container.nextSibling) container.parentNode.insertBefore(imgElement, container.nextSibling);
                        else container.parentNode.appendChild(imgElement);
                    }
                }
            }

            if (imgElement) {
                imgElement.src = base64Data;
                imgElement.classList.remove('hidden');
                imgElement.style.display = 'block';
                const placeholder = document.getElementById(`placeholder_${safeId}`);
                if (placeholder) {
                    placeholder.classList.add('hidden');
                    placeholder.style.display = 'none';
                }
            }
        });
    }

    function renderFolderStats(info) {
        const statsBox = document.getElementById("folderStatsBox");
        let colorSuffix = "grey";
        if (info.status_color === "green") colorSuffix = "green";
        else if (info.status_color === "yellow") colorSuffix = "yellow";
        else if (info.status_color === "red") colorSuffix = "red";

        statsBox.innerHTML = `
        <div style="display:flex; justify-content:space-between; border-bottom:1px solid #eee; padding-bottom:5px; margin-bottom:5px; font-weight:bold;">
            <span>Case Details</span>
            <div style="display:flex; align-items:center;">
                <span class="status-dot status-${colorSuffix}"></span>
                <span style="font-size:10px; text-transform:uppercase; color:#666;">${info.status_label}</span>
            </div>
        </div>
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:5px;">
            <div style="color:#666;">Downloaded:</div><div style="text-align:right;">${info.download_date}</div>
            <div style="color:#666;">TAT Limit:</div><div style="text-align:right; color:#2563eb;">${info.tat_date}</div>
            <div style="color:#666;">Site Report:</div><div style="text-align:right;">${info.site_report_date}</div>
            <div style="color:#666;">Final Report:</div><div style="text-align:right;">${info.final_report_date}</div>
        </div>
    `;
        statsBox.classList.remove("hidden");
    }

    function appendFileList(folders, files, targetContainer) {
        if (!targetContainer) return;

        files = files.filter(f => f.name.toLowerCase() !== 'desktop.ini' && f.name !== '.DS_Store');

        const sortByDateDesc = (a, b) => {
            const timeA = a.mtime || 0;
            const timeB = b.mtime || 0;
            return timeB - timeA;
        };

        folders.sort(sortByDateDesc);
        files.sort(sortByDateDesc);

        folders.forEach(folder => {
            const li = document.createElement("li");
            li.className = "p-2 hover:bg-blue-50 flex items-start justify-between group border-b border-gray-50";
            li.dataset.folderPath = folder.path;

            let statusDotHtml = getStatusDotHtml(folder.status_color);

            const leftDiv = document.createElement("div");
            leftDiv.className = "flex items-start gap-3 cursor-pointer flex-1 min-w-0";

            leftDiv.innerHTML = `
          <div class="flex flex-col items-center justify-start flex-shrink-0 w-8 pt-0.5">
              <span class="text-xl leading-none">📁</span> 
              ${statusDotHtml}
          </div>
          <div class="flex flex-col">
              <span class="font-medium break-all whitespace-normal leading-snug text-sm pt-1 block">${folder.name}</span>
              <span class="text-[10px] text-gray-400">
                ${folder.created ? new Date(folder.created * 1000).toLocaleDateString() : ''}
              </span>
          </div>
        `;

            const isCaseFolder = (folder.status_color !== null && folder.status_color !== undefined);
            leftDiv.onclick = () => loadFolder(folder.path, isCaseFolder);
            li.appendChild(leftDiv);

            if (folder.has_chat) {
                const chatBtnWrapper = document.createElement("div");
                chatBtnWrapper.className = "relative ml-2 flex-shrink-0 mt-1";
                const chatBtn = document.createElement("button");
                chatBtn.className = "w-8 h-8 rounded-full bg-green-100 text-green-600 hover:bg-green-200 flex items-center justify-center";
                chatBtn.innerHTML = '<i class="fas fa-comments"></i>';
                chatBtn.onclick = (e) => { e.stopPropagation(); openFolderChat(folder.path, folder.name); };
                chatBtnWrapper.appendChild(chatBtn);
                li.appendChild(chatBtnWrapper);
            }
            targetContainer.appendChild(li);
        });

        files.forEach(file => {
            const li = document.createElement("li");
            li.className = "p-2 cursor-pointer hover:bg-gray-100 border-b border-gray-50";
            const dateStr = file.mtime ? new Date(file.mtime * 1000).toLocaleDateString() : '';

            li.innerHTML = `
          <div class="flex justify-between items-start">
            <div class="min-w-0 pr-2 flex-1">
              <div class="font-medium break-all whitespace-normal leading-snug text-sm text-gray-700">${file.name}</div>
              <div class="flex gap-2 mt-0.5">
                  <div class="text-[10px] text-gray-400 uppercase tracking-wider">${file.extension || "FILE"}</div>
                  <div class="text-[10px] text-gray-400">${dateStr}</div>
              </div>
            </div>
          </div>`;

            li.onclick = () => {
                document.querySelectorAll("#searchResultsList li").forEach(el => el.classList.remove("bg-blue-100"));
                li.classList.add("bg-blue-100");
                loadBigPreview(file);
                setFileInfo(file);
            };
            targetContainer.appendChild(li);
        });

        appendThumbs(files);
    }

    function appendThumbs(files) {
        if (!files.length) return;
        const noThumbMsg = thumbsContainer.querySelector('.no-thumbs');
        if (noThumbMsg) noThumbMsg.remove();

        files.forEach(file => {
            const card = document.createElement("div");
            card.className = "thumb-item";
            thumbsContainer.appendChild(card);
        });
        processThumbQueue();
    }
    /* =========================
       5. THUMBNAILS & PREVIEWS
    ========================= */
    const thumbQueue = [];
    let activeRequests = 0;
    const MAX_CONCURRENT = 3; // Only 3 G: Drive requests at once

    function processThumbQueue() {
        // Stop if we are at the limit or queue is empty
        if (activeRequests >= MAX_CONCURRENT || thumbQueue.length === 0) return;

        // Get the next image waiting in line
        const { imgElement, url, card } = thumbQueue.shift();
        activeRequests++;

        imgElement.onload = () => {
            activeRequests--;
            card.innerHTML = ""; // Remove spinner
            card.appendChild(imgElement);
            processThumbQueue(); // Call the next one!
        };

        imgElement.onerror = () => {
            activeRequests--;
            // Show fallback icon
            let icon = "fa-file-image";
            if (url.includes("pdf")) icon = "fa-file-pdf";
            card.innerHTML = `<div class="file-icon"><i class="fas ${icon} text-red-400"></i></div>`;
            processThumbQueue(); // Call the next one!
        };

        // ACTUALLY START THE DOWNLOAD HERE
        imgElement.src = url;
    }

    function renderThumbs(files) {
        files = files.filter(f => f.name.toLowerCase() !== 'desktop.ini' && f.name !== '.DS_Store');
        thumbsContainer.innerHTML = "";

        // Clear old queue so we don't load images from the previous folder
        thumbQueue.length = 0;
        activeRequests = 0;

        if (!files.length) {
            thumbsContainer.innerHTML = `<div class="no-thumbs">No files to preview</div>`;
            return;
        }

        files.forEach(file => {
            const card = document.createElement("div");
            card.className = "thumb-item";
            // Show Spinner immediately
            card.innerHTML = `<div class="file-icon"><i class="fas fa-spinner fa-spin text-gray-400"></i></div>`;

            const ext = file.name.split(".").pop().toLowerCase();

            // --- PREPARE IMAGE OBJECT (Don't set .src yet!) ---
            if (['jpg', 'jpeg', 'png', 'gif', 'bmp', 'pdf'].includes(ext)) {
                const img = new Image();
                img.className = "preview-thumb-img";
                // Inline styles to ensure it fits
                img.style.width = "100%";
                img.style.height = "100%";
                img.style.objectFit = "contain";

                let url = "";
                // Use your Python APIs
                if (ext === 'pdf') {
                    url = `/coreapi/api/thumbnail/?path=${encodeURIComponent(file.path)}`;
                } else {
                    url = `/coreapi/serve-file/?path=${encodeURIComponent(file.path)}`;
                }

                // PUSH TO QUEUE INSTEAD OF LOADING
                thumbQueue.push({ imgElement: img, url: url, card: card });
            }
            else {
                // Non-image files (Word/Excel) load instantly
                let icon = "fa-file-alt";
                if (['doc', 'docx'].includes(ext)) icon = "fa-file-word";
                if (['xls', 'xlsx'].includes(ext)) icon = "fa-file-excel";
                card.innerHTML = `<div class="file-icon"><i class="fas ${icon}"></i><br><span style="font-size:10px">${ext.toUpperCase()}</span></div>`;
            }

            // Click to Preview
            card.onclick = () => {
                document.querySelectorAll(".file-item").forEach(el => el.classList.remove("selected"));
                loadBigPreview(file);
                setFileInfo(file);
            };

            thumbsContainer.appendChild(card);
        });

        // Start 3 workers
        processThumbQueue();
        processThumbQueue();
        processThumbQueue();
    }

    /* =========================
       7. FOLDER CHAT (Ported)
    ========================= */
    const folderChatModal = document.getElementById('folderChatModal');
    const folderChatMsgs = document.getElementById('folderChatMessages');

    function openFolderChat(path, name) {
        currentChatFolder = path;
        document.getElementById('folderChatTitle').textContent = name;

        // Show Modal
        folderChatModal.classList.remove('hidden');
        folderChatModal.style.display = 'flex'; // Force Flex for centering

        loadFolderChatHistory();

        if (folderChatSocket) folderChatSocket.close();
        const protocol = location.protocol === 'https:' ? 'wss' : 'ws';
        const wsUrl = `${protocol}://${location.host}/ws/chat/folder/?path=${encodeURIComponent(path)}`;
        folderChatSocket = new WebSocket(wsUrl);

        folderChatSocket.onmessage = function (e) {
            const data = JSON.parse(e.data);
            appendFolderMessage(data);
        };
    }

    function closeFolderChat() {
        folderChatModal.classList.add('hidden');
        folderChatModal.style.display = 'none';
        currentChatFolder = null;
        if (folderChatSocket) { folderChatSocket.close(); folderChatSocket = null; }
    }

    function appendFolderMessage(msg) {
        const isMe = msg.is_me;
        const div = document.createElement('div');
        div.className = isMe ? 'chat-bubble chat-me' : 'chat-bubble chat-other';

        div.innerHTML = `
        ${!isMe ? `<div style="font-size:10px; font-weight:bold; color:orange; margin-bottom:2px;">${msg.user}</div>` : ''}
        <div style="word-wrap:break-word;">${msg.message}</div>
        <div style="font-size:9px; color:#aaa; text-align:right; margin-top:4px;">${msg.time}</div>
    `;
        folderChatMsgs.appendChild(div);
        folderChatMsgs.scrollTop = folderChatMsgs.scrollHeight;
    }

    function loadFolderChatHistory() {
        folderChatMsgs.innerHTML = '<div style="text-align:center; color:#999; margin-top:20px;">Loading...</div>';
        fetch(`/chat/api/folder-history/?path=${encodeURIComponent(currentChatFolder)}`)
            .then(r => r.json())
            .then(data => {
                folderChatMsgs.innerHTML = "";
                if (data.messages.length === 0) {
                    folderChatMsgs.innerHTML = '<div style="text-align:center; color:#ccc; margin-top:20px;">No notes yet.</div>';
                    return;
                }
                data.messages.forEach(msg => appendFolderMessage(msg));
            });
    }

    document.getElementById('folderChatForm').onsubmit = (e) => {
        e.preventDefault();
        const input = document.getElementById('folderChatInput');
        const msg = input.value.trim();

        // Check if socket is ready
        if (!msg || !folderChatSocket || folderChatSocket.readyState !== WebSocket.OPEN) {
            console.error("Socket not ready or message empty");
            return;
        }

        // Send to Consumer
        folderChatSocket.send(JSON.stringify({
            'message': msg
        }));

        input.value = ""; // Clear input
    };
    function setFileInfo(file) {
        fileInfoBox.innerHTML = `
    <div class="info-row"><strong>Name:</strong> <span>${file.name}</span></div>
    <div class="info-row"><strong>Type:</strong> ${file.extension || "Unknown"}</div>
    <div class="info-row"><strong>Size:</strong> ${file.size || "N/A"}</div>
  `;
    }

    /* =========================
       6. PDF & ANALYSIS TOOLS
    ========================= */
    function loadPdfJsIfNeeded() {
        if (window.pdfjsLib) return Promise.resolve();
        return new Promise((resolve) => {
            const script = document.createElement("script");
            script.src = "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js";
            script.onload = () => {
                pdfjsLib.GlobalWorkerOptions.workerSrc = "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js";
                resolve();
            };
            document.head.appendChild(script);
        });
    }

    // Analysis Controls
    const analyseBtn = document.getElementById("analyseBtn");
    const analyseModal = document.getElementById("analyseModal");
    const fileSelectModal = document.getElementById("fileSelectModal");
    const fileSelectList = document.getElementById("fileSelectList");

    function startAnalysis(files) {
        if (analysisController) analysisController.abort();
        analysisController = new AbortController();
        document.getElementById("analyseLoading").classList.remove("hidden");

        fetch("/coreapi/api/analyze/", {
            method: "POST",
            headers: { "Content-Type": "application/json", "X-CSRFToken": csrftoken },
            body: JSON.stringify({ files, folder: currentFolder }),
            signal: analysisController.signal
        })
            .then(r => r.json())
            .then(() => loadFolder(currentFolder))
            .catch(e => { if (e.name !== 'AbortError') alert("Analysis failed"); })
            .finally(() => {
                document.getElementById("analyseLoading").classList.add("hidden");
                analysisController = null;
            });
    }

    analyseBtn.onclick = () => {
        if (!currentFolder && currentFolderFiles.length === 0) return alert("No files");
        analyseModal.classList.remove("hidden");
    };

    document.getElementById("analyseSelectAll").onclick = () => {
        if (!currentFolderFiles.length) return alert("No files");
        const files = currentFolderFiles.map(f => ({ file_path: f.path }));
        analyseModal.classList.add("hidden");
        startAnalysis(files);
    };

    document.getElementById("analyseSelectFiles").onclick = () => {
        if (!currentFolderFiles.length) return alert("No files");
        fileSelectList.innerHTML = "";
        selectedAnalysisFiles = [];
        currentFolderFiles.forEach(file => {
            const row = document.createElement("label");
            row.className = "flex items-center gap-2 mb-2 cursor-pointer";
            row.innerHTML = `<input type="checkbox" value="${file.path}" /> <span class="truncate">${file.name}</span>`;
            row.querySelector("input").onchange = (e) => {
                if (e.target.checked) selectedAnalysisFiles.push({ file_path: e.target.value });
                else selectedAnalysisFiles = selectedAnalysisFiles.filter(f => f.file_path !== e.target.value);
            };
            fileSelectList.appendChild(row);
        });
        analyseModal.classList.add("hidden");
        fileSelectModal.classList.remove("hidden");
    };

    document.getElementById("confirmFileSelection").onclick = () => {
        if (!selectedAnalysisFiles.length) return alert("Select a file");
        fileSelectModal.classList.add("hidden");
        startAnalysis(selectedAnalysisFiles);
    };

    document.getElementById("analyseClose").onclick = () => analyseModal.classList.add("hidden");
    document.getElementById("fileSelectClose").onclick = () => fileSelectModal.classList.add("hidden");


    function globalSearch(query) {
        fileList.innerHTML = `<li class="file-item loading">Searching...</li>`;

        // Create a new controller for this specific request
        if (currentSearchController) currentSearchController.abort();
        currentSearchController = new AbortController();
        const signal = currentSearchController.signal;

        fetch(`/coreapi/api/search/?q=${encodeURIComponent(query)}`, { signal })
            .then(r => r.json())
            .then(data => {
                // --- 1. SORTING LOGIC (Newest First) ---
                // Sorts by 'mtime' (Modified Time). 
                const sortByDateDesc = (a, b) => {
                    const timeA = a.mtime || 0;
                    const timeB = b.mtime || 0;
                    return timeB - timeA;
                };

                const sortedFolders = (data.folders || []).sort(sortByDateDesc);
                const sortedFiles = (data.files || []).sort(sortByDateDesc);

                // --- 2. CLEAR & RENDER ---
                fileList.innerHTML = ""; // Clear "Searching..." text

                if (sortedFolders.length === 0 && sortedFiles.length === 0) {
                    fileList.innerHTML = `<li class="p-4 text-gray-500 text-center">No matches found for "${query}"</li>`;
                    thumbsContainer.innerHTML = "";
                    return;
                }

                // --- 3. CALL THE CORRECT FUNCTION ---
                // WAS: renderFileList (Error) -> NOW: appendFileList (Correct)
                appendFileList(sortedFolders, sortedFiles);
                renderThumbs(sortedFiles);
            })
            .catch(err => {
                if (err.name !== 'AbortError') {
                    console.error('Search failed', err);
                    fileList.innerHTML = `<li class="text-red-500 p-2">Error searching.</li>`;
                }
            });
    }

    /* =========================
       7. MODAL & PREVIEW UI
    ========================= */

    document.getElementById("modalClose").onclick = () => {
        fullscreenModal.setAttribute("aria-hidden", "true");
        modalFrame.src = ""; modalImage.src = "";
    };




    // Enforce Landscape
    /* =========================
       UPDATED ORIENTATION LOGIC
    ========================= */
    function enforceTabletLandscape() {
        const sketchModal = document.getElementById('sketchModal');

        // 1. If Sketch Modal is Open, ALLOW Portrait (Do not block)
        if (sketchModal && !sketchModal.classList.contains('hidden')) {
            document.getElementById("orientationBlocker").classList.add("hidden");
            document.body.style.overflow = "hidden"; // Keep scrolling locked
            return;
        }

        // 2. Standard Logic for Dashboard
        const isTablet = window.innerWidth >= 768 && window.innerWidth <= 1024;
        const isPortrait = window.innerHeight > window.innerWidth;
        const blocker = document.getElementById("orientationBlocker");

        if (isTablet && isPortrait) {
            blocker.classList.remove("hidden");
            document.body.style.overflow = "hidden";
        } else {
            blocker.classList.add("hidden");
            document.body.style.overflow = "";
        }
    }

    // Add a specific resize listener to handle canvas resizing when rotating
    window.addEventListener("resize", () => {
        enforceTabletLandscape();
        // If sketch modal is open, resize the canvas to fit the new orientation
        if (!document.getElementById('sketchModal').classList.contains('hidden')) {
            resizeCanvas();
        }
    });

    window.addEventListener("resize", enforceTabletLandscape);
    window.addEventListener("orientationchange", enforceTabletLandscape);

    /* =========================
       8. SKETCH PAD & DRAWING LOGIC (COMPLETE & FIXED)
    ========================= */
    // --- STATE ---
    let elements = [];
    let redoStack = [];
    let undoStack = [];
    let selectedElement = null;
    let attachedErasers = [];
    let clipboard = null;

    // --- VIEWPORT STATE ---
    let camera = { x: 0, y: 0, z: 1 };

    // --- INTERACTION STATE ---
    let isDrawing = false;
    let isDragging = false;
    let isResizing = false;
    let isPanning = false;
    let isPromptOpen = false;

    // --- ERASER STATE ---
    let isEraserActive = false;
    let eraserMode = 'rub'; // 'object' or 'rub'
    let currentTool = 'brush';

    let startX, startY;
    let lastX, lastY;
    let lastTime = 0; // For speed calculation
    const MAX_ERASER_SIZE = 80;
    const SPEED_SENSITIVITY = 2; // Higher = harder to grow eraser
    // --- CANVAS SETUP ---
    function resizeCanvas() {
        if (!canvas) return;
        const sidebar = document.getElementById('sketchSidebar');
        const sidebarWidth = sidebar ? sidebar.offsetWidth : 0;

        // Save current elements to restore after resize if needed, 
        // but usually elements array is the source of truth.
        canvas.width = window.innerWidth - sidebarWidth;
        canvas.height = window.innerHeight;

        renderScene();
    }
    async function openSketchPad(path) {
        activeSketchPath = path;

        // 1. Reset and Load
        // We clear current memory and then pull from formState
        elements = [];
        if (formState.vectors && formState.vectors[path]) {
            console.log("📝 Loading existing vectors for:", path);
            // Create a deep copy to avoid reference bugs
            elements = JSON.parse(JSON.stringify(formState.vectors[path]));
        }

        // 2. UI Visibility
        sketchModal.classList.remove('hidden');

        // 3. CRITICAL: Trigger Canvas Prep
        // We must resize and clear history so the user starts fresh
        resizeCanvas();
        undoStack = [];
        redoStack = [];

        // 4. Force immediate render of loaded elements
        renderScene();
    }

    // Helper to render after fetching
    function initCanvasWithData(data) {
        resizeCanvas(); // Ensure canvas size is correct
        elements = data || [];
        redoStack = [];
        undoStack = []; // Clear history

        // Center the view
        camera.x = (canvas.width - (canvas.width * MIN_ZOOM)) / 2;
        camera.y = (canvas.height - (canvas.height * MIN_ZOOM)) / 2;

        renderScene();
    }
    function closeSketchModal() {
        sketchModal.classList.add('hidden');
        activeSketchPath = null;
        if (document.exitFullscreen) document.exitFullscreen().catch(e => console.log(e));
        enforceTabletLandscape();
    }

    // ================= ZOOM & PAN LOGIC =================

    // Smart Zoom Function
    // --- CONFIGURATION ---
    const MIN_ZOOM = 0.5; // This is your "Full Zoom Out" limit
    const MAX_ZOOM = 5.0;

    function zoomToPoint(newScale, screenX, screenY) {
        // 1. Enforce Limits
        if (newScale < MIN_ZOOM) newScale = MIN_ZOOM; // Cannot zoom out past start
        if (newScale > MAX_ZOOM) newScale = MAX_ZOOM;

        // 2. Calculate World Position
        const worldX = (screenX - camera.x) / camera.z;
        const worldY = (screenY - camera.y) / camera.z;

        // 3. Update Scale
        camera.z = newScale;

        // 4. Update Camera Position to keep focus stable
        camera.x = screenX - (worldX * newScale);
        camera.y = screenY - (worldY * newScale);

        renderScene();
    }

    // Button Zoom (defaults to center of screen)
    function zoomCanvas(amount) {
        const centerX = canvas.width / 2;
        const centerY = canvas.height / 2;
        zoomToPoint(camera.z + amount, centerX, centerY);
    }
    function resetZoom() {
        camera = { x: 0, y: 0, z: 1 };
        renderScene();
    }

    // Convert Screen Coordinates (Mouse) to World Coordinates (Canvas Drawing)
    function toWorld(screenX, screenY) {
        return {
            x: (screenX - camera.x) / camera.z,
            y: (screenY - camera.y) / camera.z
        };
    }

    // ================= TOOLBAR FUNCTIONS =================
    function setTool(tool) {
        currentTool = tool;
        isEraserActive = false;
        selectedElement = null;

        document.querySelectorAll('.tool-btn').forEach(b => b.classList.remove('active'));
        const btn = document.querySelector(`button[onclick="setTool('${tool}')"]`);
        if (btn) btn.classList.add('active');

        if (tool === 'select') canvas.style.cursor = 'grab';
        else if (tool === 'text') canvas.style.cursor = 'text';
        else canvas.style.cursor = 'crosshair';

        // Hide Eraser Specific Controls
        const eraserCtrl = document.getElementById('eraserSizeControl');
        if (eraserCtrl) eraserCtrl.style.display = 'none';
        const objEraser = document.getElementById('btn_erase_object');
        if (objEraser) objEraser.classList.remove('active');
        const rubEraser = document.getElementById('btn_erase_rub');
        if (rubEraser) rubEraser.classList.remove('active');

        renderScene();
    }
    function setEraserMode(mode) {
        currentTool = 'eraser';
        isEraserActive = true;
        eraserMode = mode;
        selectedElement = null;

        document.querySelectorAll('.tool-btn').forEach(b => b.classList.remove('active'));

        // Highlight specific eraser button
        const btn = document.getElementById(`btn_erase_${mode}`);
        if (btn) btn.classList.add('active');

        // Show size slider ONLY for rubbing mode
        const eraserCtrl = document.getElementById('eraserSizeControl');
        if (eraserCtrl) eraserCtrl.style.display = (mode === 'rub') ? 'flex' : 'none';

        canvas.style.cursor = 'cell';
    }
    function updateProp(prop, value) {
        // 1. HANDLE SIZE CHANGES
        if (prop === 'size') {
            // If value is empty (user deleted everything), stop here to let them type
            if (value === "") return;

            const intVal = parseInt(value, 10);
            if (isNaN(intVal)) return;

            // Update Text Label
            const label = document.getElementById('strokeVal');
            if (label) label.innerText = intVal + 'px';

            const slider = document.getElementById('strokeSize');
            const numInput = document.getElementById('pencilSize');

            // SCENARIO A: User is typing in the Number Box
            if (document.activeElement === numInput) {
                // Only update the slider
                if (slider && parseInt(slider.value) !== intVal) {
                    slider.value = intVal;
                }
            }
            // SCENARIO B: User is dragging the Slider
            else if (document.activeElement === slider) {
                // Only update the number input
                if (numInput && parseInt(numInput.value) !== intVal) {
                    numInput.value = intVal;
                }
            }
            // SCENARIO C: Code triggering update (e.g., loading saved state)
            else {
                if (slider) slider.value = intVal;
                if (numInput) numInput.value = intVal;
            }
        }

        // 2. HANDLE COLOR CHANGES
        if (prop === 'color') {
            document.getElementById('mainColor').value = value;
        }

        // 3. UPDATE SELECTED ELEMENT
        if (selectedElement) {
            saveState();
            selectedElement[prop] = value;
            renderScene();
        }
    }

    function setColor(hex) {
        updateProp('color', hex);
    }

    // ================= ACTION FUNCTIONS =================

    // Save current state to history stack
    function saveState() {
        // Deep copy current elements to redoStack isn't linked
        // NOTE: For standard Undo, we push current state to history. 
        // But here we are using a simplified approach: elements IS the state.
        // So 'undo' means popping from elements.
        // However, for Property changes, we need more complex history. 
        // For now, this Undo logic focuses on ADDED/REMOVED shapes.
    }

    function fillSelected() {
        if (selectedElement && ['rect', 'circle', 'triangle'].includes(selectedElement.type)) {
            const color = document.getElementById('mainColor').value;
            selectedElement.fill = color;
            renderScene();
        } else {
            alert("Select a shape (Rect, Circle, Triangle) to fill.");
        }
    }
    /* =========================
       HISTORY MANAGER (Snapshots)
    ========================= */
    function saveToHistory() {
        // Save a copy of the current elements array as a string
        if (undoStack.length > 50) undoStack.shift(); // Limit history to 50 steps
        undoStack.push(JSON.stringify(elements));
        redoStack = []; // Clear redo stack whenever a new action happens
    }
    function undoSketch() {
        if (undoStack.length > 0) {
            // 1. Save current state to Redo Stack before undoing
            redoStack.push(JSON.stringify(elements));

            // 2. Restore previous state
            const previousState = undoStack.pop();
            elements = JSON.parse(previousState);

            // 3. Reset Selection to avoid ghost boxes
            selectedElement = null;
            attachedErasers = [];

            renderScene();
        }
    }

    function redoSketch() {
        if (redoStack.length > 0) {
            // 1. Save current state to Undo Stack
            undoStack.push(JSON.stringify(elements));

            // 2. Restore next state
            const nextState = redoStack.pop();
            elements = JSON.parse(nextState);

            renderScene();
        }
    }

    function triggerClearSketch() {
        if (elements.length === 0) return;
        showConfirm(
            "Clear Drawing?",
            "Are you sure you want to delete everything?",
            () => {
                saveToHistory(); // ✅ Save before clearing!
                elements = [];
                renderScene();
            }
        );
    }

    // Trigger Save with Popup
    function triggerSaveSketch() {
        showConfirm(
            "Save Sketch?",
            "Do you want to save this drawing and close the sketch pad?",
            () => {
                saveSketchModal(); // Call the actual save logic
            }
        );
    }

    /* =========================
       CORE RENDERING ENGINE (True Erasure Fix)
    ========================= */
    function renderScene() {
        if (!ctx) return;

        // 1. Clear the ENTIRE canvas to start fresh frame
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        ctx.save();
        ctx.translate(camera.x, camera.y);
        ctx.scale(camera.z, camera.z);

        // ❌ REMOVED: Do NOT draw a white background rectangle here.
        // We want the base to be transparent so 'destination-out' cuts to transparency.

        // 2. Draw Elements
        elements.forEach(el => {
            // A. Setup Style for this element
            ctx.lineWidth = el.size;
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';

            // B. Handle Line Styles (Dashed/Dotted)
            if (el.style === 'dashed') ctx.setLineDash([15, 10]);
            else if (el.style === 'dotted') ctx.setLineDash([3, 8]);
            else ctx.setLineDash([]);

            // C. CRITICAL: Handle Eraser Mode vs Drawing Mode
            if (el.isEraser) {
                // "destination-out" removes existing pixels where we draw
                ctx.globalCompositeOperation = 'destination-out';
                ctx.strokeStyle = "rgba(0,0,0,1)"; // Color is irrelevant, only Alpha matters
                ctx.fillStyle = "rgba(0,0,0,1)";
            } else {
                // "source-over" is standard drawing on top
                ctx.globalCompositeOperation = 'source-over';
                ctx.strokeStyle = el.color;
                ctx.fillStyle = el.fill || 'transparent';
            }

            ctx.beginPath();

            // --- D. DRAWING PATHS ---
            if (el.type === 'brush' || el.type === 'rub_stroke') {
                if (el.points.length > 0) {
                    ctx.moveTo(el.points[0].x, el.points[0].y);
                    el.points.forEach(p => ctx.lineTo(p.x, p.y));

                    // Important: Fill is mostly for shapes, Stroke is for lines
                    ctx.stroke();
                }
            }
            else if (el.type === 'line') {
                ctx.moveTo(el.x, el.y);
                ctx.lineTo(el.endX, el.endY);
                ctx.stroke();
            }
            else if (el.type === 'arrow') {
                drawArrow(ctx, el.x, el.y, el.endX, el.endY, el.size);
            }
            else if (el.type === 'rect') {
                ctx.rect(el.x, el.y, el.w, el.h);
                if (el.fill) ctx.fill();
                ctx.stroke();
                if (el.text) drawTextCenter(ctx, el.text, el.x + el.w / 2, el.y + el.h / 2, el.size);
            }
            else if (el.type === 'triangle') {
                ctx.beginPath();
                ctx.moveTo(el.x + el.w / 2, el.y);
                ctx.lineTo(el.x, el.y + el.h);
                ctx.lineTo(el.x + el.w, el.y + el.h);
                ctx.closePath();
                if (el.fill) ctx.fill();
                ctx.stroke();
            }
            else if (el.type === 'circle') {
                ctx.beginPath();
                ctx.arc(el.x, el.y, el.r, 0, 2 * Math.PI);
                if (el.fill) ctx.fill();
                ctx.stroke();
                if (el.text) drawTextCenter(ctx, el.text, el.x, el.y, el.size);
            }
            else if (el.type === 'text') {
                // Text needs standard blending always
                ctx.globalCompositeOperation = 'source-over';
                ctx.font = (el.size * 3) + "px Arial";
                ctx.fillStyle = el.color;
                ctx.fillText(el.text || "", el.x, el.y);
            }

            // Reset for next loop iteration
            // This is important because 'destination-out' is sticky
            ctx.globalCompositeOperation = 'source-over';

        });

        // 3. Draw Selection Box (Always on top)
        if (selectedElement) {
            ctx.globalCompositeOperation = 'source-over';
            ctx.strokeStyle = "#3b82f6";
            ctx.lineWidth = 2 / camera.z;
            ctx.setLineDash([5, 5]);

            let b = getBounds(selectedElement);
            if (b) {
                ctx.strokeRect(b.x - 5, b.y - 5, b.w + 10, b.h + 10);
                ctx.fillStyle = "#3b82f6";
                ctx.fillRect(b.x + b.w - 5, b.y + b.h - 5, 10, 10);
            }
        }

        ctx.restore();
    }
    // Helper: Draw Arrow
    function drawArrow(ctx, fromx, fromy, tox, toy, width) {
        const headlen = width * 5;
        const dx = tox - fromx;
        const dy = toy - fromy;
        const angle = Math.atan2(dy, dx);

        ctx.moveTo(fromx, fromy);
        ctx.lineTo(tox, toy);
        ctx.stroke();

        ctx.beginPath();
        ctx.moveTo(tox, toy);
        ctx.lineTo(tox - headlen * Math.cos(angle - Math.PI / 6), toy - headlen * Math.sin(angle - Math.PI / 6));
        ctx.lineTo(tox - headlen * Math.cos(angle + Math.PI / 6), toy - headlen * Math.sin(angle + Math.PI / 6));
        ctx.lineTo(tox, toy);
        ctx.fillStyle = ctx.strokeStyle;
        ctx.fill();
    }

    function drawTextCenter(ctx, text, x, y, size) {
        if (!text) return;
        ctx.fillStyle = "black";
        ctx.font = ((size || 20) * 0.8) + "px Arial"; // Relative font size
        ctx.textAlign = "center";
        ctx.textBaseline = "middle";
        ctx.fillText(text, x, y);
    }
    /* ==========================================
       HELPER: GET BOUNDING BOX (Fixed for Brush/Rubber)
       ========================================== */
    function getBounds(el) {
        if (!el) return null;

        // 1. RECT / TRIANGLE
        if (el.type === 'rect' || el.type === 'triangle') {
            return { x: el.x, y: el.y, w: el.w, h: el.h };
        }

        // 2. CIRCLE
        if (el.type === 'circle') {
            return { x: el.x - el.r, y: el.y - el.r, w: el.r * 2, h: el.r * 2 };
        }

        // 3. TEXT
        if (el.type === 'text') {
            ctx.font = (el.size * 3) + "px Arial";
            const width = ctx.measureText(el.text || "").width;
            return { x: el.x, y: el.y - (el.size * 3), w: width, h: (el.size * 3) };
        }

        // 4. LINE / ARROW
        if (el.type === 'line' || el.type === 'arrow') {
            let minX = Math.min(el.x, el.endX), maxX = Math.max(el.x, el.endX);
            let minY = Math.min(el.y, el.endY), maxY = Math.max(el.y, el.endY);
            return { x: minX, y: minY, w: maxX - minX, h: maxY - minY };
        }

        // 5. BRUSH / RUBBER STROKE (The Fix!)
        if (el.type === 'brush' || el.type === 'rub_stroke') {
            if (!el.points || el.points.length === 0) return null;

            let minX = Infinity, maxX = -Infinity, minY = Infinity, maxY = -Infinity;

            el.points.forEach(p => {
                if (p.x < minX) minX = p.x;
                if (p.x > maxX) maxX = p.x;
                if (p.y < minY) minY = p.y;
                if (p.y > maxY) maxY = p.y;
            });

            // Add the stroke width padding so we catch the edges
            const padding = (el.size || 10) / 2;

            return {
                x: minX - padding,
                y: minY - padding,
                w: (maxX - minX) + (padding * 2),
                h: (maxY - minY) + (padding * 2)
            };
        }

        return null;
    }
    // ================= INTERACTION HANDLERS =================
    const getPos = (e) => {
        const rect = canvas.getBoundingClientRect();
        let cx, cy;
        if (e.touches && e.touches.length > 0) { cx = e.touches[0].clientX; cy = e.touches[0].clientY; }
        else if (e.changedTouches && e.changedTouches.length > 0) { cx = e.changedTouches[0].clientX; cy = e.changedTouches[0].clientY; }
        else { cx = e.clientX; cy = e.clientY; }

        // Return raw screen coordinates here, convert to world later
        return { x: cx - rect.left, y: cy - rect.top };
    };

    // --- HELPER: HIT TEST (Improved Tolerance) ---
    function isHit(el, x, y) {
        const TOLERANCE = 10 / camera.z; // 10px buffer, adjusted for zoom

        // 1. Brush / Rubber Strokes
        if (el.type === 'brush' || el.type === 'rub_stroke') {
            // Check distance to any point in the path
            return el.points.some(p => Math.hypot(p.x - x, p.y - y) < (el.size + TOLERANCE));
        }

        // 2. Lines / Arrows
        if (el.type === 'line' || el.type === 'arrow') {
            // Distance from point to line segment formula
            const A = x - el.x;
            const B = y - el.y;
            const C = el.endX - el.x;
            const D = el.endY - el.y;
            const dot = A * C + B * D;
            const len_sq = C * C + D * D;
            let param = -1;
            if (len_sq !== 0) param = dot / len_sq;

            let xx, yy;
            if (param < 0) { xx = el.x; yy = el.y; }
            else if (param > 1) { xx = el.endX; yy = el.endY; }
            else { xx = el.x + param * C; yy = el.y + param * D; }

            const dist = Math.hypot(x - xx, y - yy);
            return dist < (el.size + TOLERANCE);
        }

        // 3. Shapes (Rect/Circle) - Check if inside OR on edge
        const b = getBounds(el);
        if (!b) return false;

        // Simple Box check with Tolerance
        return (x >= b.x - TOLERANCE && x <= b.x + b.w + TOLERANCE &&
            y >= b.y - TOLERANCE && y <= b.y + b.h + TOLERANCE);
    }
    // --- INTERACTION STATE UPDATES ---
    let isPinching = false;
    let startPinchDist = 0;
    let startZoomLevel = 1;
    let startPinchCenter = { x: 0, y: 0 }; // Track where we started pinching

    // --- TOUCH STATE ---
    let pinchStartWorld = { x: 0, y: 0 }; // The anchor point in World Coords

    const handleStart = (e) => {
        // 1. PINCH ZOOM START
        if (e.touches && e.touches.length === 2) {
            e.preventDefault();
            if (isDrawing) { elements.pop(); isDrawing = false; }
            isPinching = true;
            isDragging = false;
            isPanning = false;
            startPinchDist = getTouchDistance(e);
            startZoomLevel = camera.z;
            startPinchCenter = getTouchCenter(e);
            pinchStartWorld = toWorld(startPinchCenter.x, startPinchCenter.y);
            return;
        }

        if (e.type === 'touchstart') e.preventDefault();
        const screenPos = getPos(e);
        const worldPos = toWorld(screenPos.x, screenPos.y);

        startX = worldPos.x;
        startY = worldPos.y;
        lastX = worldPos.x;
        lastY = worldPos.y;
        lastTime = Date.now();

        // 2. ERASER LOGIC (Object or Rubber)
        if (isEraserActive) {
            if (eraserMode === 'object') {
                // OBJECT ERASER
                let hitIndex = -1;
                for (let i = elements.length - 1; i >= 0; i--) {
                    // Ignore "Eraser Strokes" so we don't accidentally delete the hole
                    if (!elements[i].isEraser && isHit(elements[i], startX, startY)) {
                        hitIndex = i;
                        break;
                    }
                }

                if (hitIndex !== -1) {
                    saveToHistory(); // Save before delete
                    elements.splice(hitIndex, 1);
                    renderScene();
                }
            }
            else if (eraserMode === 'rub') {
                saveToHistory(); // Save before rubbing
                isDrawing = true;
                let baseSize = parseInt(document.getElementById('eraserSizeSlider')?.value) || 20;
                elements.push({
                    type: 'rub_stroke',
                    isEraser: true, // Invisible flag
                    points: [{ x: startX, y: startY }],
                    size: baseSize,
                    color: 'white'
                });
            }
            return;
        }

        // 3. SELECT / PAN TOOL (Updated)
        if (currentTool === 'select') {
            let hitFound = false;
            attachedErasers = []; // Reset sticky list

            for (let i = elements.length - 1; i >= 0; i--) {
                const el = elements[i];

                // A. Skip Erasers (Can't select a hole directly)
                if (el.isEraser) continue;

                // B. ✅ NEW: Skip Pencil/Brush Drawings (Make them unselectable)
                if (el.type === 'brush') continue;

                // C. Check Hit
                if (isHit(el, startX, startY)) {
                    hitFound = true;
                    selectedElement = el;

                    // D. ✅ STICKY LOGIC: Find erasers attached to THIS object
                    // This ensures holes move with the shape
                    elements.forEach(otherEl => {
                        if (otherEl.isEraser && areOverlapping(selectedElement, otherEl)) {
                            attachedErasers.push(otherEl);
                        }
                    });

                    // Update UI Sliders
                    if (selectedElement.size) {
                        const slider = document.getElementById('strokeSize');
                        if (slider) slider.value = selectedElement.size;
                    }
                    if (selectedElement.color) {
                        const picker = document.getElementById('mainColor');
                        if (picker) picker.value = selectedElement.color;
                    }

                    // Resize vs Move Logic
                    const b = getBounds(selectedElement);
                    if (b && Math.abs(startX - (b.x + b.w)) < (20 / camera.z) && Math.abs(startY - (b.y + b.h)) < (20 / camera.z)) {
                        isResizing = true;
                        saveToHistory();
                    } else {
                        isDragging = true;
                        saveToHistory();
                    }
                    break;
                }
            }

            if (!hitFound) {
                selectedElement = null;
                attachedErasers = [];
                isPanning = false;
                canvas.style.cursor = 'default';
            }
            renderScene();
            return;
        }

        // 4. DRAWING
        isDrawing = true;
        redoStack = [];

        saveToHistory();

        let color = document.getElementById('mainColor').value;
        let sizeInput = document.getElementById('pencilSize');
        let sliderInput = document.getElementById('strokeSize');
        let size = parseInt(sizeInput?.value) || parseInt(sliderInput?.value) || 3;
        let style = document.getElementById('lineStyle')?.value || 'solid';
        let isParallel = document.getElementById('parallelToggle')?.checked;

        let newEl = { type: currentTool, color, size, style, x: startX, y: startY };

        if (currentTool === 'brush') {
            newEl.points = [{ x: startX, y: startY }];
        } else if (['line', 'arrow'].includes(currentTool)) {
            newEl.endX = startX; newEl.endY = startY;
        } else if (['rect', 'triangle'].includes(currentTool)) {
            newEl.w = 0; newEl.h = 0; newEl.text = "";
        } else if (currentTool === 'circle') {
            newEl.r = 0; newEl.text = "";
        }

        elements.push(newEl);

        if (isParallel && ['line', 'brush'].includes(currentTool)) {
            let dist = parseInt(document.getElementById('parallelDist')?.value) || 20;
            let parallelEl = JSON.parse(JSON.stringify(newEl));
            parallelEl.x += dist;
            parallelEl.y += dist;
            if (parallelEl.endX !== undefined) { parallelEl.endX += dist; parallelEl.endY += dist; }
            if (parallelEl.points) { parallelEl.points = parallelEl.points.map(p => ({ x: p.x + dist, y: p.y + dist })); }
            parallelEl.isGhost = true;
            elements.push(parallelEl);
        }
    };
    // --- HELPER: CHECK OVERLAP ---
    function areOverlapping(el1, el2) {
        const b1 = getBounds(el1);
        const b2 = getBounds(el2);

        if (!b1 || !b2) return false;

        // Standard Bounding Box Intersection Check
        return !(b2.x > b1.x + b1.w ||
            b2.x + b2.w < b1.x ||
            b2.y > b1.y + b1.h ||
            b2.y + b2.h < b1.y);
    }
    const handleMove = (e) => {
        if (e.type === 'touchmove') e.preventDefault();

        // 1. PINCH ZOOM MOVE (SMART ZOOM)
        if (isPinching && e.touches && e.touches.length === 2) {
            const currentDist = getTouchDistance(e);
            const currentCenter = getTouchCenter(e); // Center moves slightly as fingers move

            const scaleFactor = currentDist / startPinchDist;
            const newZoom = startZoomLevel * scaleFactor;

            // Use the smart zoom function with the pinch center
            zoomToPoint(newZoom, currentCenter.x, currentCenter.y);
            return;
        }

        const screenPos = getPos(e);
        const worldPos = toWorld(screenPos.x, screenPos.y);
        const dx = worldPos.x - startX;
        const dy = worldPos.y - startY;

        // 2. PANNING
        if (isPanning) {
            camera.x += (screenPos.x - lastX);
            camera.y += (screenPos.y - lastY);
            lastX = screenPos.x;
            lastY = screenPos.y;
            renderScene();
            return;
        }
        // 3. RUBBING ERASER (Dynamic Size)
        if (isEraserActive && eraserMode === 'rub' && isDrawing) {
            const now = Date.now();
            const dt = now - lastTime;
            const dist = Math.hypot(worldPos.x - lastX, worldPos.y - lastY);
            const speed = dist / (dt || 1); // Pixels per ms

            // Calculate dynamic size
            const baseSize = parseInt(document.getElementById('eraserSizeSlider')?.value) || 20;
            const speedFactor = Math.min(speed * SPEED_SENSITIVITY, 4.0);
            const dynamicSize = Math.min(baseSize * (1 + speedFactor), MAX_ERASER_SIZE);

            const activeEraser = elements[elements.length - 1];
            activeEraser.points.push({ x: worldPos.x, y: worldPos.y });

            // Update size to max reached
            if (dynamicSize > activeEraser.size) {
                activeEraser.size = dynamicSize;
            }

            lastX = worldPos.x;
            lastY = worldPos.y;
            lastTime = now;

            renderScene();
            return;
        }

        // 4. MANIPULATION
        if (currentTool === 'select' && selectedElement) {
            if (isDragging) {
                // A. Move the Main Object
                if (selectedElement.type === 'brush') {
                    selectedElement.points.forEach(p => { p.x += dx; p.y += dy; });
                } else if (['line', 'arrow'].includes(selectedElement.type)) {
                    selectedElement.x += dx; selectedElement.y += dy;
                    selectedElement.endX += dx; selectedElement.endY += dy;
                } else {
                    selectedElement.x += dx; selectedElement.y += dy;
                }

                // ✅ B. Move Attached Erasers (Sticky Effect)
                attachedErasers.forEach(eraser => {
                    // Erasers are always type 'rub_stroke' (which is basically a brush)
                    if (eraser.points) {
                        eraser.points.forEach(p => { p.x += dx; p.y += dy; });
                    }
                });

                startX = worldPos.x; startY = worldPos.y;
                renderScene();
            }
            else if (isResizing) {
                // ... (Keep your existing resizing logic) ...
                if (['rect', 'triangle'].includes(selectedElement.type)) {
                    selectedElement.w = worldPos.x - selectedElement.x;
                    selectedElement.h = worldPos.y - selectedElement.y;
                } else if (selectedElement.type === 'circle') {
                    selectedElement.r = Math.sqrt((worldPos.x - selectedElement.x) ** 2 + (worldPos.y - selectedElement.y) ** 2);
                } else if (['line', 'arrow'].includes(selectedElement.type)) {
                    selectedElement.endX = worldPos.x;
                    selectedElement.endY = worldPos.y;
                }
                renderScene();
            }
            return;
        }
        // 4. DRAWING
        if (!isDrawing) return;

        let activeEls = [elements[elements.length - 1]];
        if (elements.length > 1 && elements[elements.length - 1].isGhost) {
            activeEls.push(elements[elements.length - 2]);
        }

        activeEls.forEach((activeEl) => {
            let currX = worldPos.x;
            let currY = worldPos.y;

            if (activeEl.isGhost) {
                let dist = parseInt(document.getElementById('parallelDist').value) || 20;
                currX += dist; currY += dist;
            }

            if (activeEl.type === 'brush') {
                activeEl.points.push({ x: currX, y: currY });
            } else if (['line', 'arrow'].includes(activeEl.type)) {
                activeEl.endX = currX; activeEl.endY = currY;
            } else if (['rect', 'triangle'].includes(activeEl.type)) {
                activeEl.w = currX - startX;
                activeEl.h = currY - startY;
            } else if (activeEl.type === 'circle') {
                activeEl.r = Math.sqrt(Math.pow(currX - startX, 2) + Math.pow(currY - startY, 2));
            }
        });

        renderScene();
    };

    const handleEnd = (e) => {
        if (e.type === 'touchend') e.preventDefault();

        // Reset States
        isPinching = false;
        isDrawing = false;
        isDragging = false;
        isResizing = false;
        isPanning = false;

        if (currentTool === 'select') canvas.style.cursor = 'grab';

        elements.forEach(el => delete el.isGhost);

        if (currentTool === 'text' && !isDragging && !isPinching) {
            addText(startX, startY);
        }
    };

    // ================= TEXT HANDLING (FIXED) =================
    function addText(x, y) {
        if (isPromptOpen) return;
        isPromptOpen = true;

        setTimeout(() => {
            const text = prompt("Enter text:", "");
            if (text && text.trim() !== "") {
                const color = document.getElementById('mainColor').value;
                const size = parseInt(document.getElementById('strokeSize').value);
                // Default size if slider is too small for text
                const finalSize = size < 10 ? 12 : size;

                elements.push({
                    type: 'text',
                    text: text,
                    x: x, y: y,
                    color: color,
                    size: finalSize
                });
                redoStack = []; // Clear redo
                renderScene();
            }
            isPromptOpen = false;
        }, 100);
    }

    // Double click to edit text
    if (canvas) {
        canvas.addEventListener('dblclick', (e) => {
            const screenPos = getPos(e);
            const worldPos = toWorld(screenPos.x, screenPos.y);

            for (let i = elements.length - 1; i >= 0; i--) {
                if (isHit(elements[i], worldPos.x, worldPos.y)) {
                    const el = elements[i];
                    if (el.type !== 'text') continue;

                    if (isPromptOpen) return;
                    isPromptOpen = true;

                    setTimeout(() => {
                        const newText = prompt("Edit Text:", el.text || "");
                        if (newText !== null) {
                            el.text = newText;
                            renderScene();
                        }
                        isPromptOpen = false;
                    }, 100);
                    return;
                }
            }
        });

        // LISTENERS
        canvas.addEventListener('mousedown', handleStart);
        canvas.addEventListener('mousemove', handleMove);
        canvas.addEventListener('mouseup', handleEnd);

        canvas.addEventListener('touchstart', handleStart, { passive: false });
        canvas.addEventListener('touchmove', handleMove, { passive: false });
        canvas.addEventListener('touchend', handleEnd, { passive: false });

        // Key shortcuts
        window.addEventListener('keydown', (e) => {
            if (sketchModal.classList.contains('hidden')) return;
            if (e.key === 'Delete') triggerClearSketch();
            if (e.ctrlKey && e.key === 'c') copyShape();
            if (e.ctrlKey && e.key === 'v') pasteShape();
            if (e.ctrlKey && e.key === 'z') undoSketch();
            if (e.ctrlKey && e.key === 'y') redoSketch();
        });
        // Mouse Wheel Zoom
        canvas.addEventListener('wheel', (e) => {
            e.preventDefault();

            const rect = canvas.getBoundingClientRect();
            const mouseX = e.clientX - rect.left;
            const mouseY = e.clientY - rect.top;

            // Determine zoom direction
            const zoomIntensity = 0.1;
            const delta = e.deltaY < 0 ? zoomIntensity : -zoomIntensity;

            // Call smart zoom
            zoomToPoint(camera.z + delta, mouseX, mouseY);
        }, { passive: false });
    }

    // --- HELPER FUNCTIONS ---

    // Distance between two fingers
    function getTouchDistance(e) {
        return Math.hypot(
            e.touches[0].clientX - e.touches[1].clientX,
            e.touches[0].clientY - e.touches[1].clientY
        );
    }

    // Center point between two fingers (Screen Coordinates)
    function getTouchCenter(e) {
        const rect = canvas.getBoundingClientRect();
        return {
            x: ((e.touches[0].clientX + e.touches[1].clientX) / 2) - rect.left,
            y: ((e.touches[0].clientY + e.touches[1].clientY) / 2) - rect.top
        };
    }
    /* =========================
       CORE: SAVE SKETCH (Direct Update)
    ========================= */
    function saveSketchModal() {
        if (!activeSketchPath) return;

        // IF CANVAS IS EMPTY: The user wants to remove the existing sketch
        if (elements.length === 0) {
            // 1. Explicitly null out the data so the backend sees the deletion signal
            if (!formState.images) formState.images = {};
            formState.images[activeSketchPath] = "";

            if (!formState.vectors) formState.vectors = {};
            formState.vectors[activeSketchPath] = [];

            // 2. Hide the thumbnail preview
            const safeId = activeSketchPath.replace(/\./g, '_');
            const imgElement = document.getElementById(`img_preview_${safeId}`);
            if (imgElement) {
                imgElement.src = "";
                imgElement.classList.add('hidden');
            }

            saveLocal();
            closeSketchModal();

            // 3. Trigger a save to the server immediately (HEAVY SAVE)
            // This sends the empty strings to trigger the Python delete logic above
            saveToServer(true);
            return;
        }
        // --- CROP LOGIC (Keep exactly as is) ---
        let minX = Infinity, maxX = -Infinity, minY = Infinity, maxY = -Infinity;
        elements.forEach(el => {
            if (el.type === 'brush') { el.points.forEach(p => { minX = Math.min(minX, p.x); minY = Math.min(minY, p.y); maxX = Math.max(maxX, p.x); maxY = Math.max(maxY, p.y); }); }
            else if (['line', 'arrow'].includes(el.type)) { minX = Math.min(minX, el.x, el.endX); minY = Math.min(minY, el.y, el.endY); maxX = Math.max(maxX, el.x, el.endX); maxY = Math.max(maxY, el.y, el.endY); }
            else if (el.type === 'circle') { minX = Math.min(minX, el.x - el.r); minY = Math.min(minY, el.y - el.r); maxX = Math.max(maxX, el.x + el.r); maxY = Math.max(maxY, el.y + el.r); }
            else { const w = el.w || 0; const h = el.h || 0; minX = Math.min(minX, el.x); minY = Math.min(minY, el.y); maxX = Math.max(maxX, el.x + w); maxY = Math.max(maxY, el.y + h); }
        });
        const padding = 20;
        const cropWidth = (maxX - minX) + (padding * 2);
        const cropHeight = (maxY - minY) + (padding * 2);
        const prevCanvasWidth = canvas.width;
        const prevCanvasHeight = canvas.height;
        const prevCamera = { ...camera };
        canvas.width = cropWidth;
        canvas.height = cropHeight;
        camera = { x: -minX + padding, y: -minY + padding, z: 1 };
        renderScene();
        canvas.width = prevCanvasWidth;
        canvas.height = prevCanvasHeight;
        camera = prevCamera;
        renderScene();
        // --- END CROP ---

        // 2. CREATE FINAL COMPOSITE (Flatten transparency to white)
        const tempCanvas = document.createElement('canvas');
        tempCanvas.width = canvas.width;
        tempCanvas.height = canvas.height;
        const tCtx = tempCanvas.getContext('2d');

        // A. Fill White Background
        tCtx.fillStyle = "white";
        tCtx.fillRect(0, 0, tempCanvas.width, tempCanvas.height);

        // B. Draw the Main Canvas on top
        tCtx.drawImage(canvas, 0, 0);

        // 3. Get Data URL from the flattened canvas
        const dataUrl = tempCanvas.toDataURL('image/png');

        // Restore
        canvas.width = prevCanvasWidth;
        canvas.height = prevCanvasHeight;
        camera = prevCamera;
        renderScene();

        // Save Data
        if (!formState.images) formState.images = {};
        formState.images[activeSketchPath] = dataUrl;
        if (!formState.vectors) formState.vectors = {};
        formState.vectors[activeSketchPath] = JSON.parse(JSON.stringify(elements));

        // ✅ FORCE UPDATE UI IMMEDIATELY
        renderAllSavedImages();

        saveLocal();
        closeSketchModal();
        updateCompletionStats();
        // ✅ NEW: Trigger an immediate database save the moment they close the pad
        clearTimeout(autoSaveTimer);

        // Only save to DB if we have passed the 20% threshold
        const currentPercent = (formState.completion_metrics && formState.completion_metrics.percent) || 0;
        if (currentPercent >= 20) {
            saveToServer();
        }
    }
    /* ==========================================
       HELPER: CALCULATE 'FIT TO CONTENT' VIEW
       ========================================== */
    function fitCameraToContent() {
        if (elements.length === 0) return { x: 0, y: 0, z: 1 };

        let minX = Infinity, minY = Infinity, maxX = -Infinity, maxY = -Infinity;

        // 1. Loop through all elements to find edges
        elements.forEach(el => {
            if (el.type === 'brush') {
                el.points.forEach(p => {
                    minX = Math.min(minX, p.x); minY = Math.min(minY, p.y);
                    maxX = Math.max(maxX, p.x); maxY = Math.max(maxY, p.y);
                });
            }
            else if (['line', 'arrow'].includes(el.type)) {
                minX = Math.min(minX, el.x, el.endX); minY = Math.min(minY, el.y, el.endY);
                maxX = Math.max(maxX, el.x, el.endX); maxY = Math.max(maxY, el.y, el.endY);
            }
            else if (el.type === 'circle') {
                minX = Math.min(minX, el.x - el.r); minY = Math.min(minY, el.y - el.r);
                maxX = Math.max(maxX, el.x + el.r); maxY = Math.max(maxY, el.y + el.r);
            }
            else {
                // Rect, Triangle, Text
                const w = el.w || 0; const h = el.h || 0;
                minX = Math.min(minX, el.x); minY = Math.min(minY, el.y);
                maxX = Math.max(maxX, el.x + w); maxY = Math.max(maxY, el.y + h);
            }
        });

        // 2. Add padding so it looks nice (50px margin)
        const padding = 50;
        const contentW = (maxX - minX) + (padding * 2);
        const contentH = (maxY - minY) + (padding * 2);

        // 3. Calculate Scale to fit
        const scaleX = canvas.width / contentW;
        const scaleY = canvas.height / contentH;
        let newZoom = Math.min(scaleX, scaleY);

        // Optional: Prevent zooming IN (only zoom out if drawing is huge)
        if (newZoom > 1) newZoom = 1;

        // 4. Center the Camera
        const centerX = (minX + maxX) / 2;
        const centerY = (minY + maxY) / 2;

        const newX = (canvas.width / 2) - (centerX * newZoom);
        const newY = (canvas.height / 2) - (centerY * newZoom);

        return { x: newX, y: newY, z: newZoom };
    }

    function cleanPayload(obj) {
        // If null or not an object, return as is
        if (obj === null || typeof obj !== 'object') {
            return obj;
        }

        // Handle Arrays
        if (Array.isArray(obj)) {
            const cleanedArray = obj
                .map(item => cleanPayload(item))
                .filter(item => item !== "" && item !== null && item !== undefined);
            return cleanedArray.length > 0 ? cleanedArray : undefined;
        }

        // Handle Objects
        const cleanedObj = {};
        let hasData = false;

        for (const key in obj) {
            if (Object.prototype.hasOwnProperty.call(obj, key)) {
                const value = cleanPayload(obj[key]);

                // Keep value if it is not empty string, null, or undefined
                if (value !== "" && value !== null && value !== undefined) {
                    // If it's an object (and not array), check if it has keys
                    if (typeof value === 'object' && !Array.isArray(value) && Object.keys(value).length === 0) {
                        continue;
                    }
                    cleanedObj[key] = value;
                    hasData = true;
                }
            }
        }

        return hasData ? cleanedObj : undefined;
    }
    /* =========================
       9. DATA SYNC & SUBMISSION
    ========================= */
    function updateNestedState(obj, path, value) {
        if (!path) return;
        const keys = path.split('.');
        let current = obj;
        for (let i = 0; i < keys.length - 1; i++) {
            if (!current[keys[i]]) current[keys[i]] = {};
            current = current[keys[i]];
        }
        current[keys[keys.length - 1]] = value;
    }

    function getNestedValue(obj, path) {
        if (!path) return undefined;
        return path.split('.').reduce((acc, part) => (acc && acc[part] !== undefined) ? acc[part] : undefined, obj);
    }

    function updateArrayState(obj, path, value, isChecked) {
        if (!path) return;
        const keys = path.split('.');
        let current = obj;
        for (let i = 0; i < keys.length - 1; i++) {
            if (!current[keys[i]]) current[keys[i]] = {};
            current = current[keys[i]];
        }
        const lastKey = keys[keys.length - 1];
        if (!Array.isArray(current[lastKey])) current[lastKey] = [];
        if (isChecked) { if (!current[lastKey].includes(value)) current[lastKey].push(value); }
        else { current[lastKey] = current[lastKey].filter(v => v !== value); }
    }

    /* =========================
       9. DATA SYNC & SUBMISSION
    ========================= */
    async function saveToServer() {
        // 1. Ensure folder exists
        if (!currentFolder || currentFolder === "") currentFolder = "Drafts";

        // 2. Clone the state
        const payload = JSON.parse(JSON.stringify(formState));

        // 🚨 THE FIX: We completely removed the line that deleted payload.images and payload.vectors.
        // Now, every time the form saves, the sketches go with it safely.

        payload.target_folder = currentFolder;

        try {
            const response = await fetch('/coreapi/api/auto-save/', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrftoken },
                body: JSON.stringify({ folder_path: currentFolder, payload: payload })
            });

            const res = await response.json();
            if (res.success) {
                if (res.report_id) formState.report_id = res.report_id;

                if (res.new_folder_path) {
                    // Auto-switched to the correct indexed folder
                    currentFolder = res.new_folder_path;
                    formState.target_folder = res.new_folder_path;
                    localStorage.setItem('vadrida_active_folder', res.new_folder_path);

                    document.getElementById("topBannerPath").textContent = "/" + res.new_folder_path;
                    document.getElementById("currentPath").textContent = "/" + res.new_folder_path;
                    console.log("📂 Context auto-linked to correct folder.");
                }
            } else if (res.mismatch) {
                // 🛑 HANDLE REJECTION
                console.error("🚫 Save rejected: Office File No doesn't exist in system index.");
                // Optional: You could turn the input border red here
                const fileInp = document.querySelector('[data-path="Valuers_Checklist.Office_file_no"]');
                if (fileInp) fileInp.style.borderColor = "red";
            }
        } catch (err) {
            console.error("❌ Save Failed:", err);
        }
    }

    /* =========================
       UI SYNC (UPDATED: Clears Sketches Too)
    ========================= */
    function syncStateToUI() {
        // 1. Handle Text Inputs, Textareas, Selects, and RADIO BUTTONS
        document.querySelectorAll('[data-path]').forEach(el => {
            const val = getNestedValue(formState, el.getAttribute('data-path'));

            // Radio Buttons
            if (el.type === 'radio') {
                const savedValStr = (val !== undefined && val !== null) ? String(val).trim() : "";
                const inputValStr = String(el.value).trim();
                el.checked = (savedValStr === inputValStr);
            }
            // Checkboxes (Boolean)
            else if (el.type === 'checkbox' && !el.hasAttribute('data-array')) {
                el.checked = (val === true || val === "true" || val === el.value);
            }
            // Standard Inputs
            else {
                el.value = (val !== undefined && val !== null) ? val : "";
            }
        });

        // 2. Handle Arrays (Multiple Select Checkboxes)
        document.querySelectorAll('[data-array]').forEach(el => {
            const arr = getNestedValue(formState, el.getAttribute('data-array'));
            if (Array.isArray(arr) && arr.includes(el.value)) {
                el.checked = true;
            } else {
                el.checked = false;
            }
            toggleEncroachmentFields();
            toggleOwnershipNotes();
            toggleRailwayDistance();
        });

        // ✅ 3. NEW: Clear Sketch Thumbnails
        // This finds ALL images with IDs starting with "img_preview_"
        document.querySelectorAll('img[id^="img_preview_"]').forEach(img => {
            // Construct the original data path from the ID (reverse safeId logic)
            // e.g., img_preview_Sketch_main_layout -> Sketch.main_layout
            const safeId = img.id.replace('img_preview_', '');
            // We can't easily reverse "_" to "." perfectly if keys have underscores, 
            // so we check the `formState.images` object directly using the ID or fuzzy match.

            let hasImage = false;

            // Check exact match in formState.images
            // We need to iterate the images dictionary because the key format differs slightly
            if (formState.images) {
                // Look for any key that turns into this safeId
                const match = Object.keys(formState.images).find(key => key.replace(/\./g, '_') === safeId);

                if (match && formState.images[match]) {
                    img.src = formState.images[match];
                    img.classList.remove('hidden');
                    img.style.display = 'block';
                    hasImage = true;
                }
            }

            // If no image found in state, HIDE IT
            if (!hasImage) {
                img.src = "";
                img.classList.add('hidden');
                img.style.display = 'none';
            }
        });
        splitRentDurationToUI();
        // updatePanchayatList();   // 1. Load the list based on saved District
        togglePanchayatField();  // 2. Show/Hide box based on saved Local Body

        // 3. Restore the specific Panchayat selected (after list is re-generated)
        // const savedPanchayat = getNestedValue(formState, 'Survey.grama_panchayat');
        // if(savedPanchayat) {
        //     document.getElementById('panchayatSelect').value = savedPanchayat;
        // }
        updateCompletionStats();
        checkFileNumberForUpload();
    }
    /* ==========================================
       UPDATED: INJECT ICONS (Conditional Upload)
       ========================================== */
    function injectPencilIcons() {
        const textareas = document.querySelectorAll('textarea[data-path]');

        // Define which text fields are allowed to have Photo Uploads
        // You can add more paths to this array if needed later
        const uploadAllowList = [
            'Sketch.landmark_description'
        ];

        textareas.forEach(textarea => {
            if (textarea.parentElement.classList.contains('input-wrapper')) return;

            const path = textarea.getAttribute('data-path');
            const safeId = path.replace(/\./g, '_');

            // 1. Create Wrapper
            const wrapper = document.createElement('div');
            wrapper.className = 'input-wrapper';
            textarea.parentNode.insertBefore(wrapper, textarea);
            wrapper.appendChild(textarea);

            // 2. Create Icon Group
            const group = document.createElement('div');
            group.className = 'icon-group';

            // --- BUTTON A: SKETCH (Always Added) ---
            const sketchBtn = document.createElement('div');
            sketchBtn.className = 'action-icon sketch-btn';
            sketchBtn.innerHTML = '<i class="fas fa-pencil-alt"></i>';
            sketchBtn.title = "Draw Sketch";
            sketchBtn.onclick = (e) => {
                e.stopPropagation();
                openSketchPad(path);
            };
            group.appendChild(sketchBtn);

            // --- BUTTON B: UPLOAD (Conditional) ---
            // Only add this button if the current path is in our allow list
            if (uploadAllowList.includes(path)) {
                const uploadBtn = document.createElement('div');
                uploadBtn.className = 'action-icon upload-btn';
                uploadBtn.innerHTML = '<i class="fas fa-camera"></i>';
                uploadBtn.title = "Upload Image";

                const fileInput = document.createElement('input');
                fileInput.type = 'file';
                fileInput.accept = 'image/*';
                fileInput.style.display = 'none';

                uploadBtn.onclick = (e) => {
                    e.stopPropagation();
                    fileInput.click();
                };

                fileInput.onchange = (e) => {
                    if (e.target.files && e.target.files[0]) {
                        handleImageUpload(path, e.target.files[0]);
                    }
                };

                group.appendChild(uploadBtn);
                wrapper.appendChild(fileInput);
            }

            wrapper.appendChild(group);

            // 3. Create Thumbnail Preview logic (Same as before)
            let img = document.getElementById(`img_preview_${safeId}`);
            if (!img) {
                img = document.createElement('img');
                img.id = `img_preview_${safeId}`;
                img.className = 'sketch-thumb hidden';
                img.style.marginTop = '10px';
                img.style.maxHeight = '150px';
                img.style.borderRadius = '8px';
                img.style.border = '1px solid #e5e7eb';
                img.style.cursor = 'pointer';

                // Clicking preview always opens Sketch Pad (for viewing/editing)
                img.onclick = () => openSketchPad(path);

                wrapper.parentNode.insertBefore(img, wrapper.nextSibling);
            }
        });
    }
    // --- HELPER: HANDLE IMAGE UPLOAD ---
    function handleImageUpload(path, file) {
        const reader = new FileReader();

        reader.onload = (e) => {
            const base64String = e.target.result;

            // 1. Save to State
            if (!formState.images) formState.images = {};
            formState.images[path] = base64String;

            // 2. Update UI via Helper (Guarantees consistency)
            // 2. Update UI via Helper
            renderAllSavedImages();

            // 3. Update Progress (Uploading an image counts towards 20%)
            updateCompletionStats();
            const currentPercent = (formState.completion_metrics && formState.completion_metrics.percent) || 0;

            // 4. Trigger Instant Save
            saveLocal();
            clearTimeout(autoSaveTimer);

            if (currentPercent >= 20) {
                saveToServer();
            }
        };

        reader.readAsDataURL(file);
    }
    function renderSurveyColumns() {
        const headerRow = document.getElementById('surveyHeader');
        const bodyRows = document.querySelectorAll('#surveyBody tr');
        if (!headerRow) return;

        // Clear existing dynamic columns
        headerRow.querySelectorAll('.dyn-col').forEach(el => el.remove());
        bodyRows.forEach(row => row.querySelectorAll('.dyn-cell').forEach(el => el.remove()));

        const availableDocs = formState.Valuers_Checklist.documents_received || [];
        const surveyDocs = formState.Survey.docs || [];

        const landTypes = [
            { id: 'dry', label: 'Dry Land' },
            { id: 'wet', label: 'Wet Land' },
            { id: 'sthirapunja', label: 'Sthirapunja' },
            { id: 'asthirapunja', label: 'Asthirapunja' },
            { id: 'thottam', label: 'Thottam' },
            { id: 'others', label: 'Others' }
        ];
        surveyDocs.forEach((docObj, index) => {
            // 1. Render Header (Dropdown to select Doc Name)
            const th = document.createElement('th');
            th.className = 'dyn-col';
            th.style.minWidth = "150px";
            let optionsHtml = `<option value="">Select Doc</option>`;
            availableDocs.forEach(d => {
                const sel = (d === docObj.name) ? "selected" : "";
                optionsHtml += `<option value="${d}" ${sel}>${d}</option>`;
            });
            th.innerHTML = `<select class="form-select" style="width: 100%; color:black;" onchange="updateSurveyDocName(${index}, this.value)">${optionsHtml}</select>`;
            headerRow.appendChild(th);

            // 2. Render Body Cells
            bodyRows.forEach(row => {
                const key = row.getAttribute('data-row-key');
                if (key) {
                    const td = document.createElement('td');
                    td.className = 'dyn-cell';
                    const val = docObj[key] || '';

                    // --- LOGIC CHANGE STARTS HERE ---
                    let inputHtml = '';

                    if (key === 'land_classification') {
                        // Start Grid
                        inputHtml = `<table>`;

                        // Optional: Mini Headers inside the cell
                        inputHtml += `<tr><th style="z-index:auto;">Type</th><th>Area</th></tr>`;

                        // Loop through 6 types
                        landTypes.forEach(type => {
                            // Unique Keys: e.g., 'check_dry', 'area_dry'
                            const checkKey = `check_${type.id}`;
                            const areaKey = `area_${type.id}`;

                            // Get Values
                            const isChecked = docObj[checkKey] ? 'checked' : '';
                            const areaVal = docObj[areaKey] || '';

                            // CSS Grid Row using 'display: contents' logic from CSS above
                            inputHtml += `<tr><td style="z-index:auto">
                                    <input type="checkbox" ${isChecked} 
                                        onchange="updateSurveyDocData(${index}, '${checkKey}', this.checked)">
                                    ${type.label}
                                </td><td>
                                    <input type="text" class="lc-area-input" 
                                        placeholder="Area" 
                                        value="${areaVal}" 
                                        oninput="updateSurveyDocData(${index}, '${areaKey}', this.value)">
                                </td>
                            </tr>
                        `;
                        });

                        inputHtml += `</table>`; // End Grid
                    }
                    else if (key === 'land_extent') {
                        // Keep Text Input for Extent (as requested)
                        inputHtml = `<input type="text" class="table-input" value="${val}" oninput="updateSurveyDocData(${index}, '${key}', this.value)">`;
                    }
                    else {
                        // Number Input for everything else (Survey No, Block No, etc.)
                        inputHtml = `<input type="text" class="table-input" value="${val}" oninput="updateSurveyDocData(${index}, '${key}', this.value)">`;
                    }
                    // --- LOGIC CHANGE ENDS HERE ---

                    td.innerHTML = inputHtml;
                    row.appendChild(td);
                }
            });
        });
        calculateSurveyTotals();
        checkWetLandStatus();
    }

    /* =========================
       HELPER: Update Survey Data & Trigger Save
    ========================= */
    window.updateSurveyDocData = (index, key, value) => {
        // 1. Update the State Object
        if (!formState.Survey.docs[index]) formState.Survey.docs[index] = {};
        formState.Survey.docs[index][key] = value;
        if (key === 'land_extent')
            calculateSurveyTotals();
        checkWetLandStatus();
        saveLocal();
        clearTimeout(autoSaveTimer);
        autoSaveTimer = setTimeout(() => {
            saveToServer();
        }, SAVE_DELAY_MS);
    };
    /* =========================
       MISSING FUNCTION: Fixes Document Name Dropdown
    ========================= */
    window.updateSurveyDocName = (index, value) => {
        // 1. Update the 'name' property for this column
        if (!formState.Survey.docs[index]) formState.Survey.docs[index] = {};
        formState.Survey.docs[index].name = value;
        calculateSurveyTotals();
        checkWetLandStatus();

        // 2. Save immediately
        saveLocal();

        // 3. Trigger Auto-Save to Server
        clearTimeout(autoSaveTimer);
        autoSaveTimer = setTimeout(() => {
            saveToServer();
        }, SAVE_DELAY_MS);
    };


    function addSurveyColumn() {
        if (!formState.Survey.docs) formState.Survey.docs = [];
        formState.Survey.docs.push({ name: "", scedule_no: "" });
        renderSurveyColumns();
        saveLocal();
        updateCompletionStats();
    }

    function updateAllDocumentDropdowns() {
        // Always read from the source of truth: formState
        const docs = formState.Valuers_Checklist.documents_received || [];

        document.querySelectorAll('.dynamic-doc-dropdown').forEach(select => {
            // 1. Capture the current value (in case user just typed it before save)
            // BUT prioritize formState if we are loading.
            const path = select.getAttribute('data-path');
            const savedValue = getNestedValue(formState, path);

            // 2. Rebuild Options
            select.innerHTML = '<option value="">Select Document</option>';
            docs.forEach(docName => {
                const opt = document.createElement('option');
                opt.value = docName;
                opt.textContent = docName;
                select.appendChild(opt);
            });

            // 3. Restore Value
            // If we have a saved value in state, use it.
            if (savedValue && docs.includes(savedValue)) {
                select.value = savedValue;
            }
        });
    }
    // 2. Hybrid Input Listener
    document.getElementById('siteFeedbackForm').addEventListener('input', (e) => {
        const target = e.target;
        const path = target.getAttribute('data-path');
        const arrayPath = target.getAttribute('data-array');

        // A. Update State
        if (path) {
            updateNestedState(formState, path, target.value);
        } else if (arrayPath) {
            updateArrayState(formState, arrayPath, target.value, target.checked);

            // Update Dropdowns immediately when Documents Received changes
            if (arrayPath === 'Valuers_Checklist.documents_received') {
                updateAllDocumentDropdowns();
                renderSurveyColumns();
            }
        }

        // Recalculate progress immediately

        updateCompletionStats();
        if (e.target.getAttribute('data-path') === "Valuers_Checklist.Office_file_no") {
            checkFileNumberForUpload();
        }

        // ==========================================
        // B. THE 20% HANDOVER LOGIC (Dynamic Key)
        // ==========================================
        const currentPercent = (formState.completion_metrics && formState.completion_metrics.percent) || 0;
        const dynamicKey = getDraftKey(currentFolder);

        if (currentPercent < 20) {
            saveLocal();
            clearTimeout(autoSaveTimer);
        } else {
            // We hit 20%! Delete this specific draft from local storage and let DB take over.
            localStorage.removeItem(dynamicKey);
            clearTimeout(autoSaveTimer);
            autoSaveTimer = setTimeout(() => {
                saveToServer();
            }, SAVE_DELAY_MS);
        }
    });

    let pendingAction = null;
    const confirmModal = document.getElementById('confirmationModal');
    const confirmTitle = document.getElementById('confirmTitle');
    const confirmMessage = document.getElementById('confirmMessage');

    function showConfirm(title, message, actionCallback) {
        confirmTitle.textContent = title;
        confirmMessage.textContent = message;
        pendingAction = actionCallback;
        confirmModal.classList.remove('hidden');
    }

    document.getElementById('confirmNoBtn').onclick = () => {
        confirmModal.classList.add('hidden');
        pendingAction = null;
    };

    document.getElementById('confirmYesBtn').onclick = () => {
        if (pendingAction) pendingAction();
        confirmModal.classList.add('hidden');
    };

    // 1. TRIGGER SUBMIT
    document.getElementById('triggerSubmitBtn').onclick = (e) => {
        e.preventDefault();
        showConfirm(
            "Submit Report?",
            "Are you sure you want to submit this feedback? This cannot be undone.",
            performSubmit
        );
    };

    // 2. TRIGGER RESET
    document.getElementById('triggerResetBtn').onclick = (e) => {
        e.preventDefault();
        showConfirm(
            "Clear All Data?",
            "This will delete all your text, checkboxes, and sketches. Are you sure?",
            performReset
        );
    };

    async function performSubmit() {
        // 1. Validation: Basic Fields (Check BEFORE wiping anything!)
        const fileNo = getNestedValue(formState, 'Valuers_Checklist.Office_file_no');
        const applicant = getNestedValue(formState, 'Valuers_Checklist.applicant_name');

        if (!fileNo || !applicant || fileNo.toString().trim() === "" || applicant.toString().trim() === "") {
            alert("Error: You must provide an 'Office File No.' and 'Applicant Name' before submitting.");
            return;
        }

        // 2. Validation: Completion Percentage
        const currentPercent = (formState.completion_metrics && formState.completion_metrics.percent) || 0;

        if (currentPercent < 20) {
            alert(`Incomplete Report: Your completion status is only ${currentPercent}%. You need at least 20% to submit.`);
            return; // Stop execution
        }

        // 3. Save Sketch if open
        if (!document.getElementById('sketchModal').classList.contains('hidden')) {
            saveSketchModal();
        }

        try {
            const btn = document.getElementById('triggerSubmitBtn');
            const originalText = btn.textContent;
            btn.textContent = "Submitting...";
            btn.disabled = true;

            // 4. Prepare Payload
            let payload = JSON.parse(JSON.stringify(formState));
            payload.report_id = formState.report_id;
            payload.target_folder = currentFolder;

            if (payload.vectors) delete payload.vectors;
            payload = cleanPayload(payload);
            if (!payload) payload = {};

            // 5. Send Request
            const response = await fetch('/coreapi/api/save-feedback/', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrftoken },
                body: JSON.stringify({ payload })
            });

            if (!response.ok) {
                throw new Error(`Server Error: ${response.status} ${response.statusText}`);
            }

            const textResponse = await response.text();
            let res;
            try {
                res = JSON.parse(textResponse);
            } catch (jsonErr) {
                console.error("Server returned non-JSON response:", textResponse);
                throw new Error("Invalid server response. Data might be saved, but response was bad.");
            }

            if (res.success) {
                // ✅ NOW IT IS SAFE TO CLEAN UP!
                // 1. Erase the local storage for this case
                const dynamicKey = getDraftKey(currentFolder);
                localStorage.removeItem(dynamicKey);

                // 2. Wipe the JS memory
                formState = getEmptyState();

                // 3. Redirect the user
                window.location.href = res.redirect_url;
            } else {
                btn.textContent = originalText;
                btn.disabled = false;
                alert("Server reported error: " + res.error);
            }

        } catch (err) {
            console.error("Submit Failed:", err);
            const btn = document.getElementById('triggerSubmitBtn');
            if (btn) {
                btn.textContent = "Submit Feedback";
                btn.disabled = false;
            }
            alert("Submission Issue: " + err.message + "\n(Check Console for details)");
        }
    }
    // --- NEW DYNAMIC KEY GENERATOR ---
    function getDraftKey(folderPath) {
        if (!folderPath) return 'vadrida_draft_unknown';
        const folderName = folderPath.split('/').pop() || "";
        // Extract the leading file number (e.g., 0126010008)
        const match = folderName.match(/^(\d+)/);
        const fileNo = match ? match[1] : folderName;
        return `vadrida_draft_${fileNo}`;
    }

    // --- UPDATED SAVE LOCAL ---
    function saveLocal() {
        if (!currentFolder) return;
        const dynamicKey = getDraftKey(currentFolder);

        try {
            localStorage.setItem(dynamicKey, JSON.stringify(formState));
        } catch (e) {
            console.warn("Local Storage full. Stripping images...", e);
            try {
                const stateToSave = JSON.parse(JSON.stringify(formState));
                if (stateToSave.images) delete stateToSave.images;
                if (stateToSave.vectors) delete stateToSave.vectors;
                localStorage.setItem(dynamicKey, JSON.stringify(stateToSave));
            } catch (e2) {
                console.error("Critical: Could not save text backup.", e2);
            }
        }
    }
    async function performReset() {
        // 1. Reset the State Object to Blank Defaults
        formState = getEmptyState();

        // 2. Clear Local Storage (But keep folder location!)
        localStorage.removeItem(STORAGE_KEY);

        // 3. Update the UI Immediately (No Reload needed)
        syncStateToUI();              // Clears text boxes, radios, checkboxes
        initBuildingTable();          // Resets building table to default rows
        renderSurveyColumns();        // Resets survey table columns
        updateAllDocumentDropdowns(); // Resets dropdowns

        // Clear Timeline
        document.getElementById('finalConstructionString').value = "";
        parseTimelineString("");

        // Clear Sketch/Photo Previews
        document.querySelectorAll('img[id^="img_preview_"]').forEach(img => {
            img.src = "";
            img.classList.add('hidden');
            img.style.display = 'none';
        });
        // Show placeholders if any
        document.querySelectorAll('[id^="placeholder_"]').forEach(ph => {
            ph.classList.remove('hidden');
        });

        // 4. Force Save to Server
        // We send the 'formState' which is now full of empty strings.
        // This overwrites the database logic, ensuring the "Auto-Fill" doesn't triggers again.
        const btn = document.getElementById('triggerResetBtn');
        const originalText = btn.innerText;
        btn.innerText = "Clearing...";

        await saveToServer();

        btn.innerText = originalText;
        // No alert needed, the UI update is feedback enough
    }

    function copyAllDocsToSites(checkbox) {
        const directions = ['north', 'east', 'south', 'west'];
        const prefix = "Boundary_analysis_property_identification";

        if (checkbox.checked) {
            // --- CHECKED STATE: COPY VALUES ---
            directions.forEach(direction => {
                const doc1Input = document.querySelector(`input[data-path="${prefix}.${direction}_doc1"]`);
                const doc2Input = document.querySelector(`input[data-path="${prefix}.${direction}_doc2"]`);
                const siteInput = document.querySelector(`input[data-path="${prefix}.${direction}_site"]`);

                if (siteInput) {
                    const v1 = doc1Input ? doc1Input.value.trim() : "";
                    const v2 = doc2Input ? doc2Input.value.trim() : "";

                    let combinedValue = "";
                    if (v1 && v2) {
                        combinedValue = `${v1}, ${v2}`;
                    } else {
                        combinedValue = v1 || v2;
                    }

                    siteInput.value = combinedValue;

                    // Trigger Auto-Save
                    siteInput.dispatchEvent(new Event('input', { bubbles: true }));
                }
            });
        } else {
            // --- UNCHECKED STATE: CLEAR VALUES ---
            directions.forEach(direction => {
                const siteInput = document.querySelector(`input[data-path="${prefix}.${direction}_site"]`);

                if (siteInput) {
                    // Clear the value
                    siteInput.value = "";

                    // Trigger Auto-Save (so the empty state is saved)
                    siteInput.dispatchEvent(new Event('input', { bubbles: true }));
                }
            });
        }
    }

    // --- 1. CORE: Recalculate State ---
    function handlePercentInput(e) {
        const currentInput = e.target;
        let currentVal = parseFloat(currentInput.value);

        // STEP 1: If input is invalid/empty, just cleanup and STOP.
        // Do not try to auto-fill the next column yet.
        if (isNaN(currentVal) || currentVal <= 0) {
            // If this is the LAST column, just do nothing (let user type)
            // If this is NOT the last column, deleting it is tricky because focus might get lost.
            // Better approach: Just don't trigger the "add next column" logic.

            // However, we MUST clean up any columns *after* this one, 
            // because if I change 50 to 0, the next column (50) is now invalid logic.
            const allInputs = Array.from(document.querySelectorAll('.timeline-percent'));
            const currentIndex = allInputs.indexOf(currentInput);

            // Remove everything to the right immediately
            for (let i = allInputs.length - 1; i > currentIndex; i--) {
                removeColumnAtIndex(i);
            }

            updateTimelineString();
            return;
        }

        // STEP 2: Logic for Valid Inputs
        // Get fresh list of inputs after potential cleanups
        const allInputs = Array.from(document.querySelectorAll('.timeline-percent'));
        const currentIndex = allInputs.indexOf(currentInput);

        // Calculate sum UP TO this column
        let sumSoFar = 0;
        for (let i = 0; i < currentIndex; i++) {
            sumSoFar += parseFloat(allInputs[i].value) || 0;
        }

        // Cap at 100% logic
        if (sumSoFar + currentVal > 100) {
            currentVal = 100 - sumSoFar;
            currentInput.value = currentVal;
        }

        sumSoFar += currentVal;
        const remainder = 100 - sumSoFar;

        // STEP 3: Handle the Remainder
        // A. If 100% reached, delete everything to the right
        if (remainder <= 0) {
            for (let i = allInputs.length - 1; i > currentIndex; i--) {
                removeColumnAtIndex(i);
            }
        }
        // B. If there is remainder, FORCE the next column to match it
        else {
            // Is there already a next column?
            if (currentIndex + 1 < allInputs.length) {
                const nextInput = allInputs[currentIndex + 1];
                // Only update it if it's different (prevents cursor jumping issues sometimes)
                if (parseFloat(nextInput.value) !== remainder) {
                    nextInput.value = remainder;
                }
                // Ensure nothing exists after that neighbor
                for (let i = allInputs.length - 1; i > currentIndex + 1; i--) {
                    removeColumnAtIndex(i);
                }
            }
            // No next column? Create it (Max 5 limit)
            else if (allInputs.length < 5) {
                createColumnAtIndex(currentIndex + 1, remainder);
            }
        }

        updateTimelineString();
    }

    function createColumnAtIndex(index, percentVal = "", yearVal = "") {
        const rowPercent = document.getElementById('row_percent');
        const rowYear = document.getElementById('row_year');
        const controlCell = document.getElementById('controlCell');

        // 1. Create Year Input (Now on Top)
        const tdY = document.createElement('td');
        const inpY = document.createElement('input');
        inpY.type = "number";
        inpY.className = "table-input timeline-year";
        inpY.placeholder = "Year";
        inpY.value = yearVal;
        inpY.addEventListener('input', updateTimelineString);
        tdY.appendChild(inpY);

        // 2. Create Percent Input (Now on Bottom)
        const tdP = document.createElement('td');
        const inpP = document.createElement('input');
        inpP.type = "number";
        inpP.className = "table-input timeline-percent";
        inpP.placeholder = "%";
        inpP.value = percentVal;
        inpP.addEventListener('input', handlePercentInput);
        tdP.appendChild(inpP);

        // INSERTION LOGIC CHANGED:
        // Year row has the control button, so insert BEFORE it
        rowYear.insertBefore(tdY, controlCell);

        // Percent row has no control button anymore, so just APPEND
        rowPercent.appendChild(tdP);
    }

    // --- 3. DOM Helper: Remove Column ---
    function removeColumnAtIndex(index) {
        const rowPercent = document.getElementById('row_percent');
        const rowYear = document.getElementById('row_year');

        // rowYear children: [Label, Input, Input, Buttons]
        // rowPercent children: [Label, Input, Input]

        // Actual index in DOM is index + 1 (skipping the Label <td>)
        const domIndex = index + 1;

        // Remove Year Cell
        // Check if the element exists and is NOT the control cell (buttons)
        if (rowYear.children[domIndex] && !rowYear.children[domIndex].hasAttribute('rowspan')) {
            rowYear.children[domIndex].remove();
        }

        // Remove Percent Cell
        if (rowPercent.children[domIndex]) {
            rowPercent.children[domIndex].remove();
        }
    }
    // --- 4. Manual Buttons ---
    function manualAddColumn() {
        const allPercents = Array.from(document.querySelectorAll('.timeline-percent'));
        if (allPercents.length >= 5) { alert("Max 5 columns."); return; }

        let sum = 0;
        allPercents.forEach(p => sum += parseFloat(p.value) || 0);
        if (sum >= 100) { alert("Total is already 100%. Adjust previous values."); return; }

        createColumnAtIndex(allPercents.length, "");
    }

    function removeLastColumn() {
        const allPercents = document.querySelectorAll('.timeline-percent');
        if (allPercents.length <= 1) return; // Keep at least 1
        removeColumnAtIndex(allPercents.length - 1);
        updateTimelineString();
    }

    // --- 5. Save & Parse ---
    function updateTimelineString() {
        const percents = document.querySelectorAll('.timeline-percent');
        const years = document.querySelectorAll('.timeline-year');

        let parts = [];
        percents.forEach((p, index) => {
            const pVal = p.value;
            const yVal = years[index] ? years[index].value : "";
            // Only save if there is data, but respect 0
            if (pVal !== "" || yVal !== "") {
                parts.push(`${yVal} (${pVal}%)`);
            }
        });

        const finalString = parts.join(", ");
        const hiddenInput = document.getElementById('finalConstructionString');
        if (hiddenInput) {
            hiddenInput.value = finalString;
            hiddenInput.dispatchEvent(new Event('input', { bubbles: true }));
        }
    }

    function parseTimelineString(str) {
        const rowPercent = document.getElementById('row_percent');
        const rowYear = document.getElementById('row_year');

        // CLEANUP LOGIC CHANGED due to row swap:

        // Year Row (Top): Label is index 0. Button is lastChild.
        // Keep removing children between Label and Button
        while (rowYear.children.length > 2) {
            rowYear.removeChild(rowYear.children[1]);
        }

        // Percent Row (Bottom): Label is index 0. No buttons here anymore.
        // Keep removing everything after label
        while (rowPercent.children.length > 1) {
            rowPercent.removeChild(rowPercent.children[1]);
        }

        if (!str) { createColumnAtIndex(0, ""); return; }

        const parts = str.split(', ');
        parts.forEach((part, idx) => {
            const match = part.match(/(\d+)\s*\((\d+)%\)/);
            if (match) {
                createColumnAtIndex(idx, match[2], match[1]); // Percent, Year
            } else {
                createColumnAtIndex(idx, "", "");
            }
        });
    }

    function toggleSketchSidebar() {
        const sidebar = document.getElementById('sketchSidebar');
        const icon = document.getElementById('toggleIcon');

        // Toggle the class
        sidebar.classList.toggle('collapsed');

        // Change Arrow Direction & Tool Selection
        if (sidebar.classList.contains('collapsed')) {
            icon.className = "fas fa-chevron-right"; // Arrow points right to open

            // Ensure one of the visible tools is active (Pencil default)
            if (currentTool !== 'brush' && currentTool !== 'eraser') {
                setTool('brush');
            }
        } else {
            icon.className = "fas fa-chevron-left"; // Arrow points left to close
        }

        // IMPORTANT: Wait for CSS transition (300ms) then resize canvas
        setTimeout(resizeCanvas, 310);
    }


    /* ==========================================
       SERVER-SIDE INFINITE SCROLL PDF VIEWER
       ========================================== */

    // State
    let viewerState = {
        path: null,
        nextPageToLoad: 0,
        zoom: 1.0,
        isLoading: false,
        isFinished: false // True when we hit the last page
    };

    // Elements
    const scrollContainer = document.getElementById("scrollContainer");
    const scrollSentinel = document.getElementById("scrollSentinel"); // The loading spinner at bottom
    const pdfToolbar = document.getElementById("pdfToolbar");
    const pageCountDisplay = document.getElementById("pageCountDisplay");
    const zoomLevelDisplay = document.getElementById("zoomLevelDisplay");

    const imgContainer = document.getElementById("bigImageContainer");
    const imgEl = document.getElementById("bigImageFrame");

    let imgState = { scale: 1, panning: false, pointX: 0, pointY: 0, startX: 0, startY: 0 };

    function resetImageZoom() {
        imgState = { scale: 1, panning: false, pointX: 0, pointY: 0, startX: 0, startY: 0 };
        if (imgEl) {
            imgEl.style.transform = `translate(0px, 0px) scale(1)`;
            if (imgContainer) imgContainer.style.cursor = 'grab';
        }
    }

    function updateImageTransform() {
        if (imgEl) {
            imgEl.style.transform = `translate(${imgState.pointX}px, ${imgState.pointY}px) scale(${imgState.scale})`;
        }
    }

    function initGalleryGestures() {
        if (!imgContainer || !imgEl) return;

        // 1. DOUBLE CLICK (MOUSE)
        imgContainer.addEventListener('dblclick', (e) => {
            e.preventDefault();
            if (imgState.scale === 1) {
                imgState.scale = 3;
            } else {
                imgState.scale = 1;
                imgState.pointX = 0; imgState.pointY = 0;
            }
            updateImageTransform();
        });

        // 2. TOUCH GESTURES
        let lastTap = 0;
        let startDist = 0;
        let startScale = 1;

        imgContainer.addEventListener('touchstart', (e) => {
            const currentTime = new Date().getTime();
            const tapLength = currentTime - lastTap;

            // Double Tap
            if (tapLength < 300 && tapLength > 0 && e.touches.length === 1) {
                e.preventDefault();
                if (imgState.scale === 1) {
                    imgState.scale = 3;
                } else {
                    imgState.scale = 1;
                    imgState.pointX = 0; imgState.pointY = 0;
                }
                updateImageTransform();
                lastTap = 0;
                return;
            }
            lastTap = currentTime;

            // Pinch Start
            if (e.touches.length === 2) {
                e.preventDefault();
                startDist = Math.hypot(
                    e.touches[0].clientX - e.touches[1].clientX,
                    e.touches[0].clientY - e.touches[1].clientY
                );
                startScale = imgState.scale;
            }
            // Pan Start
            else if (e.touches.length === 1 && imgState.scale > 1) {
                imgState.startX = e.touches[0].clientX - imgState.pointX;
                imgState.startY = e.touches[0].clientY - imgState.pointY;
                imgState.panning = true;
            }
        }, { passive: false });

        imgContainer.addEventListener('touchmove', (e) => {
            e.preventDefault();
            imgEl.style.transition = 'none'; // Instant follow

            // Pinch Move
            if (e.touches.length === 2) {
                const dist = Math.hypot(
                    e.touches[0].clientX - e.touches[1].clientX,
                    e.touches[0].clientY - e.touches[1].clientY
                );
                if (startDist > 0) {
                    const newScale = startScale * (dist / startDist);
                    imgState.scale = Math.min(Math.max(1, newScale), 5);
                    updateImageTransform();
                }
            }
            // Pan Move
            else if (e.touches.length === 1 && imgState.panning) {
                imgState.pointX = e.touches[0].clientX - imgState.startX;
                imgState.pointY = e.touches[0].clientY - imgState.startY;
                updateImageTransform();
            }
        }, { passive: false });

        imgContainer.addEventListener('touchend', () => {
            imgState.panning = false;
            imgEl.style.transition = 'transform 0.1s ease-out';
            if (imgState.scale < 1) { imgState.scale = 1; updateImageTransform(); }
        });

        // 3. MOUSE WHEEL & DRAG
        imgContainer.addEventListener('wheel', (e) => {
            e.preventDefault();
            const delta = -Math.sign(e.deltaY) * 0.2;
            imgState.scale = Math.min(Math.max(1, imgState.scale + delta), 5);
            updateImageTransform();
        }, { passive: false });

        imgContainer.addEventListener('mousedown', (e) => {
            if (imgState.scale > 1) {
                e.preventDefault();
                imgState.startX = e.clientX - imgState.pointX;
                imgState.startY = e.clientY - imgState.pointY;
                imgState.panning = true;
                imgContainer.style.cursor = 'grabbing';
            }
        });

        window.addEventListener('mousemove', (e) => {
            if (!imgState.panning) return;
            e.preventDefault();
            imgEl.style.transition = 'none';
            imgState.pointX = e.clientX - imgState.startX;
            imgState.pointY = e.clientY - imgState.startY;
            updateImageTransform();
        });

        window.addEventListener('mouseup', () => {
            imgState.panning = false;
            if (imgEl) imgEl.style.transition = 'transform 0.1s ease-out';
            if (imgContainer) imgContainer.style.cursor = (imgState.scale > 1) ? 'grab' : 'default';
        });
    }
    // Initialize immediately
    initGalleryGestures();
    // --- 1. OBSERVER SETUP ---
    // (We reuse your existing viewerState, scrollContainer, and scrollSentinel variables)

    // Create the observer to watch the spinner
    const observer = new IntersectionObserver((entries) => {
        if (entries[0].isIntersecting) loadNextPage();
    }, { root: scrollContainer, threshold: 0.1 });

    // Start watching the spinner if it exists
    if (scrollSentinel) observer.observe(scrollSentinel);

    // --- 2. LOAD PREVIEW ---
    function loadBigPreview(file) {
        currentFile = file;
        let fullPath = file.path;
        if (!fullPath) {
            const folderPrefix = currentFolder ? currentFolder.replace(/\/$/, "") + "/" : "";
            fullPath = folderPrefix + file.name;
        }
        currentFile.path = fullPath;

        const titleEl = document.getElementById("bigPreviewTitle");
        if (titleEl) titleEl.textContent = fullPath;

        const noSelection = document.getElementById("noSelection");
        const bigImgContainer = document.getElementById("bigImageContainer");
        const bigImg = document.getElementById("bigImageFrame");
        const downloadBtn = document.getElementById("downloadPdfBtn");

        // Hide all views initially
        if (noSelection) noSelection.classList.add("hidden");
        if (scrollContainer) scrollContainer.classList.add("hidden");
        if (bigImgContainer) bigImgContainer.classList.add("hidden");
        if (downloadBtn) downloadBtn.classList.remove("hidden");

        const url = `/coreapi/serve-file/?path=${encodeURIComponent(fullPath)}`;
        const ext = file.name.split(".").pop().toLowerCase();

        // A. IMAGE LOGIC
        if (["jpg", "jpeg", "png", "gif", "bmp", "webp"].includes(ext)) {
            if (bigImg && bigImgContainer) {
                bigImg.src = url;
                bigImgContainer.classList.remove("hidden");
                resetImageZoom();
            }
        }
        // B. TABLET PDF LOGIC (Scaled Image Slices)
        else if (ext === "pdf") {
            // Clear old pages
            if (scrollContainer) {
                scrollContainer.querySelectorAll('img.pdf-page-img').forEach(img => img.remove());
                scrollContainer.classList.remove("hidden");
            }
            if (scrollSentinel) scrollSentinel.classList.remove("hidden");

            // Reset state and ZOOM
            pdfZoomState.scale = 1.0; // <-- ADD THIS LINE
            viewerState = { path: fullPath, nextPageToLoad: 0, isLoading: false, isFinished: false };
            loadNextPage(); // Trigger first page
        }
        // C. UNSUPPORTED
        else {
            if (noSelection) {
                noSelection.classList.remove("hidden");
                noSelection.textContent = "Preview not available. Please download.";
            }
        }
    }

    // --- 3. PAGE LOADING & SCALE FIX ---
    function loadNextPage() {
        if (viewerState.isLoading || viewerState.isFinished) return;
        viewerState.isLoading = true;

        const pageIndex = viewerState.nextPageToLoad;
        const img = document.createElement("img");

        // THE FIX: Removed transitions and added w-full for perfect scaling
        img.className = "pdf-page-img shadow-md mb-2 h-auto bg-white";
        img.style.maxWidth = "none";
        img.style.width = `${pdfZoomState.scale * 100}%`;
        img.alt = `Page ${pageIndex + 1}`;

        const url = `/coreapi/render-page/?path=${encodeURIComponent(viewerState.path)}&page=${pageIndex}&zoom=1.5`;

        img.onload = () => {
            viewerState.isLoading = false;
            viewerState.nextPageToLoad++;

            if (pageCountDisplay) {
                pageCountDisplay.textContent = `Pages loaded: ${viewerState.nextPageToLoad}`;
            }

            if (isSentinelVisible()) {
                loadNextPage();
            }
        };

        img.onerror = () => {
            viewerState.isFinished = true;
            viewerState.isLoading = false;
            img.remove();
            if (scrollSentinel) scrollSentinel.classList.add("hidden");
            if (typeof observer !== 'undefined') observer.unobserve(scrollSentinel);
        };

        img.src = url;
        if (scrollContainer && scrollSentinel) {
            scrollContainer.insertBefore(img, scrollSentinel);
        }
    }
    /* ==========================================
   PDF PINCH, SCROLL & DOUBLE-TAP ZOOM LOGIC
========================================== */
    let pdfZoomState = {
        scale: 1.0,
        initialPinchDist: 0,
        initialScale: 1.0,
        min: 0.5,
        max: 4.0
    };

    function applyPdfZoom(originX, originY) {
        if (!scrollContainer) return;

        const rect = scrollContainer.getBoundingClientRect();

        // 1. Identify focal point
        const clientX = originX !== undefined ? originX : rect.left + rect.width / 2;
        const clientY = originY !== undefined ? originY : rect.top + rect.height / 2;

        const viewX = clientX - rect.left;
        const viewY = clientY - rect.top;

        // 2. Calculate percentage
        const oldScrollWidth = scrollContainer.scrollWidth;
        const oldScrollHeight = scrollContainer.scrollHeight;

        const pctX = (scrollContainer.scrollLeft + viewX) / oldScrollWidth;
        const pctY = (scrollContainer.scrollTop + viewY) / oldScrollHeight;

        // 3. Prevent clipping on the left
        if (pdfZoomState.scale > 1.0) {
            scrollContainer.classList.remove('items-center');
            scrollContainer.classList.add('items-start');
        } else {
            scrollContainer.classList.remove('items-start');
            scrollContainer.classList.add('items-center');
        }

        // 4. Apply scale instantly
        const pages = scrollContainer.querySelectorAll('.pdf-page-img');
        pages.forEach(img => {
            img.style.width = `${pdfZoomState.scale * 100}%`;
        });

        if (zoomLevelDisplay) {
            zoomLevelDisplay.textContent = `${Math.round(pdfZoomState.scale * 100)}%`;
        }

        // 5. Force layout reflow and adjust scroll
        const newScrollWidth = scrollContainer.scrollWidth;
        const newScrollHeight = scrollContainer.scrollHeight;

        scrollContainer.scrollLeft = (newScrollWidth * pctX) - viewX;
        scrollContainer.scrollTop = (newScrollHeight * pctY) - viewY;
    }

    // 1. Button Controls
    const btnZoomIn = document.getElementById("pdfZoomIn");
    if (btnZoomIn) {
        btnZoomIn.onclick = () => {
            if (pdfZoomState.scale < pdfZoomState.max) {
                pdfZoomState.scale += 0.25;
                applyPdfZoom();
            }
        };
    }

    const btnZoomOut = document.getElementById("pdfZoomOut");
    if (btnZoomOut) {
        btnZoomOut.onclick = () => {
            if (pdfZoomState.scale > pdfZoomState.min) {
                pdfZoomState.scale -= 0.25;
                applyPdfZoom();
            }
        };
    }

    // Event Listeners for Scroll Container
    if (scrollContainer) {
        let pdfLastTap = 0;

        // 2. Desktop: Double-Click to Zoom at Cursor
        scrollContainer.addEventListener('dblclick', (e) => {
            e.preventDefault();
            pdfZoomState.scale = (pdfZoomState.scale === 1.0) ? 2.5 : 1.0;
            applyPdfZoom(e.clientX, e.clientY);
        });

        // 3. Desktop: Ctrl + Scroll Wheel at Cursor
        scrollContainer.addEventListener('wheel', (e) => {
            if (e.ctrlKey) {
                e.preventDefault();
                const zoomDelta = e.deltaY < 0 ? 0.15 : -0.15;
                pdfZoomState.scale = Math.min(Math.max(pdfZoomState.min, pdfZoomState.scale + zoomDelta), pdfZoomState.max);
                applyPdfZoom(e.clientX, e.clientY);
            }
        }, { passive: false });

        // 4. Tablet: Pinch & Double-Tap
        scrollContainer.addEventListener('touchstart', (e) => {
            if (e.touches.length === 1) {
                const currentTime = new Date().getTime();
                const tapLength = currentTime - pdfLastTap;

                if (tapLength < 300 && tapLength > 0) {
                    e.preventDefault();
                    pdfZoomState.scale = (pdfZoomState.scale === 1.0) ? 2.5 : 1.0;
                    applyPdfZoom(e.touches[0].clientX, e.touches[0].clientY);
                    pdfLastTap = 0;
                } else {
                    pdfLastTap = currentTime;
                }
            }

            if (e.touches.length === 2) {
                e.preventDefault();
                pdfZoomState.initialPinchDist = Math.hypot(
                    e.touches[0].clientX - e.touches[1].clientX,
                    e.touches[0].clientY - e.touches[1].clientY
                );
                pdfZoomState.initialScale = pdfZoomState.scale;
            }
        }, { passive: false });

        scrollContainer.addEventListener('touchmove', (e) => {
            if (e.touches.length === 2 && pdfZoomState.initialPinchDist > 0) {
                e.preventDefault();
                const currentDist = Math.hypot(
                    e.touches[0].clientX - e.touches[1].clientX,
                    e.touches[0].clientY - e.touches[1].clientY
                );
                const scaleFactor = currentDist / pdfZoomState.initialPinchDist;
                pdfZoomState.scale = Math.min(Math.max(pdfZoomState.min, pdfZoomState.initialScale * scaleFactor), pdfZoomState.max);

                const pinchCenterX = (e.touches[0].clientX + e.touches[1].clientX) / 2;
                const pinchCenterY = (e.touches[0].clientY + e.touches[1].clientY) / 2;

                applyPdfZoom(pinchCenterX, pinchCenterY);
            }
        }, { passive: false });

        scrollContainer.addEventListener('touchend', (e) => {
            if (e.touches.length < 2) {
                pdfZoomState.initialPinchDist = 0;
            }
        });
    }

    /* ==========================================
       FULLSCREEN MODAL LOGIC (FINAL FIX)
       ========================================== */

    // 1. Elements
    const fullscreenModal = document.getElementById("fullscreenModal");
    const modalTitle = document.getElementById("modalTitle");

    // Containers
    const modalFrame = document.getElementById("modalFrame");
    const imageZoomWrapper = document.getElementById("imageZoomWrapper");
    const modalPdfContainer = document.getElementById("modalPdfContainer");
    const modalImage = document.getElementById("modalImage");
    const modalZoomDisplay = document.getElementById("modalZoomLevel");

    // State
    let currentModalZoom = 1.0;
    let modalState = {
        path: null,
        nextPage: 0,
        isLoading: false,
        isFinished: false,
        observer: null,
        mode: 'none'
    };

    /* --- 1. OPEN MODAL --- */
    document.getElementById("openFullBtn").onclick = () => {
        if (!currentFile) return alert("Select a file first");

        // 1. Show Modal (Requires the HTML fix mentioned below)
        const modal = document.getElementById("fullscreenModal");
        modal.classList.remove("hidden");
        modal.classList.add("flex");
        modal.setAttribute("aria-hidden", "false");

        const title = document.getElementById("modalTitle");
        if (title) title.textContent = currentFile.name;

        // 2. Get Elements safely
        const frame = document.getElementById("modalFrame");
        const zoomWrapper = document.getElementById("imageZoomWrapper");
        const pdfContainer = document.getElementById("modalPdfContainer");
        const imgObj = document.getElementById("modalImage");

        // 3. Reset Layers (Hide everything first)
        [frame, zoomWrapper, pdfContainer, imgObj].forEach(el => {
            if (el) {
                el.classList.add("hidden");
                el.classList.remove("flex");
                el.style.display = "none";
            }
        });

        // Clear PDF container if it exists
        if (pdfContainer) pdfContainer.innerHTML = "";

        // 4. Set State
        modalState.path = currentFile.path;
        const ext = currentFile.name.split(".").pop().toLowerCase();

        // CASE A: PDF
        if (ext === 'pdf') {
            modalState.mode = 'pdf';
            if (pdfContainer) {
                pdfContainer.classList.remove("hidden");
                pdfContainer.classList.add("flex");
                pdfContainer.style.display = "flex";
                if (typeof initPdfModal === "function") initPdfModal(); // Safety check
            }
        }
        // CASE B: IMAGE
        else if (["jpg", "jpeg", "png", "gif", "bmp", "webp"].includes(ext)) {
            modalState.mode = 'image';

            // If wrapper exists, use it. If not, try to show image directly.
            const container = zoomWrapper || modal;

            if (container && imgObj) {
                if (zoomWrapper) {
                    zoomWrapper.classList.remove("hidden");
                    zoomWrapper.classList.add("flex");
                    zoomWrapper.style.display = "flex";
                }

                imgObj.classList.remove("hidden");
                imgObj.style.display = "block";

                // Add timestamp to force refresh
                imgObj.src = `/coreapi/serve-file/?path=${encodeURIComponent(currentFile.path)}&t=${new Date().getTime()}`;

                // Reset Styles
                imgObj.style.transform = "scale(1)";
                imgObj.style.maxWidth = "100%";
                imgObj.style.maxHeight = "100%";
                imgObj.style.margin = "0";
            }
        }
        // CASE C: OTHER
        else {
            if (pdfContainer) {
                pdfContainer.classList.remove("hidden");
                pdfContainer.classList.add("flex");
                pdfContainer.style.display = "flex";
                pdfContainer.innerHTML = `<div class="text-gray-500 m-auto">Preview not available</div>`;
            }
        }
    };
    /* --- 2. CLOSE MODAL --- */
    document.getElementById("modalClose").onclick = () => {
        fullscreenModal.classList.add("hidden");
        fullscreenModal.classList.remove("flex");
        fullscreenModal.setAttribute("aria-hidden", "true");

        if (modalImage) modalImage.src = "";
        if (modalPdfContainer) modalPdfContainer.innerHTML = "";
        if (modalState.observer) modalState.observer.disconnect();
    };

    /* --- 3. ZOOM LOGIC (Full Width Fix) --- */
    function updateZoomDisplay() {
        if (modalZoomDisplay) modalZoomDisplay.textContent = Math.round(currentModalZoom * 100) + "%";
    }
    function applyModalZoom() {
        if (typeof updateZoomDisplay === "function") updateZoomDisplay();

        if (modalState.mode === 'image' && modalImage) {
            if (currentModalZoom > 1.0) {
                modalImage.style.maxWidth = "none";
                modalImage.style.maxHeight = "none";
                modalImage.style.transform = `scale(${currentModalZoom})`;
                modalImage.style.margin = "100px";
            } else {
                modalImage.style.maxWidth = "100%";
                modalImage.style.maxHeight = "100%";
                modalImage.style.transform = "scale(1)";
                modalImage.style.margin = "0";
            }
        }
        else if (modalState.mode === 'pdf' && modalPdfContainer) {
            // Enforce 100% width based on zoom
            const widthPercent = Math.round(currentModalZoom * 100);
            const pages = modalPdfContainer.querySelectorAll("img");
            pages.forEach(p => {
                p.style.width = `${widthPercent}%`;
                p.style.maxWidth = "none";

                // Recalculate height on zoom to prevent distortion/gaps
                const currentW = p.getBoundingClientRect().width;
                p.style.minHeight = `${currentW * 1.414}px`;
            });
        }
    }


    /* --- 4. PDF SCROLL LOGIC (Robust) --- */
    function initPdfModal() {
        modalState.nextPage = 0;
        modalState.isLoading = false;
        modalState.isFinished = false;

        // Sentinel (Spinner)
        const sentinel = document.createElement("div");
        sentinel.className = "w-full h-24 flex items-center justify-center py-4";
        sentinel.style.flexShrink = "0"; // CRITICAL: Stop shrinking height
        sentinel.innerHTML = '<div class="spinner border-4 border-gray-300 border-t-blue-500 rounded-full w-8 h-8 animate-spin"></div>';

        if (modalPdfContainer) modalPdfContainer.appendChild(sentinel);

        if (modalState.observer) modalState.observer.disconnect();

        if (modalPdfContainer) {
            modalState.observer = new IntersectionObserver((entries) => {
                if (entries[0].isIntersecting) loadNextModalPage(sentinel);
            }, { root: modalPdfContainer, threshold: 0.1 });

            modalState.observer.observe(sentinel);

            // Initial Trigger
            loadNextModalPage(sentinel);
        }
    }

    function loadNextModalPage(sentinel) {
        if (modalState.isLoading || modalState.isFinished) return;
        modalState.isLoading = true;

        const img = document.createElement("img");

        // 1. Setup Sizing
        const containerWidth = modalPdfContainer.clientWidth || window.innerWidth;
        const widthPercent = Math.round(currentModalZoom * 100);
        const estimatedHeight = (containerWidth * (widthPercent / 100)) * 1.414;

        img.style.width = `${widthPercent}%`;
        img.style.maxWidth = "none";
        img.style.marginBottom = "20px";
        img.style.boxShadow = "0 4px 10px rgba(0,0,0,0.2)";
        img.style.backgroundColor = "white";
        img.style.flexShrink = "0";
        img.style.minHeight = `${estimatedHeight}px`;

        // 2. Request Page
        img.src = `/coreapi/render-page/?path=${encodeURIComponent(modalState.path)}&page=${modalState.nextPage}&zoom=2.0`;

        // 3. Success Handler
        img.onload = () => {
            modalState.isLoading = false;
            modalState.nextPage++;

            // Auto-load next if screen isn't full
            if (sentinel.parentElement && sentinel.getBoundingClientRect().top < window.innerHeight) {
                loadNextModalPage(sentinel);
            }
        };

        // 4. Error/End of PDF Handler (THE FIX)
        img.onerror = () => {
            // console.log("End of document reached.");
            modalState.isFinished = true;
            modalState.isLoading = false;

            // REMOVE THE BROKEN IMAGE IMMEDIATELY
            img.remove();

            // Stop the loading spinner
            if (sentinel.parentElement) sentinel.remove();
            if (modalState.observer) modalState.observer.disconnect();
        };

        if (modalPdfContainer) modalPdfContainer.insertBefore(img, sentinel);
    }
    /* ==========================================
       UPDATED: DOWNLOAD BUTTONS
       ========================================== */

    // 1. Dashboard Download Button (Small icon in header)
    document.getElementById("downloadPdfBtn").onclick = (e) => {
        e.stopPropagation(); // Prevent glitches
        triggerDownload();
    };

    // 2. Modal Download Button (Big button in modal)
    document.getElementById("modalDownloadBtn").onclick = () => {
        triggerDownload();
    };

    // Shared Download Function
    function triggerDownload() {
        if (!currentFile) {
            alert("No file selected.");
            return;
        }
        // Points to the standard serve-file view with download=true
        const url = `/coreapi/serve-file/?path=${encodeURIComponent(currentFile.path)}&download=true`;
        window.location.href = url;
    }


    /* =========================
       ADVANCED FILE SHARING (Sends Actual File)
    ========================= */

    // 1. Get Elements
    const modalShareBtn = document.getElementById("modalShare");
    const shareButtonsContainer = document.getElementById("shareButtonsContainer");
    const modalDownloadBtn = document.getElementById("modalDownloadBtn");

    // 2. Main Share Button Logic
    modalShareBtn.onclick = async (e) => {
        e.preventDefault();

        if (!currentFile) return alert("No file selected");

        const originalText = modalShareBtn.innerHTML;

        // Visual Feedback: Show user we are preparing the file
        modalShareBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Preparing...';
        modalShareBtn.style.pointerEvents = "none"; // Prevent double click

        try {
            // A. Construct the Download URL
            const downloadUrl = `/coreapi/serve-file/?path=${encodeURIComponent(currentFile.path)}&download=true`;

            // B. Fetch the file data (Blob) from your server
            const response = await fetch(downloadUrl);
            const blob = await response.blob();

            // C. Create a Virtual File object
            // We use the correct MIME type (pdf, jpg, etc.)
            const fileObj = new File([blob], currentFile.name, { type: blob.type });

            // D. Check if the Device supports File Sharing
            if (navigator.canShare && navigator.canShare({ files: [fileObj] })) {

                // --- SUCCESS: Share the Actual File ---
                await navigator.share({
                    files: [fileObj],
                    title: currentFile.name,
                    text: 'Here is the file.'
                });

            } else {
                // --- FALLBACK: Device doesn't support file sharing (e.g. Desktop) ---
                // We revert to the Link menu, but we tell the user why
                shareButtonsContainer.classList.toggle("hidden");

                // Still update links just in case they want to send the link instead
                const fileLink = window.location.origin + `/coreapi/serve-file/?path=${encodeURIComponent(currentFile.path)}`;
                updateShareLinks(fileLink);
            }

        } catch (err) {
            console.log('Share failed or canceled:', err);
            // If user canceled share, do nothing. If error, maybe show alert.
            if (err.name !== 'AbortError' && err.name !== 'NotAllowedError') {
                alert("Could not share file directly. Try downloading it first.");
            }
        } finally {
            // Reset Button
            modalShareBtn.innerHTML = originalText;
            modalShareBtn.style.pointerEvents = "auto";
        }
    };

    // 3. Fallback Links (Only used if File Sharing fails/Desktop)
    function updateShareLinks(url) {
        const encodedUrl = encodeURIComponent(url);
        const encodedText = encodeURIComponent("Check this document: " + currentFile.name);

        // Note: These CANNOT attach files. This is a browser limitation.
        document.getElementById("shareWhatsapp").href = `https://wa.me/?text=${encodedText}%20${encodedUrl}`;
        document.getElementById("shareTelegram").href = `https://t.me/share/url?url=${encodedUrl}&text=${encodedText}`;
        document.getElementById("shareEmail").href = `mailto:?subject=${encodeURIComponent(currentFile.name)}&body=${encodedText}%20${encodedUrl}`;

        document.getElementById("shareCopy").onclick = (e) => {
            e.preventDefault();
            navigator.clipboard.writeText(url).then(() => {
                alert("Link copied to clipboard!");
                shareButtonsContainer.classList.add("hidden");
            });
        };
    }

    // 4. Download Button Logic
    modalDownloadBtn.onclick = (e) => {
        e.preventDefault();
        if (!currentFile) return alert("No file selected");
        const downloadUrl = `/coreapi/serve-file/?path=${encodeURIComponent(currentFile.path)}&download=true`;
        window.location.href = downloadUrl;
    };
    /* =========================
       11. SAFETY NET (Auto-Save & Scroll Memory)
    ========================= */
    window.addEventListener('beforeunload', (event) => {
        // 1. Save Form Data (Auto-save)
        if (currentFolder) {
            const payload = JSON.stringify({
                folder_path: currentFolder,
                payload: formState
            });
            fetch('/coreapi/api/auto-save/', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrftoken },
                body: payload,
                keepalive: true
            });
        }

        // 2. ✅ SAVE SCROLL POSITIONS (ROBUST FIX)

        // A. Form Scroll (Check BOTH container and form element)
        const rightCol = document.getElementById('rightColumnContainer');
        const formEl = document.getElementById('siteFeedbackForm');

        // Use the value from whichever element is actually scrolling
        const currentFormScroll = Math.max(
            rightCol ? rightCol.scrollTop : 0,
            formEl ? formEl.scrollTop : 0
        );

        localStorage.setItem('vadrida_form_scroll', currentFormScroll);

        // Save Fullscreen State
        if (rightCol) {
            const isFullscreen = rightCol.classList.contains('fullscreen-active');
            localStorage.setItem('vadrida_form_fullscreen', isFullscreen);
        }

        // B. File List Scroll
        const fileListCol = document.querySelector('.file-list-container');
        if (fileListCol) {
            localStorage.setItem('vadrida_file_list_scroll', fileListCol.scrollTop);
        }
    });
    /* ==========================================
       LOGIC: Toggle Ownership Notes Visibility
       ========================================== */
    function toggleOwnershipNotes() {
        const notesBox = document.getElementById('ownershipNotesBox');
        // Check if "Discrepancy noted" is checked
        const discrepancyRadio = document.querySelector('input[name="doc_verification"][value="discrepancy noted"]');
        const isDiscrepancy = discrepancyRadio && discrepancyRadio.checked;

        if (isDiscrepancy) {
            notesBox.classList.remove('hidden');
        } else {
            notesBox.classList.add('hidden');

            // --- DATA CLEANUP ---
            // 1. Clear State
            updateNestedState(formState, 'Ownership_Analysis.Ownership_Analysis_notes', "");
            // 2. Clear Input UI
            const input = document.querySelector('[data-path="Ownership_Analysis.Ownership_Analysis_notes"]');
            if (input) input.value = "";
            // 3. Save
            saveLocal();
        }
        updateCompletionStats();
    }

    /* ==========================================
       AUTO-CALCULATE EXTENT TOTALS (With Cents)
       ========================================== */
    function calculateSurveyTotals() {
        let ltrSum = 0;
        let ltrCount = 0;

        let deedSum = 0;
        let deedCount = 0;

        // 1. Calculate Sums and Counts
        const docs = formState.Survey.docs || [];

        docs.forEach(doc => {
            const extentVal = parseFloat(doc.land_extent) || 0;
            const docName = (doc.name || "").trim(); // Exact match

            if (docName === "LTR") {
                ltrSum += extentVal;
                ltrCount++;
            }
            else if (docName === "Title Deed") {
                deedSum += extentVal;
                deedCount++;
            }
        });

        // 2. DOM Elements
        const mainContainer = document.getElementById("surveyTotalsContainer");
        const ltrWrapper = document.getElementById("ltr_total_wrapper");
        const ltrInput = document.getElementById("total_ltr_extent");

        const deedWrapper = document.getElementById("deed_total_wrapper");
        const deedInput = document.getElementById("total_deed_extent");

        let showMainContainer = false;

        // --- Helper to Format String ---
        const formatValue = (aresValue) => {
            // Round Ares to reasonable decimals (e.g. 3) to avoid float errors
            const cleanAres = parseFloat(aresValue.toFixed(3));

            // Calculate Cents: (Ares * 100) / 40.47
            const cents = (cleanAres * 100) / 40.47;

            // Format: "2.1 (5.189 cents)"
            return `${cleanAres} (${cents.toFixed(3)} cents)`;
        };

        // 3. Handle LTR Visibility & Value
        if (ltrCount > 1 && ltrSum > 0) {
            const finalStr = formatValue(ltrSum);

            ltrInput.value = finalStr;
            formState.Survey.total_ltr_extent = finalStr; // Save the full string for PDF

            ltrWrapper.classList.remove("hidden");
            showMainContainer = true;
        } else {
            ltrWrapper.classList.add("hidden");
            ltrInput.value = "";
            formState.Survey.total_ltr_extent = "";
        }

        // 4. Handle Title Deed Visibility & Value
        if (deedCount > 1 && deedSum > 0) {
            const finalStr = formatValue(deedSum);

            deedInput.value = finalStr;
            formState.Survey.total_deed_extent = finalStr; // Save the full string for PDF

            deedWrapper.classList.remove("hidden");
            showMainContainer = true;
        } else {
            deedWrapper.classList.add("hidden");
            deedInput.value = "";
            formState.Survey.total_deed_extent = "";
        }

        // 5. Toggle Main Box Visibility
        if (showMainContainer) {
            mainContainer.classList.remove("hidden");
        } else {
            mainContainer.classList.add("hidden");
        }
    }
    /* ==========================================
       CHECK FOR WET LAND IN LTR
       ========================================== */
    function checkWetLandStatus() {
        const docs = formState.Survey.docs || [];
        let isWetLandFound = false;

        // Loop through all columns
        docs.forEach(doc => {
            const docName = (doc.name || "").trim();
            // Check for LTR + check_wet
            if (docName === "LTR" && (doc.check_wet === true || doc.check_wet === "true")) {
                isWetLandFound = true;
            }
        });

        const questionBox = document.getElementById("wetLandQuestions");

        if (isWetLandFound) {
            questionBox.classList.remove("hidden");
        } else {
            questionBox.classList.add("hidden");

            // --- DATA CLEANUP ---
            // Only clear if we are actually hiding it (avoid clearing on initial load if empty)
            // Check if data exists before clearing to avoid unnecessary writes
            if (formState.Survey.paddy_land_check || formState.Survey.trees_2008_check) {
                updateNestedState(formState, 'Survey.paddy_land_check', "");
                updateNestedState(formState, 'Survey.trees_2008_check', "");

                // Clear Radios in UI
                document.querySelectorAll('input[name="paddy_land_check"]').forEach(el => el.checked = false);
                document.querySelectorAll('input[name="trees_2008_check"]').forEach(el => el.checked = false);

                saveLocal();
            }
        }
    }
    /* ==========================================
       LOGIC: Toggle Encroachment Fields
       ========================================== */
    function toggleEncroachmentFields() {
        const container = document.getElementById('encroachmentDetails');
        const yesRadio = document.querySelector('input[name="encroachment_check"][value="Yes"]');
        const isYes = yesRadio && yesRadio.checked;

        if (container) {
            if (isYes) {
                container.classList.remove('hidden');
            } else {
                container.classList.add('hidden');

                // --- DATA CLEANUP ---
                // Clear all 3 related fields
                const pathsToClear = [
                    'Demarcation.demarcation_notes',
                    'Demarcation.enroachment_subject_to_neighbour',
                    'Demarcation.enroachment_neighbour_to_subject'
                ];

                pathsToClear.forEach(path => {
                    updateNestedState(formState, path, ""); // Clear State
                    const input = document.querySelector(`[data-path="${path}"]`);
                    if (input) input.value = ""; // Clear UI
                });
                saveLocal();
            }
        }
        updateCompletionStats();
    }
    /* ==========================================
       LOGIC: Toggle Railway Distance Row
       ========================================== */
    function toggleRailwayDistance() {
        const row = document.getElementById('railwayDistanceRow');
        const yesRadio = document.querySelector('input[name="railway"][value="Yes"]');
        const isYes = yesRadio && yesRadio.checked;

        if (row) {
            if (isYes) {
                row.classList.remove('hidden');
            } else {
                row.classList.add('hidden');

                // --- DATA CLEANUP ---
                updateNestedState(formState, 'land_inspection_details.railway_distance', "");
                const input = document.querySelector('[data-path="land_inspection_details.railway_distance"]');
                if (input) input.value = "";

                saveLocal();
            }
        }
        updateCompletionStats();
    }

    /* =========================
       10. APP INIT (Smart Restoration)
    ========================= */
    document.addEventListener("DOMContentLoaded", () => {
        console.log("App Initializing...");

        // 1. DETECT NAVIGATION TYPE
        // Check if the page was reloaded (F5)
        const navEntry = performance.getEntriesByType("navigation")[0];
        const isReload = navEntry && navEntry.type === 'reload';

        // Check previous URL
        const previousUrl = document.referrer || "";
        // Adjust strings if your URLs differ slightly
        const cameFromEditor = previousUrl.includes("pdf-editor") || previousUrl.includes("pdf_editor");

        // 2. DECISION LOGIC
        if (isReload || cameFromEditor) {
            console.log("♻️ Restoration Mode: (Reloaded or Back from Editor)");
            // We DO NOTHING here. We let the standard code below load the data from LocalStorage.
        }
        else {
            console.log("✨ Fresh Entry: Clearing Old Context");
            // Clear Active Folder (So file explorer starts at Root)
            localStorage.removeItem('vadrida_active_folder');

            // Clear Form Draft (Start with blank form)
            localStorage.removeItem(STORAGE_KEY);

            // Reset internal state immediately
            formState = getEmptyState();

            // Clear scroll positions
            localStorage.removeItem('vadrida_file_list_scroll');
        }

        // --- STANDARD RESTORATION LOGIC ---

        const lastPath = localStorage.getItem('vadrida_active_folder');

        setTimeout(() => {
            const savedStr = getNestedValue(formState, "Building_analysis.construction_year");
            if (savedStr) parseTimelineString(savedStr);
            else createColumnAtIndex(0, "");
        }, 200);

        initBuildingTable();

        // Load Folder: If we preserved lastPath (Reload/Editor), load it. Otherwise load "" (Root).
        if (lastPath) loadFolder(lastPath);
        else loadFolder("");

        enforceTabletLandscape();
        injectPencilIcons();
        renderSurveyColumns();
        updateAllDocumentDropdowns();

        // Load saved images
        if (formState.images) {
            Object.keys(formState.images).forEach(path => {
                const safeId = path.replace(/\./g, '_');
                const previewImg = document.getElementById(`img_preview_${safeId}`);
                if (previewImg) {
                    previewImg.src = formState.images[path];
                    previewImg.classList.remove('hidden');
                    if (path === 'Sketch.main_layout') {
                        const ph = document.getElementById(`placeholder_${safeId}`);
                        if (ph) ph.classList.add('hidden');
                    }
                }
            });
        }

        // ============================================================
        // SCROLL MEMORY & FULLSCREEN LOGIC
        // ============================================================
        const fsBtn = document.getElementById('toggleFormFullscreenBtn');
        const rightCol = document.getElementById('rightColumnContainer');
        const icon = fsBtn ? fsBtn.querySelector('i') : null;

        // Restore Fullscreen Mode
        const wasFullscreen = localStorage.getItem('vadrida_form_fullscreen') === 'true';
        if (wasFullscreen && rightCol && icon) {
            rightCol.classList.add('fullscreen-active');
            icon.className = 'fas fa-compress';
            icon.style.color = '#ef4444';
            document.body.style.overflow = 'hidden';
        }

        // Attach Click Listener
        if (fsBtn && rightCol) {
            fsBtn.onclick = () => {
                const currentScroll = rightCol.scrollTop;
                rightCol.classList.toggle('fullscreen-active');
                const isNowFullscreen = rightCol.classList.contains('fullscreen-active');
                rightCol.scrollTop = currentScroll;

                if (isNowFullscreen) {
                    icon.className = 'fas fa-compress';
                    icon.style.color = '#ef4444';
                    document.body.style.overflow = 'hidden';
                    localStorage.setItem('vadrida_form_fullscreen', 'true');
                } else {
                    icon.className = 'fas fa-expand';
                    icon.style.color = '#374151';
                    document.body.style.overflow = '';
                    localStorage.setItem('vadrida_form_fullscreen', 'false');
                }
            };
        }

        // Date restriction
        const dateInput = document.querySelector('input[data-path="Valuers_Checklist.inspection_date"]');
        if (dateInput) {
            const today = new Date().toISOString().split("T")[0];
            dateInput.setAttribute("max", today);
        }

        // Logout Listener (Backup safety)
        const logoutLinks = document.querySelectorAll('a[href*="logout"]');
        logoutLinks.forEach(link => {
            link.addEventListener('click', () => {
                localStorage.removeItem(STORAGE_KEY);
                localStorage.removeItem('vadrida_active_folder');
            });
        });
    });
    /* =========================
       1. GLOBAL VARIABLES
    ========================= */
    let map, marker;
    let isMapReady = false;
    let pendingMapUpdate = false;
    let userMarker, directionBeam;

    /* =========================
       2. MAP INITIALIZATION
    ========================= */
    window.initMap = function () {
        console.log("Initializing Map...");

        const startPos = { lat: 9.9312, lng: 76.2673 };
        const mapEl = document.getElementById("googleMap");


        if (!mapEl) return;

        map = new google.maps.Map(mapEl, {
            zoom: 15,
            center: startPos,
            mapTypeId: "hybrid",
            tilt: 45,
            streetViewControl: false,
            fullscreenControl: true, // Native button
            gestureHandling: 'cooperative'
        });

        marker = new google.maps.Marker({
            position: startPos,
            map: map,
            draggable: false, // Locked by default
            animation: google.maps.Animation.DROP,
            title: "Subject Property"
        });
        // 🔵 Blue Dot (User)
        userMarker = new google.maps.Marker({
            map: map,
            clickable: false,
            icon: {
                path: google.maps.SymbolPath.CIRCLE,
                fillColor: '#4285F4', fillOpacity: 1, scale: 7,
                strokeColor: 'white', strokeWeight: 2
            }
        });
        userHeading = new google.maps.Marker({
            map: map,
            clickable: false,
            visible: false,
            icon: {
                path: "M-10,0 L0,-20 L10,0 A15,15 0 0,1 -10,0 Z", // Cone shape
                fillColor: '#4285F4', fillOpacity: 0.3, scale: 2,
                strokeWeight: 0, rotation: 0,
                anchor: new google.maps.Point(0, 0)
            }
        });

        // --- Events ---
        marker.addListener("dragend", () => {
            const pos = marker.getPosition();
            updateLocationInputs(pos.lat(), pos.lng());
        });

        // Handle Native Fullscreen Clicks
        map.addListener("click", (e) => {
            if (isMapInFullscreen()) {
                marker.setPosition(e.latLng);
                updateLocationInputs(e.latLng.lat(), e.latLng.lng());
            } else {
                console.log("Map locked. Use Fullscreen button to edit.");
            }
        });

        // Auto-Unlock on Fullscreen
        const handleFullscreenChange = () => {
            if (isMapInFullscreen()) {
                marker.setDraggable(true);
                mapEl.style.cursor = "crosshair";
            } else {
                marker.setDraggable(false);
                mapEl.style.cursor = "default";
            }
        };

        document.addEventListener("fullscreenchange", handleFullscreenChange);
        document.addEventListener("webkitfullscreenchange", handleFullscreenChange);
        document.addEventListener("mozfullscreenchange", handleFullscreenChange);
        document.addEventListener("msfullscreenchange", handleFullscreenChange);

        isMapReady = true;
        if (pendingMapUpdate) updateMapFromState();
    };

    function startLiveTracking() {
        // 1. TRACK POSITION (The Blue Dot)
        if (navigator.geolocation) {
            navigator.geolocation.watchPosition((position) => {
                const pos = {
                    lat: position.coords.latitude,
                    lng: position.coords.longitude
                };
                userMarker.setPosition(pos);
            }, (err) => console.warn("GPS error:", err), { enableHighAccuracy: true });
        }

        // 2. TRACK DIRECTION (The Beam)
        if (window.DeviceOrientationEvent) {
            window.addEventListener('deviceorientationabsolute', (event) => {
                let heading = event.alpha; // North is 0
                if (event.webkitCompassHeading) heading = event.webkitCompassHeading; // iOS Fix

                if (heading !== null && userMarker.getPosition()) {
                    const userPos = userMarker.getPosition();
                    // Create a short line pointing in the direction the user is facing
                    const beamLength = 0.0002; // Roughly 20 meters
                    const endLat = userPos.lat() + (beamLength * Math.cos(heading * Math.PI / 180));
                    const endLng = userPos.lng() + (beamLength * Math.sin(heading * Math.PI / 180));

                    directionBeam.setPath([userPos, { lat: endLat, lng: endLng }]);
                    directionBeam.setVisible(true);
                }
            }, true);
        }
    }


    /* =========================
       3. HELPER FUNCTIONS
    ========================= */
    // Robust Fullscreen Check
    function isMapInFullscreen() {
        return document.fullscreenElement ||
            document.webkitFullscreenElement ||
            document.mozFullScreenElement ||
            document.msFullscreenElement;
    }

    function updateLocationInputs(lat, lng) {
        const latInput = document.getElementById("input_lat");
        const lngInput = document.getElementById("input_lng");

        if (latInput) latInput.value = lat.toFixed(6);
        if (lngInput) lngInput.value = lng.toFixed(6);

        // Call Global Save if available
        if (typeof updateNestedState === "function") {
            updateNestedState(formState, 'land_inspection_details.latitude', lat.toFixed(6));
            updateNestedState(formState, 'land_inspection_details.longitude', lng.toFixed(6));

            clearTimeout(autoSaveTimer);
            autoSaveTimer = setTimeout(() => saveToServer(), 2000);
        }
    }

    function updateMapFromState() {
        if (!isMapReady || !map || !marker) {
            pendingMapUpdate = true;
            return;
        }
        const lat = parseFloat(getNestedValue(formState, 'land_inspection_details.latitude'));
        const lng = parseFloat(getNestedValue(formState, 'land_inspection_details.longitude'));

        if (!isNaN(lat) && !isNaN(lng) && lat !== 0 && lng !== 0) {
            const pos = { lat: lat, lng: lng };
            map.setCenter(pos);
            marker.setPosition(pos);
            map.setZoom(19);

            const latInput = document.getElementById("input_lat");
            const lngInput = document.getElementById("input_lng");
            if (latInput) latInput.value = lat;
            if (lngInput) lngInput.value = lng;

            pendingMapUpdate = false;
        }
    }

    /* =========================
       FIXED GPS & COMPASS LOGIC
    ========================= */
    async function getCurrentLocation() {
        const btn = event.currentTarget;
        const originalContent = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Locating...';

        // 1. Request Compass Permission (CRITICAL for iOS/Android Chrome/Safari)
        if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function') {
            try {
                const permission = await DeviceOrientationEvent.requestPermission();
                if (permission !== 'granted') {
                    alert("Permission denied for compass. Heading beam will not show.");
                }
            } catch (e) { console.error("Permission error:", e); }
        }

        // 2. Start Live Position Tracking
        if (navigator.geolocation) {
            // use watchPosition for real-time movement, or getCurrentPosition for a one-time snap
            navigator.geolocation.getCurrentPosition((position) => {
                const pos = {
                    lat: position.coords.latitude,
                    lng: position.coords.longitude
                };

                // Move the property marker to user location
                marker.setPosition(pos);
                map.setCenter(pos);
                map.setZoom(19); // Zoom in close for accuracy

                // Update the text inputs
                updateLocationInputs(pos.lat, pos.lng);

                // Show the user's "Blue Dot" and heading beam
                if (userMarker) userMarker.setPosition(pos);
                if (userHeading) {
                    userHeading.setPosition(pos);
                    userHeading.setVisible(true);
                }

                btn.innerHTML = originalContent;
                console.log("GPS Updated successfully.");
            }, (err) => {
                alert("GPS Error: " + err.message);
                btn.innerHTML = originalContent;
            }, {
                enableHighAccuracy: true,
                timeout: 10000,
                maximumAge: 0
            });
        } else {
            alert("Geolocation is not supported by this browser.");
            btn.innerHTML = originalContent;
        }

        // 3. Start Direction Tracking (Heading) - Only attaches if not already listening
        if (!window.headingListenerActive) {
            window.addEventListener('deviceorientation', (event) => {
                let heading = 0;
                if (event.webkitCompassHeading) {
                    heading = event.webkitCompassHeading; // iOS
                } else if (event.alpha) {
                    heading = 360 - event.alpha; // Android logic
                }

                if (userHeading && userHeading.getVisible()) {
                    const icon = userHeading.getIcon();
                    icon.rotation = heading;
                    userHeading.setIcon(icon);
                }
            }, true);
            window.headingListenerActive = true;
        }
    }
    /* =========================
       RENT DURATION LOGIC
    ========================= */
    function handleRentDurationChange() {
        const y = document.getElementById('rent_years').value || 0;
        const m = document.getElementById('rent_months').value || 0;

        // Combine into a single string for the database
        const finalString = `${y} Years ${m} Months`;

        const masterInput = document.getElementById('rent_duration_master');
        masterInput.value = finalString;

        // Trigger the existing auto-save logic
        masterInput.dispatchEvent(new Event('input', { bubbles: true }));
    }

    function splitRentDurationToUI() {
        const masterInput = document.getElementById('rent_duration_master');
        const val = masterInput.value || "";

        // Parse "X Years Y Months"
        const yearsMatch = val.match(/(\d+)\s*Years/i);
        const monthsMatch = val.match(/(\d+)\s*Months/i);

        if (yearsMatch) document.getElementById('rent_years').value = yearsMatch[1];
        if (monthsMatch) document.getElementById('rent_months').value = monthsMatch[1];
    }
    /* =========================
       LOCATION & PANCHAYAT LOGIC
    ========================= */

    // Dummy data for now - You can replace these lists later
    const panchayatData = {
        "Ernakulam": ["Aluva", "Angamaly", "Kalady", "Kunnathunad", "Paravur"],
        "Thiruvananthapuram": ["Attingal", "Nedumangad", "Neyyattinkara", "Varkala"],
        "Kollam": ["Karunagappally", "Kottarakkara", "Punalur"],
        "Thrissur": ["Chalakudy", "Kodungallur", "Guruvayur"],
        "Kozhikode": ["Vadakara", "Koyilandy", "Ramanattukara"]
        // Add other districts as empty arrays or full lists later
    };

    function togglePanchayatField() {
        const typeSelect = document.getElementById('localBodySelect');
        const wrapper = document.getElementById('panchayatWrapper');

        // Check if "Grama Panchayat" is selected
        if (typeSelect && typeSelect.value === "Grama Panchayat") {
            wrapper.classList.remove('hidden');
        } else {
            wrapper.classList.add('hidden');
            // Optional: Clear the value if hidden
            const pSelect = document.getElementById('panchayatSelect');
            if (pSelect) {
                pSelect.value = "";
                // We manually trigger the data update since we changed value via JS
                const path = pSelect.getAttribute('data-path');
                if (path) updateNestedState(formState, path, "");
            }
        }
        updateCompletionStats();
    }

    function updatePanchayatList() {
        const districtSelect = document.getElementById('districtSelect');
        const panchayatSelect = document.getElementById('panchayatSelect');
        const selectedDist = districtSelect.value;

        // 1. Clear existing options
        panchayatSelect.innerHTML = '<option value="">Select Panchayat</option>';

        // 2. Get list for this district
        const list = panchayatData[selectedDist] || []; // Returns empty array if district not found

        // 3. Populate new options
        list.forEach(name => {
            const opt = document.createElement('option');
            opt.value = name;
            opt.textContent = name;
            panchayatSelect.appendChild(opt);
        });
    }
    /* =========================
       COMPLETION TRACKING LOGIC (With Sketch Awareness)
    ========================= */
    function updateCompletionStats() {
        // 1. Select inputs (excluding hidden ones)
        const allInputs = document.querySelectorAll('[data-path]:not([type="hidden"]), [data-array]:not([type="hidden"])');

        let totalFields = 0;
        let filledFields = 0;
        let uniqueArrayFields = new Set();

        allInputs.forEach(el => {
            // Ignore the hidden master input for years/months
            if (el.id === 'rent_duration_master') return;

            // A. Checkboxes & Radios (Group Logic)
            if (el.type === 'checkbox' || el.type === 'radio') {
                const name = el.getAttribute('data-array') || el.name;
                if (!uniqueArrayFields.has(name)) {
                    uniqueArrayFields.add(name);
                    totalFields++;
                    const group = document.querySelectorAll(`[data-array="${name}"], [name="${name}"]`);
                    let isGroupFilled = false;
                    group.forEach(item => { if (item.checked) isGroupFilled = true; });
                    if (isGroupFilled) filledFields++;
                }
            }
            // B. Text, Number, Selects, Textareas
            else {
                // Strict check: Ignore "notselected" (dropdown default) and empty strings
                // We only count it as a "field" if it is actually visible on screen
                if (el.offsetParent !== null) {
                    totalFields++;

                    const val = el.value.trim();
                    const path = el.getAttribute('data-path');

                    // 1. Check for Text
                    const hasText = val !== "" && val !== "notselected";

                    // 2. Check for Saved Image/Sketch (The Fix)
                    // We check if the 'images' object in state has a key matching this input's path
                    const hasImage = path && formState.images && formState.images[path] && formState.images[path].length > 0;

                    // If EITHER is present, it is filled
                    if (hasText || hasImage) {
                        filledFields++;
                    }
                }
            }
        });

        // 2. Calculate
        let percent = 0;
        if (totalFields > 0) {
            percent = Math.round((filledFields / totalFields) * 100);
        }

        // 3. Update UI
        const bar = document.getElementById('progressBar');
        const txt = document.getElementById('progressText');
        if (bar && txt) {
            bar.style.width = percent + "%";
            txt.innerText = percent + "%";

            if (percent < 30) bar.style.background = "#ef4444";
            else if (percent < 70) bar.style.background = "#facc15";
            else bar.style.background = "#4ade80";
        }

        // 4. Save to State
        if (formState.completion_metrics) {
            formState.completion_metrics = {
                percent: percent,
                filled: filledFields,
                total: totalFields,
                last_updated: new Date().toISOString()
            };
        }
    }
    /* =========================
       DRAGGABLE RESIZER LOGIC (Desktop + Tablet Fix)
    ========================= */
    document.addEventListener("DOMContentLoaded", () => {
        const resizer = document.getElementById('dragHandle');
        const leftSide = document.getElementById('leftColumn');
        const container = document.getElementById('mainLayout');

        if (!resizer || !leftSide || !container) return;

        let isResizing = false;

        // Helper: Get X coordinate from either Mouse or Touch event
        const getX = (e) => {
            return e.type.includes('touch') ? e.touches[0].clientX : e.clientX;
        };

        // 1. START DRAGGING
        const startDrag = (e) => {
            isResizing = true;
            document.body.classList.add('resizing');
            resizer.classList.add('active');

            // Prevent default touch actions (like scrolling while dragging)
            if (e.type === 'touchstart') {
                // e.preventDefault(); // Optional: Uncomment if dragging causes page scroll
            }
        };

        // 2. WHILE DRAGGING
        const onDrag = (e) => {
            if (!isResizing) return;

            // Prevent selecting text or scrolling while resizing
            if (e.type.includes('touch')) e.preventDefault();

            const containerRect = container.getBoundingClientRect();
            const clientX = getX(e);

            // Calculate new width relative to container left edge
            const newWidth = clientX - containerRect.left;

            // Constraints
            const minW = 300;
            const maxW = containerRect.width - 640; // Keep space for right side

            if (newWidth > minW && newWidth < maxW) {
                leftSide.style.width = `${newWidth}px`;
                leftSide.style.flexBasis = `${newWidth}px`; // Force flex update
            }
        };

        // 3. STOP DRAGGING
        const stopDrag = () => {
            if (isResizing) {
                isResizing = false;
                document.body.classList.remove('resizing');
                resizer.classList.remove('active');

                // Fix: Re-render canvas if it was open during resize
                if (typeof resizeCanvas === 'function') resizeCanvas();
            }
        };

        // --- ATTACH LISTENERS (MOUSE) ---
        resizer.addEventListener('mousedown', startDrag);
        document.addEventListener('mousemove', onDrag);
        document.addEventListener('mouseup', stopDrag);

        // --- ATTACH LISTENERS (TOUCH / TABLET) ---
        resizer.addEventListener('touchstart', startDrag, { passive: false });
        document.addEventListener('touchmove', onDrag, { passive: false });
        document.addEventListener('touchend', stopDrag);
    });

    /* =========================
       SITE PHOTO UPLOAD LOGIC
       ========================= */

    // 1. Check if the button should be visible
    function checkFileNumberForUpload() {
        const fileNoInput = document.querySelector('input[data-path="Valuers_Checklist.Office_file_no"]');
        const uploadBtn = document.getElementById("sitePhotoUploadContainer");

        if (fileNoInput && uploadBtn) {
            // Show if there is text in the File Number input
            if (fileNoInput.value.trim().length > 0) {
                uploadBtn.classList.remove("hidden");
                uploadBtn.style.display = "flex";
            } else {
                uploadBtn.classList.add("hidden");
                uploadBtn.style.display = "none";
            }
        }
    }

    // 2. Handle the actual file upload
    async function handleSitePhotoUpload(inputElement) {
        const files = inputElement.files;
        if (!files || files.length === 0) return;

        // Ensure a folder is selected on the left
        if (!currentFolder) {
            alert("Please select a folder from the left list first.");
            inputElement.value = ""; // Reset
            return;
        }

        const statusText = document.getElementById("uploadStatusText");
        statusText.innerText = "Uploading...";
        statusText.style.color = "orange";

        const formData = new FormData();
        formData.append('current_folder', currentFolder);

        // Append all selected files
        for (let i = 0; i < files.length; i++) {
            formData.append('site_photos', files[i]);
        }

        try {
            const response = await fetch('/coreapi/api/upload-site-photos/', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrftoken // Uses your existing getCookie logic
                },
                body: formData
            });

            const result = await response.json();

            if (result.success) {
                statusText.innerText = "Done! Saved to /p";
                statusText.style.color = "green";

                setTimeout(() => { statusText.innerText = ""; }, 3000);

                // SAVE PATHS TO FORM STATE
                // This ensures the report knows which images belong to it
                if (!formState.site_photos) formState.site_photos = [];

                result.saved_paths.forEach(path => {
                    if (!formState.site_photos.includes(path)) {
                        formState.site_photos.push(path);
                    }
                });

                // Trigger Auto-Save immediately to save the new image paths
                saveLocal();
                saveToServer();

            } else {
                alert("Upload Error: " + result.error);
                statusText.innerText = "Error";
                statusText.style.color = "red";
            }
        } catch (err) {
            console.error(err);
            alert("Network Error uploading photos.");
            statusText.innerText = "Error";
            statusText.style.color = "red";
        }

        // Reset input so users can upload the same file again if needed
        inputElement.value = "";
    }
    /* =========================
       DATABASE CASE FINDER
    ========================= */
    const caseInput = document.getElementById('caseSearchInput');
    const bankSelect = document.getElementById('bank_select');
    const distSelect = document.getElementById('district_select');
    const yearSelect = document.getElementById('year_select');
    const searchBtn = document.getElementById('searchCaseBtn');

    // 1. Safely attach Button Click Listener
    if (searchBtn) {
        searchBtn.addEventListener('click', performCaseSearch);
    } else {
        console.error("Search Button not found in HTML!");
    }

    // 2. Safely attach Enter Key Listener
    if (caseInput) {
        caseInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault(); // Prevent accidental form submission
                performCaseSearch();
            }
        });
    }

    async function performCaseSearch() {
        // Grab values safely
        const bank = bankSelect ? bankSelect.value : "";
        const dist = distSelect ? distSelect.value : "";
        const year = yearSelect ? yearSelect.value : "";
        const q = caseInput ? caseInput.value.trim() : "";

        const listContainer = document.getElementById('searchResultsList');
        if (!listContainer) return;

        if (!q) {
            listContainer.innerHTML = `<li class="p-4 text-center text-gray-400 text-sm">Please type a file number or name to search.</li>`;
            return;
        }

        // UI Loading State
        const originalBtnHTML = searchBtn.innerHTML;
        searchBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Searching...';
        searchBtn.disabled = true;
        searchBtn.style.opacity = "0.7";

        listContainer.innerHTML = `<li class="p-4 text-center text-blue-600"><i class="fas fa-spinner fa-spin text-2xl mb-2"></i><br>Searching Database...</li>`;

        try {
            const url = `/coreapi/api/db-case-search/?bank=${bank}&dist=${dist}&year=${year}&q=${encodeURIComponent(q)}`;
            const response = await fetch(url);
            const data = await response.json();

            listContainer.innerHTML = "";

            // IF NOT FOUND: Show Red Error Box
            if (!data.folders || data.folders.length === 0) {
                listContainer.innerHTML = `
                <div style="padding: 15px; text-align: center; color: #ef4444; background: #fee2e2; border-radius: 8px; margin: 10px; border: 1px solid #fca5a5;">
                    <i class="fas fa-exclamation-circle text-2xl mb-2"></i><br>
                    <strong>Case Not Found</strong><br>
                    <span style="font-size: 12px; color: #b91c1c;">No matching record in the database.</span>
                </div>`;
                return;
            }

            // IF FOUND: Show Green Success Banner, then append items
            listContainer.innerHTML = `
            <div style="padding: 8px; background: #dcfce7; color: #166534; font-size: 12px; font-weight: bold; text-align: center; border-bottom: 1px solid #bbf7d0;">
                <i class="fas fa-check-circle"></i> Found ${data.folders.length} matching case(s)
            </div>`;

            // Append results 
            appendFileList(data.folders, [], listContainer);

        } catch (err) {
            console.error("Database search failed", err);
            listContainer.innerHTML = `
            <div style="padding: 15px; text-align: center; color: #ef4444; background: #fee2e2; border-radius: 8px; margin: 10px;">
                <i class="fas fa-wifi text-2xl mb-2"></i><br>
                <strong>Network Error</strong><br>
                <span style="font-size: 12px;">Could not connect to the database.</span>
            </div>`;
        } finally {
            // Restore Button State
            if (searchBtn) {
                searchBtn.innerHTML = originalBtnHTML;
                searchBtn.disabled = false;
                searchBtn.style.opacity = "1";
            }
        }
    }
</script>
<script
    src="https://maps.googleapis.com/maps/api/js?key={{ google_maps_api_key }}&callback=initMap&libraries=places&v=weekly"
    async defer></script>
{% endblock %}