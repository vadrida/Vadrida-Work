{% extends "base.html" %}
{% load static %}
{% block title %}Site Feedback Form â€” Vadrida{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="{% static 'css/feedback.css' %}">
<style>
/* Fullscreen Animation & Layout */
.right-column {
    display: flex;       /* Use Flexbox */
    flex-direction: column; /* Stack children vertically */
    height: 100%;        /* Fill height */
    overflow: hidden;    /* PREVENT the container itself from scrolling */
    background: white;
    position: relative;
    
    /* Animation settings */
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}
.right-column.fullscreen-active {
        position: fixed !important;
        top: 0 !important;
        left: 0 !important;
        width: 100vw !important;
        height: 100vh !important;
        
        /* SUPER HIGH Z-INDEX to cover Navbar (which is usually 1000) */
        z-index: 100 !important; 
        
        background: #ffffff;
        overflow-y: auto !important; /* The DIV handles scrolling now */
        padding: 0 !important;
        margin: 0 !important;
    }
/* Ensure the form inside scrolls properly when full screen */
.right-column.fullscreen-active .form-section {
    height: 100%;
    display: flex;
    flex-direction: column;
    padding: 0;
    border: none;
    box-shadow: none;
}

/* Make the actual form scrollable, keeping the header fixed at top */
.right-column.fullscreen-active .feedback-form {
    flex: 1;
    overflow-y: auto;
    padding: 0 20px 40px 20px; /* Add bottom padding for submit buttons */
}
.form-header {
    flex-shrink: 0;      /* Never shrink */
    z-index: 10;
    background-color: #ffffff;
    border-bottom: 1px solid #e5e7eb;
    padding: 15px 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    box-shadow: 0 2px 4px rgba(0,0,0,0.05);
}
.right-column.fullscreen-active .form-header {
    margin: -20px -20px 20px -20px; 
    padding: 15px 25px;
    background-color: #f8f9fa;
    border-radius: 0;
    z-index: 9999;
}
.feedback-form {
    flex-grow: 1;        /* Take up all remaining space */
    overflow-y: auto;    /* ENABLE SCROLLING here */
    padding: 20px;
    padding-bottom: 100px; /* Space for buttons */
}
.form-section {
    display: flex;
    flex-direction: column;
    height: 100%;
}
</style>
{% endblock %}

{% block content %}
<!-- Navigation Bar -->
<nav class="feedback-nav">
  <div class="nav-content">
    <div class="nav-left">
      <a href="{% url 'coreapi:dashboard' %}" class="nav-link back-link">
        <i class="fas fa-arrow-left"></i> Back to Dashboard
      </a>
    </div>
    <div class="nav-center">
      <h1 class="page-title">Site Feedback Form</h1>
    </div>
    <div class="nav-right">
      <span class="user-info">{{ request.session.user_name }}</span>
    </div>
  </div>
</nav>

<div id="orientationBlocker" class="orientation-blocker hidden">
  <div class="orientation-box">
    <h2>Rotate Device</h2>
    <p>This page works only in <b>landscape mode</b> on tablets.</p>
  </div>
</div>

<div class="relative">
  <!-- Loading overlay for Analyse action -->
  <div id="analyseLoading" class="loading-overlay hidden">
    <div class="spinner"></div>
    <div class="text-lg font-semibold">Analyzing â€” please wait...</div>
    <div class="text-sm">Processing your file...</div>
  </div>
  <div class="sticky top-[90px] z-40 bg-white border-b border-gray-200 px-4 py-3 mb-4 shadow-sm flex items-center">
      <div class="text-gray-500 mr-2 text-sm">
          <i class="fas fa-folder-open text-yellow-500"></i> Current Location:
      </div>
      <div id="topBannerPath" class="font-mono text-sm text-blue-700 font-semibold tracking-wide truncate">
          /
      </div>
  </div>
  <div class="feedback-layout">
    <!-- LEFT COLUMN: File List + Preview -->
    <div class="left-column">
  <section class="file-section">
    <div class="section-header">
      <h3 class="section-title">Files</h3>
      <button id="refreshFolders" class="refresh-btn">ðŸ”„</button>
    </div>

    <div class="file-controls">
      <input id="fileSearch" type="text" placeholder="Search file id or name..." class="search-input" />
      <div class="path-nav">
        <button id="goBackBtn" class="nav-btn">â¬…</button>
        <span id="currentPath" class="break-all whitespace-normal font-mono text-xs text-gray-500 leading-tight">/</span>
      </div>
    </div>

    <div id="folderStatsBox" class="hidden mb-3 p-3 bg-gray-50 border rounded text-xs space-y-1 flex-shrink-0 shadow-inner">
    </div>
    <div class="file-list-container">
      <ul id="fileList" class="file-list"></ul>
    </div>

  </section>

  <section class="preview-section">
        <div class="section-header">
          <h3 class="section-title">Preview</h3>
          <div class="preview-controls">
            <button id="analyseBtn" class="analyse-btn">Analyse</button>
            <button id="openFullBtn" class="control-btn">Open Full</button>
          </div>
        </div>

        <div id="thumbs" class="thumbs-strip"></div>

        <div class="preview-container">
          <div class="preview-header" style="height: auto; min-height: 50px; padding: 10px; display: flex; justify-content: space-between; align-items: center; background: #f3f4f6; border-bottom: 1px solid #ddd;">
            <div id="bigPreviewTitle" class="preview-title break-all whitespace-normal leading-tight" style="flex: 1; padding-right: 10px; font-family: monospace; font-weight: 600; color: #374151;">
                Home / Root
            </div>
            <button hidden id="downloadPdfBtn" class="download-btn hidden">
                <i class="fas fa-file-download"></i>
            </button>
          </div>
          
          <div id="bigViewer" class="relative h-full flex flex-col bg-gray-100" style="overflow: hidden;">
            
            <div id="noSelection" class="flex items-center justify-center h-full text-gray-400">
                Select a file to preview
            </div>

            <div id="pdfToolbar" class="hidden flex items-center justify-between px-4 py-2 bg-white border-b shadow-sm z-10">
                <div class="text-sm font-semibold text-gray-600" id="pageCountDisplay">Page 1</div>
                <div class="flex items-center gap-2">
                  </div>
            </div>

            <div id="scrollContainer" class="hidden flex-1 overflow-y-auto p-4 flex flex-col items-center gap-4">
                <div id="scrollSentinel" class="w-full h-20 flex items-center justify-center text-gray-400">
                    <div class="spinner border-4 border-gray-300 border-t-blue-500 rounded-full w-6 h-6 animate-spin"></div>
                </div>
            </div>
            
            <div id="bigImageContainer" class="hidden w-full h-full flex items-center justify-center overflow-hidden relative z-20" style="touch-action: none; cursor: grab;">
                <img id="bigImageFrame" class="max-w-full max-h-full object-contain transition-transform duration-100 ease-out origin-center" src="" alt="Preview" />
            </div>

          </div>
        </div>
      </section>
</div>

    <!-- RIGHT COLUMN: Comprehensive Feedback Form -->
   <div class="right-column" id="rightColumnContainer">
      <div class="form-section">
        
        <div class="form-header" style="display: flex; justify-content: space-between; align-items: center;">
          <h3 class="section-title">Site Feedback Form</h3>
          <button type="button" id="toggleFormFullscreenBtn" class="control-btn" title="Toggle Fullscreen" 
                  style="background: transparent; position:sticky; border: none; color: #374151; font-size: 1.1rem; cursor: pointer; padding: 5px;">
            <i class="fas fa-expand"></i>
          </button>
        </div>

        <form id="siteFeedbackForm" class="feedback-form">
          
          <!-- Valuers Checklist -->
          <div class="form-section-group">
            <h4 class="form-section-title">Site Inspection Report</h4>
            
            <div class="form-row">
              <div class="form-group">
                <label class="form-label">1. Office File No.</label>
                <input type="number" data-path="Valuers_Checklist.Office_file_no" class="form-input">
              </div>
              <div class="form-group">
                <label class="form-label">2. Applicant Name</label>
                <input type="text" data-path="Valuers_Checklist.applicant_name" class="form-input">
              </div>
            </div>

            <div class="form-row">
              <div class="form-group">
                <label class="form-label">3. Inspection Date</label>
                <input type="date" data-path="Valuers_Checklist.inspection_date" class="form-input">
              </div>
              <div class="form-group">
                <label class="form-label">4. Name of the person met at site</label>
                <input type="text" data-path="Valuers_Checklist.person_met" class="form-input">
              </div>
            </div>

            <div class="form-group">
              <label class="form-label">5. Product</label>
              <select data-path="Valuers_Checklist.product" class="form-select">
                <option value="notselected">Select Product</option>
                <option value="1st purchase">1st Purchase</option>
                <option value="construction">Construction</option>
                <option value="topup">Top Up</option>
                <option value="pd">PD</option>
                <option value="resale">Resale</option>
                <option value="renovation">Renovation</option>
                <option value="takeover">Takeover</option>
                <option value="lap">LAP</option>
                <option value="extension">Extension</option>
                <option value="npa">NPA</option>
              </select>
            </div>

            <div class="form-group">
              <label class="form-label">6. Documents Received</label>
              <div class="checkbox-grid">
                <label class="checkbox-label"><input type="checkbox" data-array="Valuers_Checklist.documents_received" value="Agreement"> Agreement</label>
                <label class="checkbox-label"><input type="checkbox" data-array="Valuers_Checklist.documents_received" value="Encumbrance"> Encumbrance</label>
                <label class="checkbox-label"><input type="checkbox" data-array="Valuers_Checklist.documents_received" value="Building Permit"> Building Permit</label>
                <label class="checkbox-label"><input type="checkbox" data-array="Valuers_Checklist.documents_received" value="Declaration"> Declaration</label>
                <label class="checkbox-label"><input type="checkbox" data-array="Valuers_Checklist.documents_received" value="Location Sketch"> Location Sketch</label>
                <label class="checkbox-label"><input type="checkbox" data-array="Valuers_Checklist.documents_received" value="Development Permit"> Development Permit</label>
                <label class="checkbox-label"><input type="checkbox" data-array="Valuers_Checklist.documents_received" value="Title Deed"> Title Deed</label>
                <label class="checkbox-label"><input type="checkbox" data-array="Valuers_Checklist.documents_received" value="Survey Sketch"> Survey Sketch</label>
                <label class="checkbox-label"><input type="checkbox" data-array="Valuers_Checklist.documents_received" value="Building Certificate"> Building Certificate</label>
                <label class="checkbox-label"><input type="checkbox" data-array="Valuers_Checklist.documents_received" value="LTR"> LTR</label>
                <label class="checkbox-label"><input type="checkbox" data-array="Valuers_Checklist.documents_received" value="Building Tax receipt"> Building Tax Receipt</label>
                <label class="checkbox-label"><input type="checkbox" data-array="Valuers_Checklist.documents_received" value="Approved plan"> Approved Plan</label>
                <label class="checkbox-label"><input type="checkbox" data-array="Valuers_Checklist.documents_received" value="Possession"> Possession</label>
                <label class="checkbox-label"><input type="checkbox" data-array="Valuers_Checklist.documents_received" value="Engineers plan"> Engineers Plan</label>
              </div>
            </div>
          </div>

          <!-- I. Ownership Analysis -->
          <div class="form-section-group">
            <h4 class="form-section-title">I. Ownership Analysis</h4>
            
            <div class="form-group">
                <label class="form-label">1. Owner(s) Name</label>
                <input type="text" data-path="Ownership_Analysis.owners_name" class="form-input">
            </div>
            
            <div class="form-group">
                <label class="form-label">Document Verification</label>
                <div class="checkbox-group">
                <label class="checkbox-label">
                    <input type="radio" name="doc_verification" 
                        data-path="Ownership_Analysis.document_verification" 
                        value="same in all documents"
                        onchange="toggleOwnershipNotes()"> 
                    Same in all documents
                </label>
                
                <label class="checkbox-label">
                    <input type="radio" name="doc_verification" 
                        data-path="Ownership_Analysis.document_verification" 
                        value="discrepancy noted"
                        onchange="toggleOwnershipNotes()"> 
                    Discrepancy noted
                </label>
                </div>
            </div>

            <div id="ownershipNotesBox" class="form-group mt-3 hidden">
                <label class="form-label">Notes on discrepancy</label>
                <textarea data-path="Ownership_Analysis.Ownership_Analysis_notes" class="form-textarea" rows="4" style="width: 100%;"></textarea>
            </div>
            </div>
          <!-- II. Survey Number and Land Extend Analysis -->
          <div class="form-section-group">
            <h4 class="form-section-title">II. Survey Number and Land Extend Analysis</h4>
            
            <div class="table-container" style="overflow-x: auto;">
                <table class="analysis-table survey-table" id="surveyTable">
                    <thead>
                        <tr id="surveyHeader">
                            <th style="min-width: 150px; position: sticky; left: 0; z-index: 10;">Doc Name</th>
                            </tr>
                    </thead>
                    <tbody id="surveyBody">
                        <tr data-row-key="scedule_no"><td>Scedule No</td></tr>
                        <tr data-row-key="re_sy_block_no"><td>Re-Sy Block No</td></tr>
                        <tr data-row-key="re_sy_no"><td>Re-Sy No</td></tr>
                        <tr data-row-key="re_sy_subdiv_no"><td>Re-Sy Subdiv No</td></tr>
                        <tr data-row-key="sy_block_no"><td>Sy Block No</td></tr>
                        <tr data-row-key="sy_no"><td>Sy No</td></tr>
                        <tr data-row-key="sy_subdiv_no"><td>Sy Subdiv No</td></tr>
                        <tr data-row-key="land_extent"><td>Land Extent (Ares)</td></tr>
                        <tr data-row-key="land_classification"><td>Land Classification</td></tr>
                    </tbody>
                </table>
            </div>

            <button type="button" class="timeline-btn add-btn" onclick="addSurveyColumn()" title="Add Column">
                <i class="fas fa-plus"></i>
            </button>

    
            <div id="surveyTotalsContainer" class="mt-4 mb-4 p-3 bg-blue-50 border border-blue-100 rounded-lg hidden">
                <h5 class="font-bold text-sm text-blue-800 mb-2">Land Extent Total (Ares)</h5>
                
                <div class="grid grid-cols-2 gap-4">
                    <div id="ltr_total_wrapper" class="form-group mb-0 hidden">
                    <label class="text-xs font-semibold text-gray-500 uppercase">1. LTR Total</label>
                    <input type="text" id="total_ltr_extent" data-path="Survey.total_ltr_extent" class="form-input font-bold text-gray-700 bg-white" readonly>
                </div>

                <div id="deed_total_wrapper" class="form-group mb-0 hidden">
                    <label class="text-xs font-semibold text-gray-500 uppercase">2. Title Deed Total</label>
                    <input type="text" id="total_deed_extent" data-path="Survey.total_deed_extent" class="form-input font-bold text-gray-700 bg-white" readonly>
                </div>
                </div>
            </div>
            <div id="wetLandQuestions" class="mt-3 p-3 bg-orange-50 border border-orange-100 rounded-lg hidden">
                <h5 class="font-bold text-sm text-orange-800 mb-2">Wet Land Verification (LTR)</h5>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="form-group mb-0">
                        <label class="text-xs font-semibold text-gray-700">Are 3 sides Paddy land (Paadam)?</label>
                        <div class="flex gap-4 mt-1">
                            <label class="inline-flex items-center">
                                <input type="radio" name="paddy_land_check" data-path="Survey.paddy_land_check" value="Yes" class="form-radio h-4 w-4 text-orange-600">
                                <span class="ml-2 text-sm">Yes</span>
                            </label>
                            <label class="inline-flex items-center">
                                <input type="radio" name="paddy_land_check" data-path="Survey.paddy_land_check" value="No" class="form-radio h-4 w-4 text-orange-600">
                                <span class="ml-2 text-sm">No</span>
                            </label>
                        </div>
                    </div>

                    <div class="form-group mb-0">
                        <label class="text-xs font-semibold text-gray-700">Are there trees/buildings existing before 2008?</label>
                        <div class="flex gap-4 mt-1">
                            <label class="inline-flex items-center">
                                <input type="radio" name="trees_2008_check" data-path="Survey.trees_2008_check" value="Yes" class="form-radio h-4 w-4 text-orange-600">
                                <span class="ml-2 text-sm">Yes</span>
                            </label>
                            <label class="inline-flex items-center">
                                <input type="radio" name="trees_2008_check" data-path="Survey.trees_2008_check" value="No" class="form-radio h-4 w-4 text-orange-600">
                                <span class="ml-2 text-sm">No</span>
                            </label>
                        </div>
                    </div>
                </div>
            </div>
            <div class="form-group mt-4">
                <label class="form-label">Deviations in Survey no, land extend, land Classification ... etc. if any.</label>
                <textarea data-path="Survey.survey_notes" class="form-textarea" rows="4" style="width: 100%;"></textarea>
            </div>


        </div>
          <!-- III. Boundary Analysis and Property Identification -->
          <div class="form-section-group">
            <h4 class="form-section-title">III. Boundary Analysis and Property Identification</h4>
            
            <div class="table-container">
              <table class="analysis-table">
                <thead>
                  <tr>
                    <th style="width: 10%;">Direction</th>
                    
                    <th style="width: 25%;">
                      <label class="text-xs font-bold block mb-1">Ref Doc 1</label>
                      <select data-path="Boundary_analysis_property_identification.ref_doc_1_name" class="form-select dynamic-doc-dropdown" style="width: 100%; color: #000;">
                          <option value="">Select Document</option>
                      </select>
                    </th>

                    <th style="width: 25%;">
                      <label class="text-xs font-bold block mb-1">Ref Doc 2</label>
                      <select data-path="Boundary_analysis_property_identification.ref_doc_2_name" class="form-select dynamic-doc-dropdown" style="width: 100%; color:#000">
                          <option value="">Select Document</option>
                      </select>
                    </th>

                    <th style="width: 20%;">Translation Reason if any</th>
                    
                    <th style="width: 20%;">
                        Site
                        <div style="margin-top: 5px;">
                            <label style="font-size: 11px; font-weight: normal; color: white; display: flex; align-items: center; gap: 6px; cursor: pointer; background: rgba(255,255,255,0.2); padding: 2px 6px; border-radius: 4px;">
                                <input type="checkbox" onchange="copyAllDocsToSites(this)" style="width: 12px; height: 12px;"> 
                                Same as in doc (All)
                            </label>
                        </div>
                    </th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                      <td>East</td>
                      <td><input type="text" data-path="Boundary_analysis_property_identification.east_doc1" class="table-input" placeholder="Val as per Doc 1"></td>
                      <td><input type="text" data-path="Boundary_analysis_property_identification.east_doc2" class="table-input" placeholder="Val as per Doc 2"></td>
                      <td><input type="text" data-path="Boundary_analysis_property_identification.east_translation" class="table-input"></td>
                      <td><input type="text" data-path="Boundary_analysis_property_identification.east_site" class="table-input"></td>
                  </tr>
                  <tr>
                    <td>North</td>
                    <td><input type="text" data-path="Boundary_analysis_property_identification.north_doc1" class="table-input" placeholder="Val as per Doc 1"></td>
                    <td><input type="text" data-path="Boundary_analysis_property_identification.north_doc2" class="table-input" placeholder="Val as per Doc 2"></td>
                    <td><input type="text" data-path="Boundary_analysis_property_identification.north_translation" class="table-input"></td>
                    <td><input type="text" data-path="Boundary_analysis_property_identification.north_site" class="table-input"></td>
                  </tr>
                  
                  <tr>
                      <td>West</td>
                      <td><input type="text" data-path="Boundary_analysis_property_identification.west_doc1" class="table-input" placeholder="Val as per Doc 1"></td>
                      <td><input type="text" data-path="Boundary_analysis_property_identification.west_doc2" class="table-input" placeholder="Val as per Doc 2"></td>
                      <td><input type="text" data-path="Boundary_analysis_property_identification.west_translation" class="table-input"></td>
                      <td><input type="text" data-path="Boundary_analysis_property_identification.west_site" class="table-input"></td>
                  </tr>
              
                  
                  <tr>
                      <td>South</td>
                      <td><input type="text" data-path="Boundary_analysis_property_identification.south_doc1" class="table-input" placeholder="Val as per Doc 1"></td>
                      <td><input type="text" data-path="Boundary_analysis_property_identification.south_doc2" class="table-input" placeholder="Val as per Doc 2"></td>
                      <td><input type="text" data-path="Boundary_analysis_property_identification.south_translation" class="table-input"></td>
                      <td><input type="text" data-path="Boundary_analysis_property_identification.south_site" class="table-input"></td>
                  </tr>
                  
                </tbody>
              </table>
            </div>
            
            <div class="form-group mt-3">
              <label class="form-label">Deviations in boundary if any ?</label>
              <textarea data-path="Boundary_analysis_property_identification.Boundary_property_notes" class="form-textarea" rows="4"></textarea>
            </div>


          </div>
          <!-- IV. Demarcations -->
          <div class="form-section-group">
            <h4 class="form-section-title">IV. Demarcations</h4>
            
            <div class="table-container">
              <table class="analysis-table">
                <thead>
                  <tr>
                    <th>Direction</th>
                    <th>Demarcation Type</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td>North</td>
                    <td class="checkbox-cell">
                      <label class="checkbox-label-small"><input type="checkbox" data-array="Demarcation.north" value="no demarcation"> No demarcation</label>
                      <label class="checkbox-label-small"><input type="checkbox" data-array="Demarcation.north" value="gi sheet fence"> GI sheet fence</label>
                      <label class="checkbox-label-small"><input type="checkbox" data-array="Demarcation.north" value="Foundation"> Foundation</label>
                      <label class="checkbox-label-small"><input type="checkbox" data-array="Demarcation.north" value="barbed wire"> Barbed wire</label>
                      <label class="checkbox-label-small"><input type="checkbox" data-array="Demarcation.north" value="steel pegs"> Steel pegs</label>
                      <label class="checkbox-label-small"><input type="checkbox" data-array="Demarcation.north" value="compound wall"> Compound wall</label>
                      <label class="checkbox-label-small"><input type="checkbox" data-array="Demarcation.north" value="bio fence"> Bio fence</label>
                      <label class="checkbox-label-small"><input type="checkbox" data-array="Demarcation.north" value="survey stone"> Survey stone</label>
                      <label class="checkbox-label-small"><input type="checkbox" data-array="Demarcation.north" value="wooden pegs"> Wooden pegs</label>
                    </td>
                  </tr>
                  <tr>
                    <td>East</td>
                    <td class="checkbox-cell">
                      <label class="checkbox-label-small"><input type="checkbox" data-array="Demarcation.east" value="no demarcation"> No demarcation</label>
                      <label class="checkbox-label-small"><input type="checkbox" data-array="Demarcation.east" value="gi sheet fence"> GI sheet fence</label>
                      <label class="checkbox-label-small"><input type="checkbox" data-array="Demarcation.east" value="Foundation"> Foundation</label>
                      <label class="checkbox-label-small"><input type="checkbox" data-array="Demarcation.east" value="barbed wire"> Barbed wire</label>
                      <label class="checkbox-label-small"><input type="checkbox" data-array="Demarcation.east" value="steel pegs"> Steel pegs</label>
                      <label class="checkbox-label-small"><input type="checkbox" data-array="Demarcation.east" value="compound wall"> Compound wall</label>
                      <label class="checkbox-label-small"><input type="checkbox" data-array="Demarcation.east" value="bio fence"> Bio fence</label>
                      <label class="checkbox-label-small"><input type="checkbox" data-array="Demarcation.east" value="survey stone"> Survey stone</label>
                      <label class="checkbox-label-small"><input type="checkbox" data-array="Demarcation.east" value="wooden pegs"> Wooden pegs</label>
                    </td>
                  </tr>
                  <tr>
                    <td>South</td>
                    <td class="checkbox-cell">
                      <label class="checkbox-label-small"><input type="checkbox" data-array="Demarcation.south" value="no demarcation"> No demarcation</label>
                      <label class="checkbox-label-small"><input type="checkbox" data-array="Demarcation.south" value="gi sheet fence"> GI sheet fence</label>
                      <label class="checkbox-label-small"><input type="checkbox" data-array="Demarcation.south" value="Foundation"> Foundation</label>
                      <label class="checkbox-label-small"><input type="checkbox" data-array="Demarcation.south" value="barbed wire"> Barbed wire</label>
                      <label class="checkbox-label-small"><input type="checkbox" data-array="Demarcation.south" value="steel pegs"> Steel pegs</label>
                      <label class="checkbox-label-small"><input type="checkbox" data-array="Demarcation.south" value="compound wall"> Compound wall</label>
                      <label class="checkbox-label-small"><input type="checkbox" data-array="Demarcation.south" value="bio fence"> Bio fence</label>
                      <label class="checkbox-label-small"><input type="checkbox" data-array="Demarcation.south" value="survey stone"> Survey stone</label>
                      <label class="checkbox-label-small"><input type="checkbox" data-array="Demarcation.south" value="wooden pegs"> Wooden pegs</label>
                    </td>
                  </tr>
                  <tr>
                    <td>West</td>
                    <td class="checkbox-cell">
                      <label class="checkbox-label-small"><input type="checkbox" data-array="Demarcation.west" value="no demarcation"> No demarcation</label>
                      <label class="checkbox-label-small"><input type="checkbox" data-array="Demarcation.west" value="gi sheet fence"> GI sheet fence</label>
                      <label class="checkbox-label-small"><input type="checkbox" data-array="Demarcation.west" value="Foundation"> Foundation</label>
                      <label class="checkbox-label-small"><input type="checkbox" data-array="Demarcation.west" value="barbed wire"> Barbed wire</label>
                      <label class="checkbox-label-small"><input type="checkbox" data-array="Demarcation.west" value="steel pegs"> Steel pegs</label>
                      <label class="checkbox-label-small"><input type="checkbox" data-array="Demarcation.west" value="compound wall"> Compound wall</label>
                      <label class="checkbox-label-small"><input type="checkbox" data-array="Demarcation.west" value="bio fence"> Bio fence</label>
                      <label class="checkbox-label-small"><input type="checkbox" data-array="Demarcation.west" value="survey stone"> Survey stone</label>
                      <label class="checkbox-label-small"><input type="checkbox" data-array="Demarcation.west" value="wooden pegs"> Wooden pegs</label>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
<div class="form-group">
    <label class="form-label">Encroachment if any</label>
    <div class="checkbox-group">
        <label class="checkbox-label">
            <input type="radio" name="encroachment_check" 
                   data-path="Demarcation.encroachment_check" 
                   value="Yes" 
                   onchange="toggleEncroachmentFields()"> 
            Yes
        </label>
        
        <label class="checkbox-label">
            <input type="radio" name="encroachment_check" 
                   data-path="Demarcation.encroachment_check" 
                   value="No" 
                   onchange="toggleEncroachmentFields()"> 
            No
        </label>
    </div>
</div>

<div id="encroachmentDetails" class="hidden border-l-2 border-orange-200 pl-4 ml-1 mt-2">
    
    <div class="form-group">
        <label class="form-label">Notes if any</label>
        <textarea data-path="Demarcation.demarcation_notes" class="form-textarea" rows="3"></textarea>
    </div>

    <div class="form-group">
        <label class="form-label">Encroachment of subject building to neighbouring property, if any..?</label>
        <textarea data-path="Demarcation.enroachment_subject_to_neighbour" class="form-textarea" rows="3"></textarea>
    </div>

    <div class="form-group">
        <label class="form-label">Encroachment of neighbour's building to subject property, if any..?</label>
        <textarea data-path="Demarcation.enroachment_neighbour_to_subject" class="form-textarea" rows="3"></textarea>
    </div>

</div>

          <!-- V. Access Nature/Right of Access -->
          <div class="form-section-group">
            <h4 class="form-section-title">V. Access Nature/Right of Access</h4>
            
            <div class="table-container">
              <table class="analysis-table access-table">
                <tbody>
                  <tr>
                    <td>1. Type of access as per title deed</td>
                    <td class="checkbox-cell">
                      <label class="checkbox-label-small"><input type="checkbox" data-array="Access.typeofaccess_titledeed" value="footway"> Footway</label>
                      <label class="checkbox-label-small"><input type="checkbox" data-array="Access.typeofaccess_titledeed" value="panchayat rd"> Panchayat Rd</label>
                      <label class="checkbox-label-small"><input type="checkbox" data-array="Access.typeofaccess_titledeed" value="corporation rd"> Corporation Rd</label>
                      <label class="checkbox-label-small"><input type="checkbox" data-array="Access.typeofaccess_titledeed" value="national highway"> National Highway</label>
                      <label class="checkbox-label-small"><input type="checkbox" data-array="Access.typeofaccess_titledeed" value="private way"> Private Way</label>
                      <label class="checkbox-label-small"><input type="checkbox" data-array="Access.typeofaccess_titledeed" value="municipal rd"> Municipal Rd</label>
                      <label class="checkbox-label-small"><input type="checkbox" data-array="Access.typeofaccess_titledeed" value="pwd road"> PWD Road</label>
                      <label class="checkbox-label-small"><input type="checkbox" data-array="Access.typeofaccess_titledeed" value="land locked"> Land Locked</label>
                    </td>
                  </tr>
                  <tr>
                    <td>2. Type of access as per site visit</td>
                    <td class="checkbox-cell">
                      <label class="checkbox-label-small"><input type="checkbox" data-array="Access.typeofaccess_sitevisit" value="footway"> Footway</label>
                      <label class="checkbox-label-small"><input type="checkbox" data-array="Access.typeofaccess_sitevisit" value="panchayat rd"> Panchayat Rd</label>
                      <label class="checkbox-label-small"><input type="checkbox" data-array="Access.typeofaccess_sitevisit" value="corporation rd"> Corporation Rd</label>
                      <label class="checkbox-label-small"><input type="checkbox" data-array="Access.typeofaccess_sitevisit" value="national highway"> National Highway</label>
                      <label class="checkbox-label-small"><input type="checkbox" data-array="Access.typeofaccess_sitevisit" value="private way"> Private Way</label>
                      <label class="checkbox-label-small"><input type="checkbox" data-array="Access.typeofaccess_sitevisit" value="municipal rd"> Municipal Rd</label>
                      <label class="checkbox-label-small"><input type="checkbox" data-array="Access.typeofaccess_sitevisit" value="pwd road"> PWD Road</label>
                      <label class="checkbox-label-small"><input type="checkbox" data-array="Access.typeofaccess_sitevisit" value="land locked"> Land Locked</label>
                    </td>
                  </tr>
                  <tr>
                    <td>3. If private way, no of users..?</td>
                    <td class="checkbox-cell">
                      <label class="checkbox-label-small"><input type="checkbox" data-array="Access.private_no_user" value="self use"> Self use</label>
                      <label class="checkbox-label-small"><input type="checkbox" data-array="Access.private_no_user" value="self & 1 user"> Self & 1 user</label>
                      <label class="checkbox-label-small"><input type="checkbox" data-array="Access.private_no_user" value="self & 2 user"> Self & 2 user</label>
                      <label class="checkbox-label-small"><input type="checkbox" data-array="Access.private_no_user" value="self + family"> Self + family</label>
                    </td>
                  </tr>
                  <tr>
                    <td>4. Demarcation of private road</td>
                    <td class="checkbox-cell">
                      <label class="checkbox-label-small"><input type="checkbox" data-array="Access.private_rd_demarcation" value="no demarcation"> No demarcation</label>
                      <label class="checkbox-label-small"><input type="checkbox" data-array="Access.private_rd_demarcation" value="gi sheet fence"> GI sheet fence</label>
                      <label class="checkbox-label-small"><input type="checkbox" data-array="Access.private_rd_demarcation" value="barbed wire"> Barbed wire</label>
                      <label class="checkbox-label-small"><input type="checkbox" data-array="Access.private_rd_demarcation" value="steel pegs"> Steel pegs</label>
                      <label class="checkbox-label-small"><input type="checkbox" data-array="Access.private_rd_demarcation" value="compound wall"> Compound wall</label>
                      <label class="checkbox-label-small"><input type="checkbox" data-array="Access.private_rd_demarcation" value="bio fence"> Bio fence</label>
                      <label class="checkbox-label-small"><input type="checkbox" data-array="Access.private_rd_demarcation" value="survey stone"> Survey stone</label>
                      <label class="checkbox-label-small"><input type="checkbox" data-array="Access.private_rd_demarcation" value="wooden pegs"> Wooden pegs</label>
                    </td>
                  </tr>
                  <tr>
                    <td>5. Least width of main access in M</td>
                    <td><input type="number" step="0.01" data-path="Access.main_access_width" class="table-input"></td>
                  </tr>
                  <tr>
                    <td>6. Vehicular access</td>
                    <td class="checkbox-cell">
                      <label class="checkbox-label-small"><input type="checkbox" data-array="Access.vehicular_access" value="pedestrian"> Pedestrian</label>
                      <label class="checkbox-label-small"><input type="checkbox" data-array="Access.vehicular_access" value="2-wheeler"> 2-wheeler</label>
                      <label class="checkbox-label-small"><input type="checkbox" data-array="Access.vehicular_access" value="3-wheeler"> 3-wheeler</label>
                      <label class="checkbox-label-small"><input type="checkbox" data-array="Access.vehicular_access" value="4-wheeler"> 4-wheeler</label>
                    </td>
                  </tr>
                  <tr>
                    <td>7. Material of road</td>
                    <td class="checkbox-cell">
                      <label class="checkbox-label-small"><input type="checkbox" data-array="Access.road_material" value="mud road"> Mud road</label>
                      <label class="checkbox-label-small"><input type="checkbox" data-array="Access.road_material" value="gravel road"> Gravel road</label>
                      <label class="checkbox-label-small"><input type="checkbox" data-array="Access.road_material" value="concrete road"> Concrete road</label>
                      <label class="checkbox-label-small"><input type="checkbox" data-array="Access.road_material" value="paving tile rd"> Paving tile rd</label>
                      <label class="checkbox-label-small"><input type="checkbox" data-array="Access.road_material" value="tar road"> Tar road</label>
                    </td>
                  </tr>
                  <tr>
                    <td>8. Least width of internal roads,<br> in case of plot development</td>
                    <td><input type="number" step="0.01" data-path="Access.internal_road_width" class="table-input"></td>
                  </tr>
                  <tr>
                    <td>9. Weather the internal rd. <br> abutting the subject plot has <br> connectivity to main access <br> as per deed..?</td>
                    <td><input type="text" data-path="Access.internal_to_main_connectivity" class="table-input h-20"></td>
                  </tr>
                  
                </tbody>
              </table>
            </div>
           
            <div class="form-group">
              <label class="form-label">Notes on Discrepancy if any...</label>
              <textarea data-path="Access.access_notes" class="form-textarea" rows="4"></textarea>
            </div>
          </div>

          <!-- VI. For Purchase and Resale cases -->
          <div class="form-section-group">
            <h4 class="form-section-title">VI. For Purchase and Resale cases</h4>
            
            <div class="table-container">
              <table class="analysis-table">
                <tbody>
                  <tr>
                    <td>1. Buyer name</td>
                    <td><input type="text" data-path="Purchase_resale.buyer_name" class="table-input"></td>
                  </tr>
                  <tr>
                    <td>2. Seller name</td>
                    <td><input type="text" data-path="Purchase_resale.seller_name" class="table-input"></td>
                  </tr>
                  <tr>
                    <td>3. Relation b/w buyer <br> and seller, if any</td>
                    <td><input type="text" data-path="Purchase_resale.buyer_seller_relation" class="table-input"></td>
                  </tr>
                  <tr>
                    <td>4. Since how long the <br> property is up for sale..? (months)</td>
                    <td><input type="number" data-path="Purchase_resale.property_sale_duration" class="table-input"></td>
                  </tr>
                  <tr>
                    <td>5. Brockers/OLX/99acers etc <br> involved or how transaction happened..?</td>
                    <td><input type="text" data-path="Purchase_resale.transaction_method" class="table-input"></td>
                  </tr>
                  <tr>
                    <td>6. Land extend proposed <br> for purchase..?</td>
                    <td><input type="text" data-path="Purchase_resale.purchase_land_extent" class="table-input"></td>
                  </tr>
                  <tr>
                    <td>7. Price asked</td>
                    <td><input type="number" data-path="Purchase_resale.price_asked" class="table-input"></td>
                  </tr>
                  <tr>
                    <td>8. Deal breaker value</td>
                    <td><input type="number" data-path="Purchase_resale.deal_breaker_value" class="table-input"></td>
                  </tr>
                </tbody>
              </table>
            </div>


            <div class="form-group">
              <label class="form-label">Notes</label>
              <textarea data-path="Purchase_resale.purchase_resale_notes" class="form-textarea" rows="4"></textarea>
            </div>
          </div>

          <!-- VII. Building Analysis -->
          <div class="form-section-group">
            <h4 class="form-section-title">VII. Building Analysis</h4>
            
            <div class="mb-2 flex justify-end gap-2">
                <button type="button" class="px-3 py-1 bg-green-100 text-green-700 rounded text-sm hover:bg-green-200" onclick="addApartment()">
                    <i class="fas fa-plus mr-1"></i> Add Apartment
                </button>

                <button type="button" class="px-3 py-1 bg-blue-100 text-blue-700 rounded text-sm hover:bg-blue-200" onclick="addFloor('above')">
                    <i class="fas fa-arrow-up mr-1"></i> Add Floor Above
                </button>
            </div>

            <div class="table-container">
                <table class="analysis-table">
                <thead>
                    <tr>
                    <th>Floor No / Unit</th> <th>Builtup Area (measured at site)</th>
                    <th>No. of Rooms</th>
                    <th>No. of Kitchen</th>
                    <th>No. of Bathrooms</th>
                    <th>Usage (Residential/Commercial/Industrial)</th>
                    <th>Occupancy (Owner/Applicant/Rented/Vacant)</th>
                    <th style="width: 10px;"></th> 
                    </tr>
                </thead>
                <tbody id="buildingTableBody"></tbody>
                </table>
            </div>

            <div class="mt-2 flex justify-end">
                <button type="button" class="px-3 py-1 bg-blue-100 text-blue-700 rounded text-sm hover:bg-blue-200" onclick="addFloor('below')">
                    <i class="fas fa-arrow-down mr-1"></i> Add Floor Below
                </button>
            </div>
            <label class="form-label" style="font-size: 15px; font-weight: bolder;">Details if Rented</label> <br> <br>

              <label class="form-label">Rented Amount&nbsp;&nbsp;</label> 
              <input type="text" data-path="Building_analysis.rent_amt" class="form-input"> <br>

              <label class="form-label">Rented Duration&nbsp;</label> 
              <input type="text" data-path="Building_analysis.rent_duration" class="form-input"> <br><br>

            <label class="form-label" style="font-size: 15px; font-weight: bolder;">Building Details</label> <br> <br>

              <label class="form-label">Building No</label> 
              <input type="text" data-path="Boundary_analysis.Building_no" class="form-input"> <br>
          
              <label class="form-label">Ward no&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</label>
              <input type="text" data-path="Boundary_analysis.Ward" class="form-input">
           
            
            <div class="form-group mt-3">
              <label class="form-label">Notes(Discrepancy respect to BUA, occupancy, alignment, orientation etc...)</label>
              <textarea data-path="Building_analysis.building_analysis_notes" class="form-textarea" rows="4"></textarea>
            </div>  
            </div>
            <!-- Roof Type Table -->
            <div class="table-container">
              <table class="analysis-table">
                <thead>
                  <tr>
                    <th>Roof Type</th>
                    <th> <label class="checkbox-label-small"><input type="checkbox" data-array="Building_analysis.roof_type" value="RCC"> RCC</label>
                     </th>
                    <th> <label class="checkbox-label-small"><input type="checkbox" data-array="Building_analysis.roof_type" value="Tiled">Tiled</label>
                     </th>
                    <th> <label class="checkbox-label-small"><input type="checkbox" data-array="Building_analysis.roof_type" value="Sheet"> Sheet</label>
                     </th>
                    <th> <label class="checkbox-label-small"><input type="checkbox" data-array="Building_analysis.roof_type" value="Other"> Other</label>
                     </th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td>Roof Percentage</td>
                    <td><input type="number" data-path="Building_analysis.RCC_Percentage" step="0.01" class="table-input" placeholder="%"></td>
                    <td><input type="number" data-path="Building_analysis.Tiled_Percentage" step="0.01" class="table-input" placeholder="%"></td>
                    <td><input type="number" data-path="Building_analysis.Sheet_Percentage" step="0.01" class="table-input" placeholder="%"></td>
                    <td><input type="number" data-path="Building_analysis.Other_Percentage" step="0.01" class="table-input" placeholder="%"></td>
                  </tr>
                </tbody>
              </table>
            </div>

            <!-- Setback Table -->
            <div class="table-container">
                <table class="analysis-table">
                    <thead>
                    <tr>
                        <!-- Single column -->
                        <th rowspan="2">Setback (m)</th>

                        <!-- Yard headers -->
                        <th colspan="2">Front Yard</th>
                        <th colspan="2">Side-1 Yard</th>
                        <th colspan="2">Side-2 Yard</th>
                        <th colspan="2">Rear Yard</th>
                    </tr>
                    <tr>
                        <!-- Sub headers -->
                        <th style="z-index: auto;">Min</th>
                        <th>Max</th>

                        <th>Min</th>
                        <th>Max</th>

                        <th>Min</th>
                        <th>Max</th>

                        <th>Min</th>
                        <th>Max</th>
                    </tr>
                    </thead>

                    <tbody>
                    <tr>
                        <!-- SINGLE setback input -->
                        <td>
                        <input
                            type="number"
                            data-path="Building_analysis.setback"
                            step="0.01"
                            class="table-input"
                            placeholder="Setback"
                        />
                        </td>

                        <!-- Front yard -->
                        <td><input type="number" data-path="Building_analysis.front_yard_min" step="0.01" class="table-input" /></td>
                        <td><input type="number" data-path="Building_analysis.front_yard_max" step="0.01" class="table-input" /></td>

                        <!-- Side-1 -->
                        <td><input type="number" data-path="Building_analysis.side1_yard_min" step="0.01" class="table-input" /></td>
                        <td><input type="number" data-path="Building_analysis.side1_yard_max" step="0.01" class="table-input" /></td>

                        <!-- Side-2 -->
                        <td><input type="number" data-path="Building_analysis.side2_yard_min" step="0.01" class="table-input" /></td>
                        <td><input type="number" data-path="Building_analysis.side2_yard_max" step="0.01" class="table-input" /></td>

                        <!-- Rear -->
                        <td><input type="number" data-path="Building_analysis.rear_yard_min" step="0.01" class="table-input" /></td>
                        <td><input type="number" data-path="Building_analysis.rear_yard_max" step="0.01" class="table-input" /></td>
                    </tr>
                    </tbody>
                </table>
            </div>

            <!-- Construction Timeline Table -->
         <div class="form-group">
            <label class="form-label">Year of Construction</label>
            <div class="table-container">
              <table class="analysis-table" id="timelineTable" style="table-layout: fixed; width: 100%;">
                <tbody>
                  <tr id="row_year">
                    <td style="width: 100px; background: #f0f0f0; font-weight: bold;">Year</td>
                    
                    <td rowspan="2" id="controlCell" style="width: 40px; text-align: center; vertical-align: middle; background: #e8f0fe; border-left: 2px solid #ccc;">
                      <div style="display: flex; flex-direction: column; gap: 5px; align-items: center;">
                          <button type="button" class="timeline-btn add-btn" onclick="manualAddColumn()" title="Add Column">
                            <i class="fas fa-plus"></i>
                          </button>
                          <button type="button" class="timeline-btn remove-btn" onclick="removeLastColumn()" title="Remove Last">
                            <i class="fas fa-minus"></i>
                          </button>
                      </div>
                    </td>
                  </tr>

                  <tr id="row_percent">
                    <td style="width: 100px; background: #f0f0f0; font-weight: bold;">% Area</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <input type="hidden" data-path="Building_analysis.construction_year" id="finalConstructionString">
          </div>

        <div class="form-group">
          <label class="form-label">Notes on number of carparks, wardrobes, kitchen cabinets, flooring material, interior decorations or any other amenities...</label>
          <textarea data-path="Building_analysis.amenities_notes" class="form-textarea" rows="4"></textarea>
        </div>

        <div class="form-section-group">
            <h4 class="form-section-title">IX. Land Inspection Details</h4>
            <table class="analysis-table" id="land_inspection_table" style="table-layout: fixed; width: 100%;">
                <tr>
                    <td>
                        <label class="form-label">Nearest City (KM) &nbsp;&nbsp;</label>
                    </td>
                    <td>
                        <input type="text" class="table-input" data-path="land_inspection_details.nearest_city">
                    </td>
                </tr>
                <tr>
                    <td>
                        <label class="form-label">Nearest Highway &nbsp;&nbsp;</label>
                    </td>
                    <td>
                        <input type="text" class="table-input" data-path="land_inspection_details.nearest_Highway">
                    </td>
                </tr>
                <tr>
                    <td>
                        <label class="form-label">Nearest School &nbsp;&nbsp;</label>
                    </td>
                    <td>
                        <input type="text" class="table-input" data-path="land_inspection_details.nearest_school">
                    </td>
                </tr>
                <tr>
                    <td>
                        <label class="form-label">Nearest Railway &nbsp;&nbsp;</label>
                    </td>
                    <td>
                        <input type="text" class="table-input" data-path="land_inspection_details.nearest_railway">
                    </td>
                </tr>
                <tr>
                    <td>
                        <label class="form-label">Nearest Bus stop &nbsp;&nbsp;</label>
                    </td>
                    <td>
                        <input type="text" class="table-input" data-path="land_inspection_details.nearest_busstop">
                    </td>
                </tr>
                <tr>
                    <td>
                        <label class="form-label">Nearest Hospital &nbsp;&nbsp;</label>
                    </td>
                    <td>
                        <input type="text" class="table-input" data-path="land_inspection_details.nearest_hospital">
                    </td>
                </tr>
                <tr>
                    <td>
                        <div class="form-group">
                        <label class="form-label">CRZ</label>
                    </td>
                    <td>
                       <input type="radio" name="crz" data-path="land_inspection_details.crz" value="Yes"> Yes
                        <input type="radio" name="crz" data-path="land_inspection_details.crz" value="No"> No
                    </td>
                </tr>
                <tr>
                    <td>
                        <div class="form-group">
                        <label class="form-label">Crematoriums</label>
                    </td>
                    <td>
                       <input type="radio" name="Crematoriums" data-path="land_inspection_details.crematoriums" value="Yes"> Yes
                       <input type="radio" name="Crematoriums" data-path="land_inspection_details.crematoriums" value="No"> No
                    </td>
                </tr>
                <tr>
                    <td>
                        <div class="form-group">
                        <label class="form-label">Stigma</label>
                    </td>
                    <td>
                       <input type="radio" name="stigma" data-path="land_inspection_details.stigma" value="Yes"> Yes
                       <input type="radio" name="stigma" data-path="land_inspection_details.stigma" value="No"> No
                    </td>
                </tr>
                 <tr>
                    <td>
                        <div class="form-group">
                        <label class="form-label">Slums</label>
                    </td>
                    <td>
                       <input type="radio" name="slums" data-path="land_inspection_details.slums" value="Yes"> Yes
                       <input type="radio" name="slums" data-path="land_inspection_details.slums" value="No"> No
                    </td>
                </tr>
                 <tr>
                    <td>
                        <div class="form-group">
                        <label class="form-label">Communial Area</label>
                    </td>
                    <td>
                       <input type="radio" name="Comm" data-path="land_inspection_details.communial_area" value="Yes"> Yes
                       <input type="radio" name="Comm" data-path="land_inspection_details.communial_area" value="No"> No
                    </td>
                </tr>
                 <tr>
                    <td>
                        <div class="form-group">
                        <label class="form-label">Factory Abutting</label>
                    </td>
                    <td>
                       <input type="radio" name="factory" data-path="land_inspection_details.factory_abutting" value="Yes"> Yes
                       <input type="radio" name="factory" data-path="land_inspection_details.factory_abutting" value="No"> No
                    </td>
                </tr>
                 <tr>
                    <td>
                        <div class="form-group">
                        <label class="form-label">Defence Area</label>
                    </td>
                    <td>
                       <input type="radio" name="Defence" data-path="land_inspection_details.defence_area" value="Yes"> Yes
                       <input type="radio" name="Defence" data-path="land_inspection_details.defence_area" value="No"> No
                    </td>
                </tr>
                 <tr>
                    <td>
                        <div class="form-group">
                        <label class="form-label">Heritage Property</label>
                    </td>
                    <td>
                       <input type="radio" name="heritage" data-path="land_inspection_details.heritage_property" value="Yes"> Yes
                       <input type="radio" name="heritage" data-path="land_inspection_details.heritage_property" value="No"> No
                    </td>
                </tr>
                 <tr>
                    <td>
                        <div class="form-group">
                        <label class="form-label">Rubber Plantations</label>
                    </td>
                    <td>
                       <input type="radio" name="plantations" data-path="land_inspection_details.rubber_plantations" value="Yes"> Yes
                       <input type="radio" name="plantations" data-path="land_inspection_details.rubber_plantations" value="No"> No
                    </td>
                </tr>
                 <tr>
                    <td>
                        <div class="form-group">
                        <label class="form-label">Coconut Thope</label>
                    </td>
                    <td>
                       <input type="radio" name="coconut" data-path="land_inspection_details.coconut_thope" value="Yes"> Yes
                       <input type="radio" name="coconut" data-path="land_inspection_details.coconut_thope" value="No"> No
                    </td>
                </tr>
                 <tr>
                    <td>
                        <div class="form-group">
                        <label class="form-label">Buffer Zone</label>
                    </td>
                    <td>
                       <input type="radio" name="buffer" data-path="land_inspection_details.buffer_zone" value="Yes"> Yes
                       <input type="radio" name="buffer" data-path="land_inspection_details.buffer_zone" value="No"> No
                    </td>
                </tr>
                 <tr>
                    <td>
                        <div class="form-group">
                        <label class="form-label">Telecommunication Tower</label>
                    </td>
                    <td>
                       <input type="radio" name="tele" data-path="land_inspection_details.telecommunication_tower" value="Yes"> Yes
                       <input type="radio" name="tele" data-path="land_inspection_details.telecommunication_tower" value="No"> No
                    </td>
                </tr>
                 <tr>
                    <td>
                        <div class="form-group">
                        <label class="form-label">High Tension Wire/Electrical Line</label>
                    </td>
                    <td>
                       <input type="radio" name="high_tens" data-path="land_inspection_details.high_tension_wire_electrical_line" value="Yes"> Yes
                       <input type="radio" name="high_tens" data-path="land_inspection_details.high_tension_wire_electrical_line" value="No"> No
                    </td>
                </tr>
                 <tr>
                    <td>
                        <div class="form-group">
                        <label class="form-label">Enroachment of subject <br> building to other prop</label>
                    </td>
                    <td>
                       <input type="radio" name="enroachment" data-path="land_inspection_details.enroachment_subject_to_prop" value="Yes"> Yes
                       <input type="radio" name="enroachment" data-path="land_inspection_details.enroachment_subject_to_prop" value="No"> No
                    </td>
                </tr>
                 <tr>
                    <td>
                        <div class="form-group">
                        <label class="form-label">Intrusion of other buildings <br> to the subject prop</label>
                    </td>
                    <td>
                       <input type="radio" name="intrusion" data-path="land_inspection_details.intrusion_other_to_subject" value="Yes"> Yes
                       <input type="radio" name="intrusion" data-path="land_inspection_details.intrusion_other_to_subject" value="No"> No
                    </td>
                </tr>
                 <tr>
                    <td>
                        <div class="form-group">
                            <label class="form-label">Railway Line passing <br> through property</label>
                        </div>
                    </td>
                    <td>
                        <div style="display: flex; gap: 15px;">
                            <label style="display: flex; align-items: center; gap: 5px;">
                                <input type="radio" name="railway" data-path="land_inspection_details.railway_pass" value="Yes" onchange="toggleRailwayDistance()"> 
                                Yes
                            </label>
                            <label style="display: flex; align-items: center; gap: 5px;">
                                <input type="radio" name="railway" data-path="land_inspection_details.railway_pass" value="No" onchange="toggleRailwayDistance()"> 
                                No
                            </label>
                        </div>
                    </td>
                </tr>

                <tr id="railwayDistanceRow" class="hidden">
                    <td>
                        <label class="form-label" style="color: #c2410c;">Railway Line Distance (m)</label>
                    </td>
                    <td>
                        <input type="text" class="table-input" data-path="land_inspection_details.railway_distance" style="height: 50px;" placeholder="Enter distance...">
                    </td>
                </tr>
                 <tr>
                    <td>
                        <div class="form-group">
                        <label class="form-label">Sarpakkavu, Small-Temple, <br> Church, Mosque <br> in the property</label>
                    </td>
                    <td>
                       <input type="radio" name="sarppam" data-path="land_inspection_details.STCM_in_property" value="Yes"> Yes
                       <input type="radio" name="sarppam" data-path="land_inspection_details.STCM_in_property" value="No"> No
                    </td>
                </tr>
            </table>
            
          
          
            <div class="form-group">
                <label class="form-label">Inspection Notes</label>
                <textarea data-path="land_inspection_details.inspection_notes" class="form-textarea" rows="3"></textarea>
            </div>


          <!-- VIII. Landmark and Layout (Handsketch) -->
          <div class="form-section-group">
            <h4 class="form-section-title">VIII. Landmark and Layout (Handsketch)</h4>
            
            <div class="form-group">
                <label class="form-label">Landmark Description</label>
                <textarea data-path="Sketch.landmark_description" class="form-textarea" rows="3"></textarea>
            </div>

            <div class="form-group mt-4">
                <label class="form-label font-bold">Site Layout Sketch</label>
                
                <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                    
                    <button type="button" class="modal-btn primary" style="flex: 1; margin-bottom: 0;" onclick="openSketchPad('Sketch.main_layout')">
                        <i class="fas fa-drafting-compass mr-2"></i> Open Pad
                    </button>

                    <button type="button" class="modal-btn success" style="flex: 1; margin-bottom: 0; background-color: #10b981; border-color: #10b981;" onclick="document.getElementById('mainLayoutUpload').click()">
                        <i class="fas fa-camera mr-2"></i> Upload Photo
                    </button>

                    <input type="file" id="mainLayoutUpload" class="hidden" accept="image/*" 
                        onchange="if(this.files[0]) handleImageUpload('Sketch.main_layout', this.files[0])">
                </div>

                <div class="main-sketch-preview" style="position: relative; border: 2px dashed #ccc; min-height: 300px; display: flex; align-items: center; justify-content: center; background: #f9fafb; border-radius: 8px; overflow: hidden;">
                    
                    <div class="main-sketch-preview" style="position: relative; border: 2px dashed #ccc; min-height: 300px; display: flex; align-items: center; justify-content: center; background: #f9fafb;">
                            <img id="img_preview_Sketch_main_layout" class="hidden" style="width: 100%; max-height: 100%; z-index: 1;">
                            
                        </div>
                </div>
            </div>
            </div>
             
            <div class="form-group">
            <label class="form-label">Overall Remarks (Comments on land extend, sold value, sold date etc... comparing with the subject property)</label>
            <textarea data-path="Building_analysis.extra_remarks" class="form-textarea" rows="4"></textarea>
            </div>
            <div class="form-group">
            <label class="form-label" style="font-size: large;">Recommented Land Value</label>
            <input type="text" class="form-input" data-path="land_inspection_details.land_value">
            </div>
            <div class="form-group">
            <label class="form-label">Notes on Land Value References Received</label>
            <textarea data-path="Building_analysis.val_references" class="form-textarea" rows="4"></textarea>
            </div>
         <div class="form-group mt-4" style="gap: 10px;">
          <button type="button" id="triggerSubmitBtn" class="submit-btn" style="width: 100%;">
            Submit Feedback
          </button>

          <button type="button" id="triggerResetBtn" 
                  style="background: #ef4444; color: white; padding: 12px; border-radius: 8px; border:none; width: 100%; cursor: pointer; font-weight: 600;">
              âš ï¸ Reset Form Data
          </button>
        </div>
        </form>

      </div>
    </div>
  </div>
</div>

<!-- All modals remain the same -->
<div id="fullscreenModal" class="fixed inset-0 z-50 hidden items-center justify-center bg-black bg-opacity-90" aria-hidden="true">
  <div class="modal-box">
    <div class="modal-header">
      <div id="modalTitle" class="modal-title">Preview</div>
      <div class="modal-controls">
        <div id="shareButtonsContainer" class="share-buttons hidden">
          <a href="#" id="shareWhatsapp" class="share-btn">
            <i class="fab fa-whatsapp mr-2"></i>WhatsApp
          </a>
          <a href="#" id="shareTelegram" class="share-btn">
            <i class="fab fa-telegram mr-2"></i>Telegram
          </a>
          <a href="#" id="shareEmail" class="share-btn">
            <i class="fas fa-envelope mr-2"></i>Email
          </a>
          <a href="#" id="shareCopy" class="share-btn">
            <i class="fas fa-link mr-2"></i>Copy Link
          </a>
        </div>
        <a id="modalShare" href="#" class="share-btn">
          <i class="fas fa-share-alt mr-2"></i>Share
        </a>
        <button id="modalDownloadBtn" class="download-btn">
          <i class="fas fa-file-download mr-2"></i>Download
        </button>
        <button id="modalClose" class="control-btn">Close</button>
      </div>
    </div>
  <div id="modalBody" class="modal-body" style="overflow: hidden; display: flex; justify-content: center; background: #f0f0f0;">
    <iframe id="modalFrame" class="hidden" src="" style="width: 100%; height: 100%; border: none;"></iframe>
    
    <img id="modalImage" class="hidden" src="" alt="preview" style="max-width: 100%; max-height: 100%; object-fit: contain;" />
    
    <div id="modalPdfContainer" class="hidden pdf-scroll-container" style="width: 100%; height: 100%; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; align-items: center;"></div>
  </div>
  </div>
</div>

<div id="analyseModal" class="modal hidden">
  <div class="modal-content">
    <h2 class="modal-title">Analyse Files</h2>
    <p class="modal-text">Choose files for analysis</p>
    <button id="analyseSelectFiles" class="modal-btn primary">Select Files</button>
    <button id="analyseSelectAll" class="modal-btn success">Select All Files</button>
    <button id="analyseClose" class="modal-btn">Cancel</button>
  </div>
</div>

<div id="fileSelectModal" class="modal hidden">
  <div class="modal-content">
    <h2 class="modal-title">Select Files</h2>
    <div id="fileSelectList" class="file-select-list"></div>
    <button id="confirmFileSelection" class="modal-btn primary">Confirm Selection</button>
    <button id="fileSelectClose" class="modal-btn">Cancel</button>
  </div>
</div>

<!-- folderchat  -->


<div id="folderChatModal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-[60]" style="display: none; justify-content: center; align-items: center;">
  <div class="bg-white rounded-lg w-[500px] h-[500px] flex flex-col shadow-2xl" style="width: 500px; height: 500px; background: white; display: flex; flex-direction: column; border-radius: 8px;">
    <div class="p-4 border-b flex justify-between items-center bg-blue-600 text-white rounded-t-lg" style="padding: 15px; background: #2563eb; color: white; display: flex; justify-content: space-between;">
      <h3 class="font-bold break-all whitespace-normal pr-4 text-sm leading-tight" id="folderChatTitle">Case Chat</h3>
      <button onclick="closeFolderChat()" class="hover:text-gray-200" style="background: none; border: none; color: white; cursor: pointer; font-size: 1.2rem;">&times;</button>
    </div>
    
    <div id="folderChatMessages" class="flex-1 overflow-y-auto p-4 space-y-3 bg-gray-50" style="flex: 1; overflow-y: auto; padding: 15px; background: #f9fafb; display: flex; flex-direction: column; gap: 10px;">
    </div>

    <form id="folderChatForm" class="p-3 border-t bg-white flex gap-2" style="padding: 10px; border-top: 1px solid #eee; display: flex; gap: 10px;">
      <input type="text" id="folderChatInput" class="flex-1 border rounded-full px-4 py-2 focus:outline-none" style="flex: 1; padding: 8px 15px; border-radius: 20px; border: 1px solid #ddd;" placeholder="Type a note..." autocomplete="off">
      <button type="submit" class="bg-blue-600 text-white rounded-full w-10 h-10 hover:bg-blue-700 flex items-center justify-center" style="width: 40px; height: 40px; border-radius: 50%; background: #2563eb; color: white; border: none; cursor: pointer;">
        <i class="fas fa-paper-plane"></i>
      </button>
    </form>
  </div>
</div>


<div id="sketchModal" class="sketch-modal-overlay hidden">
    
    <div id="sketchSidebar" class="sketch-toolbar-container">
        
        <button onclick="toggleSketchSidebar()" class="sidebar-toggle-btn" title="Toggle Toolbar">
            <i id="toggleIcon" class="fas fa-chevron-left"></i>
        </button>

        <div class="toolbar-section tools-section">
            <div class="section-label">Tools</div>
            <div class="tools-grid">
                <button onclick="setTool('select')" class="tool-btn" title="Select (V)"><i class="fas fa-hand-paper"></i></button>
                
                <button onclick="setTool('brush')" class="tool-btn active keep-visible" title="Pencil (P)"><i class="fas fa-pencil-alt"></i></button>
                <button onclick="setTool('eraser')" class="tool-btn keep-visible" title="Eraser (E)"><i class="fas fa-eraser"></i></button>
                
                <button onclick="setTool('text')" class="tool-btn" title="Text (T)"><i class="fas fa-font"></i></button>
                <button onclick="fillSelected()" class="tool-btn" title="Fill Shape"><i class="fas fa-fill-drip"></i></button>
            </div>
        </div>

        <div class="toolbar-section">
            <div class="section-label">Shapes</div>
            <div class="tools-grid">
                <button onclick="setTool('line')" class="tool-btn"><i class="fas fa-slash"></i></button>
                <button onclick="setTool('rect')" class="tool-btn"><i class="far fa-square"></i></button>
                <button onclick="setTool('circle')" class="tool-btn"><i class="far fa-circle"></i></button>
                <button onclick="setTool('arrow')" class="tool-btn"><i class="fas fa-long-arrow-alt-right"></i></button>
                <button onclick="setTool('triangle')" class="tool-btn"><i class="fas fa-caret-up"></i></button>
            </div>
        </div>

        <div class="toolbar-section">
            <div class="section-label">Properties</div>
            
            <div class="prop-row">
                <span>Size:</span>
                <div style="display:flex; align-items:center; gap:5px; flex:1; justify-content:end;">
                    <input type="range" id="strokeSize" min="1" max="50" value="3" oninput="updateProp('size', this.value)" style="width: 60px;">
                    <span id="strokeVal" style="width: 25px; text-align:right;">3px</span>
                    <input 
                        type="number" 
                        id="pencilSize" 
                        value="3" 
                        min="1" 
                        max="100" 
                        oninput="updateProp('size', this.value)" 
                        class="border border-gray-300 rounded px-2 py-1 w-16 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 shadow-sm"
                    >
                </div>
            </div>
            
            <div class="prop-row">
                <span>Style:</span>
                <select id="lineStyle" onchange="updateProp('style', this.value)" class="form-select" style="padding: 2px; width: 90px;">
                    <option value="solid">Solid</option>
                    <option value="dashed">Dashed</option>
                    <option value="dotted">Dotted</option>
                </select>
            </div>

            <div class="prop-row parallel-box">
                <label style="color: #d97706; font-weight:bold; font-size: 11px; display:flex; align-items:center; gap:5px;">
                    <input type="checkbox" id="parallelToggle"> Parallel
                </label>
                <input type="number" id="parallelDist" value="20" class="tiny-input" style="width:40px;">
            </div>
        </div>

        <div class="toolbar-section">
            <div class="section-label">Colors</div>
            <div class="color-picker-row">
                <input type="color" id="mainColor" value="#000000" onchange="updateProp('color', this.value)" style="width:40px; height:30px; border:none; padding:0;">
                <div class="quick-colors">
                    <div class="c-swatch" style="background:black" onclick="setColor('#000000')"></div>
                    <div class="c-swatch" style="background:red" onclick="setColor('#ff0000')"></div>
                    <div class="c-swatch" style="background:blue" onclick="setColor('#0000ff')"></div>
                    <div class="c-swatch" style="background:green" onclick="setColor('#008000')"></div>
                </div>
            </div>
        </div>

        <div class="toolbar-section action-buttons-row" style="margin-top: auto;">
            <div class="section-label">Actions</div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 5px; margin-bottom: 10px;">
                <button onclick="undoSketch()" class="tool-btn" title="Undo"><i class="fas fa-undo"></i></button>
                <button onclick="redoSketch()" class="tool-btn" title="Redo"><i class="fas fa-redo"></i></button>
                <button onclick="resetZoom()" class="tool-btn" title="Reset View"><i class="fas fa-compress"></i></button>
            </div>

            <button onclick="triggerClearSketch()" class="tool-btn" style="width:100%; height:30px; background:#fee2e2; color:#dc2626; border-color:#fca5a5; margin-bottom: 10px;">
                <i class="fas fa-trash mr-2"></i> Clear Canvas
            </button>

            <div style="display:flex; gap:5px; margin-bottom: 100px;">
                <button class="modal-btn primary small" style="flex:1;" onclick="triggerSaveSketch()">Save</button>
                <button class="modal-btn small" style="flex:1;" onclick="closeSketchModal()">Exit</button>
            </div>
        </div>

    </div>

    <div class="sketch-canvas-container" id="sketchContainer">
        <canvas id="proCanvas" class="canvas-layer"></canvas>
    </div>
</div>
<div id="confirmationModal" class="modal hidden">
  <div class="modal-content" style="max-width: 400px; text-align: center;">
    <div style="margin-bottom: 15px; font-size: 40px; color: #f59e0b;">
      <i class="fas fa-exclamation-circle"></i>
    </div>
    <h2 id="confirmTitle" class="modal-title">Are you sure?</h2>
    <p id="confirmMessage" class="modal-text">Do you really want to proceed?</p>
    
    <div style="display: flex; gap: 10px; margin-top: 20px;">
      <button id="confirmYesBtn" class="modal-btn primary" style="background: #ef4444; border-color: #ef4444;">Yes, do it</button>
      <button id="confirmNoBtn" class="modal-btn">No, Cancel</button>
    </div>
  </div>
</div>

<script>
/* =========================
   1. UTILITIES & CONFIG
========================= */
function getCookie(name) {
  let v = null;
  if (document.cookie && document.cookie !== '') {
    document.cookie.split(';').forEach(c => {
      c = c.trim();
      if (c.startsWith(name + '=')) v = decodeURIComponent(c.substring(name.length + 1));
    });
  }
  return v;
}
const csrftoken = getCookie("csrftoken");

const STORAGE_KEY = 'vadrida_site_feedback_autosave';
/* =========================
   2. STATE MANAGEMENT
========================= */
let currentFolder = "";
let currentFile = null;
let analysisController = null;
let currentFolderFiles = [];
let selectedAnalysisFiles = [];
let rootFoldersCache = null;
let isSearching = false;
let currentPreviewUrl = null;
let activeSketchPath = null;
const folderScrollHistory = {};
let folderChatSocket = null;
let currentChatFolder = null;
let autoSaveTimer = null;
const SAVE_DELAY_MS = 5000; // 10 Seconds
function getEmptyState() {
    return {
  report_id: null,
    Valuers_Checklist: {
        documents_received: [], 
        product: "",
        Office_file_no: "",
        applicant_name: "",
        inspection_date: "",
        person_met: ""
    },
    Ownership_Analysis : { document_verification : "", Ownership_Analysis_notes : "", owners_name : "" },
    Survey: { docs: [], survey_notes: "", paddy_land_check: "",
            trees_2008_check: "", total_ltr_extent: "",
            total_deed_extent: ""},

    Boundary_analysis_property_identification: { 
        ref_doc_1_name: "", ref_doc_2_name: "",
        north_doc1: "", north_doc2: "", east_doc1: "", east_doc2: "",
        south_doc1: "", south_doc2: "", west_doc1: "", west_doc2: "",
        north_translation:"", north_site:"", east_translation:"", east_site:"", 
        south_translation:"", south_site:"", west_translation:"", west_site:"", 
        Boundary_property_notes : ""
    },
    Demarcation: {north: [],east:[],south:[],west:[],demarcation_notes:"",enroachment_subject_to_neighbour:"",enroachment_neighbour_to_subject:"", enroachment_check:""},
    Access : {
        access_notes:"", typeofaccess_titledeed : [], typeofaccess_sitevisit : [], private_no_user :[],
        private_rd_demarcation:[], main_access_width:"", vehicular_access:[], internal_road_width:"",
        internal_to_main_connectivity:"", road_material:[]
    },
    Purchase_resale : {
        Purchase_resale_notes:"", buyer_name:"", seller_name:"", buyer_seller_relation:"",
        property_sale_duration:"", transaction_method:"", purchase_land_extent:"", price_asked:"", deal_breaker_value:""
    },
    // --- CORRECTION HERE: Keys now match HTML "data-path" (e.g., BF, GF) ---
    Building_analysis: { 
        Building_analysis_notes:"", roof_type: [], setback: "", construction_year:"", amenities_notes:""
        , Building_no : "", Ward :"",
        
        // Corrected Casing (BF instead of Bf)
        BF_2_Builtup_area:"", BF_2_Rooms_no:"", BF_2_Kitchen_no:"", BF_2_Bathrooms_no:"", BF_2_Usage:[], BF_2_Occupancy:[],
        BF_1_Builtup_area:"", BF_1_Rooms_no:"", BF_1_Kitchen_no:"", BF_1_Bathrooms_no:"", BF_1_Usage:[], BF_1_Occupancy:[],
        GF_Builtup_area:"",   GF_Rooms_no:"",   GF_Kitchen_no:"",   GF_Bathrooms_no:"",   GF_Usage:[],   GF_Occupancy:[],
        apartments:[],
        
        first_flr_Builtup_area:"", first_flr_Rooms_no:"", first_flr_Kitchen_no:"", first_flr_Bathrooms_no:"", first_flr_Usage:[], first_flr_Occupancy:[],
        second_flr_Builtup_area:"",second_flr_Rooms_no:"",second_flr_Kitchen_no:"",second_flr_Bathrooms_no:"",second_flr_Usage:[],second_flr_Occupancy:[],
        third_flr_Builtup_area:"", third_flr_Rooms_no:"", third_flr_Kitchen_no:"", third_flr_Bathrooms_no:"", third_flr_Usage:[], third_flr_Occupancy:[],
        fourth_flr_Builtup_area:"",fourth_flr_Rooms_no:"",fourth_flr_Kitchen_no:"",fourth_flr_Bathrooms_no:"",fourth_flr_Usage:[],fourth_flr_Occupancy:[],
        fifth_flr_Builtup_area:"", fifth_flr_Rooms_no:"", fifth_flr_Kitchen_no:"", fifth_flr_Bathrooms_no:"", fifth_flr_Usage:[], fifth_flr_Occupancy:[],
        
        front_yard_min:"", front_yard_max:"", side1_yard_min:"", side1_yard_max:"", 
        side2_yard_min:"", side2_yard_max:"", rear_yard_min:"", rear_yard_max:"",
        rent_amt:"",rent_duration:"",extra_remarks:"",val_references:"",
        
        RCC_Percentage:"", Tiled_Percentage:"", Sheet_Percentage:"", Other_Percentage:"" 
    },
    land_inspection_details:{ nearest_city:"",crz:"", stigma:"", nearest_Highway:"", nearest_school:"", nearest_railway:"", nearest_busstop:"",
    nearest_hospital:"", crematoriums:"", slums:"", communial_area:"", factory_abutting:"", defence_area:"", heritage_property:"", rubber_plantations:"",
    coconut_thope:"", buffer_zone:"", telecommunication_tower:"", high_tension_wire_electrical_line:"",enroachment_subject_to_prop:"",
    intrusion_other_to_subject:"", railway_distance:"", STCM_in_property:"", inspection_notes:"", land_value:"",railway_pass:"",
    },
    Sketch: { landmark_description: "", main_layout: "" }, 
    images: {} ,
    vectors : {} // We keep this for local reload, but will delete before submit
};
}
let formState = getEmptyState();
let visibleFloorIndices = [2, 3];
const floorConfig = [
    { label: "BF-2",      key: "BF_2" },
    { label: "BF-1",      key: "BF_1" },
    { label: "GF",        key: "GF" },
    { label: "1st Floor", key: "first_flr" },
    { label: "2nd Floor", key: "second_flr" },
    { label: "3rd Floor", key: "third_flr" },
    { label: "4th Floor", key: "fourth_flr" },
    { label: "5th Floor", key: "fifth_flr" }
];
/* =========================
   3. DOM ELEMENTS
========================= */
const fileList = document.getElementById("fileList");
const thumbsContainer = document.getElementById("thumbs");
const bigImageFrame = document.getElementById("bigImageFrame");
const noSelection = document.getElementById("noSelection");
const bigPreviewTitle = document.getElementById("bigPreviewTitle");
const fileInfoBox = document.getElementById("fileInfoBox");
const pdfWrapper = document.getElementById("pdfWrapper");
const pdfMain = document.getElementById("pdfMain");

// Sketch Elements - Pointing to PRO CANVAS (Modal)
const sketchModal = document.getElementById('sketchModal');
const canvas = document.getElementById("proCanvas"); 
const ctx = canvas ? canvas.getContext("2d") : null;



function initBuildingTable() {
    // Check if we have saved data for hidden floors and auto-show them
    // e.g., if "BF_1_Builtup_area" has data, make sure index 1 is visible
    const data = formState.Building_analysis || {};
    
    floorConfig.forEach((floor, index) => {
        // Check a key field (e.g., Builtup Area) to see if data exists
        const hasData = data[`${floor.key}_Builtup_area`] || 
                        data[`${floor.key}_Rooms_no`];
        
        if (hasData && !visibleFloorIndices.includes(index)) {
            visibleFloorIndices.push(index);
        }
    });

    // Sort indices to keep floors in order (BF-2 -> 5th Floor)
    visibleFloorIndices.sort((a, b) => a - b);
    
    renderBuildingRows();
}

function renderBuildingRows() {
    const tbody = document.getElementById("buildingTableBody");
    if (!tbody) return;
    
    tbody.innerHTML = "";

    // 1. RENDER FIXED FLOORS (BF, GF, 1st, etc.)
    visibleFloorIndices.forEach(index => {
        const floor = floorConfig[index];
        const key = floor.key;
        
        const getVal = (suffix) => (formState.Building_analysis && formState.Building_analysis[`${key}_${suffix}`]) || "";
        const getChecked = (arraySuffix, val) => {
            const arr = (formState.Building_analysis && formState.Building_analysis[`${key}_${arraySuffix}`]) || [];
            return Array.isArray(arr) && arr.includes(val) ? "checked" : "";
        };

        const tr = document.createElement("tr");
        tr.innerHTML = `
            <td class="font-bold bg-gray-50">${floor.label}</td>
            <td><input type="number" data-path="Building_analysis.${key}_Builtup_area" step="0.01" class="table-input" value="${getVal('Builtup_area')}"></td>
            <td><input type="number" data-path="Building_analysis.${key}_Rooms_no" class="table-input" value="${getVal('Rooms_no')}"></td>
            <td><input type="number" data-path="Building_analysis.${key}_Kitchen_no" class="table-input" value="${getVal('Kitchen_no')}"></td>
            <td><input type="number" data-path="Building_analysis.${key}_Bathrooms_no" class="table-input" value="${getVal('Bathrooms_no')}"></td>
            <td>
                <div class="radio-cell-group">
                  <label class="radio-cell-label"><input type="checkbox" data-array="Building_analysis.${key}_Usage" value="Residential" ${getChecked('Usage', 'Residential')}> Res</label>
                  <label class="radio-cell-label"><input type="checkbox" data-array="Building_analysis.${key}_Usage" value="Commercial" ${getChecked('Usage', 'Commercial')}> Com</label>
                  <label class="radio-cell-label"><input type="checkbox" data-array="Building_analysis.${key}_Usage" value="Industrial" ${getChecked('Usage', 'Industrial')}> Ind</label>
                </div>
            </td>
            <td>
                <div class="radio-cell-group">
                  <label class="radio-cell-label"><input type="checkbox" data-array="Building_analysis.${key}_Occupancy" value="Owner" ${getChecked('Occupancy', 'Owner')}> Owner</label>
                  <label class="radio-cell-label"><input type="checkbox" data-array="Building_analysis.${key}_Occupancy" value="Applicant" ${getChecked('Occupancy', 'Applicant')}> App</label>
                  <label class="radio-cell-label"><input type="checkbox" data-array="Building_analysis.${key}_Occupancy" value="Rented" ${getChecked('Occupancy', 'Rented')}> Rent</label>
                  <label class="radio-cell-label"><input type="checkbox" data-array="Building_analysis.${key}_Occupancy" value="Vacant" ${getChecked('Occupancy', 'Vacant')}> Vac</label>
                </div>
            </td>
            <td>
                ${ (floor.label !== 'GF' && floor.label !== '1st Floor') ? 
                   `<button onclick="removeFloor(${index})" class="text-red-500 hover:text-red-700" title="Remove Row"><i class="fas fa-trash"></i></button>` 
                   : '' 
                }
            </td>
        `;
        tbody.appendChild(tr);
    });

    // 2. RENDER DYNAMIC APARTMENTS
    const apts = formState.Building_analysis.apartments || [];
    apts.forEach((apt, idx) => {
        // Path base: "Building_analysis.apartments.0."
        const basePath = `Building_analysis.apartments.${idx}`;
        
        const getAptVal = (key) => apt[key] || "";
        const getAptChecked = (key, val) => (Array.isArray(apt[key]) && apt[key].includes(val)) ? "checked" : "";

        const tr = document.createElement("tr");
        tr.innerHTML = `
            <td class="font-bold bg-green-50 text-green-800">
                <input type="text" data-path="${basePath}.label" class="table-input font-bold" value="${getAptVal('label') || 'Apartment ' + (idx + 1)}" placeholder="Unit Name">
            </td>
            <td><input type="number" data-path="${basePath}.Builtup_area" step="0.01" class="table-input" value="${getAptVal('Builtup_area')}"></td>
            <td><input type="number" data-path="${basePath}.Rooms_no" class="table-input" value="${getAptVal('Rooms_no')}"></td>
            <td><input type="number" data-path="${basePath}.Kitchen_no" class="table-input" value="${getAptVal('Kitchen_no')}"></td>
            <td><input type="number" data-path="${basePath}.Bathrooms_no" class="table-input" value="${getAptVal('Bathrooms_no')}"></td>
            
            <td>
                <div class="radio-cell-group">
                  <label class="radio-cell-label"><input type="checkbox" data-array="${basePath}.Usage" value="Residential" ${getAptChecked('Usage', 'Residential')}> Res</label>
                  <label class="radio-cell-label"><input type="checkbox" data-array="${basePath}.Usage" value="Commercial" ${getAptChecked('Usage', 'Commercial')}> Com</label>
                  <label class="radio-cell-label"><input type="checkbox" data-array="${basePath}.Usage" value="Industrial" ${getAptChecked('Usage', 'Industrial')}> Ind</label>
                </div>
            </td>
            
            <td>
                <div class="radio-cell-group">
                  <label class="radio-cell-label"><input type="checkbox" data-array="${basePath}.Occupancy" value="Owner" ${getAptChecked('Occupancy', 'Owner')}> Owner</label>
                  <label class="radio-cell-label"><input type="checkbox" data-array="${basePath}.Occupancy" value="Applicant" ${getAptChecked('Occupancy', 'Applicant')}> App</label>
                  <label class="radio-cell-label"><input type="checkbox" data-array="${basePath}.Occupancy" value="Rented" ${getAptChecked('Occupancy', 'Rented')}> Rent</label>
                  <label class="radio-cell-label"><input type="checkbox" data-array="${basePath}.Occupancy" value="Vacant" ${getAptChecked('Occupancy', 'Vacant')}> Vac</label>
                </div>
            </td>
            
            <td>
                <button onclick="removeApartment(${idx})" class="text-red-500 hover:text-red-700" title="Remove Apartment"><i class="fas fa-trash"></i></button>
            </td>
        `;
        tbody.appendChild(tr);
    });
}

function addFloor(direction) {
    // Find min and max currently visible indices
    const min = Math.min(...visibleFloorIndices);
    const max = Math.max(...visibleFloorIndices);

    let newIndex;
    if (direction === 'above') {
        newIndex = max + 1;
        if (newIndex >= floorConfig.length) return alert("Max floor limit reached (5th Floor)");
    } else {
        newIndex = min - 1;
        if (newIndex < 0) return alert("Min floor limit reached (BF-2)");
    }

    if (!visibleFloorIndices.includes(newIndex)) {
        visibleFloorIndices.push(newIndex);
        visibleFloorIndices.sort((a, b) => a - b);
        renderBuildingRows();
    }
}

function removeFloor(indexToRemove) {
    visibleFloorIndices = visibleFloorIndices.filter(i => i !== indexToRemove);
    renderBuildingRows();
    // Optional: Clear data for that floor in formState if you want strict cleanup
}
/* =========================
   APARTMENT LOGIC
   ========================= */

function addApartment() {
    if (!formState.Building_analysis.apartments) {
        formState.Building_analysis.apartments = [];
    }
    
    if (formState.Building_analysis.apartments.length >= 1) {
        alert("You can only add one apartment.");
        return;
    }
    
    // Add empty object
    formState.Building_analysis.apartments.push({
        label: `Apartment`, // Simplified label since there is only 1
        Builtup_area: "",
        Rooms_no: "",
        Kitchen_no: "",
        Bathrooms_no: "",
        Usage: [],
        Occupancy: []
    });
    
    renderBuildingRows();
    saveLocal();
}

function removeApartment(index) {
    if (!formState.Building_analysis.apartments) return;
    
    // Remove item at index
    formState.Building_analysis.apartments.splice(index, 1);
    
    renderBuildingRows();
    saveLocal();
}

/* =========================
   4. FILE EXPLORER LOGIC (SMART RESTORE)
========================= */
function loadFolder(path = "") {
  if (currentFolder && currentFolder !== path) {
      saveToServer(true); 
      clearTimeout(autoSaveTimer); 
  }

  const scrollContainer = document.querySelector('.file-list-container');
  if (scrollContainer) folderScrollHistory[currentFolder] = scrollContainer.scrollTop;

  currentFolder = path;
  formState.target_folder = path; 
  
  document.getElementById("currentPath").textContent = "/" + (path || "");
  const banner = document.getElementById("bigPreviewTitle");
  if(banner) banner.textContent = path ? path : "Home / Root";
  const topBanner = document.getElementById("topBannerPath");
  if (topBanner) topBanner.textContent = path ? "/" + path : "/";

  document.getElementById("scrollContainer").classList.add("hidden");
  document.getElementById("pdfToolbar").classList.add("hidden");
  document.getElementById("bigImageFrame").classList.add("hidden");
  document.getElementById("noSelection").classList.remove("hidden");

  const statsBox = document.getElementById("folderStatsBox");
  
  fetch(`/coreapi/api/folder-contents/?path=${encodeURIComponent(path)}`)
    .then(r => r.json())
    .then(data => {
      // 1. Start Fresh
      formState = getEmptyState(); 

      const localDataString = localStorage.getItem(STORAGE_KEY);
      const localFolder = localStorage.getItem('vadrida_active_folder');
      let localData = null;

      if (localDataString && localFolder === path) {
          try { localData = JSON.parse(localDataString); } catch(e) { console.error("Local parse error", e); }
      }

      const serverDraft = data.saved_draft || {};

      // 2. Smart Merge
      if (localData) {
          formState = { ...formState, ...serverDraft, ...localData };
          if (serverDraft.images && Object.keys(serverDraft.images).length > 0) formState.images = serverDraft.images;
          if (serverDraft.vectors && Object.keys(serverDraft.vectors).length > 0) formState.vectors = serverDraft.vectors;
      } 
      else if (data.saved_draft) {
          formState = { ...formState, ...data.saved_draft };
      } 
      else if (data.auto_fill) {
          updateNestedState(formState, 'Valuers_Checklist.Office_file_no', data.auto_fill.file_no);
          updateNestedState(formState, 'Valuers_Checklist.applicant_name', data.auto_fill.applicant_name);
          updateNestedState(formState, 'Valuers_Checklist.product', data.auto_fill.product);
          saveToServer(); 
      }
      
      if (!formState.images) formState.images = {};
      if (!formState.vectors) formState.vectors = {};

      if (data.folder_info && data.folder_info.download_date) {
            formState.meta_download_date = data.folder_info.download_date;
            saveLocal();
      }

      currentFolderFiles = data.files || [];
      renderFileList(data.folders || [], data.files || []);
      renderThumbs(data.files || []);

      // 3. UI Sync
      initBuildingTable();   
      renderSurveyColumns();          
      updateAllDocumentDropdowns();  
      injectPencilIcons(); 

      const constructionStr = getNestedValue(formState, "Building_analysis.construction_year");
      parseTimelineString(constructionStr); 

      syncStateToUI();        
      renderAllSavedImages();

      localStorage.setItem('vadrida_active_folder', path);

      if (data.folder_info) { renderFolderStats(data.folder_info); } 
      else { if(statsBox) statsBox.classList.add("hidden"); }

      // âœ… SCROLL RESTORE FIX (Apply to BOTH potential containers)
      setTimeout(() => {
          // 1. File List
          const fileListContainer = document.querySelector('.file-list-container');
          const savedListScroll = parseInt(localStorage.getItem('vadrida_file_list_scroll') || '0');
          if (fileListContainer && savedListScroll > 0) {
              fileListContainer.scrollTop = savedListScroll;
          }

          // 2. Feedback Form
          const savedFormScroll = parseInt(localStorage.getItem('vadrida_form_scroll') || '0');
          if (savedFormScroll > 0) {
              const rightCol = document.getElementById('rightColumnContainer');
              const formEl = document.getElementById('siteFeedbackForm');
              
              // Apply to both (The one with overflow:hidden will simply ignore it)
              if (rightCol) rightCol.scrollTop = savedFormScroll;
              if (formEl) formEl.scrollTop = savedFormScroll;
          }
      }, 100);
    });
}
/* =========================
   CORE: RENDER ALL IMAGES (Self-Healing)
   If an image tag is missing, this creates it on the fly.
========================= */
function renderAllSavedImages() {
    console.log("Rendering images...", Object.keys(formState.images || {}));

    if (!formState.images) return;

    Object.keys(formState.images).forEach(path => {
        const base64Data = formState.images[path];
        if (!base64Data) return;

        // 1. Construct the Expected ID
        const safeId = path.replace(/\./g, '_');
        const imgId = `img_preview_${safeId}`;
        
        let imgElement = document.getElementById(imgId);

        // 2. SELF-HEALING: If DOM element is missing, create it now!
        if (!imgElement) {
            // Try to find the input/textarea associated with this data path
            const targetInput = document.querySelector(`[data-path="${path}"]`);
            
            if (targetInput) {
                console.log(`Creating missing image container for: ${path}`);
                
                // Create the Image Element
                imgElement = document.createElement('img');
                imgElement.id = imgId;
                imgElement.className = 'sketch-thumb';
                imgElement.style.marginTop = '10px';
                imgElement.style.maxHeight = '150px';
                imgElement.style.maxWidth = '100%';
                imgElement.style.borderRadius = '8px';
                imgElement.style.border = '1px solid #e5e7eb';
                imgElement.style.cursor = 'pointer';
                imgElement.style.display = 'block'; // Force visible
                
                // Add Click Listener
                imgElement.onclick = (e) => {
                    e.stopPropagation(); 
                    openSketchPad(path);
                };

                // Find where to insert it. 
                const container = targetInput.closest('.input-wrapper') || targetInput;
                
                // Insert AFTER the input/wrapper
                if (container.parentNode) {
                    if (container.nextSibling) {
                        container.parentNode.insertBefore(imgElement, container.nextSibling);
                    } else {
                        container.parentNode.appendChild(imgElement);
                    }
                }
            }
        }

        // 3. RENDER THE DATA
        if (imgElement) {
            imgElement.src = base64Data;
            imgElement.classList.remove('hidden');
            imgElement.style.display = 'block'; 
            
            // Special handling for Main Layout Placeholder
            const placeholder = document.getElementById(`placeholder_${safeId}`);
            if (placeholder) {
                placeholder.classList.add('hidden');
                placeholder.style.display = 'none';
            }
        }
    });
}
function renderFolderStats(info) {
    const statsBox = document.getElementById("folderStatsBox");
    
    // Map backend color to YOUR CSS classes
    let colorSuffix = "grey";
    if (info.status_color === "green") colorSuffix = "green";
    else if (info.status_color === "yellow") colorSuffix = "yellow";
    else if (info.status_color === "red") colorSuffix = "red";

    statsBox.innerHTML = `
        <div style="display:flex; justify-content:space-between; border-bottom:1px solid #eee; padding-bottom:5px; margin-bottom:5px; font-weight:bold;">
            <span>Case Details</span>
            <div style="display:flex; align-items:center;">
                <span class="status-dot status-${colorSuffix}"></span>
                <span style="font-size:10px; text-transform:uppercase; color:#666;">${info.status_label}</span>
            </div>
        </div>
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:5px;">
            <div style="color:#666;">Downloaded:</div><div style="text-align:right;">${info.download_date}</div>
            <div style="color:#666;">TAT Limit:</div><div style="text-align:right; color:#2563eb;">${info.tat_date}</div>
            <div style="color:#666;">Site Report:</div><div style="text-align:right;">${info.site_report_date}</div>
            <div style="color:#666;">Final Report:</div><div style="text-align:right;">${info.final_report_date}</div>
        </div>
    `;
    statsBox.classList.remove("hidden");
}
document.getElementById("goBackBtn").onclick = () => {
  if (!currentFolder) return;
  const parts = currentFolder.split("/");
  parts.pop();
  loadFolder(parts.join("/"));
};

function renderFileList(folders, files) {
  files = files.filter(f => f.name.toLowerCase() !== 'desktop.ini' && f.name !== '.DS_Store');
  fileList.innerHTML = "";

  // 1. RENDER FOLDERS
  folders.forEach(folder => {
    const li = document.createElement("li");
    // 'items-start' makes the icon stick to the TOP if text is 2 lines
    li.className = "p-2 hover:bg-blue-50 flex items-start justify-between group border-b border-gray-50";
    li.dataset.folderPath = folder.path; 

    // --- Status Dot Logic ---
    let statusDotHtml = "";
    if (folder.status_color) {
        let colorClass = "bg-gray-400";
        if (folder.status_color === "green") colorClass = "bg-green-500";
        else if (folder.status_color === "yellow") colorClass = "bg-yellow-400";
        else if (folder.status_color === "red") colorClass = "bg-red-500";
        
        // Added flex-shrink-0 to prevent dot from squishing
        statusDotHtml = `<span class="block w-2 h-2 rounded-full ${colorClass} mt-1 flex-shrink-0"></span>`;
    } else {
        statusDotHtml = `<span class="block w-2 h-2 mt-1 flex-shrink-0"></span>`; 
    }

    const leftDiv = document.createElement("div");
    // 'min-w-0' is CRITICAL. It allows the text container to shrink and wrap.
    leftDiv.className = "flex items-start gap-3 cursor-pointer flex-1 min-w-0"; 
    
    leftDiv.innerHTML = `
      <div class="flex flex-col items-center justify-start flex-shrink-0 w-8 pt-0.5">
          <span class="text-xl leading-none">ðŸ“</span> 
          ${statusDotHtml}
      </div>
      <span class="font-medium break-all whitespace-normal leading-snug text-sm pt-1 block">${folder.name}</span>
    `;
    
    leftDiv.onclick = () => loadFolder(folder.path);
    li.appendChild(leftDiv);

    // --- Chat Icon Logic ---
    if (folder.has_chat) {
       const chatBtnWrapper = document.createElement("div");
       chatBtnWrapper.className = "relative ml-2 flex-shrink-0 mt-1"; 
       
       const chatBtn = document.createElement("button");
       chatBtn.className = "w-8 h-8 rounded-full bg-green-100 text-green-600 hover:bg-green-200 flex items-center justify-center";
       chatBtn.innerHTML = '<i class="fas fa-comments"></i>';
       chatBtn.onclick = (e) => {
           e.stopPropagation();
           openFolderChat(folder.path, folder.name);
           const dot = chatBtnWrapper.querySelector('.unread-dot');
           if(dot) dot.remove();
       };
       chatBtnWrapper.appendChild(chatBtn);
       
       if (folder.is_unread) {
           const dot = document.createElement("span");
           dot.className = "unread-dot absolute -top-1 -right-1 w-3 h-3 bg-red-500 rounded-full border-2 border-white";
           chatBtnWrapper.appendChild(dot);
       }
       li.appendChild(chatBtnWrapper);
    }

    fileList.appendChild(li);
  });

  // 2. RENDER FILES
  files.forEach(file => {
      const li = document.createElement("li");
      li.className = "p-2 cursor-pointer hover:bg-gray-100 border-b border-gray-50";
      
      // Fixed: Removed fixed height, allowed wrapping
      li.innerHTML = `
        <div class="flex justify-between items-start">
          <div class="min-w-0 pr-2 flex-1">
            <div class="font-medium break-all whitespace-normal leading-snug text-sm text-gray-700">${file.name}</div>
            <div class="text-[10px] text-gray-400 uppercase tracking-wider mt-0.5">${file.extension || "FILE"}</div>
          </div>
        </div>`;
        
      li.onclick = () => {
          document.querySelectorAll("#fileList li").forEach(el => el.classList.remove("bg-blue-100"));
          li.classList.add("bg-blue-100");
          loadBigPreview(file);
          setFileInfo(file);
      };
      fileList.appendChild(li);
  });

  if (!folders.length && !files.length) {
    fileList.innerHTML = `<li class="p-3 text-gray-400 text-center text-sm">Empty Folder</li>`;
  }
}
/* =========================
   5. THUMBNAILS & PREVIEWS
========================= */
/* =========================
   SAFE THUMBNAIL LOADER (Queue System)
   Prevents server freeze by loading only 3 images at a time.
========================= */
const thumbQueue = [];
let activeRequests = 0;
const MAX_CONCURRENT = 3; // Only 3 G: Drive requests at once

function processThumbQueue() {
    // Stop if we are at the limit or queue is empty
    if (activeRequests >= MAX_CONCURRENT || thumbQueue.length === 0) return;

    // Get the next image waiting in line
    const { imgElement, url, card } = thumbQueue.shift();
    activeRequests++;

    imgElement.onload = () => {
        activeRequests--;
        card.innerHTML = ""; // Remove spinner
        card.appendChild(imgElement);
        processThumbQueue(); // Call the next one!
    };

    imgElement.onerror = () => {
        activeRequests--;
        // Show fallback icon
        let icon = "fa-file-image";
        if(url.includes("pdf")) icon = "fa-file-pdf";
        card.innerHTML = `<div class="file-icon"><i class="fas ${icon} text-red-400"></i></div>`;
        processThumbQueue(); // Call the next one!
    };

    // ACTUALLY START THE DOWNLOAD HERE
    imgElement.src = url;
}

function renderThumbs(files) {
    files = files.filter(f => f.name.toLowerCase() !== 'desktop.ini' && f.name !== '.DS_Store');
  thumbsContainer.innerHTML = "";
  
  // Clear old queue so we don't load images from the previous folder
  thumbQueue.length = 0; 
  activeRequests = 0;

  if (!files.length) {
    thumbsContainer.innerHTML = `<div class="no-thumbs">No files to preview</div>`;
    return;
  }

  files.forEach(file => {
    const card = document.createElement("div");
    card.className = "thumb-item";
    // Show Spinner immediately
    card.innerHTML = `<div class="file-icon"><i class="fas fa-spinner fa-spin text-gray-400"></i></div>`;

    const ext = file.name.split(".").pop().toLowerCase();

    // --- PREPARE IMAGE OBJECT (Don't set .src yet!) ---
    if (['jpg', 'jpeg', 'png', 'gif', 'bmp', 'pdf'].includes(ext)) {
        const img = new Image();
        img.className = "preview-thumb-img";
        // Inline styles to ensure it fits
        img.style.width = "100%";
        img.style.height = "100%";
        img.style.objectFit = "contain";

        let url = "";
        // Use your Python APIs
        if (ext === 'pdf') {
             url = `/coreapi/api/thumbnail/?path=${encodeURIComponent(file.path)}`;
        } else {
             url = `/coreapi/serve-file/?path=${encodeURIComponent(file.path)}`;
        }

        // PUSH TO QUEUE INSTEAD OF LOADING
        thumbQueue.push({ imgElement: img, url: url, card: card });
    } 
    else {
        // Non-image files (Word/Excel) load instantly
        let icon = "fa-file-alt";
        if(['doc','docx'].includes(ext)) icon = "fa-file-word";
        if(['xls','xlsx'].includes(ext)) icon = "fa-file-excel";
        card.innerHTML = `<div class="file-icon"><i class="fas ${icon}"></i><br><span style="font-size:10px">${ext.toUpperCase()}</span></div>`;
    }

    // Click to Preview
    card.onclick = () => {
      document.querySelectorAll(".file-item").forEach(el => el.classList.remove("selected"));
      loadBigPreview(file);
      setFileInfo(file);
    };

    thumbsContainer.appendChild(card);
  });

  // Start 3 workers
  processThumbQueue();
  processThumbQueue();
  processThumbQueue();
}

/* =========================
   7. FOLDER CHAT (Ported)
========================= */
const folderChatModal = document.getElementById('folderChatModal');
const folderChatMsgs = document.getElementById('folderChatMessages');

function openFolderChat(path, name) {
    currentChatFolder = path;
    document.getElementById('folderChatTitle').textContent = name;
    
    // Show Modal
    folderChatModal.classList.remove('hidden');
    folderChatModal.style.display = 'flex'; // Force Flex for centering

    loadFolderChatHistory();

    if (folderChatSocket) folderChatSocket.close();
    const protocol = location.protocol === 'https:' ? 'wss' : 'ws';
    const wsUrl = `${protocol}://${location.host}/ws/chat/folder/?path=${encodeURIComponent(path)}`;
    folderChatSocket = new WebSocket(wsUrl);

    folderChatSocket.onmessage = function(e) {
        const data = JSON.parse(e.data);
        appendFolderMessage(data); 
    };
}

function closeFolderChat() {
    folderChatModal.classList.add('hidden');
    folderChatModal.style.display = 'none';
    currentChatFolder = null;
    if (folderChatSocket) { folderChatSocket.close(); folderChatSocket = null; }
}

function appendFolderMessage(msg) {
    const isMe = msg.is_me;
    const div = document.createElement('div');
    div.className = isMe ? 'chat-bubble chat-me' : 'chat-bubble chat-other';
    
    div.innerHTML = `
        ${!isMe ? `<div style="font-size:10px; font-weight:bold; color:orange; margin-bottom:2px;">${msg.user}</div>` : ''}
        <div style="word-wrap:break-word;">${msg.message}</div>
        <div style="font-size:9px; color:#aaa; text-align:right; margin-top:4px;">${msg.time}</div>
    `;
    folderChatMsgs.appendChild(div);
    folderChatMsgs.scrollTop = folderChatMsgs.scrollHeight;
}

function loadFolderChatHistory() {
    folderChatMsgs.innerHTML = '<div style="text-align:center; color:#999; margin-top:20px;">Loading...</div>';
    fetch(`/chat/api/folder-history/?path=${encodeURIComponent(currentChatFolder)}`)
        .then(r => r.json())
        .then(data => {
            folderChatMsgs.innerHTML = ""; 
            if(data.messages.length === 0) {
                folderChatMsgs.innerHTML = '<div style="text-align:center; color:#ccc; margin-top:20px;">No notes yet.</div>';
                return;
            }
            data.messages.forEach(msg => appendFolderMessage(msg));
        });
}

document.getElementById('folderChatForm').onsubmit = (e) => {
    e.preventDefault();
    const input = document.getElementById('folderChatInput');
    const msg = input.value.trim();
    
    // Check if socket is ready
    if(!msg || !folderChatSocket || folderChatSocket.readyState !== WebSocket.OPEN) {
        console.error("Socket not ready or message empty");
        return;
    }

    // Send to Consumer
    folderChatSocket.send(JSON.stringify({
        'message': msg
    }));
    
    input.value = ""; // Clear input
};
function setFileInfo(file) {
  fileInfoBox.innerHTML = `
    <div class="info-row"><strong>Name:</strong> <span>${file.name}</span></div>
    <div class="info-row"><strong>Type:</strong> ${file.extension || "Unknown"}</div>
    <div class="info-row"><strong>Size:</strong> ${file.size || "N/A"}</div>
  `;
}

/* =========================
   6. PDF & ANALYSIS TOOLS
========================= */
function loadPdfJsIfNeeded() {
  if (window.pdfjsLib) return Promise.resolve();
  return new Promise((resolve) => {
    const script = document.createElement("script");
    script.src = "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js";
    script.onload = () => {
      pdfjsLib.GlobalWorkerOptions.workerSrc = "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js";
      resolve();
    };
    document.head.appendChild(script);
  });
}

// Analysis Controls
const analyseBtn = document.getElementById("analyseBtn");
const analyseModal = document.getElementById("analyseModal");
const fileSelectModal = document.getElementById("fileSelectModal");
const fileSelectList = document.getElementById("fileSelectList");

function startAnalysis(files) {
  if (analysisController) analysisController.abort();
  analysisController = new AbortController();
  document.getElementById("analyseLoading").classList.remove("hidden");

  fetch("/coreapi/api/analyze/", {
    method: "POST",
    headers: { "Content-Type": "application/json", "X-CSRFToken": csrftoken },
    body: JSON.stringify({ files, folder: currentFolder }),
    signal: analysisController.signal
  })
  .then(r => r.json())
  .then(() => loadFolder(currentFolder))
  .catch(e => { if (e.name !== 'AbortError') alert("Analysis failed"); })
  .finally(() => {
    document.getElementById("analyseLoading").classList.add("hidden");
    analysisController = null;
  });
}

analyseBtn.onclick = () => {
  if (!currentFolder && currentFolderFiles.length === 0) return alert("No files");
  analyseModal.classList.remove("hidden");
};

document.getElementById("analyseSelectAll").onclick = () => {
  if (!currentFolderFiles.length) return alert("No files");
  const files = currentFolderFiles.map(f => ({ file_path: f.path }));
  analyseModal.classList.add("hidden");
  startAnalysis(files);
};

document.getElementById("analyseSelectFiles").onclick = () => {
  if (!currentFolderFiles.length) return alert("No files");
  fileSelectList.innerHTML = "";
  selectedAnalysisFiles = [];
  currentFolderFiles.forEach(file => {
    const row = document.createElement("label");
    row.className = "flex items-center gap-2 mb-2 cursor-pointer";
    row.innerHTML = `<input type="checkbox" value="${file.path}" /> <span class="truncate">${file.name}</span>`;
    row.querySelector("input").onchange = (e) => {
      if (e.target.checked) selectedAnalysisFiles.push({ file_path: e.target.value });
      else selectedAnalysisFiles = selectedAnalysisFiles.filter(f => f.file_path !== e.target.value);
    };
    fileSelectList.appendChild(row);
  });
  analyseModal.classList.add("hidden");
  fileSelectModal.classList.remove("hidden");
};

document.getElementById("confirmFileSelection").onclick = () => {
  if (!selectedAnalysisFiles.length) return alert("Select a file");
  fileSelectModal.classList.add("hidden");
  startAnalysis(selectedAnalysisFiles);
};

document.getElementById("analyseClose").onclick = () => analyseModal.classList.add("hidden");
document.getElementById("fileSelectClose").onclick = () => fileSelectModal.classList.add("hidden");


/* =========================
   SEARCH DEBOUNCE (Updated)
========================= */
const searchInput = document.getElementById("fileSearch");
let searchTimer = null;
let currentSearchController = null; // Store the abort controller

searchInput.addEventListener("input", e => {
  const q = e.target.value.trim();
  
  // 1. Clear the timer (Stop previous countdown)
  clearTimeout(searchTimer);

  // 2. Cancel any currently running network request
  if (currentSearchController) {
      currentSearchController.abort();
  }

  // 3. Wait 800ms (0.8 seconds) before sending the new request
  searchTimer = setTimeout(() => {
    if (!q) { 
        loadFolder(currentFolder); 
        return; 
    }
    globalSearch(q);
  }, 800); 
});

function globalSearch(query) {
  fileList.innerHTML = `<li class="file-item loading">Searching...</li>`;
  
  // Create a new controller for this specific request
  currentSearchController = new AbortController();
  const signal = currentSearchController.signal;

  fetch(`/coreapi/api/search/?q=${encodeURIComponent(query)}`, { signal })
    .then(r => r.json())
    .then(data => {
      renderFileList(data.folders || [], data.files || []);
      renderThumbs(data.files || []);
    })
    .catch(err => {
        if (err.name === 'AbortError') {
            console.log('Search aborted');
        } else {
            console.error('Search failed', err);
        }
    });
}
/* =========================
   REFRESH BUTTON (Fixed)
========================= */
document.getElementById("refreshFolders").onclick = () => {
  const btn = document.getElementById("refreshFolders");
  btn.classList.add("rotating"); 
  btn.disabled = true;
  
  const searchInput = document.getElementById("fileSearch");
  if(searchInput.value) searchInput.value = "";

  loadFolder(currentFolder);

  setTimeout(() => {
      btn.classList.remove("rotating");
      btn.disabled = false;
  }, 500);
};
/* =========================
   7. MODAL & PREVIEW UI
========================= */

document.getElementById("modalClose").onclick = () => {
  fullscreenModal.setAttribute("aria-hidden", "true");
  modalFrame.src = ""; modalImage.src = "";
};




// Enforce Landscape
/* =========================
   UPDATED ORIENTATION LOGIC
========================= */
function enforceTabletLandscape() {
  const sketchModal = document.getElementById('sketchModal');
  
  // 1. If Sketch Modal is Open, ALLOW Portrait (Do not block)
  if (sketchModal && !sketchModal.classList.contains('hidden')) {
      document.getElementById("orientationBlocker").classList.add("hidden");
      document.body.style.overflow = "hidden"; // Keep scrolling locked
      return; 
  }

  // 2. Standard Logic for Dashboard
  const isTablet = window.innerWidth >= 768 && window.innerWidth <= 1024;
  const isPortrait = window.innerHeight > window.innerWidth;
  const blocker = document.getElementById("orientationBlocker");

  if (isTablet && isPortrait) {
    blocker.classList.remove("hidden");
    document.body.style.overflow = "hidden";
  } else {
    blocker.classList.add("hidden");
    document.body.style.overflow = "";
  }
}

// Add a specific resize listener to handle canvas resizing when rotating
window.addEventListener("resize", () => {
    enforceTabletLandscape();
    // If sketch modal is open, resize the canvas to fit the new orientation
    if (!document.getElementById('sketchModal').classList.contains('hidden')) {
        resizeCanvas();
    }
});

window.addEventListener("resize", enforceTabletLandscape);
window.addEventListener("orientationchange", enforceTabletLandscape);
/* =========================
   8. SKETCH PAD & DRAWING LOGIC (COMPLETE & FIXED)
========================= */

// --- STATE ---
let elements = [];       // Current shapes
let redoStack = [];      // For Redo functionality
let selectedElement = null; 
let clipboard = null;    

// --- VIEWPORT STATE (Zoom/Pan) ---
let camera = { x: 0, y: 0, z: 1 }; // x/y = pan, z = zoom level

// --- INTERACTION STATE ---
let isDrawing = false;
let isDragging = false;
let isResizing = false;
let isPanning = false; 
let isPromptOpen = false;

let startX, startY; // Screen coordinates
let lastX, lastY;   // For panning calculations
let currentTool = 'brush'; 

// --- CANVAS SETUP ---
function resizeCanvas() {
    if(!canvas) return;
    const sidebar = document.getElementById('sketchSidebar');
    // Get width of sidebar (it changes when collapsed)
    const sidebarWidth = sidebar ? sidebar.offsetWidth : 0; 
    
    const saved = JSON.stringify(elements);
    
    // Canvas width is Window - Sidebar
    canvas.width = window.innerWidth - sidebarWidth;
    canvas.height = window.innerHeight; 
    
    if(saved) elements = JSON.parse(saved);
    renderScene();
}

function openSketchPad(path) {
    activeSketchPath = path;
    sketchModal.classList.remove('hidden');

    const elem = document.documentElement;
    if (elem.requestFullscreen) elem.requestFullscreen().catch(e=>console.log(e));

    // --- CHANGE: Start exactly at MIN_ZOOM ---
    camera = { x: 0, y: 0, z: MIN_ZOOM };

    // Update Compass
    const container = document.getElementById('sketchContainer');
    const existingCompass = document.getElementById('sketchCompassOverlay');
    if (existingCompass) existingCompass.remove();

    if (path === 'Sketch.main_layout') {
        const compass = document.createElement('img');
        compass.id = 'sketchCompassOverlay';
        compass.src = "/static/images/compass-icon.png"; 
        compass.alt = "N";
        Object.assign(compass.style, {
            position: 'absolute', top: '20px', right: '25px', width: '60px',
            opacity: '0.8', pointerEvents: 'none', zIndex: '100'
        });
        container.appendChild(compass);
    }

    setTimeout(() => {
        resizeCanvas();
        if (formState.vectors && formState.vectors[path]) {
            elements = JSON.parse(JSON.stringify(formState.vectors[path]));
        } else {
            elements = []; 
        }
        redoStack = []; 
        
        // --- CHANGE: Center the canvas for the zoomed-out view ---
        // This ensures the "sheet" looks centered when you open it
        camera.x = (canvas.width - (canvas.width * MIN_ZOOM)) / 2;
        camera.y = (canvas.height - (canvas.height * MIN_ZOOM)) / 2;

        renderScene();
    }, 100); 
}

function closeSketchModal() {
    sketchModal.classList.add('hidden');
    activeSketchPath = null;
    if (document.exitFullscreen) document.exitFullscreen().catch(e=>console.log(e));
    enforceTabletLandscape();
}

// ================= ZOOM & PAN LOGIC =================

// Smart Zoom Function
// --- CONFIGURATION ---
const MIN_ZOOM = 0.5; // This is your "Full Zoom Out" limit
const MAX_ZOOM = 5.0;

function zoomToPoint(newScale, screenX, screenY) {
    // 1. Enforce Limits
    if (newScale < MIN_ZOOM) newScale = MIN_ZOOM; // Cannot zoom out past start
    if (newScale > MAX_ZOOM) newScale = MAX_ZOOM;

    // 2. Calculate World Position
    const worldX = (screenX - camera.x) / camera.z;
    const worldY = (screenY - camera.y) / camera.z;

    // 3. Update Scale
    camera.z = newScale;

    // 4. Update Camera Position to keep focus stable
    camera.x = screenX - (worldX * newScale);
    camera.y = screenY - (worldY * newScale);

    renderScene();
}

// Button Zoom (defaults to center of screen)
function zoomCanvas(amount) {
    const centerX = canvas.width / 2;
    const centerY = canvas.height / 2;
    zoomToPoint(camera.z + amount, centerX, centerY);
}
function resetZoom() {
    camera = { x: 0, y: 0, z: 1 };
    renderScene();
}

// Convert Screen Coordinates (Mouse) to World Coordinates (Canvas Drawing)
function toWorld(screenX, screenY) {
    return {
        x: (screenX - camera.x) / camera.z,
        y: (screenY - camera.y) / camera.z
    };
}

// ================= TOOLBAR FUNCTIONS =================
function setTool(tool) {
    currentTool = tool;
    selectedElement = null;
    document.querySelectorAll('.tool-btn').forEach(b => b.classList.remove('active'));
    
    // Highlight active button
    const btn = document.querySelector(`button[onclick="setTool('${tool}')"]`);
    if(btn) btn.classList.add('active');
    
    // Cursor handling
    if(tool === 'select') canvas.style.cursor = 'grab';
    else if(tool === 'text') canvas.style.cursor = 'text';
    else canvas.style.cursor = 'crosshair';

    renderScene();
}
function updateProp(prop, value) {
    // 1. HANDLE SIZE CHANGES
    if (prop === 'size') {
        // If value is empty (user deleted everything), stop here to let them type
        if (value === "") return;

        const intVal = parseInt(value, 10);
        if (isNaN(intVal)) return;

        // Update Text Label
        const label = document.getElementById('strokeVal');
        if(label) label.innerText = intVal + 'px';

        const slider = document.getElementById('strokeSize');
        const numInput = document.getElementById('pencilSize');

        // SCENARIO A: User is typing in the Number Box
        if (document.activeElement === numInput) {
            // Only update the slider
            if (slider && parseInt(slider.value) !== intVal) {
                slider.value = intVal;
            }
        } 
        // SCENARIO B: User is dragging the Slider
        else if (document.activeElement === slider) {
            // Only update the number input
            if (numInput && parseInt(numInput.value) !== intVal) {
                numInput.value = intVal;
            }
        }
        // SCENARIO C: Code triggering update (e.g., loading saved state)
        else {
            if (slider) slider.value = intVal;
            if (numInput) numInput.value = intVal;
        }
    }

    // 2. HANDLE COLOR CHANGES
    if (prop === 'color') {
        document.getElementById('mainColor').value = value;
    }

    // 3. UPDATE SELECTED ELEMENT
    if (selectedElement) {
        saveState(); 
        selectedElement[prop] = value;
        renderScene();
    }
}

function setColor(hex) {
    updateProp('color', hex);
}

// ================= ACTION FUNCTIONS =================

// Save current state to history stack
function saveState() {
    // Deep copy current elements to redoStack isn't linked
    // NOTE: For standard Undo, we push current state to history. 
    // But here we are using a simplified approach: elements IS the state.
    // So 'undo' means popping from elements.
    // However, for Property changes, we need more complex history. 
    // For now, this Undo logic focuses on ADDED/REMOVED shapes.
}

function fillSelected() {
    if (selectedElement && ['rect','circle','triangle'].includes(selectedElement.type)) {
        const color = document.getElementById('mainColor').value;
        selectedElement.fill = color;
        renderScene();
    } else {
        alert("Select a shape (Rect, Circle, Triangle) to fill.");
    }
}

function undoSketch() {
    if (elements.length > 0) {
        const popped = elements.pop();
        redoStack.push(popped);
        renderScene();
    }
}

function redoSketch() {
    if (redoStack.length > 0) {
        const popped = redoStack.pop();
        elements.push(popped);
        renderScene();
    }
}

// Trigger with Popup
function triggerClearSketch() {
    if (elements.length === 0) return; 
    // Use the existing global showConfirm function
    showConfirm(
        "Clear Drawing?",
        "Are you sure you want to delete everything? This cannot be undone.",
        () => {
            elements = [];
            redoStack = [];
            renderScene();
        }
    );
}

// Trigger Save with Popup
function triggerSaveSketch() {
    showConfirm(
        "Save Sketch?",
        "Do you want to save this drawing and close the sketch pad?",
        () => {
            saveSketchModal(); // Call the actual save logic
        }
    );
}

// ================= CORE RENDERING ENGINE =================
function renderScene() {
    if (!ctx) return;
    
    // 1. Clear Screen
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    
    // 2. Save Context & Apply Camera Transform
    ctx.save();
    ctx.translate(camera.x, camera.y);
    ctx.scale(camera.z, camera.z);

    // 3. Draw White Background (World Space)
    // We draw a huge rectangle so it looks like an infinite canvas
    ctx.fillStyle = "white";
    // Draw slightly larger than viewport to ensure coverage
    const worldTopLeft = toWorld(0,0);
    const worldBotRight = toWorld(canvas.width, canvas.height);
    ctx.fillRect(worldTopLeft.x, worldTopLeft.y, 
                 (worldBotRight.x - worldTopLeft.x), 
                 (worldBotRight.y - worldTopLeft.y));

    // 4. Draw All Elements
    elements.forEach(el => {
        ctx.save(); 
        
        ctx.beginPath();
        ctx.strokeStyle = el.color;
        ctx.lineWidth = el.size;
        ctx.fillStyle = el.fill || 'transparent';
        ctx.lineCap = 'round';
        ctx.lineJoin = 'round';

        if (el.style === 'dashed') ctx.setLineDash([15, 10]);
        else if (el.style === 'dotted') ctx.setLineDash([3, 8]);
        else ctx.setLineDash([]);

        if (el.type === 'brush') {
            if(el.points.length > 0) {
                ctx.moveTo(el.points[0].x, el.points[0].y);
                el.points.forEach(p => ctx.lineTo(p.x, p.y));
                ctx.stroke();
            }
        } 
        else if (el.type === 'line') {
            ctx.moveTo(el.x, el.y);
            ctx.lineTo(el.endX, el.endY);
            ctx.stroke();
        } 
        else if (el.type === 'arrow') {
            drawArrow(ctx, el.x, el.y, el.endX, el.endY, el.size);
        }
        else if (el.type === 'rect') {
            ctx.rect(el.x, el.y, el.w, el.h);
            if(el.fill) ctx.fill();
            ctx.stroke();
            if(el.text) drawTextCenter(ctx, el.text, el.x + el.w/2, el.y + el.h/2, el.size);
        } 
        else if (el.type === 'triangle') {
            ctx.beginPath();
            ctx.moveTo(el.x + el.w/2, el.y); 
            ctx.lineTo(el.x, el.y + el.h);   
            ctx.lineTo(el.x + el.w, el.y + el.h); 
            ctx.closePath();
            if(el.fill) ctx.fill();
            ctx.stroke();
        }
        else if (el.type === 'circle') {
            ctx.beginPath();
            ctx.arc(el.x, el.y, el.r, 0, 2 * Math.PI);
            if(el.fill) ctx.fill();
            ctx.stroke();
            if(el.text) drawTextCenter(ctx, el.text, el.x, el.y, el.size);
        } 
        else if (el.type === 'text') {
            ctx.font = (el.size * 3) + "px Arial"; // Scale font with size
            ctx.fillStyle = el.color; 
            ctx.fillText(el.text || "", el.x, el.y); // Fix undefined text
        }

        ctx.restore(); 
    });

    // 5. Draw Selection Box
    if (selectedElement) {
        ctx.save();
        ctx.strokeStyle = "#3b82f6"; 
        ctx.lineWidth = 2 / camera.z; // Keep selection line thin regardless of zoom
        ctx.setLineDash([5, 5]);
        
        let b = getBounds(selectedElement);
        if(b) {
            ctx.strokeRect(b.x - 5, b.y - 5, b.w + 10, b.h + 10);
            // Resize Handle
            ctx.fillStyle = "#3b82f6";
            ctx.fillRect(b.x + b.w - 5, b.y + b.h - 5, 10, 10);
        }
        ctx.restore();
    }

    // 6. Restore Camera (End Frame)
    ctx.restore();
}

// Helper: Draw Arrow
function drawArrow(ctx, fromx, fromy, tox, toy, width) {
    const headlen = width * 5; 
    const dx = tox - fromx;
    const dy = toy - fromy;
    const angle = Math.atan2(dy, dx);
    
    ctx.moveTo(fromx, fromy);
    ctx.lineTo(tox, toy);
    ctx.stroke();
    
    ctx.beginPath();
    ctx.moveTo(tox, toy);
    ctx.lineTo(tox - headlen * Math.cos(angle - Math.PI / 6), toy - headlen * Math.sin(angle - Math.PI / 6));
    ctx.lineTo(tox - headlen * Math.cos(angle + Math.PI / 6), toy - headlen * Math.sin(angle + Math.PI / 6));
    ctx.lineTo(tox, toy);
    ctx.fillStyle = ctx.strokeStyle;
    ctx.fill();
}

function drawTextCenter(ctx, text, x, y, size) {
    if(!text) return;
    ctx.fillStyle = "black";
    ctx.font = ((size || 20) * 0.8) + "px Arial"; // Relative font size
    ctx.textAlign = "center";
    ctx.textBaseline = "middle";
    ctx.fillText(text, x, y);
}

function getBounds(el) {
    if(!el) return null;
    if(el.type === 'rect' || el.type === 'triangle') return {x: el.x, y: el.y, w: el.w, h: el.h};
    if(el.type === 'circle') return {x: el.x - el.r, y: el.y - el.r, w: el.r*2, h: el.r*2};
    if(el.type === 'text') {
        ctx.font = (el.size * 3) + "px Arial";
        const width = ctx.measureText(el.text || "").width;
        return {x: el.x, y: el.y - (el.size*3), w: width, h: (el.size*3)};
    }
    if(el.type === 'line' || el.type === 'arrow') {
        let minX = Math.min(el.x, el.endX), maxX = Math.max(el.x, el.endX);
        let minY = Math.min(el.y, el.endY), maxY = Math.max(el.y, el.endY);
        return {x: minX, y: minY, w: maxX-minX, h: maxY-minY};
    }
    return null;
}

// ================= INTERACTION HANDLERS =================
const getPos = (e) => {
    const rect = canvas.getBoundingClientRect();
    let cx, cy;
    if (e.touches && e.touches.length > 0) { cx = e.touches[0].clientX; cy = e.touches[0].clientY; }
    else if (e.changedTouches && e.changedTouches.length > 0) { cx = e.changedTouches[0].clientX; cy = e.changedTouches[0].clientY; }
    else { cx = e.clientX; cy = e.clientY; }
    
    // Return raw screen coordinates here, convert to world later
    return { x: cx - rect.left, y: cy - rect.top };
};

// Hit Test (must use World Coordinates)
function isHit(el, wx, wy) {
    const b = getBounds(el);
    if(b) return (wx >= b.x && wx <= b.x + b.w && wy >= b.y && wy <= b.y + b.h);
    return false;
}

// --- INTERACTION STATE UPDATES ---
let isPinching = false;
let startPinchDist = 0;
let startZoomLevel = 1;
let startPinchCenter = { x: 0, y: 0 }; // Track where we started pinching

// --- TOUCH STATE ---
let pinchStartWorld = { x: 0, y: 0 }; // The anchor point in World Coords

const handleStart = (e) => {
    // 1. PINCH ZOOM START
    if (e.touches && e.touches.length === 2) {
        e.preventDefault();
        if (isDrawing) { elements.pop(); isDrawing = false; }
        isPinching = true;
        isDragging = false;
        isPanning = false;
        
        startPinchDist = getTouchDistance(e);
        startZoomLevel = camera.z;
        startPinchCenter = getTouchCenter(e); 
        pinchStartWorld = toWorld(startPinchCenter.x, startPinchCenter.y);
        return;
    }

    if(e.type === 'touchstart') e.preventDefault();
    const screenPos = getPos(e);
    const worldPos = toWorld(screenPos.x, screenPos.y);

    startX = worldPos.x;
    startY = worldPos.y;
    lastX = screenPos.x; 
    lastY = screenPos.y;

    // 2. PANNING (Select Tool)
    if (currentTool === 'select') {
        let hitFound = false;
        for (let i = elements.length - 1; i >= 0; i--) {
            if (isHit(elements[i], startX, startY)) {
                hitFound = true; 
                selectedElement = elements[i];
                if(selectedElement.size) document.getElementById('strokeSize').value = selectedElement.size;
                if(selectedElement.color) document.getElementById('mainColor').value = selectedElement.color;
                
                const b = getBounds(selectedElement);
                if(b && Math.abs(startX - (b.x + b.w)) < (20/camera.z) && Math.abs(startY - (b.y + b.h)) < (20/camera.z)) {
                    isResizing = true; 
                } else {
                    isDragging = true;
                }
                break;
            }
        }
        
        if (!hitFound) {
            selectedElement = null;
            isPanning = true;      
            canvas.style.cursor = 'grabbing';
        }
        renderScene();
        return;
    }

    // 3. DRAWING
    isDrawing = true;
    redoStack = []; 
    
    let color = document.getElementById('mainColor').value;
    let sizeInput = document.getElementById('pencilSize');
    let sliderInput = document.getElementById('strokeSize');
    let size = parseInt(sizeInput.value) || parseInt(sliderInput.value) || 3;
    let style = document.getElementById('lineStyle').value;
    let isParallel = document.getElementById('parallelToggle').checked;
    
    if (currentTool === 'eraser') { color = '#FFFFFF'; style = 'solid'; }

    // Create Main Element
    let newEl = { type: currentTool, color, size, style, x: startX, y: startY };

    if (currentTool === 'brush' || currentTool === 'eraser') {
        newEl.type = 'brush'; 
        newEl.points = [{x: startX, y: startY}];
    } else if (currentTool === 'line' || currentTool === 'arrow') {
        newEl.endX = startX; newEl.endY = startY;
    } else if (['rect','triangle'].includes(currentTool)) {
        newEl.w = 0; newEl.h = 0; newEl.text = "";
    } else if (currentTool === 'circle') {
        newEl.r = 0; newEl.text = "";
    }

    elements.push(newEl);
    
    // --- UPDATED: PARALLEL MODE FOR BRUSH & LINES ---
    if (isParallel && (currentTool === 'line' || currentTool === 'brush')) {
        let dist = parseInt(document.getElementById('parallelDist').value) || 20;
        
        // Clone the main element
        let parallelEl = JSON.parse(JSON.stringify(newEl));
        
        // Offset properties
        parallelEl.x += dist; 
        parallelEl.y += dist; 
        
        if (parallelEl.endX !== undefined) {
             parallelEl.endX += dist; 
             parallelEl.endY += dist;
        }
        
        // CRITICAL: Offset the points array for Brush
        if (parallelEl.points) {
            parallelEl.points = parallelEl.points.map(p => ({
                x: p.x + dist,
                y: p.y + dist
            }));
        }

        parallelEl.isGhost = true; // Tag it so handleMove updates it correctly
        elements.push(parallelEl);
    }
};

const handleMove = (e) => {
    if(e.type === 'touchmove') e.preventDefault();

    // 1. PINCH ZOOM MOVE (SMART ZOOM)
    if (isPinching && e.touches && e.touches.length === 2) {
        const currentDist = getTouchDistance(e);
        const currentCenter = getTouchCenter(e); // Center moves slightly as fingers move
        
        const scaleFactor = currentDist / startPinchDist;
        const newZoom = startZoomLevel * scaleFactor;
        
        // Use the smart zoom function with the pinch center
        zoomToPoint(newZoom, currentCenter.x, currentCenter.y);
        return;
    }

    const screenPos = getPos(e);
    const worldPos = toWorld(screenPos.x, screenPos.y);
    const dx = worldPos.x - startX;
    const dy = worldPos.y - startY;

    // 2. PANNING
    if (isPanning) {
        camera.x += (screenPos.x - lastX);
        camera.y += (screenPos.y - lastY);
        lastX = screenPos.x;
        lastY = screenPos.y;
        renderScene();
        return;
    }

    // 3. MANIPULATION
    if (currentTool === 'select' && selectedElement) {
        if (isDragging) {
            if(selectedElement.type === 'brush') {
                selectedElement.points.forEach(p => { p.x += dx; p.y += dy; });
            } else if (['line','arrow'].includes(selectedElement.type)) {
                selectedElement.x += dx; selectedElement.y += dy;
                selectedElement.endX += dx; selectedElement.endY += dy;
            } else {
                selectedElement.x += dx; selectedElement.y += dy;
            }
            startX = worldPos.x; startY = worldPos.y; 
            renderScene();
        } else if (isResizing) {
            if(['rect','triangle'].includes(selectedElement.type)) {
                selectedElement.w = worldPos.x - selectedElement.x;
                selectedElement.h = worldPos.y - selectedElement.y;
            } else if (selectedElement.type === 'circle') {
                selectedElement.r = Math.sqrt((worldPos.x - selectedElement.x)**2 + (worldPos.y - selectedElement.y)**2);
            } else if (['line','arrow'].includes(selectedElement.type)) {
                selectedElement.endX = worldPos.x;
                selectedElement.endY = worldPos.y;
            }
            renderScene();
        }
        return;
    }

    // 4. DRAWING
    if (!isDrawing) return;
    
    let activeEls = [elements[elements.length - 1]];
    if (elements.length > 1 && elements[elements.length-1].isGhost) {
        activeEls.push(elements[elements.length - 2]);
    }

    activeEls.forEach((activeEl) => {
        let currX = worldPos.x; 
        let currY = worldPos.y;
        
        if (activeEl.isGhost) {
             let dist = parseInt(document.getElementById('parallelDist').value) || 20;
             currX += dist; currY += dist;
        }

        if (activeEl.type === 'brush') {
            activeEl.points.push({x: currX, y: currY});
        } else if (['line','arrow'].includes(activeEl.type)) {
            activeEl.endX = currX; activeEl.endY = currY;
        } else if (['rect','triangle'].includes(activeEl.type)) {
            activeEl.w = currX - startX;
            activeEl.h = currY - startY;
        } else if (activeEl.type === 'circle') {
            activeEl.r = Math.sqrt(Math.pow(currX - startX, 2) + Math.pow(currY - startY, 2));
        }
    });

    renderScene();
};

const handleEnd = (e) => {
    if(e.type === 'touchend') e.preventDefault();
    
    // Reset States
    isPinching = false;
    isDrawing = false;
    isDragging = false;
    isResizing = false;
    isPanning = false;
    
    if(currentTool === 'select') canvas.style.cursor = 'grab';

    elements.forEach(el => delete el.isGhost);

    if (currentTool === 'text' && !isDragging && !isPinching) {
        addText(startX, startY);
    }
};

// ================= TEXT HANDLING (FIXED) =================
function addText(x, y) {
    if (isPromptOpen) return;
    isPromptOpen = true;
    
    setTimeout(() => {
        const text = prompt("Enter text:", "");
        if (text && text.trim() !== "") {
            const color = document.getElementById('mainColor').value;
            const size = parseInt(document.getElementById('strokeSize').value);
            // Default size if slider is too small for text
            const finalSize = size < 10 ? 12 : size; 
            
            elements.push({ 
                type: 'text', 
                text: text, 
                x: x, y: y, 
                color: color, 
                size: finalSize 
            });
            redoStack = []; // Clear redo
            renderScene();
        }
        isPromptOpen = false;
    }, 100);
}

// Double click to edit text
if(canvas) {
    canvas.addEventListener('dblclick', (e) => {
        const screenPos = getPos(e);
        const worldPos = toWorld(screenPos.x, screenPos.y);

        for (let i = elements.length - 1; i >= 0; i--) {
            if (isHit(elements[i], worldPos.x, worldPos.y)) {
                const el = elements[i];
                if(el.type !== 'text') continue;

                if (isPromptOpen) return;
                isPromptOpen = true;

                setTimeout(() => {
                    const newText = prompt("Edit Text:", el.text || "");
                    if (newText !== null) {
                        el.text = newText;
                        renderScene();
                    }
                    isPromptOpen = false;
                }, 100);
                return;
            }
        }
    });

    // LISTENERS
    canvas.addEventListener('mousedown', handleStart);
    canvas.addEventListener('mousemove', handleMove);
    canvas.addEventListener('mouseup', handleEnd);
    
    canvas.addEventListener('touchstart', handleStart, {passive: false});
    canvas.addEventListener('touchmove', handleMove, {passive: false});
    canvas.addEventListener('touchend', handleEnd, {passive: false});
    
    // Key shortcuts
    window.addEventListener('keydown', (e) => {
        if (sketchModal.classList.contains('hidden')) return;
        if (e.key === 'Delete') triggerClearSketch(); 
        if (e.ctrlKey && e.key === 'c') copyShape();
        if (e.ctrlKey && e.key === 'v') pasteShape();
        if (e.ctrlKey && e.key === 'z') undoSketch();
        if (e.ctrlKey && e.key === 'y') redoSketch();
    });
    // Mouse Wheel Zoom
    canvas.addEventListener('wheel', (e) => {
      e.preventDefault();
      
      const rect = canvas.getBoundingClientRect();
      const mouseX = e.clientX - rect.left;
      const mouseY = e.clientY - rect.top;

      // Determine zoom direction
      const zoomIntensity = 0.1;
      const delta = e.deltaY < 0 ? zoomIntensity : -zoomIntensity;
      
      // Call smart zoom
      zoomToPoint(camera.z + delta, mouseX, mouseY);
  }, { passive: false });
}

// --- HELPER FUNCTIONS ---

// Distance between two fingers
function getTouchDistance(e) {
    return Math.hypot(
        e.touches[0].clientX - e.touches[1].clientX,
        e.touches[0].clientY - e.touches[1].clientY
    );
}

// Center point between two fingers (Screen Coordinates)
function getTouchCenter(e) {
    const rect = canvas.getBoundingClientRect();
    return {
        x: ((e.touches[0].clientX + e.touches[1].clientX) / 2) - rect.left,
        y: ((e.touches[0].clientY + e.touches[1].clientY) / 2) - rect.top
    };
}
// ============================================

/* ==========================================
   SMART SAVE: CROP CANVAS TO CONTENT
   ========================================== */
/* =========================
   CORE: SAVE SKETCH (Direct Update)
========================= */
function saveSketchModal() {
    if (!activeSketchPath) return;
    if (elements.length === 0) { closeSketchModal(); return; }

    // --- CROP LOGIC (Keep exactly as is) ---
    let minX = Infinity, maxX = -Infinity, minY = Infinity, maxY = -Infinity;
    elements.forEach(el => {
       if (el.type === 'brush') { el.points.forEach(p => { minX = Math.min(minX, p.x); minY = Math.min(minY, p.y); maxX = Math.max(maxX, p.x); maxY = Math.max(maxY, p.y); }); } 
       else if (['line', 'arrow'].includes(el.type)) { minX = Math.min(minX, el.x, el.endX); minY = Math.min(minY, el.y, el.endY); maxX = Math.max(maxX, el.x, el.endX); maxY = Math.max(maxY, el.y, el.endY); }
       else if (el.type === 'circle') { minX = Math.min(minX, el.x - el.r); minY = Math.min(minY, el.y - el.r); maxX = Math.max(maxX, el.x + el.r); maxY = Math.max(maxY, el.y + el.r); }
       else { const w = el.w || 0; const h = el.h || 0; minX = Math.min(minX, el.x); minY = Math.min(minY, el.y); maxX = Math.max(maxX, el.x + w); maxY = Math.max(maxY, el.y + h); }
    });
    const padding = 20; 
    const cropWidth = (maxX - minX) + (padding * 2);
    const cropHeight = (maxY - minY) + (padding * 2);
    const prevCanvasWidth = canvas.width;
    const prevCanvasHeight = canvas.height;
    const prevCamera = { ...camera };
    canvas.width = cropWidth;
    canvas.height = cropHeight;
    camera = { x: -minX + padding, y: -minY + padding, z: 1 };
    renderScene(); 
    const dataUrl = canvas.toDataURL('image/png');
    canvas.width = prevCanvasWidth;
    canvas.height = prevCanvasHeight;
    camera = prevCamera;
    renderScene();
    // --- END CROP ---

    // Save Data
    if (!formState.images) formState.images = {};
    formState.images[activeSketchPath] = dataUrl;
    if (!formState.vectors) formState.vectors = {};
    formState.vectors[activeSketchPath] = JSON.parse(JSON.stringify(elements));
    
    // âœ… FORCE UPDATE UI IMMEDIATELY
    renderAllSavedImages();
    
    saveLocal();
    closeSketchModal();
    
    clearTimeout(autoSaveTimer);
    autoSaveTimer = setTimeout(() => saveToServer(), 1000);
}
/* ==========================================
   HELPER: CALCULATE 'FIT TO CONTENT' VIEW
   ========================================== */
function fitCameraToContent() {
    if (elements.length === 0) return { x: 0, y: 0, z: 1 };

    let minX = Infinity, minY = Infinity, maxX = -Infinity, maxY = -Infinity;

    // 1. Loop through all elements to find edges
    elements.forEach(el => {
        if (el.type === 'brush') {
            el.points.forEach(p => {
                minX = Math.min(minX, p.x); minY = Math.min(minY, p.y);
                maxX = Math.max(maxX, p.x); maxY = Math.max(maxY, p.y);
            });
        } 
        else if (['line', 'arrow'].includes(el.type)) {
            minX = Math.min(minX, el.x, el.endX); minY = Math.min(minY, el.y, el.endY);
            maxX = Math.max(maxX, el.x, el.endX); maxY = Math.max(maxY, el.y, el.endY);
        }
        else if (el.type === 'circle') {
            minX = Math.min(minX, el.x - el.r); minY = Math.min(minY, el.y - el.r);
            maxX = Math.max(maxX, el.x + el.r); maxY = Math.max(maxY, el.y + el.r);
        }
        else {
            // Rect, Triangle, Text
            const w = el.w || 0; const h = el.h || 0;
            minX = Math.min(minX, el.x); minY = Math.min(minY, el.y);
            maxX = Math.max(maxX, el.x + w); maxY = Math.max(maxY, el.y + h);
        }
    });

    // 2. Add padding so it looks nice (50px margin)
    const padding = 50; 
    const contentW = (maxX - minX) + (padding * 2);
    const contentH = (maxY - minY) + (padding * 2);

    // 3. Calculate Scale to fit
    const scaleX = canvas.width / contentW;
    const scaleY = canvas.height / contentH;
    let newZoom = Math.min(scaleX, scaleY);

    // Optional: Prevent zooming IN (only zoom out if drawing is huge)
    if (newZoom > 1) newZoom = 1; 

    // 4. Center the Camera
    const centerX = (minX + maxX) / 2;
    const centerY = (minY + maxY) / 2;
    
    const newX = (canvas.width / 2) - (centerX * newZoom);
    const newY = (canvas.height / 2) - (centerY * newZoom);

    return { x: newX, y: newY, z: newZoom };
}

function cleanPayload(obj) {
    // If null or not an object, return as is
    if (obj === null || typeof obj !== 'object') {
        return obj;
    }

    // Handle Arrays
    if (Array.isArray(obj)) {
        const cleanedArray = obj
            .map(item => cleanPayload(item))
            .filter(item => item !== "" && item !== null && item !== undefined);
        return cleanedArray.length > 0 ? cleanedArray : undefined;
    }

    // Handle Objects
    const cleanedObj = {};
    let hasData = false;

    for (const key in obj) {
        if (Object.prototype.hasOwnProperty.call(obj, key)) {
            const value = cleanPayload(obj[key]);

            // Keep value if it is not empty string, null, or undefined
            if (value !== "" && value !== null && value !== undefined) {
                // If it's an object (and not array), check if it has keys
                if (typeof value === 'object' && !Array.isArray(value) && Object.keys(value).length === 0) {
                    continue; 
                }
                cleanedObj[key] = value;
                hasData = true;
            }
        }
    }

    return hasData ? cleanedObj : undefined;
}
/* =========================
   9. DATA SYNC & SUBMISSION
========================= */
function updateNestedState(obj, path, value) {
    if (!path) return;
    const keys = path.split('.');
    let current = obj;
    for (let i = 0; i < keys.length - 1; i++) {
        if (!current[keys[i]]) current[keys[i]] = {};
        current = current[keys[i]];
    }
    current[keys[keys.length - 1]] = value;
}

function getNestedValue(obj, path) {
    if (!path) return undefined;
    return path.split('.').reduce((acc, part) => (acc && acc[part] !== undefined) ? acc[part] : undefined, obj);
}

function updateArrayState(obj, path, value, isChecked) {
    if (!path) return;
    const keys = path.split('.');
    let current = obj;
    for (let i = 0; i < keys.length - 1; i++) {
        if (!current[keys[i]]) current[keys[i]] = {};
        current = current[keys[i]];
    }
    const lastKey = keys[keys.length - 1];
    if (!Array.isArray(current[lastKey])) current[lastKey] = [];
    if (isChecked) { if (!current[lastKey].includes(value)) current[lastKey].push(value); } 
    else { current[lastKey] = current[lastKey].filter(v => v !== value); }
}

/* =========================
   9. DATA SYNC & SUBMISSION
========================= */
async function saveToServer(isLeaving = false) {
    if (!currentFolder) return; 

    // Optional: Visual Indicator for saving
    const btn = document.getElementById('triggerSubmitBtn');
    if(!isLeaving && btn) btn.innerHTML = '<i class="fas fa-sync fa-spin"></i> Saving...';

    try {
        const payload = JSON.parse(JSON.stringify(formState));
        // delete payload.vectors; // Optional optimization
        payload.target_folder = currentFolder;

        const response = await fetch('/coreapi/api/auto-save/', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrftoken },
            body: JSON.stringify({ 
                folder_path: currentFolder,
                payload: payload 
            })
        });
        
        const res = await response.json();
        if(res.success) {
            console.log("Saved at", res.last_saved);
            if(!isLeaving && btn) btn.innerText = 'Submit Feedback'; 
        }
    } catch(err) {
        console.error("Save error", err);
    }
}

/* =========================
   UI SYNC (UPDATED: Clears Sketches Too)
========================= */
function syncStateToUI() {
    // 1. Handle Text Inputs, Textareas, Selects, and RADIO BUTTONS
    document.querySelectorAll('[data-path]').forEach(el => {
        const val = getNestedValue(formState, el.getAttribute('data-path'));
        
        // Radio Buttons
        if (el.type === 'radio') {
            const savedValStr = (val !== undefined && val !== null) ? String(val).trim() : "";
            const inputValStr = String(el.value).trim();
            el.checked = (savedValStr === inputValStr);
        } 
        // Checkboxes (Boolean)
        else if (el.type === 'checkbox' && !el.hasAttribute('data-array')) {
             el.checked = (val === true || val === "true" || val === el.value);
        }
        // Standard Inputs
        else {
            el.value = (val !== undefined && val !== null) ? val : "";
        }
    });

    // 2. Handle Arrays (Multiple Select Checkboxes)
    document.querySelectorAll('[data-array]').forEach(el => {
        const arr = getNestedValue(formState, el.getAttribute('data-array'));
        if (Array.isArray(arr) && arr.includes(el.value)) {
            el.checked = true;
        } else {
            el.checked = false;
        }
    toggleEncroachmentFields();
    toggleOwnershipNotes();
    toggleRailwayDistance();
    });

    // âœ… 3. NEW: Clear Sketch Thumbnails
    // This finds ALL images with IDs starting with "img_preview_"
    document.querySelectorAll('img[id^="img_preview_"]').forEach(img => {
        // Construct the original data path from the ID (reverse safeId logic)
        // e.g., img_preview_Sketch_main_layout -> Sketch.main_layout
        const safeId = img.id.replace('img_preview_', '');
        // We can't easily reverse "_" to "." perfectly if keys have underscores, 
        // so we check the `formState.images` object directly using the ID or fuzzy match.

        let hasImage = false;
        
        // Check exact match in formState.images
        // We need to iterate the images dictionary because the key format differs slightly
        if (formState.images) {
             // Look for any key that turns into this safeId
             const match = Object.keys(formState.images).find(key => key.replace(/\./g, '_') === safeId);
             
             if (match && formState.images[match]) {
                 img.src = formState.images[match];
                 img.classList.remove('hidden');
                 img.style.display = 'block';
                 hasImage = true;
             }
        }

        // If no image found in state, HIDE IT
        if (!hasImage) {
            img.src = "";
            img.classList.add('hidden');
            img.style.display = 'none';
        }
    });
}
/* ==========================================
   UPDATED: INJECT ICONS (Conditional Upload)
   ========================================== */
function injectPencilIcons() {
    const textareas = document.querySelectorAll('textarea[data-path]');
    
    // Define which text fields are allowed to have Photo Uploads
    // You can add more paths to this array if needed later
    const uploadAllowList = [
        'Sketch.landmark_description' 
    ];

    textareas.forEach(textarea => {
        if (textarea.parentElement.classList.contains('input-wrapper')) return;
        
        const path = textarea.getAttribute('data-path');
        const safeId = path.replace(/\./g, '_');
        
        // 1. Create Wrapper
        const wrapper = document.createElement('div');
        wrapper.className = 'input-wrapper';
        textarea.parentNode.insertBefore(wrapper, textarea);
        wrapper.appendChild(textarea);
        
        // 2. Create Icon Group
        const group = document.createElement('div');
        group.className = 'icon-group';
        
        // --- BUTTON A: SKETCH (Always Added) ---
        const sketchBtn = document.createElement('div');
        sketchBtn.className = 'action-icon sketch-btn';
        sketchBtn.innerHTML = '<i class="fas fa-pencil-alt"></i>';
        sketchBtn.title = "Draw Sketch";
        sketchBtn.onclick = (e) => {
            e.stopPropagation();
            openSketchPad(path);
        };
        group.appendChild(sketchBtn);
        
        // --- BUTTON B: UPLOAD (Conditional) ---
        // Only add this button if the current path is in our allow list
        if (uploadAllowList.includes(path)) {
            const uploadBtn = document.createElement('div');
            uploadBtn.className = 'action-icon upload-btn';
            uploadBtn.innerHTML = '<i class="fas fa-camera"></i>';
            uploadBtn.title = "Upload Image";
            
            const fileInput = document.createElement('input');
            fileInput.type = 'file';
            fileInput.accept = 'image/*';
            fileInput.style.display = 'none';
            
            uploadBtn.onclick = (e) => {
                e.stopPropagation();
                fileInput.click();
            };
            
            fileInput.onchange = (e) => {
                if (e.target.files && e.target.files[0]) {
                    handleImageUpload(path, e.target.files[0]);
                }
            };

            group.appendChild(uploadBtn);
            wrapper.appendChild(fileInput);
        }

        wrapper.appendChild(group);

        // 3. Create Thumbnail Preview logic (Same as before)
        let img = document.getElementById(`img_preview_${safeId}`);
        if (!img) {
            img = document.createElement('img');
            img.id = `img_preview_${safeId}`; 
            img.className = 'sketch-thumb hidden';
            img.style.marginTop = '10px';
            img.style.maxHeight = '150px';
            img.style.borderRadius = '8px';
            img.style.border = '1px solid #e5e7eb';
            img.style.cursor = 'pointer';
            
            // Clicking preview always opens Sketch Pad (for viewing/editing)
            img.onclick = () => openSketchPad(path); 
            
            wrapper.parentNode.insertBefore(img, wrapper.nextSibling);
        }
    });
}
// --- HELPER: HANDLE IMAGE UPLOAD ---
function handleImageUpload(path, file) {
    const reader = new FileReader();
    
    reader.onload = (e) => {
        const base64String = e.target.result;
        
        // 1. Save to State
        if (!formState.images) formState.images = {};
        formState.images[path] = base64String;
        
        // 2. Update UI via Helper (Guarantees consistency)
        renderAllSavedImages();
        
        // 3. Trigger Auto-Save
        saveLocal();
        clearTimeout(autoSaveTimer);
        autoSaveTimer = setTimeout(() => {
            saveToServer();
        }, 1000); 
    };
    
    reader.readAsDataURL(file); 
}
function renderSurveyColumns() {
    const headerRow = document.getElementById('surveyHeader');
    const bodyRows = document.querySelectorAll('#surveyBody tr');
    if (!headerRow) return;

    // Clear existing dynamic columns
    headerRow.querySelectorAll('.dyn-col').forEach(el => el.remove());
    bodyRows.forEach(row => row.querySelectorAll('.dyn-cell').forEach(el => el.remove()));

    const availableDocs = formState.Valuers_Checklist.documents_received || [];
    const surveyDocs = formState.Survey.docs || [];

    const landTypes = [
        { id: 'dry',       label: 'Dry Land' },
        { id: 'wet',       label: 'Wet Land' },
        { id: 'sthirapunja',    label: 'Sthirapunja' },
        { id: 'asthirapunja',   label: 'Asthirapunja' },
        { id: 'thottam',   label: 'Thottam' },
        { id: 'others',    label: 'Others' }
    ];
    surveyDocs.forEach((docObj, index) => {
        // 1. Render Header (Dropdown to select Doc Name)
        const th = document.createElement('th');
        th.className = 'dyn-col';
        th.style.minWidth = "150px";
        let optionsHtml = `<option value="">Select Doc</option>`;
        availableDocs.forEach(d => {
            const sel = (d === docObj.name) ? "selected" : "";
            optionsHtml += `<option value="${d}" ${sel}>${d}</option>`;
        });
        th.innerHTML = `<select class="form-select" style="width: 100%; color:black;" onchange="updateSurveyDocName(${index}, this.value)">${optionsHtml}</select>`;
        headerRow.appendChild(th);

        // 2. Render Body Cells
        bodyRows.forEach(row => {
            const key = row.getAttribute('data-row-key');
            if(key) {
                const td = document.createElement('td');
                td.className = 'dyn-cell';
                const val = docObj[key] || '';

                // --- LOGIC CHANGE STARTS HERE ---
                let inputHtml = '';

                if (key === 'land_classification') {
                    // Start Grid
                    inputHtml = `<table>`;
                    
                    // Optional: Mini Headers inside the cell
                    inputHtml += `<tr><th style="z-index:auto;">Type</th><th>Area</th></tr>`;

                    // Loop through 6 types
                    landTypes.forEach(type => {
                        // Unique Keys: e.g., 'check_dry', 'area_dry'
                        const checkKey = `check_${type.id}`;
                        const areaKey = `area_${type.id}`;
                        
                        // Get Values
                        const isChecked = docObj[checkKey] ? 'checked' : '';
                        const areaVal = docObj[areaKey] || '';

                        // CSS Grid Row using 'display: contents' logic from CSS above
                        inputHtml += `<tr><td style="z-index:auto">
                                    <input type="checkbox" ${isChecked} 
                                        onchange="updateSurveyDocData(${index}, '${checkKey}', this.checked)">
                                    ${type.label}
                                </td><td>
                                    <input type="text" class="lc-area-input" 
                                        placeholder="Area" 
                                        value="${areaVal}" 
                                        oninput="updateSurveyDocData(${index}, '${areaKey}', this.value)">
                                </td>
                            </tr>
                        `;
                    });
                    
                    inputHtml += `</table>`; // End Grid
                }
                else if (key === 'land_extent') {
                     // Keep Text Input for Extent (as requested)
                     inputHtml = `<input type="text" class="table-input" value="${val}" oninput="updateSurveyDocData(${index}, '${key}', this.value)">`;
                } 
                else {
                     // Number Input for everything else (Survey No, Block No, etc.)
                     inputHtml = `<input type="text" class="table-input" value="${val}" oninput="updateSurveyDocData(${index}, '${key}', this.value)">`;
                }
                // --- LOGIC CHANGE ENDS HERE ---

                td.innerHTML = inputHtml;
                row.appendChild(td);
            }
        });
    });
    calculateSurveyTotals();
    checkWetLandStatus();
}

/* =========================
   HELPER: Update Survey Data & Trigger Save
========================= */
window.updateSurveyDocData = (index, key, value) => {
    // 1. Update the State Object
    if (!formState.Survey.docs[index]) formState.Survey.docs[index] = {};
    formState.Survey.docs[index][key] = value;
    if (key === 'land_extent') 
    calculateSurveyTotals();
    checkWetLandStatus();
    saveLocal();
    clearTimeout(autoSaveTimer);
    autoSaveTimer = setTimeout(() => {
        saveToServer();
    }, SAVE_DELAY_MS);
};
/* =========================
   MISSING FUNCTION: Fixes Document Name Dropdown
========================= */
window.updateSurveyDocName = (index, value) => {
    // 1. Update the 'name' property for this column
    if (!formState.Survey.docs[index]) formState.Survey.docs[index] = {};
    formState.Survey.docs[index].name = value;
    calculateSurveyTotals();
    checkWetLandStatus();

    // 2. Save immediately
    saveLocal();
    
    // 3. Trigger Auto-Save to Server
    clearTimeout(autoSaveTimer);
    autoSaveTimer = setTimeout(() => {
       saveToServer();
    }, SAVE_DELAY_MS);
};


function addSurveyColumn() {
    if (!formState.Survey.docs) formState.Survey.docs = [];
    formState.Survey.docs.push({ name: "", scedule_no: "" });
    renderSurveyColumns();
    saveLocal();
}

function updateAllDocumentDropdowns() {
    // Always read from the source of truth: formState
    const docs = formState.Valuers_Checklist.documents_received || [];
    
    document.querySelectorAll('.dynamic-doc-dropdown').forEach(select => {
        // 1. Capture the current value (in case user just typed it before save)
        // BUT prioritize formState if we are loading.
        const path = select.getAttribute('data-path');
        const savedValue = getNestedValue(formState, path); 
        
        // 2. Rebuild Options
        select.innerHTML = '<option value="">Select Document</option>';
        docs.forEach(docName => {
            const opt = document.createElement('option');
            opt.value = docName;
            opt.textContent = docName;
            select.appendChild(opt);
        });

        // 3. Restore Value
        // If we have a saved value in state, use it.
        if (savedValue && docs.includes(savedValue)) {
            select.value = savedValue;
        }
    });
}
// Global Event Listeners

// 2. Hybrid Input Listener
document.getElementById('siteFeedbackForm').addEventListener('input', (e) => {
    const target = e.target;
    const path = target.getAttribute('data-path');
    const arrayPath = target.getAttribute('data-array');
    
    // A. Update State
    if (path) {
        updateNestedState(formState, path, target.value);
    } else if (arrayPath) {
        updateArrayState(formState, arrayPath, target.value, target.checked);
        
        // âœ… FIX: Update Dropdowns immediately when Documents Received changes
        if (arrayPath === 'Valuers_Checklist.documents_received') {
            updateAllDocumentDropdowns(); // Refreshes the dropdown options
            renderSurveyColumns();        // Refreshes the survey table headers
        }
    }

    // B. Save to Local Storage (Instant)
    saveLocal();

    // C. Debounce Save to Server (10 Seconds)
    clearTimeout(autoSaveTimer);
    autoSaveTimer = setTimeout(() => {
        saveToServer();
    }, SAVE_DELAY_MS);
});

let pendingAction = null;
const confirmModal = document.getElementById('confirmationModal');
const confirmTitle = document.getElementById('confirmTitle');
const confirmMessage = document.getElementById('confirmMessage');

function showConfirm(title, message, actionCallback) {
    confirmTitle.textContent = title;
    confirmMessage.textContent = message;
    pendingAction = actionCallback;
    confirmModal.classList.remove('hidden');
}

document.getElementById('confirmNoBtn').onclick = () => {
    confirmModal.classList.add('hidden');
    pendingAction = null;
};

document.getElementById('confirmYesBtn').onclick = () => {
    if (pendingAction) pendingAction();
    confirmModal.classList.add('hidden');
};

// 1. TRIGGER SUBMIT
document.getElementById('triggerSubmitBtn').onclick = (e) => {
    e.preventDefault();
    showConfirm(
        "Submit Report?", 
        "Are you sure you want to submit this feedback? This cannot be undone.", 
        performSubmit
    );
};

// 2. TRIGGER RESET
document.getElementById('triggerResetBtn').onclick = (e) => {
    e.preventDefault();
    showConfirm(
        "Clear All Data?", 
        "This will delete all your text, checkboxes, and sketches. Are you sure?", 
        performReset
    );
};

async function performSubmit() {
    // 1. If Sketch Pad is open, save it first
    if (!document.getElementById('sketchModal').classList.contains('hidden')) {
        saveSketchModal();
    }

    try {
        const btn = document.getElementById('triggerSubmitBtn');
        const originalText = btn.textContent;
        btn.textContent = "Submitting...";
        btn.disabled = true;

        // 2. Prepare Payload
        let payload = JSON.parse(JSON.stringify(formState));
        
        // Ensure ID and Folder are attached
        payload.report_id = formState.report_id; 
        payload.target_folder = currentFolder; 

        // Cleanup
        if(payload.vectors) delete payload.vectors;
        payload = cleanPayload(payload);
        if (!payload) payload = {};

        // 3. Send Request
        const response = await fetch('/coreapi/api/save-feedback/', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrftoken },
            body: JSON.stringify({ payload })
        });

        // 4. Check for HTTP Errors (e.g. 500 Internal Server Error)
        if (!response.ok) {
            throw new Error(`Server Error: ${response.status} ${response.statusText}`);
        }

        // 5. Safely Parse JSON
        // We get text first to debug if it's not JSON
        const textResponse = await response.text(); 
        let res;
        try {
            res = JSON.parse(textResponse);
        } catch (jsonErr) {
            console.error("Server returned non-JSON response:", textResponse);
            throw new Error("Invalid server response. Data might be saved, but response was bad.");
        }
        
        // 6. Handle Success/Fail Logic
        if(res.success) {
            // Update ID locally
            formState.report_id = res.report_id;
            saveLocal(); 

            // Redirect
            window.location.href = res.redirect_url;
        } else {
            btn.textContent = originalText;
            btn.disabled = false;
            alert("Server reported error: " + res.error);
        }

    } catch (err) {
        console.error("Submit Failed:", err);
        // Reset button
        const btn = document.getElementById('triggerSubmitBtn');
        if(btn) {
            btn.textContent = "Submit Feedback";
            btn.disabled = false;
        }
        
        // Detailed Alert
        alert("Submission Issue: " + err.message + "\n(Check Console for details)");
    }
}
function saveLocal() {
    try {
        // 1. Try to save EVERYTHING (Images + Text)
        localStorage.setItem(STORAGE_KEY, JSON.stringify(formState));
    } catch (e) {
        // 2. Only if Storage is Full, strip images to save at least the text
        console.warn("Local Storage full. Stripping images...", e);
        try {
            const stateToSave = JSON.parse(JSON.stringify(formState));
            if (stateToSave.images) delete stateToSave.images;
            if (stateToSave.vectors) delete stateToSave.vectors;
            localStorage.setItem(STORAGE_KEY, JSON.stringify(stateToSave));
        } catch (e2) {
            console.error("Critical: Could not save text backup.", e2);
        }
    }
}
async function performReset() {
    // 1. Reset the State Object to Blank Defaults
    formState = getEmptyState(); 

    // 2. Clear Local Storage (But keep folder location!)
    localStorage.removeItem(STORAGE_KEY);

    // 3. Update the UI Immediately (No Reload needed)
    syncStateToUI();              // Clears text boxes, radios, checkboxes
    initBuildingTable();          // Resets building table to default rows
    renderSurveyColumns();        // Resets survey table columns
    updateAllDocumentDropdowns(); // Resets dropdowns
    
    // Clear Timeline
    document.getElementById('finalConstructionString').value = "";
    parseTimelineString(""); 

    // Clear Sketch/Photo Previews
    document.querySelectorAll('img[id^="img_preview_"]').forEach(img => {
        img.src = "";
        img.classList.add('hidden');
        img.style.display = 'none';
    });
    // Show placeholders if any
    document.querySelectorAll('[id^="placeholder_"]').forEach(ph => {
        ph.classList.remove('hidden');
    });

    // 4. Force Save to Server
    // We send the 'formState' which is now full of empty strings.
    // This overwrites the database logic, ensuring the "Auto-Fill" doesn't triggers again.
    const btn = document.getElementById('triggerResetBtn');
    const originalText = btn.innerText;
    btn.innerText = "Clearing...";
    
    await saveToServer(); 
    
    btn.innerText = originalText;
    // No alert needed, the UI update is feedback enough
}

function copyAllDocsToSites(checkbox) {
    const directions = ['north', 'east', 'south', 'west'];
    const prefix = "Boundary_analysis_property_identification";

    if (checkbox.checked) {
        // --- CHECKED STATE: COPY VALUES ---
        directions.forEach(direction => {
            const doc1Input = document.querySelector(`input[data-path="${prefix}.${direction}_doc1"]`);
            const doc2Input = document.querySelector(`input[data-path="${prefix}.${direction}_doc2"]`);
            const siteInput = document.querySelector(`input[data-path="${prefix}.${direction}_site"]`);

            if (siteInput) {
                const v1 = doc1Input ? doc1Input.value.trim() : "";
                const v2 = doc2Input ? doc2Input.value.trim() : "";
                
                let combinedValue = "";
                if (v1 && v2) {
                    combinedValue = `${v1}, ${v2}`;
                } else {
                    combinedValue = v1 || v2;
                }

                siteInput.value = combinedValue;
                
                // Trigger Auto-Save
                siteInput.dispatchEvent(new Event('input', { bubbles: true }));
            }
        });
    } else {
        // --- UNCHECKED STATE: CLEAR VALUES ---
        directions.forEach(direction => {
            const siteInput = document.querySelector(`input[data-path="${prefix}.${direction}_site"]`);

            if (siteInput) {
                // Clear the value
                siteInput.value = "";
                
                // Trigger Auto-Save (so the empty state is saved)
                siteInput.dispatchEvent(new Event('input', { bubbles: true }));
            }
        });
    }
}

// --- 1. CORE: Recalculate State ---
function handlePercentInput(e) {
    const currentInput = e.target;
    let currentVal = parseFloat(currentInput.value);

    // STEP 1: If input is invalid/empty, just cleanup and STOP.
    // Do not try to auto-fill the next column yet.
    if (isNaN(currentVal) || currentVal <= 0) {
        // If this is the LAST column, just do nothing (let user type)
        // If this is NOT the last column, deleting it is tricky because focus might get lost.
        // Better approach: Just don't trigger the "add next column" logic.
        
        // However, we MUST clean up any columns *after* this one, 
        // because if I change 50 to 0, the next column (50) is now invalid logic.
        const allInputs = Array.from(document.querySelectorAll('.timeline-percent'));
        const currentIndex = allInputs.indexOf(currentInput);
        
        // Remove everything to the right immediately
        for (let i = allInputs.length - 1; i > currentIndex; i--) {
            removeColumnAtIndex(i);
        }
        
        updateTimelineString();
        return; 
    }

    // STEP 2: Logic for Valid Inputs
    // Get fresh list of inputs after potential cleanups
    const allInputs = Array.from(document.querySelectorAll('.timeline-percent'));
    const currentIndex = allInputs.indexOf(currentInput);

    // Calculate sum UP TO this column
    let sumSoFar = 0;
    for(let i=0; i<currentIndex; i++) {
        sumSoFar += parseFloat(allInputs[i].value) || 0;
    }

    // Cap at 100% logic
    if (sumSoFar + currentVal > 100) {
        currentVal = 100 - sumSoFar;
        currentInput.value = currentVal;
    }
    
    sumSoFar += currentVal;
    const remainder = 100 - sumSoFar;

    // STEP 3: Handle the Remainder
    // A. If 100% reached, delete everything to the right
    if (remainder <= 0) {
        for (let i = allInputs.length - 1; i > currentIndex; i--) {
            removeColumnAtIndex(i);
        }
    } 
    // B. If there is remainder, FORCE the next column to match it
    else {
        // Is there already a next column?
        if (currentIndex + 1 < allInputs.length) {
            const nextInput = allInputs[currentIndex + 1];
            // Only update it if it's different (prevents cursor jumping issues sometimes)
            if (parseFloat(nextInput.value) !== remainder) {
                nextInput.value = remainder;
            }
            // Ensure nothing exists after that neighbor
            for (let i = allInputs.length - 1; i > currentIndex + 1; i--) {
                removeColumnAtIndex(i);
            }
        } 
        // No next column? Create it (Max 5 limit)
        else if (allInputs.length < 5) {
            createColumnAtIndex(currentIndex + 1, remainder);
        }
    }

    updateTimelineString();
}

function createColumnAtIndex(index, percentVal = "", yearVal = "") {
    const rowPercent = document.getElementById('row_percent');
    const rowYear = document.getElementById('row_year');
    const controlCell = document.getElementById('controlCell');

    // 1. Create Year Input (Now on Top)
    const tdY = document.createElement('td');
    const inpY = document.createElement('input');
    inpY.type = "number";
    inpY.className = "table-input timeline-year";
    inpY.placeholder = "Year";
    inpY.value = yearVal;
    inpY.addEventListener('input', updateTimelineString);
    tdY.appendChild(inpY);

    // 2. Create Percent Input (Now on Bottom)
    const tdP = document.createElement('td');
    const inpP = document.createElement('input');
    inpP.type = "number";
    inpP.className = "table-input timeline-percent";
    inpP.placeholder = "%";
    inpP.value = percentVal;
    inpP.addEventListener('input', handlePercentInput);
    tdP.appendChild(inpP);

    // INSERTION LOGIC CHANGED:
    // Year row has the control button, so insert BEFORE it
    rowYear.insertBefore(tdY, controlCell);
    
    // Percent row has no control button anymore, so just APPEND
    rowPercent.appendChild(tdP);
}

// --- 3. DOM Helper: Remove Column ---
function removeColumnAtIndex(index) {
    const rowPercent = document.getElementById('row_percent');
    const rowYear = document.getElementById('row_year');
    
    // rowYear children: [Label, Input, Input, Buttons]
    // rowPercent children: [Label, Input, Input]

    // Actual index in DOM is index + 1 (skipping the Label <td>)
    const domIndex = index + 1;

    // Remove Year Cell
    // Check if the element exists and is NOT the control cell (buttons)
    if (rowYear.children[domIndex] && !rowYear.children[domIndex].hasAttribute('rowspan')) {
        rowYear.children[domIndex].remove();
    }

    // Remove Percent Cell
    if (rowPercent.children[domIndex]) {
        rowPercent.children[domIndex].remove();
    }
}
// --- 4. Manual Buttons ---
function manualAddColumn() {
    const allPercents = Array.from(document.querySelectorAll('.timeline-percent'));
    if (allPercents.length >= 5) { alert("Max 5 columns."); return; }

    let sum = 0;
    allPercents.forEach(p => sum += parseFloat(p.value) || 0);
    if (sum >= 100) { alert("Total is already 100%. Adjust previous values."); return; }

    createColumnAtIndex(allPercents.length, "");
}

function removeLastColumn() {
    const allPercents = document.querySelectorAll('.timeline-percent');
    if (allPercents.length <= 1) return; // Keep at least 1
    removeColumnAtIndex(allPercents.length - 1);
    updateTimelineString();
}

// --- 5. Save & Parse ---
function updateTimelineString() {
    const percents = document.querySelectorAll('.timeline-percent');
    const years = document.querySelectorAll('.timeline-year');
    
    let parts = [];
    percents.forEach((p, index) => {
        const pVal = p.value;
        const yVal = years[index] ? years[index].value : "";
        // Only save if there is data, but respect 0
        if (pVal !== "" || yVal !== "") {
            parts.push(`${yVal} (${pVal}%)`);
        }
    });

    const finalString = parts.join(", ");
    const hiddenInput = document.getElementById('finalConstructionString');
    if(hiddenInput) {
        hiddenInput.value = finalString;
        hiddenInput.dispatchEvent(new Event('input', { bubbles: true }));
    }
}

function parseTimelineString(str) {
    const rowPercent = document.getElementById('row_percent');
    const rowYear = document.getElementById('row_year');
    
    // CLEANUP LOGIC CHANGED due to row swap:
    
    // Year Row (Top): Label is index 0. Button is lastChild.
    // Keep removing children between Label and Button
    while (rowYear.children.length > 2) { 
        rowYear.removeChild(rowYear.children[1]); 
    }
    
    // Percent Row (Bottom): Label is index 0. No buttons here anymore.
    // Keep removing everything after label
    while (rowPercent.children.length > 1) { 
        rowPercent.removeChild(rowPercent.children[1]); 
    }

    if(!str) { createColumnAtIndex(0, ""); return; }

    const parts = str.split(', ');
    parts.forEach((part, idx) => {
        const match = part.match(/(\d+)\s*\((\d+)%\)/);
        if(match) {
            createColumnAtIndex(idx, match[2], match[1]); // Percent, Year
        } else {
            createColumnAtIndex(idx, "", "");
        }
    });
}

function toggleSketchSidebar() {
    const sidebar = document.getElementById('sketchSidebar');
    const icon = document.getElementById('toggleIcon');
    
    // Toggle the class
    sidebar.classList.toggle('collapsed');
    
    // Change Arrow Direction & Tool Selection
    if (sidebar.classList.contains('collapsed')) {
        icon.className = "fas fa-chevron-right"; // Arrow points right to open
        
        // Ensure one of the visible tools is active (Pencil default)
        if (currentTool !== 'brush' && currentTool !== 'eraser') {
            setTool('brush');
        }
    } else {
        icon.className = "fas fa-chevron-left"; // Arrow points left to close
    }
    
    // IMPORTANT: Wait for CSS transition (300ms) then resize canvas
    setTimeout(resizeCanvas, 310);
}


/* ==========================================
   SERVER-SIDE INFINITE SCROLL PDF VIEWER
   ========================================== */

// State
let viewerState = {
    path: null,
    nextPageToLoad: 0,
    zoom: 1.0,
    isLoading: false,
    isFinished: false // True when we hit the last page
};

// Elements
const scrollContainer = document.getElementById("scrollContainer");
const scrollSentinel = document.getElementById("scrollSentinel"); // The loading spinner at bottom
const pdfToolbar = document.getElementById("pdfToolbar");
const pageCountDisplay = document.getElementById("pageCountDisplay");
const zoomLevelDisplay = document.getElementById("zoomLevelDisplay");

const imgContainer = document.getElementById("bigImageContainer");
const imgEl = document.getElementById("bigImageFrame");

let imgState = { scale: 1, panning: false, pointX: 0, pointY: 0, startX: 0, startY: 0 };

function resetImageZoom() {
    imgState = { scale: 1, panning: false, pointX: 0, pointY: 0, startX: 0, startY: 0 };
    if(imgEl) {
        imgEl.style.transform = `translate(0px, 0px) scale(1)`;
        if(imgContainer) imgContainer.style.cursor = 'grab';
    }
}

function updateImageTransform() {
    if(imgEl) {
        imgEl.style.transform = `translate(${imgState.pointX}px, ${imgState.pointY}px) scale(${imgState.scale})`;
    }
}

function initGalleryGestures() {
    if(!imgContainer || !imgEl) return;

    // 1. DOUBLE CLICK (MOUSE)
    imgContainer.addEventListener('dblclick', (e) => {
        e.preventDefault();
        if (imgState.scale === 1) {
            imgState.scale = 3;
        } else {
            imgState.scale = 1;
            imgState.pointX = 0; imgState.pointY = 0;
        }
        updateImageTransform();
    });

    // 2. TOUCH GESTURES
    let lastTap = 0;
    let startDist = 0;
    let startScale = 1;

    imgContainer.addEventListener('touchstart', (e) => {
        const currentTime = new Date().getTime();
        const tapLength = currentTime - lastTap;
        
        // Double Tap
        if (tapLength < 300 && tapLength > 0 && e.touches.length === 1) {
            e.preventDefault();
            if (imgState.scale === 1) {
                imgState.scale = 3;
            } else {
                imgState.scale = 1;
                imgState.pointX = 0; imgState.pointY = 0;
            }
            updateImageTransform();
            lastTap = 0;
            return;
        }
        lastTap = currentTime;

        // Pinch Start
        if (e.touches.length === 2) {
            e.preventDefault();
            startDist = Math.hypot(
                e.touches[0].clientX - e.touches[1].clientX,
                e.touches[0].clientY - e.touches[1].clientY
            );
            startScale = imgState.scale;
        } 
        // Pan Start
        else if (e.touches.length === 1 && imgState.scale > 1) {
            imgState.startX = e.touches[0].clientX - imgState.pointX;
            imgState.startY = e.touches[0].clientY - imgState.pointY;
            imgState.panning = true;
        }
    }, { passive: false });

    imgContainer.addEventListener('touchmove', (e) => {
        e.preventDefault();
        imgEl.style.transition = 'none'; // Instant follow

        // Pinch Move
        if (e.touches.length === 2) {
            const dist = Math.hypot(
                e.touches[0].clientX - e.touches[1].clientX,
                e.touches[0].clientY - e.touches[1].clientY
            );
            if (startDist > 0) {
                const newScale = startScale * (dist / startDist);
                imgState.scale = Math.min(Math.max(1, newScale), 5);
                updateImageTransform();
            }
        } 
        // Pan Move
        else if (e.touches.length === 1 && imgState.panning) {
            imgState.pointX = e.touches[0].clientX - imgState.startX;
            imgState.pointY = e.touches[0].clientY - imgState.startY;
            updateImageTransform();
        }
    }, { passive: false });

    imgContainer.addEventListener('touchend', () => {
        imgState.panning = false;
        imgEl.style.transition = 'transform 0.1s ease-out';
        if (imgState.scale < 1) { imgState.scale = 1; updateImageTransform(); }
    });

    // 3. MOUSE WHEEL & DRAG
    imgContainer.addEventListener('wheel', (e) => {
        e.preventDefault();
        const delta = -Math.sign(e.deltaY) * 0.2;
        imgState.scale = Math.min(Math.max(1, imgState.scale + delta), 5);
        updateImageTransform();
    }, { passive: false });

    imgContainer.addEventListener('mousedown', (e) => {
        if(imgState.scale > 1) {
            e.preventDefault();
            imgState.startX = e.clientX - imgState.pointX;
            imgState.startY = e.clientY - imgState.pointY;
            imgState.panning = true;
            imgContainer.style.cursor = 'grabbing';
        }
    });

    window.addEventListener('mousemove', (e) => {
        if (!imgState.panning) return;
        e.preventDefault();
        imgEl.style.transition = 'none';
        imgState.pointX = e.clientX - imgState.startX;
        imgState.pointY = e.clientY - imgState.startY;
        updateImageTransform();
    });

    window.addEventListener('mouseup', () => {
        imgState.panning = false;
        if(imgEl) imgEl.style.transition = 'transform 0.1s ease-out';
        if(imgContainer) imgContainer.style.cursor = (imgState.scale > 1) ? 'grab' : 'default';
    });
}
// Initialize immediately
initGalleryGestures();
/* =========================
   LOAD PREVIEW (Unified)
========================= */
function loadBigPreview(file) {
    currentFile = file;

    // 1. Construct Path logic
    let fullPath = file.file;
    if (!fullPath) {
        // Fallback if path is missing
        const folderPrefix = currentFolder ? currentFolder.replace(/\/$/, "") + "/" : "";
        fullPath = folderPrefix + file.name;
    }

    const banner = document.getElementById("bigPreviewTitle");
    if(banner) banner.textContent = fullPath;

    // 2. Reset UI
    document.getElementById("scrollContainer").classList.add("hidden");
    document.getElementById("pdfToolbar").classList.add("hidden");
    document.getElementById("noSelection").classList.add("hidden");
    document.getElementById("downloadPdfBtn").classList.remove("hidden");
    
    const bigImgContainer = document.getElementById("bigImageContainer");
    const bigImg = document.getElementById("bigImageFrame");
    if(bigImgContainer) bigImgContainer.classList.add("hidden");

    // Clear PDF
    const scrollContainer = document.getElementById("scrollContainer");
    if(scrollContainer) {
        const existingImages = scrollContainer.querySelectorAll('img.pdf-page-img');
        existingImages.forEach(img => img.remove());
    }

    const url = `/coreapi/serve-file/?path=${encodeURIComponent(fullPath)}`;
    const ext = file.name.split(".").pop().toLowerCase();
    currentPreviewUrl = url;

    // 3. IMAGE LOGIC
    if (["jpg","jpeg","png","gif","bmp","webp"].includes(ext)) {
        if(bigImg && bigImgContainer) {
            bigImg.src = url;
            bigImgContainer.classList.remove("hidden");
            resetImageZoom(); 
        }
    } 
    // 4. PDF LOGIC
    else if (ext === "pdf") {
        document.getElementById("scrollContainer").classList.remove("hidden");
        document.getElementById("pdfToolbar").classList.remove("hidden");
        const sentinel = document.getElementById("scrollSentinel");
        if(sentinel) sentinel.classList.remove("hidden");
        
        if(typeof viewerState !== 'undefined') {
            viewerState.path = fullPath;
            viewerState.nextPageToLoad = 0;
            viewerState.isLoading = false;
            viewerState.isFinished = false;
            viewerState.zoom = 1.0;
        }
        
        if(typeof loadNextPage === 'function') loadNextPage();
        if(typeof observer !== 'undefined' && sentinel) observer.observe(sentinel);
    } 
    // 5. UNSUPPORTED
    else {
        document.getElementById("noSelection").classList.remove("hidden");
        document.getElementById("noSelection").textContent = "Preview not available";
        document.getElementById("downloadPdfBtn").classList.add("hidden");
    }
}
// --- 2. LOAD NEXT PAGE LOGIC ---
function loadNextPage() {
    if (viewerState.isLoading || viewerState.isFinished) return;
    
    viewerState.isLoading = true;

    // specific page index to load
    const pageIndex = viewerState.nextPageToLoad;
    
    // Create the image element placeholder
    const img = createPageImage(pageIndex);
    
    // Construct Backend URL
    // Note: We use the 'render-page' view we created earlier
    const url = `/coreapi/render-page/?path=${encodeURIComponent(viewerState.path)}&page=${pageIndex}&zoom=${viewerState.zoom}`;

    img.onload = () => {
        viewerState.isLoading = false;
        viewerState.nextPageToLoad++; // Prepare for next page
        
        // Update "Page X" display based on what is currently loaded
        pageCountDisplay.textContent = `Pages loaded: ${viewerState.nextPageToLoad}`;
        
        // If the Sentinel is still visible (big screen, small PDF), load another one immediately
        // This prevents getting stuck with only 1 page on a large monitor
        if (isSentinelVisible()) {
            loadNextPage();
        }
    };

    img.onerror = () => {
        // ERROR usually means 404 Not Found -> End of Document
        console.log("End of document reached or error.");
        viewerState.isFinished = true;
        viewerState.isLoading = false;
        img.remove(); // Remove the broken image
        scrollSentinel.classList.add("hidden"); // Hide the spinner
        observer.unobserve(scrollSentinel); // Stop watching
    };

    img.src = url;
    
    // Insert before the spinner
    scrollContainer.insertBefore(img, scrollSentinel);
}

// --- 3. HELPER: CREATE IMAGE ELEMENT ---
function createPageImage(index, isSingle = false) {
    const img = document.createElement("img");
    img.className = "pdf-page-img shadow-lg bg-white mb-4 transition-transform duration-200";
    img.alt = `Page ${index + 1}`;
    img.dataset.page = index;
    
    // Styles for nice paper look
    img.style.minHeight = isSingle ? "auto" : "800px"; // Placeholder height prevents jumpiness
    img.style.minWidth = "600px";
    img.style.maxWidth = "100%";
    
    if (isSingle) img.style.minHeight = "auto";

    return img;
}

// --- 4. INTERSECTION OBSERVER (Auto-Scroll) ---
// This watches the "spinner" at the bottom. When it appears on screen, it triggers loadNextPage()
const observer = new IntersectionObserver((entries) => {
    if (entries[0].isIntersecting) {
        loadNextPage();
    }
}, { root: scrollContainer, threshold: 0.1 });

function isSentinelVisible() {
    const rect = scrollSentinel.getBoundingClientRect();
    const containerRect = scrollContainer.getBoundingClientRect();
    return (rect.top <= containerRect.bottom);
}

// --- 5. ZOOM CONTROLS ---
// Since we have many images, we update CSS transform for all of them
function updateZoom() {
    const images = document.querySelectorAll('.pdf-page-img');
    images.forEach(img => {
        // We use CSS width % to handle zoom cleanly in a flex column
        // Base is 100% (fit width). 
        // Note: Real PDF viewers re-render at higher resolution on zoom. 
        // For simple CSS zoom:
        img.style.width = `${100 * viewerState.zoom}%`;
        img.style.maxWidth = "none"; // Allow it to overflow container if zoomed in
    });
    
    // Also re-render future pages at higher quality? 
    // For now, let's stick to CSS scaling for instant feedback.
    // If you want higher quality, we'd need to clear list and re-fetch with &zoom=X parameter.
    
    zoomLevelDisplay.textContent = `${Math.round(viewerState.zoom * 100)}%`;
}



/* ==========================================
   FULLSCREEN MODAL LOGIC (FINAL FIX)
   ========================================== */

// 1. Elements
const fullscreenModal = document.getElementById("fullscreenModal");
const modalTitle = document.getElementById("modalTitle");

// Containers
const modalFrame = document.getElementById("modalFrame");
const imageZoomWrapper = document.getElementById("imageZoomWrapper"); 
const modalPdfContainer = document.getElementById("modalPdfContainer");
const modalImage = document.getElementById("modalImage");
const modalZoomDisplay = document.getElementById("modalZoomLevel"); 

// State
let currentModalZoom = 1.0; 
let modalState = {
    path: null,
    nextPage: 0,
    isLoading: false,
    isFinished: false,
    observer: null,
    mode: 'none'
};

/* --- 1. OPEN MODAL --- */
document.getElementById("openFullBtn").onclick = () => {
    if (!currentFile) return alert("Select a file first");

    // 1. Show Modal (Requires the HTML fix mentioned below)
    const modal = document.getElementById("fullscreenModal");
    modal.classList.remove("hidden");
    modal.classList.add("flex");
    modal.setAttribute("aria-hidden", "false");
    
    const title = document.getElementById("modalTitle");
    if(title) title.textContent = currentFile.name;

    // 2. Get Elements safely
    const frame = document.getElementById("modalFrame");
    const zoomWrapper = document.getElementById("imageZoomWrapper");
    const pdfContainer = document.getElementById("modalPdfContainer");
    const imgObj = document.getElementById("modalImage");

    // 3. Reset Layers (Hide everything first)
    [frame, zoomWrapper, pdfContainer, imgObj].forEach(el => {
        if(el) {
            el.classList.add("hidden");
            el.classList.remove("flex"); 
            el.style.display = "none";   
        }
    });
    
    // Clear PDF container if it exists
    if(pdfContainer) pdfContainer.innerHTML = "";

    // 4. Set State
    modalState.path = currentFile.path;
    const ext = currentFile.name.split(".").pop().toLowerCase();

    // CASE A: PDF
    if (ext === 'pdf') {
        modalState.mode = 'pdf';
        if(pdfContainer) {
            pdfContainer.classList.remove("hidden");
            pdfContainer.classList.add("flex");
            pdfContainer.style.display = "flex";
            if (typeof initPdfModal === "function") initPdfModal(); // Safety check
        }
    } 
    // CASE B: IMAGE
    else if (["jpg","jpeg","png","gif","bmp","webp"].includes(ext)) {
        modalState.mode = 'image';
        
        // If wrapper exists, use it. If not, try to show image directly.
        const container = zoomWrapper || modal; 
        
        if(container && imgObj) {
            if(zoomWrapper) {
                zoomWrapper.classList.remove("hidden");
                zoomWrapper.classList.add("flex");
                zoomWrapper.style.display = "flex";
            }
            
            imgObj.classList.remove("hidden");
            imgObj.style.display = "block";
            
            // Add timestamp to force refresh
            imgObj.src = `/coreapi/serve-file/?path=${encodeURIComponent(currentFile.path)}&t=${new Date().getTime()}`;
            
            // Reset Styles
            imgObj.style.transform = "scale(1)";
            imgObj.style.maxWidth = "100%";
            imgObj.style.maxHeight = "100%";
            imgObj.style.margin = "0";
        }
    }
    // CASE C: OTHER
    else {
        if(pdfContainer) {
            pdfContainer.classList.remove("hidden");
            pdfContainer.classList.add("flex");
            pdfContainer.style.display = "flex";
            pdfContainer.innerHTML = `<div class="text-gray-500 m-auto">Preview not available</div>`;
        }
    }
};
/* --- 2. CLOSE MODAL --- */
document.getElementById("modalClose").onclick = () => {
    fullscreenModal.classList.add("hidden");
    fullscreenModal.classList.remove("flex");
    fullscreenModal.setAttribute("aria-hidden", "true");
    
    if(modalImage) modalImage.src = "";
    if(modalPdfContainer) modalPdfContainer.innerHTML = "";
    if (modalState.observer) modalState.observer.disconnect();
};

/* --- 3. ZOOM LOGIC (Full Width Fix) --- */
function updateZoomDisplay() {
    if(modalZoomDisplay) modalZoomDisplay.textContent = Math.round(currentModalZoom * 100) + "%";
}
function applyModalZoom() {
    if(typeof updateZoomDisplay === "function") updateZoomDisplay();

    if (modalState.mode === 'image' && modalImage) {
        if (currentModalZoom > 1.0) {
            modalImage.style.maxWidth = "none";
            modalImage.style.maxHeight = "none";
            modalImage.style.transform = `scale(${currentModalZoom})`;
            modalImage.style.margin = "100px"; 
        } else {
            modalImage.style.maxWidth = "100%";
            modalImage.style.maxHeight = "100%";
            modalImage.style.transform = "scale(1)";
            modalImage.style.margin = "0";
        }
    } 
    else if (modalState.mode === 'pdf' && modalPdfContainer) {
        // Enforce 100% width based on zoom
        const widthPercent = Math.round(currentModalZoom * 100); 
        const pages = modalPdfContainer.querySelectorAll("img");
        pages.forEach(p => {
            p.style.width = `${widthPercent}%`;
            p.style.maxWidth = "none";
            
            // Recalculate height on zoom to prevent distortion/gaps
            const currentW = p.getBoundingClientRect().width;
            p.style.minHeight = `${currentW * 1.414}px`;
        });
    }
}


/* --- 4. PDF SCROLL LOGIC (Robust) --- */
function initPdfModal() {
    modalState.nextPage = 0;
    modalState.isLoading = false;
    modalState.isFinished = false;

    // Sentinel (Spinner)
    const sentinel = document.createElement("div");
    sentinel.className = "w-full h-24 flex items-center justify-center py-4";
    sentinel.style.flexShrink = "0"; // CRITICAL: Stop shrinking height
    sentinel.innerHTML = '<div class="spinner border-4 border-gray-300 border-t-blue-500 rounded-full w-8 h-8 animate-spin"></div>';
    
    if(modalPdfContainer) modalPdfContainer.appendChild(sentinel);

    if (modalState.observer) modalState.observer.disconnect();
    
    if(modalPdfContainer) {
        modalState.observer = new IntersectionObserver((entries) => {
            if (entries[0].isIntersecting) loadNextModalPage(sentinel);
        }, { root: modalPdfContainer, threshold: 0.1 });
        
        modalState.observer.observe(sentinel);
        
        // Initial Trigger
        loadNextModalPage(sentinel);
    }
}

function loadNextModalPage(sentinel) {
    if (modalState.isLoading || modalState.isFinished) return;
    modalState.isLoading = true;

    const img = document.createElement("img");
    
    // 1. Setup Sizing
    const containerWidth = modalPdfContainer.clientWidth || window.innerWidth;
    const widthPercent = Math.round(currentModalZoom * 100);
    const estimatedHeight = (containerWidth * (widthPercent/100)) * 1.414;

    img.style.width = `${widthPercent}%`;
    img.style.maxWidth = "none";
    img.style.marginBottom = "20px";
    img.style.boxShadow = "0 4px 10px rgba(0,0,0,0.2)";
    img.style.backgroundColor = "white";
    img.style.flexShrink = "0"; 
    img.style.minHeight = `${estimatedHeight}px`; 

    // 2. Request Page
    img.src = `/coreapi/render-page/?path=${encodeURIComponent(modalState.path)}&page=${modalState.nextPage}&zoom=2.0`;

    // 3. Success Handler
    img.onload = () => {
        modalState.isLoading = false;
        modalState.nextPage++;
        
        // Auto-load next if screen isn't full
        if(sentinel.parentElement && sentinel.getBoundingClientRect().top < window.innerHeight) {
             loadNextModalPage(sentinel);
        }
    };
    
    // 4. Error/End of PDF Handler (THE FIX)
    img.onerror = () => {
        // console.log("End of document reached.");
        modalState.isFinished = true;
        modalState.isLoading = false;
        
        // REMOVE THE BROKEN IMAGE IMMEDIATELY
        img.remove(); 
        
        // Stop the loading spinner
        if(sentinel.parentElement) sentinel.remove();
        if(modalState.observer) modalState.observer.disconnect();
    };

    if(modalPdfContainer) modalPdfContainer.insertBefore(img, sentinel);
}
/* ==========================================
   UPDATED: DOWNLOAD BUTTONS
   ========================================== */

// 1. Dashboard Download Button (Small icon in header)
document.getElementById("downloadPdfBtn").onclick = (e) => {
    e.stopPropagation(); // Prevent glitches
    triggerDownload();
};

// 2. Modal Download Button (Big button in modal)
document.getElementById("modalDownloadBtn").onclick = () => {
    triggerDownload();
};

// Shared Download Function
function triggerDownload() {
    if (!currentFile) {
        alert("No file selected.");
        return;
    }
    // Points to the standard serve-file view with download=true
    const url = `/coreapi/serve-file/?path=${encodeURIComponent(currentFile.path)}&download=true`;
  window.location.href = url;
}


/* =========================
   ADVANCED FILE SHARING (Sends Actual File)
========================= */

// 1. Get Elements
const modalShareBtn = document.getElementById("modalShare");
const shareButtonsContainer = document.getElementById("shareButtonsContainer");
const modalDownloadBtn = document.getElementById("modalDownloadBtn");

// 2. Main Share Button Logic
modalShareBtn.onclick = async (e) => {
  e.preventDefault();
  
  if (!currentFile) return alert("No file selected");

  const originalText = modalShareBtn.innerHTML;
  
  // Visual Feedback: Show user we are preparing the file
  modalShareBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Preparing...';
  modalShareBtn.style.pointerEvents = "none"; // Prevent double click

  try {
      // A. Construct the Download URL
      const downloadUrl = `/coreapi/serve-file/?path=${encodeURIComponent(currentFile.path)}&download=true`;

      // B. Fetch the file data (Blob) from your server
      const response = await fetch(downloadUrl);
      const blob = await response.blob();

      // C. Create a Virtual File object
      // We use the correct MIME type (pdf, jpg, etc.)
      const fileObj = new File([blob], currentFile.name, { type: blob.type });

      // D. Check if the Device supports File Sharing
      if (navigator.canShare && navigator.canShare({ files: [fileObj] })) {
          
          // --- SUCCESS: Share the Actual File ---
          await navigator.share({
              files: [fileObj],
              title: currentFile.name,
              text: 'Here is the file.'
          });
          
      } else {
          // --- FALLBACK: Device doesn't support file sharing (e.g. Desktop) ---
          // We revert to the Link menu, but we tell the user why
          shareButtonsContainer.classList.toggle("hidden");
          
          // Still update links just in case they want to send the link instead
          const fileLink = window.location.origin + `/coreapi/serve-file/?path=${encodeURIComponent(currentFile.path)}`;
          updateShareLinks(fileLink);
      }

  } catch (err) {
      console.log('Share failed or canceled:', err);
      // If user canceled share, do nothing. If error, maybe show alert.
      if (err.name !== 'AbortError' && err.name !== 'NotAllowedError') {
          alert("Could not share file directly. Try downloading it first.");
      }
  } finally {
      // Reset Button
      modalShareBtn.innerHTML = originalText;
      modalShareBtn.style.pointerEvents = "auto";
  }
};

// 3. Fallback Links (Only used if File Sharing fails/Desktop)
function updateShareLinks(url) {
  const encodedUrl = encodeURIComponent(url);
  const encodedText = encodeURIComponent("Check this document: " + currentFile.name);

  // Note: These CANNOT attach files. This is a browser limitation.
  document.getElementById("shareWhatsapp").href = `https://wa.me/?text=${encodedText}%20${encodedUrl}`;
  document.getElementById("shareTelegram").href = `https://t.me/share/url?url=${encodedUrl}&text=${encodedText}`;
  document.getElementById("shareEmail").href = `mailto:?subject=${encodeURIComponent(currentFile.name)}&body=${encodedText}%20${encodedUrl}`;

  document.getElementById("shareCopy").onclick = (e) => {
    e.preventDefault();
    navigator.clipboard.writeText(url).then(() => {
        alert("Link copied to clipboard!");
        shareButtonsContainer.classList.add("hidden");
    });
  };
}

// 4. Download Button Logic
modalDownloadBtn.onclick = (e) => {
  e.preventDefault();
  if (!currentFile) return alert("No file selected");
  const downloadUrl = `/coreapi/serve-file/?path=${encodeURIComponent(currentFile.path)}&download=true`;
  window.location.href = downloadUrl;
};
/* =========================
   11. SAFETY NET (Auto-Save & Scroll Memory)
========================= */
window.addEventListener('beforeunload', (event) => {
    // 1. Save Form Data (Auto-save)
    if (currentFolder) {
        const payload = JSON.stringify({ 
            folder_path: currentFolder, 
            payload: formState 
        });
        fetch('/coreapi/api/auto-save/', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrftoken },
            body: payload,
            keepalive: true
        });
    }

    // 2. âœ… SAVE SCROLL POSITIONS (ROBUST FIX)
    
    // A. Form Scroll (Check BOTH container and form element)
    const rightCol = document.getElementById('rightColumnContainer');
    const formEl = document.getElementById('siteFeedbackForm');
    
    // Use the value from whichever element is actually scrolling
    const currentFormScroll = Math.max(
        rightCol ? rightCol.scrollTop : 0, 
        formEl ? formEl.scrollTop : 0
    );
    
    localStorage.setItem('vadrida_form_scroll', currentFormScroll);

    // Save Fullscreen State
    if (rightCol) {
        const isFullscreen = rightCol.classList.contains('fullscreen-active');
        localStorage.setItem('vadrida_form_fullscreen', isFullscreen);
    }

    // B. File List Scroll
    const fileListCol = document.querySelector('.file-list-container');
    if (fileListCol) {
        localStorage.setItem('vadrida_file_list_scroll', fileListCol.scrollTop);
    }
});
/* ==========================================
   LOGIC: Toggle Ownership Notes Visibility
   ========================================== */
function toggleOwnershipNotes() {
    const notesBox = document.getElementById('ownershipNotesBox');
    // Check if "Discrepancy noted" is checked
    const discrepancyRadio = document.querySelector('input[name="doc_verification"][value="discrepancy noted"]');
    const isDiscrepancy = discrepancyRadio && discrepancyRadio.checked;

    if (isDiscrepancy) {
        notesBox.classList.remove('hidden');
    } else {
        notesBox.classList.add('hidden');
        
        // --- DATA CLEANUP ---
        // 1. Clear State
        updateNestedState(formState, 'Ownership_Analysis.Ownership_Analysis_notes', "");
        // 2. Clear Input UI
        const input = document.querySelector('[data-path="Ownership_Analysis.Ownership_Analysis_notes"]');
        if(input) input.value = "";
        // 3. Save
        saveLocal();
    }
}

/* ==========================================
   AUTO-CALCULATE EXTENT TOTALS (With Cents)
   ========================================== */
function calculateSurveyTotals() {
    let ltrSum = 0;
    let ltrCount = 0;
    
    let deedSum = 0;
    let deedCount = 0;
    
    // 1. Calculate Sums and Counts
    const docs = formState.Survey.docs || [];

    docs.forEach(doc => {
        const extentVal = parseFloat(doc.land_extent) || 0;
        const docName = (doc.name || "").trim(); // Exact match

        if (docName === "LTR") {
            ltrSum += extentVal;
            ltrCount++;
        }
        else if (docName === "Title Deed") {
            deedSum += extentVal;
            deedCount++;
        }
    });

    // 2. DOM Elements
    const mainContainer = document.getElementById("surveyTotalsContainer");
    const ltrWrapper = document.getElementById("ltr_total_wrapper");
    const ltrInput = document.getElementById("total_ltr_extent");
    
    const deedWrapper = document.getElementById("deed_total_wrapper");
    const deedInput = document.getElementById("total_deed_extent");

    let showMainContainer = false;

    // --- Helper to Format String ---
    const formatValue = (aresValue) => {
        // Round Ares to reasonable decimals (e.g. 3) to avoid float errors
        const cleanAres = parseFloat(aresValue.toFixed(3));
        
        // Calculate Cents: (Ares * 100) / 40.47
        const cents = (cleanAres * 100) / 40.47;
        
        // Format: "2.1 (5.189 cents)"
        return `${cleanAres} (${cents.toFixed(3)} cents)`;
    };

    // 3. Handle LTR Visibility & Value
    if (ltrCount > 1 && ltrSum > 0) {
        const finalStr = formatValue(ltrSum);
        
        ltrInput.value = finalStr;
        formState.Survey.total_ltr_extent = finalStr; // Save the full string for PDF
        
        ltrWrapper.classList.remove("hidden");
        showMainContainer = true;
    } else {
        ltrWrapper.classList.add("hidden");
        ltrInput.value = "";
        formState.Survey.total_ltr_extent = ""; 
    }

    // 4. Handle Title Deed Visibility & Value
    if (deedCount > 1 && deedSum > 0) {
        const finalStr = formatValue(deedSum);
        
        deedInput.value = finalStr;
        formState.Survey.total_deed_extent = finalStr; // Save the full string for PDF
        
        deedWrapper.classList.remove("hidden");
        showMainContainer = true;
    } else {
        deedWrapper.classList.add("hidden");
        deedInput.value = "";
        formState.Survey.total_deed_extent = "";
    }

    // 5. Toggle Main Box Visibility
    if (showMainContainer) {
        mainContainer.classList.remove("hidden");
    } else {
        mainContainer.classList.add("hidden");
    }
}
/* ==========================================
   CHECK FOR WET LAND IN LTR
   ========================================== */
function checkWetLandStatus() {
    const docs = formState.Survey.docs || [];
    let isWetLandFound = false;

    // Loop through all columns
    docs.forEach(doc => {
        const docName = (doc.name || "").trim();
        // Check for LTR + check_wet
        if (docName === "LTR" && (doc.check_wet === true || doc.check_wet === "true")) {
            isWetLandFound = true;
        }
    });

    const questionBox = document.getElementById("wetLandQuestions");
    
    if (isWetLandFound) {
        questionBox.classList.remove("hidden");
    } else {
        questionBox.classList.add("hidden");

        // --- DATA CLEANUP ---
        // Only clear if we are actually hiding it (avoid clearing on initial load if empty)
        // Check if data exists before clearing to avoid unnecessary writes
        if (formState.Survey.paddy_land_check || formState.Survey.trees_2008_check) {
            updateNestedState(formState, 'Survey.paddy_land_check', "");
            updateNestedState(formState, 'Survey.trees_2008_check', "");
            
            // Clear Radios in UI
            document.querySelectorAll('input[name="paddy_land_check"]').forEach(el => el.checked = false);
            document.querySelectorAll('input[name="trees_2008_check"]').forEach(el => el.checked = false);
            
            saveLocal();
        }
    }
}
/* ==========================================
   LOGIC: Toggle Encroachment Fields
   ========================================== */
function toggleEncroachmentFields() {
    const container = document.getElementById('encroachmentDetails');
    const yesRadio = document.querySelector('input[name="encroachment_check"][value="Yes"]');
    const isYes = yesRadio && yesRadio.checked;

    if (container) {
        if (isYes) {
            container.classList.remove('hidden');
        } else {
            container.classList.add('hidden');

            // --- DATA CLEANUP ---
            // Clear all 3 related fields
            const pathsToClear = [
                'Demarcation.demarcation_notes',
                'Demarcation.enroachment_subject_to_neighbour',
                'Demarcation.enroachment_neighbour_to_subject'
            ];

            pathsToClear.forEach(path => {
                updateNestedState(formState, path, ""); // Clear State
                const input = document.querySelector(`[data-path="${path}"]`);
                if(input) input.value = ""; // Clear UI
            });
            saveLocal();
        }
    }
}
/* ==========================================
   LOGIC: Toggle Railway Distance Row
   ========================================== */
function toggleRailwayDistance() {
    const row = document.getElementById('railwayDistanceRow');
    const yesRadio = document.querySelector('input[name="railway"][value="Yes"]');
    const isYes = yesRadio && yesRadio.checked;

    if (row) {
        if (isYes) {
            row.classList.remove('hidden');
        } else {
            row.classList.add('hidden');

            // --- DATA CLEANUP ---
            updateNestedState(formState, 'land_inspection_details.railway_distance', "");
            const input = document.querySelector('[data-path="land_inspection_details.railway_distance"]');
            if(input) input.value = "";
            
            saveLocal();
        }
    }
}

/* =========================
   10. APP INIT
========================= */
document.addEventListener("DOMContentLoaded", () => {
    console.log("App Initializing...");

    // 1. Restorations
    const lastPath = localStorage.getItem('vadrida_active_folder');
    
    setTimeout(() => {
        const savedStr = getNestedValue(formState, "Building_analysis.construction_year");
        if(savedStr) parseTimelineString(savedStr);
        else createColumnAtIndex(0, "");
    }, 200);

    initBuildingTable();
    
    if (lastPath) loadFolder(lastPath);
    else loadFolder(""); 
    
    enforceTabletLandscape();
    injectPencilIcons();
    renderSurveyColumns();
    updateAllDocumentDropdowns();

    // Load saved images
    Object.keys(formState.images).forEach(path => {
        const safeId = path.replace(/\./g, '_');
        const previewImg = document.getElementById(`img_preview_${safeId}`);
        if (previewImg) {
            previewImg.src = formState.images[path];
            previewImg.classList.remove('hidden');
            if(path === 'Sketch.main_layout') {
                const ph = document.getElementById(`placeholder_${safeId}`);
                if(ph) ph.classList.add('hidden');
            }
        }
    });

    // ============================================================
    // âœ… SCROLL MEMORY & FULLSCREEN LOGIC
    // ============================================================
    const fsBtn = document.getElementById('toggleFormFullscreenBtn');
    const rightCol = document.getElementById('rightColumnContainer');
    const icon = fsBtn ? fsBtn.querySelector('i') : null;

    // 1. Restore Fullscreen Mode
    const wasFullscreen = localStorage.getItem('vadrida_form_fullscreen') === 'true';
    if (wasFullscreen && rightCol && icon) {
        rightCol.classList.add('fullscreen-active');
        icon.className = 'fas fa-compress';
        icon.style.color = '#ef4444';
        document.body.style.overflow = 'hidden'; 
    }

    // C. Attach Click Listener with Seamless Scroll
    if (fsBtn && rightCol) {
        fsBtn.onclick = () => {
            // 1. CAPTURE: Grab exact scroll position BEFORE the layout changes
            const currentScroll = rightCol.scrollTop;

            // 2. TOGGLE: Change the class
            rightCol.classList.toggle('fullscreen-active');
            const isNowFullscreen = rightCol.classList.contains('fullscreen-active');

            // 3. RESTORE: Put the scroll position back immediately
            // We do this instantly so the user doesn't see a jump
            rightCol.scrollTop = currentScroll;

            // 4. Update Icons & LocalStorage
            if (isNowFullscreen) {
                icon.className = 'fas fa-compress';
                icon.style.color = '#ef4444';
                document.body.style.overflow = 'hidden'; 
                localStorage.setItem('vadrida_form_fullscreen', 'true');
            } else {
                icon.className = 'fas fa-expand';
                icon.style.color = '#374151';
                document.body.style.overflow = '';
                localStorage.setItem('vadrida_form_fullscreen', 'false');
            }
        };
    }
    // Date restriction
    const dateInput = document.querySelector('input[data-path="Valuers_Checklist.inspection_date"]');
    if (dateInput) {
        const today = new Date().toISOString().split("T")[0];
        dateInput.setAttribute("max", today);
    }
});

</script>

{% endblock %}