{% extends "base.html" %}
{% load static %}
{% block title %}Office Dashboard ‚Äî Vadrida{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="{% static 'css/dashboard.css' %}">
{% endblock %}

{% block content %}
<div class="relative">
  <!-- Loading overlay for Analyse action -->
  <div id="analyseLoading" class="loading-overlay hidden">
    <div class="spinner"></div>
    <div class="text-lg font-semibold">Analyzing ‚Äî please wait...</div>
    <div class="text-sm">Processing your file...</div>
  </div>

  <div class="dashboard-grid">
    <!-- LEFT: file list + dropdown + file info -->
    <aside class="bg-white rounded-lg p-4 shadow-sm">
      <div class="flex items-center justify-between mb-4 flex-shrink-0">
        <h3 class="font-montserrat font-semibold">Files</h3>
        <button id="refreshFolders" class="px-3 py-1 border rounded text-sm">üîÑ</button>
      </div>

      <div class="mb-3 flex-shrink-0">
        <input id="fileSearch" type="text" placeholder="Search file id or name..." class="w-full p-2 rounded border" />
      </div>

      <div class="file-list-scroll mb-4 flex-1 overflow-y-auto">
        <div class="flex items-center gap-2 mb-2 text-sm">
          <button id="goBackBtn" class="px-2 py-1 border rounded">‚¨Ö</button>
          <span id="currentPath">/</span>
        </div>

        <ul id="fileList" class="space-y-2 text-sm"></ul>
      </div>

      <!-- File info moved into left panel -->
      <div class="file-info bg-white border rounded p-3 mt-auto flex-shrink-0">
        <h4 class="font-semibold mb-2">File Info</h4>
        <div id="fileInfoBox" class="text-sm text-gray-600">
          Select a file to see details.
        </div>
      </div>
    </aside>

    <!-- CENTER: Big preview + controls -->
    <section class="bg-white rounded-lg shadow-sm">
      <div class="flex items-center justify-between mb-3 flex-shrink-0 p-3">
        <h3 class="font-montserrat font-semibold">Preview</h3>
        <div class="flex gap-2 flex-wrap">
          <button id="analyseBtn" class="analyse-btn px-4 py-2 rounded">Analyse</button>
          <a id="siteFeedbackBtn" href="{% url 'coreapi:feedback' %}" class="px-4 py-2 border rounded bg-gray-100 hover:bg-gray-200">
            Site Feedback
          </a>
          <button id="openFullBtn" class="px-3 py-2 border rounded">Open Full</button>
        </div>
      </div>

      <!-- Thumbnails row (populated dynamically) -->
      <div id="thumbs" class="thumbs-strip mb-3 px-3"></div>

      <!-- Large viewer -->
      <div class="preview-shell rounded border mx-3 mb-3">
        <div id="bigPreviewHeader" class="flex items-center justify-between px-4 py-2 bg-white border-b flex-shrink-0">
          <div class="font-medium text-sm truncate" id="bigPreviewTitle">No file selected</div>
          <div class="flex items-center gap-2">
            <button id="downloadPdfBtn" class="px-2 py-1 border rounded text-xs hidden download-btn">
              <i class="fas fa-file-download"></i>
            </button>
          </div>
        </div>

        <div id="bigViewer">
          <div id="noSelection">
            Select a file to preview
          </div>

          <div id="pdfWrapper" class="hidden">
            <div id="pdfMain"></div>
          </div>

          <img id="bigImageFrame" class="hidden" src="" alt="preview" />
        </div>
      </div>
    </section>

    <!-- RIGHT: WhatsApp-Style Chat -->
    <aside class="bg-white rounded-lg p-4 shadow-sm">
      <div id="pinnedMessages" class="mb-3 space-y-2"></div>
      <!-- Header -->
      <div class="flex items-center justify-between mb-3 flex-shrink-0">
        <h3 class="font-montserrat font-semibold">Chat</h3>
        <div class="text-sm text-gray-500">Agent</div>
      </div>

      <!-- Chat Area -->
      <div id="chatBox" class="chat-box bg-gray-50 rounded p-3 mb-3 flex-1 overflow-y-auto space-y-4">
        <!-- Example Messages -->
        <div class="flex flex-col">
          <span class="text-xs text-gray-500 mb-1">Agent</span>
          <div class="bg-white p-3 rounded-xl shadow-sm max-w-[75%]">
            Hi! Ready to help you with document analysis.
          </div>
        </div>
      </div>

      <!-- Typing Box -->
      <form id="chatForm" class="flex items-center gap-2 flex-shrink-0">
        <!-- File Upload -->
        <label class="cursor-pointer">
          <input type="file" id="fileInput" class="hidden" accept="image/*,.pdf,.doc,.docx" />
          <i class="fas fa-paperclip text-royal-blue-700 text-xl"></i>
        </label>

        <!-- Text Input -->
        <input
          id="chatInput"
          type="text"
          placeholder="Type a message..."
          class="flex-1 border border-gray-300 rounded-full px-4 py-2 focus:outline-none focus:ring-2 focus:ring-royal-blue-500 text-sm"
        />

        <!-- Send Button -->
        <button type="submit" class="bg-royal-blue-600 text-white px-4 py-2 rounded-full">
          <i class="fas fa-paper-plane"></i>
        </button>
      </form>
    </aside>
  </div>
</div>

<!-- Fullscreen modal for preview -->
<div id="fullscreenModal" aria-hidden="true">
  <div class="modal-box">
    <div class="flex items-center justify-between p-3 border-b bg-white">
      <div class="font-semibold" id="modalTitle">Preview</div>

      <div class="flex items-center gap-3 flex-wrap">
        <div id="shareButtonsContainer" class="flex space-x-2 hidden">
          <a href="#" id="shareWhatsapp" class="px-3 py-2 rounded border text-sm share-btn">
            <i class="fab fa-whatsapp mr-2"></i>WhatsApp
          </a>
          <a href="#" id="shareTelegram" class="px-3 py-2 rounded border text-sm share-btn">
            <i class="fab fa-telegram mr-2"></i>Telegram
          </a>
          <a href="#" id="shareEmail" class="px-3 py-2 rounded border text-sm share-btn">
            <i class="fas fa-envelope mr-2"></i>Email
          </a>
          <a href="#" id="shareCopy" class="px-3 py-2 rounded border text-sm share-btn">
            <i class="fas fa-link mr-2"></i>Copy Link
          </a>
        </div>

        <!-- Main Share button to toggle these -->
        <a id="modalShare" href="#" class="px-3 py-2 rounded border text-sm share-btn">
          <i class="fas fa-share-alt mr-2"></i>Share
        </a>

        <!-- Download button -->
        <button id="modalDownloadBtn" class="px-3 py-2 rounded border text-sm download-btn">
          <i class="fas fa-file-download mr-2"></i>Download
        </button>

        <button id="modalClose" class="px-3 py-2 border rounded text-sm">Close</button>
      </div>
    </div>

    <div id="modalBody" class="modal-inner" style="overflow: hidden; display: flex; justify-content: center; background: #f0f0f0; height: calc(100% - 60px);">
      <iframe id="modalFrame" class="hidden" src="" style="width: 100%; height: 100%; border: none;"></iframe>
      
      <img id="modalImage" class="hidden" src="" alt="preview" style="max-width: 100%; max-height: 100%; object-fit: contain;" />
      
      <div id="modalPdfContainer" class="hidden pdf-scroll-container" style="width: 100%; height: 100%; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; align-items: center;"></div>
    </div>
  </div>
</div>

<!-- Analyse Modal -->
<div id="analyseModal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
  <div class="bg-white rounded-xl p-6 w-96 max-w-[90vw] shadow-xl">
    <h2 class="text-lg font-semibold mb-4">Analyse Files</h2>
    <p class="text-sm text-gray-600 mb-4">Choose files for analysis</p>

    <button id="analyseSelectFiles" class="w-full mb-3 px-4 py-2 bg-blue-600 text-white rounded">
      Select Files
    </button>

    <button id="analyseSelectAll" class="w-full px-4 py-2 bg-green-600 text-white rounded">
      Select All Files
    </button>

    <button id="analyseClose" class="w-full mt-4 px-4 py-2 border rounded">
      Cancel
    </button>
  </div>
</div>

<!-- File Selection List Modal -->
<div id="fileSelectModal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
  <div class="bg-white rounded-xl p-6 w-[420px] max-w-[90vw] shadow-xl">
    <h2 class="text-lg font-semibold mb-4">Select Files</h2>

    <div id="fileSelectList" class="max-h-64 overflow-y-auto border rounded p-3 mb-4"></div>

    <button id="confirmFileSelection" class="w-full px-4 py-2 bg-blue-600 text-white rounded">
      Confirm Selection
    </button>

    <button id="fileSelectClose" class="w-full mt-3 px-4 py-2 border rounded">
      Cancel
    </button>
  </div>
</div>

<script>
/* =========================
   CSRF
========================= */
function getCookie(name) {
  let v = null;
  document.cookie?.split(";").forEach(c => {
    c = c.trim();
    if (c.startsWith(name + "=")) v = decodeURIComponent(c.slice(name.length + 1));
  });
  return v;
}
const csrftoken = getCookie("csrftoken");

/* =========================
   ELEMENTS
========================= */
const fileList = document.getElementById("fileList");
const thumbsContainer = document.getElementById("thumbs");
const bigImageFrame = document.getElementById("bigImageFrame");
const noSelection = document.getElementById("noSelection");
const bigPreviewTitle = document.getElementById("bigPreviewTitle");
const openModalBtn = document.getElementById("openFullBtn");
const fileInfoBox = document.getElementById("fileInfoBox");
const pdfWrapper = document.getElementById("pdfWrapper");
const pdfMain = document.getElementById("pdfMain");

/* =========================
   STATE
========================= */
let currentFolder = "";
let currentFile = null;
let analysisController = null;
let currentFolderFiles = [];
let selectedAnalysisFiles = [];
let rootFoldersCache = null;
let isSearching = false;
let currentPreviewUrl = null;

/* =========================
   FOLDER LOADER
========================= */
function loadFolder(path = "") {
  currentFolder = path;
  document.getElementById("currentPath").textContent = "/" + (path || "");

  fetch(`/coreapi/api/folder-contents/?path=${encodeURIComponent(path)}`)
    .then(r => r.json())
    .then(data => {
      currentFolderFiles = data.files || [];
      renderFileList(data.folders || [], data.files || []);
      renderThumbs(data.files || []);
    });
}

document.getElementById("goBackBtn").onclick = () => {
  if (!currentFolder) return;
  const parts = currentFolder.split("/");
  parts.pop();
  loadFolder(parts.join("/"));
};

/* =========================
   FILE LIST
========================= */
function renderFileList(folders, files) {
  fileList.innerHTML = "";

  folders.forEach(folder => {
    const li = document.createElement("li");
    li.className = "p-2 cursor-pointer hover:bg-blue-50 flex items-center gap-2";
    li.innerHTML = `üìÅ <strong>${folder.name}</strong>`;
    li.onclick = () => loadFolder(folder.path);
    fileList.appendChild(li);
  });

  files.forEach(file => {
    const li = document.createElement("li");
    li.className = "p-2 cursor-pointer hover:bg-gray-100";
    li.innerHTML = `
      <div class="flex justify-between items-center">
        <div>
          <div class="font-medium truncate">${file.name}</div>
          <div class="text-xs text-gray-500">${file.extension || ""}</div>
        </div>
        <button class="pin-btn">üìå</button>
      </div>
    `;

    li.querySelector(".pin-btn").onclick = (e) => {
      e.stopPropagation();
      pendingAttachment = {
        type: "file",
        path: file.path,
        label: file.name
      };
    };
    li.onclick = () => {
      document.querySelectorAll("#fileList li").forEach(el => el.classList.remove("bg-blue-100"));
      li.classList.add("bg-blue-100");
      loadBigPreview(file);
      setFileInfo(file);
    };

    fileList.appendChild(li);
  });

  if (!folders.length && !files.length) {
    fileList.innerHTML = `<li class="p-3 text-gray-400">No results</li>`;
  }
}

/* =========================
   THUMBNAILS
========================= */
/* =========================
   THUMBNAILS (PDF FIX)
========================= */

// 1. Helper to load PDF.js library if not present
function loadPdfJsIfNeeded() {
  if (window.pdfjsLib) return Promise.resolve();
  
  return new Promise((resolve, reject) => {
    const script = document.createElement("script");
    // Using a reliable CDN version
    script.src = "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js";
    
    script.onload = () => {
      // Set the worker source immediately after loading
      window.pdfjsLib.GlobalWorkerOptions.workerSrc = 
        "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js";
      resolve();
    };
    
    script.onerror = () => reject(new Error("Could not load PDF.js"));
    document.head.appendChild(script);
  });
}

// 2. Render PDF Thumbnail (Now accepts a direct URL)
async function renderPdfThumbnail(pdfUrl, container) {
  try {
    await loadPdfJsIfNeeded();

    // Fetch the PDF using the calculated URL
    const loadingTask = pdfjsLib.getDocument(pdfUrl);
    const pdf = await loadingTask.promise;
    
    // Get the first page
    const page = await pdf.getPage(1);

    // Calculate scale to fit the thumbnail container (approx 100x100)
    // We render slightly larger (scale 0.5) for sharpness, then resize via CSS
    const viewport = page.getViewport({ scale: 0.5 });
    
    const canvas = document.createElement("canvas");
    const context = canvas.getContext("2d");
    
    canvas.width = viewport.width;
    canvas.height = viewport.height;
    
    // Force CSS styles to ensure it stays inside the thumbnail box
    canvas.style.width = "100%";
    canvas.style.height = "100%";
    canvas.style.objectFit = "contain";

    await page.render({
      canvasContext: context,
      viewport: viewport
    }).promise;

    container.appendChild(canvas);
    
  } catch (error) {
    console.error("PDF Thumb Error:", error);
    // Fallback Icon
    container.innerHTML = `
      <div class="file-icon" style="color: #dc2626; text-align: center;">
        <i class="fas fa-file-pdf" style="font-size: 24px;"></i><br>
        <span style="font-size: 10px;">PDF</span>
      </div>`;
  }
}

// 3. Main Thumbnail Function
async function renderThumbs(files) {
  thumbsContainer.innerHTML = "";

  if (!files || !files.length) {
    thumbsContainer.innerHTML = `<div class="no-thumbs" style="padding:10px; color:#999;">No files</div>`;
    return;
  }

  for (const file of files) {
    const card = document.createElement("div");
    card.className = "thumb-item";
    
    // --- PATH BUILDING LOGIC (CRITICAL) ---
    let fullPath = file.path;
    if (!fullPath) {
        // If path is missing from API, build it: currentFolder + filename
        const folderPrefix = currentFolder ? currentFolder.replace(/\/$/, '') + '/' : '';
        fullPath = folderPrefix + file.name;
    }
    // Create the valid URL
    const fileUrl = `/coreapi/serve-file/?path=${encodeURIComponent(fullPath)}`;
    // --------------------------------------

    const ext = file.name.includes('.') ? file.name.split(".").pop().toLowerCase() : 'file';

    // IMAGE
    if (["jpg","jpeg","png","gif","bmp","webp"].includes(ext)) {
      const img = document.createElement("img");
      img.src = fileUrl;
      img.loading = "lazy";
      img.style.objectFit = "cover";
      img.style.width = "100%";
      img.style.height = "100%";
      
      img.onerror = () => {
        card.innerHTML = `<div class="file-icon"><i class="fas fa-image"></i></div>`;
      };
      card.appendChild(img);
    } 
    // PDF (Pass the URL, not the file object)
    else if (ext === "pdf") {
      // Create a loading placeholder first
      card.innerHTML = `<div class="file-icon"><i class="fas fa-spinner fa-spin"></i></div>`;
      // Call the renderer
      await renderPdfThumbnail(fileUrl, card);
      // Remove spinner if canvas is added (renderPdfThumbnail appends, doesn't replace)
      const spinner = card.querySelector('.file-icon');
      if(spinner && card.querySelector('canvas')) spinner.remove();
    } 
    // OTHER
    else {
      card.innerHTML = `
        <div class="file-icon" style="text-align: center; color: #6b7280;">
          <i class="fas fa-file" style="font-size: 24px;"></i><br>
          <span style="font-size: 10px; text-transform: uppercase;">${ext}</span>
        </div>`;
    }

    // Click to Open
    card.onclick = () => {
        document.querySelectorAll('.thumb-item').forEach(el => el.style.borderColor = '#fff');
        card.style.borderColor = '#3b82f6';
        
        // Ensure the global file object has the path for the big preview
        if (!file.path) file.path = fullPath;
        
        loadBigPreview(file);
        setFileInfo(file);
    };
    
    thumbsContainer.appendChild(card);
  }
}
/* =========================
   PREVIEW
========================= */
function loadBigPreview(file) {
  currentFile = file;

  // Hard reset
  pdfMain.innerHTML = "";
  pdfWrapper.classList.add("hidden");
  bigImageFrame.classList.add("hidden");
  noSelection.classList.add("hidden");
  bigImageFrame.src = "";

  const url = `/coreapi/serve-file/?path=${encodeURIComponent(file.path)}`;
  currentPreviewUrl = url;
  bigPreviewTitle.textContent = file.name;

  const ext = file.name.split(".").pop().toLowerCase();

  // IMAGE
  if (["jpg","jpeg","png","gif","bmp"].includes(ext)) {
    bigImageFrame.src = url;
    bigImageFrame.classList.remove("hidden");
    return;
  }

  // PDF
  if (ext === "pdf") {
    pdfWrapper.classList.remove("hidden");
    renderFullPdf(url);
    return;
  }

  // OTHER
  noSelection.textContent = "Preview not available for this file type";
  noSelection.classList.remove("hidden");
}

/* =========================
   FILE INFO
========================= */
function setFileInfo(file) {
  fileInfoBox.innerHTML = `
    <div class="mb-1"><strong>Name:</strong> <span class="text-xs break-all">${file.name}</span></div>
    <div class="mb-1"><strong>Type:</strong> ${file.extension || "Unknown"}</div>
    <div><strong>Size:</strong> ${file.size || "N/A"}</div>
  `;
}

/* =========================
   ANALYSE
========================= */
function startAnalysis(files) {
  if (analysisController) {
    analysisController.abort();
  }

  analysisController = new AbortController();
  document.getElementById("analyseLoading").classList.remove("hidden");

  fetch("/coreapi/api/analyze/", {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "X-CSRFToken": csrftoken
    },
    body: JSON.stringify({ files, folder: currentFolder }),
    signal: analysisController.signal
  })
  .then(r => r.json())
  .then(() => loadFolder(currentFolder))
  .finally(() => {
    document.getElementById("analyseLoading").classList.add("hidden");
    analysisController = null;
  });
}

const analyseBtn = document.getElementById("analyseBtn");
const analyseModal = document.getElementById("analyseModal");

analyseBtn.onclick = () => {
  if (!currentFolder) {
    alert("Select a folder first");
    return;
  }
  analyseModal.classList.remove("hidden");
};

document.getElementById("analyseSelectAll").onclick = () => {
  if (!currentFolderFiles.length) {
    alert("No files in this folder");
    return;
  }

  const files = currentFolderFiles.map(f => ({ file_path: f.path }));
  analyseModal.classList.add("hidden");
  startAnalysis(files);
};

const fileSelectModal = document.getElementById("fileSelectModal");
const fileSelectList = document.getElementById("fileSelectList");

document.getElementById("analyseSelectFiles").onclick = () => {
  if (!currentFolderFiles.length) {
    alert("No files in this folder");
    return;
  }

  fileSelectList.innerHTML = "";
  selectedAnalysisFiles = [];

  currentFolderFiles.forEach(file => {
    const row = document.createElement("label");
    row.className = "flex items-center gap-2 mb-2 cursor-pointer";
    row.innerHTML = `
      <input type="checkbox" value="${file.path}" />
      <span class="truncate">${file.name}</span>
    `;

    const checkbox = row.querySelector("input");
    checkbox.onchange = () => {
      if (checkbox.checked) {
        selectedAnalysisFiles.push({ file_path: checkbox.value });
      } else {
        selectedAnalysisFiles = selectedAnalysisFiles.filter(f => f.file_path !== checkbox.value);
      }
    };

    fileSelectList.appendChild(row);
  });

  analyseModal.classList.add("hidden");
  fileSelectModal.classList.remove("hidden");
};

document.getElementById("confirmFileSelection").onclick = () => {
  if (!selectedAnalysisFiles.length) {
    alert("Select at least one file");
    return;
  }

  fileSelectModal.classList.add("hidden");
  startAnalysis(selectedAnalysisFiles);
};

document.getElementById("analyseClose").onclick = () => {
  analyseModal.classList.add("hidden");
};

document.getElementById("fileSelectClose").onclick = () => {
  fileSelectModal.classList.add("hidden");
};

/* =========================
   FILE SEARCH
========================= */
const searchInput = document.getElementById("fileSearch");
let searchTimer = null;

searchInput.addEventListener("input", e => {
  const q = e.target.value.trim();
  clearTimeout(searchTimer);

  searchTimer = setTimeout(() => {
    if (!q) {
      isSearching = false;
      if (rootFoldersCache) {
        renderFileList(rootFoldersCache.folders || [], rootFoldersCache.files || []);
        renderThumbs(rootFoldersCache.files || []);
      } else {
        loadFolder("");
      }
      return;
    }

    globalSearch(q);
  }, 300);
});

/* =========================
   RENDER FULL PDF
========================= */
/* =========================
   RENDER FULL PDF (Updated for Modal Support)
========================= */
async function renderFullPdf(url, targetContainer = null) {
  try {
    await loadPdfJsIfNeeded();

    // Default to sidebar (pdfMain) if no specific container is passed
    const container = targetContainer || document.getElementById("pdfMain");
    
    // Show loading state
    container.innerHTML = '<div style="color:gray; text-align:center; padding:20px;">Loading PDF...</div>';

    const pdf = await pdfjsLib.getDocument(url).promise;
    container.innerHTML = ""; // Clear loader

    for (let i = 1; i <= pdf.numPages; i++) {
      const page = await pdf.getPage(i);
      
      // Determine Zoom Level
      // If in Modal (targetContainer exists), make it bigger (1.5). 
      // If in Sidebar (no targetContainer), keep it smaller.
      const baseScale = targetContainer ? 1.5 : (window.innerWidth < 768 ? 1.0 : 1.4);
      
      const viewport = page.getViewport({ scale: baseScale });

      const cvs = document.createElement("canvas");
      cvs.width = viewport.width;
      cvs.height = viewport.height;
      cvs.style.marginBottom = "10px";
      cvs.style.display = "block";
      cvs.style.boxShadow = "0 2px 5px rgba(0,0,0,0.1)"; // Nice shadow
      cvs.style.backgroundColor = "white";

      // Render
      await page.render({ 
          canvasContext: cvs.getContext("2d"), 
          viewport: viewport 
      }).promise;

      container.appendChild(cvs);
    }
  } catch (error) {
    console.error("PDF Render Error:", error);
    const container = targetContainer || document.getElementById("pdfMain");
    container.innerHTML = `<div class="p-4 text-red-500 text-center">Error loading PDF content</div>`;
  }
}
/* =========================
   PDF.JS LOADER
========================= */
function loadPdfJsIfNeeded() {
  if (window.pdfjsLib) return Promise.resolve();

  return new Promise((resolve, reject) => {
    const script = document.createElement("script");
    script.src = "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js";

    script.onload = () => {
      pdfjsLib.GlobalWorkerOptions.workerSrc =
        "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js";
      resolve();
    };

    script.onerror = reject;
    document.head.appendChild(script);
  });
}

/* =========================
   GLOBAL SEARCH
========================= */
function globalSearch(query) {
  isSearching = true;
  fileList.innerHTML = `<li class="p-2 text-gray-400">Searching...</li>`;
  thumbsContainer.innerHTML = "";

  fetch(`/coreapi/api/search/?q=${encodeURIComponent(query)}`)
    .then(r => r.json())
    .then(data => {
      renderFileList(data.folders || [], data.files || []);
      renderThumbs(data.files || []);
    })
    .catch(() => {
      fileList.innerHTML = `<li class="p-2 text-red-500">Search failed</li>`;
    });
}

/* =========================
   REFRESH
========================= */
document.getElementById("refreshFolders").onclick = () => {
  fetch("/coreapi/api/refresh/")
    .then(() => {
      rootFoldersCache = null;
      searchInput.value = "";
      loadFolder("");
    });
};

/* =========================
   FULLSCREEN MODAL LOGIC (Updated)
========================= */
const fullscreenModal = document.getElementById("fullscreenModal");
const modalFrame = document.getElementById("modalFrame");
const modalImage = document.getElementById("modalImage");

document.getElementById("openFullBtn").onclick = () => {
  if (!currentFile || !currentPreviewUrl) {
    alert("Select a file first");
    return;
  }

  // 1. Open Modal (Active on ALL devices now)
  fullscreenModal.classList.add("active"); // Ensure your CSS supports .active for display block

  // If your CSS uses Aria-Hidden instead of a class for visibility:
  fullscreenModal.setAttribute("aria-hidden", "false"); 

  // 2. Reset All Containers
  modalFrame.classList.add("hidden");
  modalImage.classList.add("hidden");
  const pdfContainer = document.getElementById("modalPdfContainer");
  pdfContainer.classList.add("hidden");
  pdfContainer.innerHTML = ""; // Clear previous

  const ext = currentFile.name.split(".").pop().toLowerCase();

  // 3. Route based on file type
  if (["jpg","jpeg","png","gif","bmp","webp"].includes(ext)) {
    // === IMAGE ===
    modalImage.src = currentPreviewUrl;
    modalImage.classList.remove("hidden");
  } 
  else if (ext === 'pdf') {
    // === PDF (Direct Render) ===
    pdfContainer.classList.remove("hidden");
    renderFullPdf(currentPreviewUrl, pdfContainer);
  } 
  else {
    // === UNSUPPORTED (Docx, Excel, etc.) ===
    // Show clean "No Preview" UI instead of broken iframe
    pdfContainer.classList.remove("hidden");
    pdfContainer.innerHTML = `
        <div style="text-align:center; display:flex; flex-direction:column; align-items:center; justify-content:center; height:100%;">
            <div style="font-size: 60px; color: #cbd5e1; margin-bottom: 20px;">
                <i class="fas fa-file-alt"></i>
            </div>
            <h3 style="font-size: 20px; color: #334155; margin: 0; font-weight: 600;">No Preview Available</h3>
            <p style="color: #64748b; margin-top: 10px;">
                .${ext.toUpperCase()} files cannot be previewed in the browser.
            </p>
            <a href="${currentPreviewUrl}&download=true" 
               style="background-color: #2563eb; color: white; padding: 10px 20px; border-radius: 6px; text-decoration: none; margin-top: 20px; font-weight: 500; display: inline-flex; align-items: center; gap: 8px;">
               <i class="fas fa-download"></i> Download File
            </a>
        </div>
    `;
  }
};

document.getElementById("modalClose").onclick = () => {
  // Close logic supporting both class and aria attribute
  fullscreenModal.classList.remove("active");
  fullscreenModal.setAttribute("aria-hidden", "true");
  
  modalFrame.src = "";
  modalImage.src = "";
  document.getElementById("modalPdfContainer").innerHTML = "";
};

/* =========================
   SHARE & DOWNLOAD
========================= */
const modalShareBtn = document.getElementById("modalShare");
const shareButtonsContainer = document.getElementById("shareButtonsContainer");

modalShareBtn.onclick = async (e) => {
  e.preventDefault();

  if (navigator.share && currentPreviewUrl) {
    try {
      await navigator.share({
        title: "Document",
        url: window.location.origin + currentPreviewUrl
      });
    } catch (_) {}
  } else {
    shareButtonsContainer.classList.toggle("hidden");
  }
};

function updateShareLinks(url) {
  const encoded = encodeURIComponent(window.location.origin + url);

  document.getElementById("shareWhatsapp").href = `https://wa.me/?text=${encoded}`;
  document.getElementById("shareTelegram").href = `https://t.me/share/url?url=${encoded}`;
  document.getElementById("shareEmail").href = `mailto:?subject=Document&body=${encoded}`;

  document.getElementById("shareCopy").onclick = (e) => {
    e.preventDefault();
    navigator.clipboard.writeText(window.location.origin + url);
    alert("Link copied to clipboard");
  };
}

const modalDownloadBtn = document.getElementById("modalDownloadBtn");

modalDownloadBtn.onclick = () => {
  if (!currentFile) {
    alert("No file selected");
    return;
  }

  const downloadUrl = `/coreapi/serve-file/?path=${encodeURIComponent(currentFile.path)}&download=true`;
  window.location.href = downloadUrl;
};

/* =========================
   INIT
========================= */
document.addEventListener("DOMContentLoaded", () => {
  console.log("Dashboard JS loaded");
  loadFolder("");
});

</script>

<script>
/* =========================
   CHAT STATE
========================= */

const CURRENT_USERNAME = "{{ request.user_profile.user_name }}";
const chatBox = document.getElementById("chatBox");
const chatForm = document.getElementById("chatForm");
const chatInput = document.getElementById("chatInput");
const pinnedBox = document.getElementById("pinnedMessages");
const fileInput = document.getElementById("fileInput");

let pendingAttachment = null;

/* =========================
   WEBSOCKET
========================= */

const protocol = location.protocol === "https:" ? "wss" : "ws";
const ws = new WebSocket(`${protocol}://${location.host}/ws/chat/global/`);

ws.onopen = () => console.log("‚úÖ WS connected");
ws.onerror = e => console.error("‚ùå WS error", e);

ws.onmessage = e => {
  const msg = JSON.parse(e.data);
  renderMessage(msg);
};

/* =========================
   LOAD HISTORY
========================= */

fetch("/chat/history/")
  .then(r => r.json())
  .then(data => {
    if (Array.isArray(data.pins)) {
      data.pins.forEach(renderPinned);
    }
    if (Array.isArray(data.messages)) {
      data.messages.forEach(renderMessage);
    }
  });

/* =========================
   SEND MESSAGE
========================= */

chatForm.onsubmit = e => {
  e.preventDefault();

  if (!chatInput.value.trim() && !pendingAttachment) return;

  ws.send(JSON.stringify({
    user: CURRENT_USERNAME,
    content: chatInput.value,
    attached_type: pendingAttachment ? pendingAttachment.type : "text",
    attached_path: pendingAttachment ? pendingAttachment.path : null,
    attached_label: pendingAttachment ? pendingAttachment.label : null,
  }));

  chatInput.value = "";
  pendingAttachment = null;
};

/* =========================
   RENDER MESSAGE
========================= */

function renderMessage(msg) {
  const mine = msg.user === CURRENT_USERNAME;

  const div = document.createElement("div");
  div.className = `flex ${mine ? "justify-end" : "justify-start"}`;

  let contentHtml = "";

  if (msg.attached_type === "file") {
    contentHtml += `
      <div class="flex items-center gap-2 cursor-pointer underline"
           onclick='openPinnedReference(${JSON.stringify(msg).replace(/'/g, "&apos;")})'>
        üìé ${msg.attached_label}
      </div>
    `;
  }

  if (msg.content) {
    contentHtml += `<div>${msg.content}</div>`;
  }

  div.innerHTML = `
    <div class="${mine ? "bg-blue-600 text-white" : "bg-white"}
                p-3 rounded-xl max-w-[75%] shadow-sm">
      ${!mine ? `<div class="text-xs font-semibold mb-1">${msg.user}</div>` : ""}
      ${contentHtml}
      <div class="text-[10px] text-right opacity-70">${msg.time}</div>
    </div>
  `;

  chatBox.appendChild(div);
  chatBox.scrollTop = chatBox.scrollHeight;
}

/* =========================
   PIN RENDERING (HISTORY ONLY)
========================= */

function renderPinned(pin) {
  const div = document.createElement("div");
  div.className = "bg-yellow-100 p-2 rounded cursor-pointer";

  div.innerHTML = `
    <strong>üìå ${pin.value}</strong>
    <div class="text-xs text-gray-600">Pinned by ${pin.by}</div>
  `;

  pinnedBox.appendChild(div);
}

/* =========================
   FILE UPLOAD
========================= */

fileInput.onchange = () => {
  const file = fileInput.files[0];
  if (!file) return;

  const formData = new FormData();
  formData.append("file", file);

  fetch("/chat/upload/", {
    method: "POST",
    headers: { "X-CSRFToken": csrftoken },
    body: formData
  })
    .then(r => r.json())
    .then(data => {
      pendingAttachment = {
        type: "file",
        path: data.path,
        label: data.label
      };
    });
};

/* =========================
   OPEN PINNED FILE / FOLDER
========================= */

function openPinnedReference(msg) {
  if (!msg.attached_path) return;

  const parts = msg.attached_path.split("/");
  const folder = parts.slice(0, -1).join("/");

  loadFolder(folder);
  waitForFileAndPreview(msg.attached_path);
}

function waitForFileAndPreview(path, tries = 10) {
  const file = currentFolderFiles.find(f => f.path === path);
  if (file) {
    loadBigPreview(file);
    return;
  }
  if (tries > 0) {
    setTimeout(() => waitForFileAndPreview(path, tries - 1), 300);
  }
}
</script>
<script>
document.getElementById("siteFeedbackBtn").onclick = () => {
  window.location.href = "feedback/";
};
</script>

{% endblock %}