{% extends "base.html" %}
{% load static %}
{% block title %}Office Dashboard ‚Äî Vadrida{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="{% static 'css/dashboard.css' %}">
{% endblock %}

{% block content %}
<div class="relative">
  <!-- Loading overlay for Analyse action -->
  <div id="analyseLoading" class="loading-overlay hidden">
    <div class="spinner"></div>
    <div class="text-lg font-semibold">Analyzing ‚Äî please wait...</div>
    <div class="text-sm">Processing your file...</div>
  </div>

  <div class="grid dashboard-grid gap-6">
    <!-- LEFT: file list + dropdown + file info -->
    <aside class="bg-white rounded-lg p-4 shadow-sm flex flex-col">
      <div class="flex items-center justify-between mb-4">
        <h3 class="font-montserrat font-semibold">Files</h3>
        <button id="refreshFolders" class="px-3 py-1 border rounded text-sm">üîÑ</button>
      </div>

     

      <div class="mb-3">
        <input id="fileSearch" type="text" placeholder="Search file id or name..." class="w-full p-2 rounded border" />
      </div>

      <div class="file-list-scroll mb-4">

       <div class="flex items-center gap-2 mb-2 text-sm">
        <button id="goBackBtn" class="px-2 py-1 border rounded">‚¨Ö</button>
        <span id="currentPath">/</span>
       </div>

       <ul id="fileList" class="space-y-2 text-sm"></ul>
      </div>

      <!-- File info moved into left panel -->
      <div class="file-info bg-white border rounded p-3 mt-auto">
        <h4 class="font-semibold mb-2">File Info</h4>
        <div id="fileInfoBox" class="text-sm text-gray-600">
          Select a file to see details.
        </div>
      </div>
    </aside>

    <!-- CENTER: Big preview + controls -->
    <section class="bg-white rounded-lg p-2 shadow-sm relative flex flex-col h-full">
      <div class="flex items-center justify-between mb-3">
        <h3 class="font-montserrat font-semibold">Preview</h3>
        <div>
          <button id="analyseBtn" class="analyse-btn px-4 py-2 rounded mr-2">Analyse</button>
          <button id="openFullBtn" class="px-3 py-2 border rounded">Open Full</button>
        </div>
      </div>

        <!-- Thumbnails row (populated dynamically) -->
        <div id="thumbs"
            class="grid grid-cols-3 gap-3 mb-3 overflow-y-auto flex-none"
            style="height: 220px;">
        </div>


        <!-- Large viewer -->
        <div class="rounded border overflow-hidden flex-1 flex flex-col min-h-0">

        <div id="bigPreviewHeader" class="flex items-center justify-between px-4 py-0 bg-white border-b">
          <div class="font-medium" id="bigPreviewTitle">No file selected</div>
          <div class="flex items-center gap-3">
            <a id="downloadPdfBtn" class="px-3 py-1 border rounded text-sm hidden download-btn" href="#" download><i class="fas fa-file-download mr-2"></i>Download</a>
          </div>
        </div>

        <div id="bigViewer" class="w-full flex-1 flex flex-col overflow-hidden">
            <div id="noSelection" class="h-full flex items-center justify-center text-gray-400">
                Select a file to view a large preview here.
            </div>
           <div id="pdfWrapper" class="flex h-full hidden">

                <div id="pdfMain" class="flex-1 overflow-y-auto bg-gray-100"></div>
           </div>


            <img id="bigImageFrame" class="w-full h-full hidden object-contain" src="" alt="preview" />
        </div>
      </div>
    </section>

    <!-- RIGHT: WhatsApp-Style Chat -->
    <aside class="bg-white rounded-lg p-4 shadow-sm flex flex-col">
      <!-- Header -->
      <div class="flex items-center justify-between mb-3">
        <h3 class="font-montserrat font-semibold">Chat</h3>
        <div class="text-sm text-gray-500">Agent</div>
      </div>

      <!-- Chat Area -->
      <div id="chatBox" class="chat-box bg-gray-50 rounded p-3 mb-3 flex-1 overflow-y-auto space-y-4">
        <!-- Example Messages -->
        <div class="flex flex-col">
          <span class="text-xs text-gray-500 mb-1">Agent</span>
          <div class="bg-white p-3 rounded-xl shadow-sm max-w-[75%]">
            Hi! Ready to help you with document analysis.
          </div>
        </div>
      </div>

      <!-- Typing Box -->
      <form id="chatForm" class="flex items-center gap-2">
        <!-- File Upload -->
        <label class="cursor-pointer">
          <input type="file" id="fileInput" class="hidden" accept="image/*,.pdf,.doc,.docx" />
          <i class="fas fa-paperclip text-royal-blue-700 text-xl"></i>
        </label>

        <!-- Text Input -->
        <input
          id="chatInput"
          type="text"
          placeholder="Type a message..."
          class="flex-1 border border-gray-300 rounded-full px-4 py-2 focus:outline-none focus:ring-2 focus:ring-royal-blue-500"
        />

        <!-- Send Button -->
        <button type="submit" class="bg-royal-blue-600 text-white px-4 py-2 rounded-full">
          <i class="fas fa-paper-plane"></i>
        </button>
      </form>
    </aside>

    <!-- Fullscreen modal for preview -->
    <div id="fullscreenModal" aria-hidden="true">
      <div class="modal-box">
        <div class="flex items-center justify-between p-3 border-b bg-white">
          <div class="font-semibold" id="modalTitle">Preview</div>

          <div class="flex items-center gap-3">
          <div id="shareButtonsContainer" class="flex space-x-2 mt-2 hidden">
            <a href="#" id="shareWhatsapp" class="px-3 py-2 rounded border text-sm share-btn">
              <i class="fab fa-whatsapp mr-2"></i>WhatsApp
            </a>
            <a href="#" id="shareTelegram" class="px-3 py-2 rounded border text-sm share-btn">
              <i class="fab fa-telegram mr-2"></i>Telegram
            </a>
            <a href="#" id="shareEmail" class="px-3 py-2 rounded border text-sm share-btn">
              <i class="fas fa-envelope mr-2"></i>Email
            </a>
            <a href="#" id="shareCopy" class="px-3 py-2 rounded border text-sm share-btn">
              <i class="fas fa-link mr-2"></i>Copy Link
            </a>
          </div>

          <!-- Main Share button to toggle these -->
          <a id="modalShare" href="#" class="px-3 py-2 rounded border text-sm share-btn">
            <i class="fas fa-share-alt mr-2"></i>Share
          </a>

            <!-- <button id="modalSaveFolder" class="px-3 py-2 border rounded text-sm"><i class="fas fa-folder mr-2"></i>Save</button> -->

            <!-- Download button -->
          
            <a id="modalDownloadBtn" href="#" download class="px-3 py-2 rounded border text-sm download-btn"><i class="fas fa-file-download mr-2"></i>Download</a>

            <button id="modalClose" class="px-3 py-2 border rounded text-sm">Close</button>
          </div>
        </div>

        <div id="modalBody" class="modal-inner">
          <iframe id="modalFrame" class="w-full h-full border-0 hidden" src=""></iframe>
          <img id="modalImage" class="w-full h-full object-contain hidden" src="" alt="preview" />
        </div>
      </div>
    </div>
  </div>
</div>
<!-- Analyse Modal -->
<div id="analyseModal"
     class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">

  <div class="bg-white rounded-xl p-6 w-96 shadow-xl">
    <h2 class="text-lg font-semibold mb-4">Analyse Files</h2>
    <p class="text-sm text-gray-600 mb-4">Choose files for analysis</p>

    <button id="analyseSelectFiles"
            class="w-full mb-3 px-4 py-2 bg-blue-600 text-white rounded">
      Select Files
    </button>

    <button id="analyseSelectAll"
            class="w-full px-4 py-2 bg-green-600 text-white rounded">
      Select All Files
    </button>

    <button id="analyseClose"
            class="w-full mt-4 px-4 py-2 border rounded">
      Cancel
    </button>
  </div>
</div>
<!-- File Selection List Modal -->
<div id="fileSelectModal"
     class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">

  <div class="bg-white rounded-xl p-6 w-[420px] shadow-xl">
    <h2 class="text-lg font-semibold mb-4">Select Files</h2>

    <div id="fileSelectList" class="max-h-64 overflow-y-auto border rounded p-3 mb-4"></div>

    <button id="confirmFileSelection"
            class="w-full px-4 py-2 bg-blue-600 text-white rounded">
      Confirm Selection
    </button>

    <button id="fileSelectClose"
            class="w-full mt-3 px-4 py-2 border rounded">
      Cancel
    </button>
  </div>
</div>
<!-- FILE LIST PANEL -->
<div class="card glass-panel mt-4 p-3">
    <!-- <h5 class="mb-3">Uploaded Files</h5> -->
    <ul id="file-list" class="file-list"></ul>
</div>


<script>
/* =========================
   CSRF
========================= */
function getCookie(name) {
  let v = null;
  document.cookie?.split(";").forEach(c => {
    c = c.trim();
    if (c.startsWith(name + "=")) v = decodeURIComponent(c.slice(name.length + 1));
  });
  return v;
}
const csrftoken = getCookie("csrftoken");


/* =========================
   ELEMENTS
========================= */
const fileList = document.getElementById("fileList");
const thumbsContainer = document.getElementById("thumbs");

const bigPdfFrame = document.getElementById("bigPdfFrame");
const bigImageFrame = document.getElementById("bigImageFrame");

const noSelection = document.getElementById("noSelection");

const bigPreviewTitle = document.getElementById("bigPreviewTitle");
const downloadPdfBtn = document.getElementById("downloadPdfBtn");
const openModalBtn = document.getElementById("openFullBtn");

const fileInfoBox = document.getElementById("fileInfoBox");

/* =========================
   STATE
========================= */
let currentFolder = "";
let currentFile = null;
let folderFiles = [];
let analysisController = null;


let rootFoldersCache = null; // initial state
let isSearching = false;



/* =========================
   FOLDER LOADER (SINGLE SOURCE)
========================= */
let pathStack = [];

function loadFolder(path = "") {
  if (pathStack[pathStack.length - 1] !== path) {
    pathStack.push(path);
  }

  document.getElementById("currentPath").textContent =
    "/" + pathStack.join("/");

  fetch(`/coreapi/api/folder-contents/?path=${encodeURIComponent(path)}`)
    .then(r => r.json())
    .then(data => {
      renderFileList(data.folders, data.files);
      renderThumbs(data.files);   // ‚úÖ THIS WAS MISSING
    });
}

document.getElementById("goBackBtn").onclick = () => {
  pathStack.pop();
  const prev = pathStack.pop() || "";
  loadFolder(prev);
};



document.getElementById("goBackBtn").onclick = () => {
  pathStack.pop(); // current
  const prev = pathStack.pop() || "";
  loadFolder(prev);
};

/* =========================
   FILE LIST
========================= */

function renderFileList(folders, files) {
  fileList.innerHTML = "";

  // Folders
  folders.forEach(folder => {
    const li = document.createElement("li");
    li.className = "p-2 cursor-pointer hover:bg-blue-50 flex items-center gap-2";
    li.innerHTML = `üìÅ <strong>${folder.name}</strong>`;

    li.onclick = () => loadFolder(folder.path);
    fileList.appendChild(li);
  });

  // Files
  files.forEach(file => {
    const li = document.createElement("li");
    li.className = "p-2 cursor-pointer hover:bg-gray-100";
    li.innerHTML = `
      <div class="font-medium">${file.name}</div>
      <div class="text-xs text-gray-500">${file.extension || ""}</div>
    `;

    // üî¥ THIS WAS MISSING
    li.onclick = () => loadBigPreview(file);
    li.onclick = () => {
  document.querySelectorAll("#fileList li")
    .forEach(el => el.classList.remove("bg-blue-100"));

  li.classList.add("bg-blue-100");
  loadBigPreview(file);
};

    fileList.appendChild(li);
  });

  if (!folders.length && !files.length) {
    fileList.innerHTML =
      `<li class="p-3 text-gray-400">No results</li>`;
  }
}

/* =========================
   THUMBNAILS
========================= */

async function renderPdfThumbnail(file, container) {
  await loadPdfJsIfNeeded();

  const url = `/coreapi/serve-file/?path=${encodeURIComponent(file.path)}`;
  const pdf = await pdfjsLib.getDocument(url).promise;
  const page = await pdf.getPage(1);

  const viewport = page.getViewport({ scale: 0.3 });
  const canvas = document.createElement("canvas");
  canvas.width = viewport.width;
  canvas.height = viewport.height;

  await page.render({
    canvasContext: canvas.getContext("2d"),
    viewport
  }).promise;

  container.appendChild(canvas);
}


async function renderThumbs(files) {
  thumbsContainer.innerHTML = "";

  if (!files.length) {
    thumbsContainer.innerHTML =
      `<div class="text-sm text-gray-400">No previews</div>`;
    return;
  }

  for (const file of files) {
    const card = document.createElement("div");
    card.className = "thumb-item cursor-pointer flex items-center justify-center";

    const ext = file.name.split(".").pop().toLowerCase();


    if (["jpg","jpeg","png","gif","bmp"].includes(ext)) {
      const img = document.createElement("img");
      img.src = `/coreapi/serve-file/?path=${encodeURIComponent(file.path)}`;
      img.loading = "lazy";
      img.style.maxHeight = "100%";
      img.style.objectFit = "contain";
      card.appendChild(img);
    }
    else if (ext === "pdf") {
      // üî¥ REAL PDF THUMBNAIL
      renderPdfThumbnail(file, card);
    }
    else {
      card.innerHTML = `
        <div class="text-sm text-gray-500">
          <i class="fas fa-file"></i><br>${ext.toUpperCase()}
        </div>
      `;
    }

    // üî¥ THIS WAS MISSING
    card.onclick = () => loadBigPreview(file);

    thumbsContainer.appendChild(card);
  }
}

/* =========================
   PREVIEW
========================= */
function loadBigPreview(file) {
  currentFile = file;

  // Hide everything first
  pdfWrapper.classList.add("hidden");
  bigImageFrame.classList.add("hidden");
  noSelection.classList.add("hidden");

  const url = `/coreapi/serve-file/?path=${encodeURIComponent(file.path)}`;
  bigPreviewTitle.textContent = file.name;

  const ext = file.name.split(".").pop().toLowerCase();

  // IMAGE
  if (["jpg","jpeg","png","gif","bmp"].includes(ext)) {
    bigImageFrame.src = url;
    bigImageFrame.classList.remove("hidden");
    return;
  }

  // PDF
  if (ext === "pdf") {
    pdfWrapper.classList.remove("hidden");
    renderFullPdf(url);
    return;
  }

  // OTHER
  noSelection.textContent = "Preview not available";
  noSelection.classList.remove("hidden");
}

/* =========================
   FILE INFO
========================= */
function setFileInfo(file) {
  fileInfoBox.innerHTML = `
    <div><strong>Name:</strong> ${file.name}</div>
    <div><strong>Type:</strong> ${file.extension || ""}</div>
    <div><strong>Size:</strong> ${file.size || ""}</div>
  `;
}


/* =========================
   ANALYSE (UNCHANGED LOGIC)
========================= */
function startAnalysis(files) {
  if (analysisController) {
    analysisController.abort();
  }

  analysisController = new AbortController();
  document.getElementById("analyseLoading").classList.remove("hidden");

  fetch("/coreapi/api/analyze/", {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "X-CSRFToken": csrftoken
    },
    body: JSON.stringify({ files, folder: currentFolder }),
    signal: analysisController.signal
  })
  .then(r => r.json())
  .then(() => loadFolder(currentFolder))
  .finally(() => {
    document.getElementById("analyseLoading").classList.add("hidden");
    analysisController = null;
  });
}


// file search--------------


const searchInput = document.getElementById("fileSearch");

let searchTimer = null;

searchInput.addEventListener("input", e => {
  const q = e.target.value.trim();

  clearTimeout(searchTimer);

  searchTimer = setTimeout(() => {
    if (!q) {
      // RESET to original state
      isSearching = false;
      if (rootFoldersCache) {
        renderFileList(
          rootFoldersCache.folders || [],
          rootFoldersCache.files || []
        );
        renderThumbs(rootFoldersCache.files || []);
      } else {
        loadFolder("");
      }
      return;
    }

    globalSearch(q);
  }, 300); // debounce
});


// render full pdf


async function renderFullPdf(url) {
  await loadPdfJsIfNeeded();

  const pdf = await pdfjsLib.getDocument(url).promise;
  pdfMain.innerHTML = "";

  for (let i = 1; i <= pdf.numPages; i++) {
    const page = await pdf.getPage(i);

    const viewport = page.getViewport({ scale: 1.4 });
    const canvas = document.createElement("canvas");

    canvas.width = viewport.width;
    canvas.height = viewport.height;

    await page.render({
      canvasContext: canvas.getContext("2d"),
      viewport
    }).promise;

    pdfMain.appendChild(canvas);
  }
}



// pdf.js loadeer===========

let pdfJsLoaded = false;

function loadPdfJsIfNeeded() {
  if (window.pdfjsLib) return Promise.resolve();

  return new Promise((resolve, reject) => {
    const script = document.createElement("script");
    script.src = "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js";

    script.onload = () => {
      pdfjsLib.GlobalWorkerOptions.workerSrc =
        "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js";
      resolve();
    };

    script.onerror = reject;
    document.head.appendChild(script);
  });
}


// Global search ============

function globalSearch(query) {
  isSearching = true;

  fileList.innerHTML = `<li class="p-2 text-gray-400">Searching...</li>`;
  thumbsContainer.innerHTML = "";

  fetch(`/coreapi/api/search/?q=${encodeURIComponent(query)}`)
    .then(r => r.json())
    .then(data => {
      // Expected response:
      // { folders: [...], files: [...] }

      renderFileList(data.folders || [], data.files || []);
      renderThumbs(data.files || []);
    })
    .catch(() => {
      fileList.innerHTML = `<li class="p-2 text-red-500">Search failed</li>`;
    });
}


// reload------------

document.getElementById("refreshFolders").onclick = () => {
  fetch("/coreapi/api/refresh/")
    .then(() => {
      rootFoldersCache = null;
      searchInput.value = "";
      loadFolder("");
    });
};



// fullscreen modal -------------

const fullscreenModal = document.getElementById("fullscreenModal");
const modalFrame = document.getElementById("modalFrame");
const modalImage = document.getElementById("modalImage");

document.getElementById("openFullBtn").onclick = () => {
  if (!currentFile) {
    alert("Select a file first");
    return;
  }

  const url = `/coreapi/serve-file/?path=${encodeURIComponent(currentFile.path)}`;
  const ext = currentFile.name.split(".").pop().toLowerCase();

  fullscreenModal.classList.add("active");

  modalFrame.classList.add("hidden");
  modalImage.classList.add("hidden");

  if (["jpg","jpeg","png","gif","bmp"].includes(ext)) {
    modalImage.src = url;
    modalImage.classList.remove("hidden");
  } else {
    modalFrame.src = url;
    modalFrame.classList.remove("hidden");
  }
};

document.getElementById("modalClose").onclick = () => {
  fullscreenModal.classList.remove("active");
  modalFrame.src = "";
  modalImage.src = "";
};


/* =========================
   INIT
========================= */
document.addEventListener("DOMContentLoaded", () => {
  console.log("Dashboard JS loaded");
  loadFolder("");
});

</script>


{% endblock %}