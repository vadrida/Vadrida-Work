{% extends "base.html" %}
{% load static %}
{% block title %}Valuation Report Editor{% endblock %}

{% block extra_head %}
<link href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.css" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<style>

    body { background-color: #525659; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }

    *, *:before, *:after { box-sizing: border-box; }



    .paper-container {

        margin-top: 50px; display: flex; flex-direction: column; align-items: center; gap: 30px; margin-bottom: 100px;

    }



    /* PDF Page Simulation A4 */

    .pdf-sheet {

        width: 210mm; 

        min-height: 297mm; 

        background: white; 

        padding: 15mm; 

        box-shadow: 0 0 10px rgba(0,0,0,0.5); 

        font-size: 9pt; 

        position: relative; 

        box-sizing: border-box;

        overflow: hidden; /* Keeps content inside A4 page */

    }



    /* --- LOGO STYLING --- */

    .header-logo {

        position: absolute; top: 10mm; right: 15mm; width: 25mm; height: auto; object-fit: contain;

    }


    input[type="checkbox"], input[type="radio"] {
            accent-color: #008000 !important; /* Force Green */
            cursor: pointer;
            width: 13px;
            height: 13px;
            /* Ensure background prints */
            -webkit-print-color-adjust: exact; 
            print-color-adjust: exact;
        }
    /* Typography & Layout */

    h1 { margin: 10px 0 15px 0; font-size: 16pt; text-transform: uppercase; text-align: center; color: #333; }

    

    .section-title { 

        background: #e0e0e0; padding: 4px 8px; font-weight: bold; 

        border: 1px solid #999; margin-top: 15px; margin-bottom: 5px; font-size: 10pt;

    }

    

    .row { 

        display: flex; gap: 10px; margin-bottom: 5px; align-items: baseline; 

    }

    

    label { font-weight: bold; color: #555; font-size: 8pt; margin-right: 5px; white-space: nowrap; }



    /* --- IMPROVED FIELD BOX (THE FIX) --- */

    .field-box { 

        border-bottom: 1px dotted #000; 

        min-height: 18px; 

        line-height: 1.4; 

        background: #fcfcfc; 

        color: #000; 

        flex-grow: 1; 

        padding: 2px 4px;

        

        /* Text Wrapping Logic */

        white-space: pre-wrap;       /* Preserves spaces/newlines, wraps text */

        word-wrap: break-word;       /* Breaks long words */

        overflow-wrap: break-word;   /* Standard property for breaking */

        word-break: break-word;      

        

        /* Display Logic */

        display: block; 

        width: 100%; 

        overflow: visible;           /* ALLOWS EXPANSION */

    }



    [contenteditable="true"]:focus { background-color: #e8f0fe; outline: none; border-bottom: 1px solid blue; }

    [contenteditable="true"]:hover { background-color: #fffde7; cursor: text; }



    /* --- TABLE STYLES (STRICT) --- */

    .report-table { 

        width: 100%; 

        border-collapse: collapse; 

        table-layout: fixed; /* STRICT COLUMN WIDTHS */

        margin-bottom: 10px;

    }

    .report-table th, .report-table td { 

        border: 1px solid #999; 

        padding: 4px; 

        text-align: center; 

        vertical-align: middle; 

        

        /* Allow cell to grow vertically, but not horizontally */

        overflow-wrap: break-word; 

        word-break: break-word;

    }

    .report-table th { background: #f0f0f0; font-weight: bold; }

    

    /* Input inside table cells */

    .report-table .field-box { 

        border-bottom: none; 

        background: transparent; 

        width: 100%; 

        min-height: 100%; 

        text-align: center;

    }



    /* --- HEADER INPUT WRAPPER (BOUNDARY TABLE) --- */

    .header-input-wrapper {

        display: flex;

        flex-direction: column;

        align-items: center;

        gap: 2px;

        width: 100%; /* Force it to fit the TH */

    }



    .header-input {

        border-bottom: 1px solid #ccc !important; /* Force line visibility */

        background: transparent;

        width: 100%; 

        min-height: 18px;

        font-weight: bold;

        text-align: center;

        font-size: 8pt;

        outline: none;

    }



    /* --- STACKED ROWS (NOTES) --- */

    .row-stacked {

        display: flex;

        flex-direction: column;

        gap: 5px;

        margin-bottom: 10px;

        width: 100%;

    }

    .row-stacked label { font-weight: bold; color: #555; font-size: 9pt; }

    .row-stacked .field-box {

        border: 1px solid #ddd;

        border-radius: 4px;

        padding: 8px;

        min-height: 60px; /* Taller default for notes */

    }



    /* Checkbox Styles */

    .checkbox-group { display: flex; flex-wrap: wrap; gap: 8px 12px; align-items: center; }

    .checkbox-item { display: flex; align-items: center; gap: 4px; font-size: 8pt; cursor: pointer; }

    .checkbox-item input { margin: 0; cursor: pointer; }

    .checkbox-grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 2px 4px; width: 100%; text-align: left; }

    .checkbox-grid-2 .checkbox-item { font-size: 7.5pt; justify-content: flex-start; }



    /* Image Wrapper */

    .img-wrapper { width: 100%; min-height: 50px; margin: 10px 0; display: flex; justify-content: center; align-items: center; }

    .img-wrapper img { max-width: 100%; max-height: 500px; width: auto; height: auto; object-fit: contain; display: block; margin: 0 auto; }



    /* Save UI */

    .floating-save { position: fixed; bottom: 20px; right: 20px; z-index: 1000; }

    .btn-save { background: #28a745; color: white; padding: 15px 30px; border: none; border-radius: 50px; font-size: 16px; font-weight: bold; box-shadow: 0 4px 6px rgba(0,0,0,0.3); cursor: pointer; }

    

    /* Print Hiding */

    @media print {

        .floating-save, .nav-left, .btn-save, button, .modal-overlay { display: none !important; }

        body { background-color: white; }

        .paper-container { margin: 0; }

        .pdf-sheet { box-shadow: none; margin: 0; width: 100%; height: auto; page-break-after: always; }

    }



    /* Modal Styles (kept compact for brevity, use your existing ones if they differ) */

    .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); z-index: 2000; display: flex; justify-content: center; align-items: center; }

    .hidden { display: none !important; }

    .save-dialog { width: 600px; height: 500px; background: white; border-radius: 12px; display: flex; flex-direction: column; overflow: hidden; box-shadow: 0 10px 25px rgba(0,0,0,0.3); }

    .dialog-header { padding: 15px 20px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; background: #f8f9fa; }

    .dialog-body { flex: 1; display: flex; flex-direction: column; overflow: hidden; }

    .toolbar-row { display: flex; gap: 10px; padding: 10px 15px; border-bottom: 1px solid #eee; background: #fff; align-items: center; }

    .path-bar { flex: 1; display: flex; align-items: center; gap: 8px; background: #f1f3f4; padding: 6px 10px; border-radius: 4px; border: 1px solid #ddd; }

    .path-input { border: none; background: transparent; width: 100%; outline: none; }

    .folder-list { flex: 1; overflow-y: auto; padding: 5px 0; }

    .folder-item { display: flex; align-items: center; padding: 10px 20px; cursor: pointer; border-bottom: 1px solid #f9f9f9; }

    .folder-item:hover { background-color: #e8f0fe; }

    .dialog-footer { padding: 15px 20px; border-top: 1px solid #eee; display: flex; justify-content: flex-end; gap: 10px; background: #f8f9fa; }

    .btn-dialog { padding: 8px 16px; border-radius: 4px; font-size: 14px; font-weight: 500; cursor: pointer; border: none; }

    .btn-cancel { background: white; border: 1px solid #ddd; color: #555; }

    .btn-confirm { background: #1a73e8; color: white; }

    .hidden-row { display: none !important; }

    /* --- FOOTER STYLING --- */

.pdf-footer {

    position: absolute;

    bottom: 15mm;       /* Align with page padding */

    left: 15mm;         /* Align with page padding */

    width: calc(100% - 30mm); /* Full width inside margins */

    border-top: 2px solid #333;

    padding-top: 5px;

    font-size: 10pt;

    font-family: 'Segoe UI', sans-serif;

    display: flex;

    justify-content: space-between;

    z-index: 10;

}



.footer-section {

    display: flex;

    flex-direction: column;

    gap: 3px;

}



.footer-item {

    color: #333;

    font-weight: 600;

}



.footer-item span {

    font-weight: normal;

    color: #000;

    margin-left: 5px;

}

</style>
{% endblock %}

{% block content %}

{{ google_maps_api_key|json_script:"google_maps_api_key" }}

<div class="paper-container">
    <div class="nav-left" style="margin-right: 650px;">
        <a href="{% url 'coreapi:feedback' %}" class="nav-link back-link">
            <i class="fas fa-arrow-left"></i> Back to Feedback
        </a>
    </div>

    <div class="pdf-sheet">
        <img 
            src="{% static 'images/VADRIDA LOGO.png' %}" 
            alt="Logo" 
            class="header-logo" 
            style="position: absolute; top: 10mm; right: 15mm; width: 25mm; height: auto; object-fit: contain;"
        >
        <h1>Site Inspection Report</h1>
        
        <div class="section-title">1. General Information</div>
        <div class="row">
            <div style="width: 50%;">
                <div class="row"><label>1.Office File No:</label><div class="field-box" contenteditable="true" data-path="Valuers_Checklist.Office_file_no"></div></div>
                <div class="row"><label>3. Inspection Date:</label><div class="field-box" contenteditable="true" data-path="Valuers_Checklist.inspection_date"></div></div>
            </div>
            <div style="width: 50%;">
                <div class="row"><label>2. Applicant Name:</label><div class="field-box" contenteditable="true" data-path="Valuers_Checklist.applicant_name"></div></div>
                <div class="row"><label>4. Person Met at site:</label><div class="field-box" contenteditable="true" data-path="Valuers_Checklist.person_met"></div></div>
            </div>
        </div>

        <div class="row" style="align-items: flex-start; margin-top: 10px;">
            <label>5. Product:</label>
            <div class="checkbox-group">
                <label class="checkbox-item"><input type="checkbox" data-bind-radio="Valuers_Checklist.product" value="1st Purchase"> 1st Purchase</label>
                <label class="checkbox-item"><input type="checkbox" data-bind-radio="Valuers_Checklist.product" value="construction"> Construction</label>
                <label class="checkbox-item"><input type="checkbox" data-bind-radio="Valuers_Checklist.product" value="topup"> Topup</label>
                <label class="checkbox-item"><input type="checkbox" data-bind-radio="Valuers_Checklist.product" value="pd"> PD</label>
                <label class="checkbox-item"><input type="checkbox" data-bind-radio="Valuers_Checklist.product" value="resale"> Resale</label>
                <label class="checkbox-item"><input type="checkbox" data-bind-radio="Valuers_Checklist.product" value="renovation"> Renovation</label>
                <label class="checkbox-item"><input type="checkbox" data-bind-radio="Valuers_Checklist.product" value="lap"> LAP</label>
                <label class="checkbox-item"><input type="checkbox" data-bind-radio="Valuers_Checklist.product" value="takeover"> Takeover</label>
                <label class="checkbox-item"><input type="checkbox" data-bind-radio="Valuers_Checklist.product" value="extension"> Extension</label>
                <label class="checkbox-item"><input type="checkbox" data-bind-radio="Valuers_Checklist.product" value="npa"> NPA</label>
            </div>
        </div>

        <div class="row" style="align-items: flex-start; margin-top: 10px;">
            <label>6. Documents Received:</label>
            <div class="checkbox-group">
                <label class="checkbox-item"><input type="checkbox" data-bind-array="Valuers_Checklist.documents_received" value="Agreement"> Agreement</label>
                <label class="checkbox-item"><input type="checkbox" data-bind-array="Valuers_Checklist.documents_received" value="Encumbrance"> Encumbrance</label>
                <label class="checkbox-item"><input type="checkbox" data-bind-array="Valuers_Checklist.documents_received" value="Building Permit"> Building Permit</label>
                <label class="checkbox-item"><input type="checkbox" data-bind-array="Valuers_Checklist.documents_received" value="Declaration"> Declaration</label>
                <label class="checkbox-item"><input type="checkbox" data-bind-array="Valuers_Checklist.documents_received" value="Location Sketch"> Location Sketch</label>
                <label class="checkbox-item"><input type="checkbox" data-bind-array="Valuers_Checklist.documents_received" value="Development Permit"> Development Permit</label>
                <label class="checkbox-item"><input type="checkbox" data-bind-array="Valuers_Checklist.documents_received" value="Title Deed"> Title Deed</label>
                <label class="checkbox-item"><input type="checkbox" data-bind-array="Valuers_Checklist.documents_received" value="Survey Sketch"> Survey Sketch</label>
                <label class="checkbox-item"><input type="checkbox" data-bind-array="Valuers_Checklist.documents_received" value="Building Certificate"> Building Certificate</label>
                <label class="checkbox-item"><input type="checkbox" data-bind-array="Valuers_Checklist.documents_received" value="LTR"> LTR</label>
                <label class="checkbox-item"><input type="checkbox" data-bind-array="Valuers_Checklist.documents_received" value="Building Tax receipt"> Building Tax receipt</label>
                <label class="checkbox-item"><input type="checkbox" data-bind-array="Valuers_Checklist.documents_received" value="Approved plan"> Approved plan</label>
                <label class="checkbox-item"><input type="checkbox" data-bind-array="Valuers_Checklist.documents_received" value="Possession"> Possession</label>
                <label class="checkbox-item"><input type="checkbox" data-bind-array="Valuers_Checklist.documents_received" value="Engineers plan"> Engineers plan</label>
            </div>
        </div>

        <div class="section-title">I. Ownership Analysis</div>
        <div class="row"><label>Owner(s) Name:</label><div class="field-box" contenteditable="true" data-path="Ownership_Analysis.owners_name"></div></div>
        <div class="checkbox-group">
            <label class="checkbox-item"><input type="radio" name="doc_verification" data-bind-radio="Ownership_Analysis.document_verification" value="same in all documents"> Same in all documents</label>
            <label class="checkbox-item"><input type="radio" name="doc_verification" data-bind-radio="Ownership_Analysis.document_verification" value="discrepancy noted"> Discrepancy noted</label>
        </div>
        <div class="row-stacked"><label>Notes on discrepancy</label><div class="field-box" contenteditable="true" data-path="Ownership_Analysis.Ownership_Analysis_notes"></div></div>
        <div class="img-wrapper" id="wrap_Ownership_Analysis_Ownership_Analysis_notes"></div>

        <div class="section-title">II. Survey Number & Land Extent</div>
        <div class="row" style="margin-bottom: 5px;">
            <div style="width: 50%;">
                <div class="row">
                    <label>District:</label>
                    <div class="field-box" contenteditable="true" data-path="Survey.district"></div>
                </div>
                <div class="row">
                    <label>Village:</label>
                    <div class="field-box" contenteditable="true" data-path="Survey.village"></div>
                </div>
            </div>
            <div style="width: 50%;">
                <div class="row">
                    <label>Taluk:</label>
                    <div class="field-box" contenteditable="true" data-path="Survey.taluk"></div>
                </div>
                <div class="row">
                    <label>Local Body:</label>
                    <div class="field-box" contenteditable="true" data-path="Survey.local_body_type"></div>
                </div>
            </div>
        </div>

        <div class="row" id="row_panchayat_name">
            <label>Grama Panchayat Name:</label>
            <div class="field-box" contenteditable="true" data-path="Survey.grama_panchayat"></div>
        </div>
        <table class="report-table">
            <thead>
                <tr>
                    <th>Doc Name</th>
                    <th>Scedule No</th>
                    <th>Re-Sy Block No</th>
                    <th>Re-Sy No</th>
                    <th>Re-Sy Sub Div No</th>
                    <th>Sy Block No</th>
                    <th>Sy No</th>
                    <th>Sy SubDiv No</th>
                    <th width="100px">Land Extent(Ares)</th>
                    <th width="100px">Land Classification</th>
                </tr>
            </thead>
            <tbody id="survey_dynamic_body"></tbody>
        </table>
        <div class="row" style="margin-top: 10px;">
            <label>Total LTR Extent:</label>
            <div class="field-box" contenteditable="true" data-path="Survey.total_ltr_extent" style="width: 150px; flex-grow: 0;"></div>
            
            <label style="margin-left: 20px;">Total Deed Extent:</label>
            <div class="field-box" contenteditable="true" data-path="Survey.total_deed_extent" style="width: 150px; flex-grow: 0;"></div>
        </div>

        <div class="row" style="margin-top: 10px; background: #fff3e0; padding: 5px; border: 1px solid #ffe0b2;">
            <div style="width: 50%;">
                <label>Are 3 sides Paddy land?</label>
                <div class="checkbox-group">
                    <label class="checkbox-item"><input type="checkbox" data-bind-radio="Survey.paddy_land_check" value="Yes"> Yes</label>
                    <label class="checkbox-item"><input type="checkbox" data-bind-radio="Survey.paddy_land_check" value="No"> No</label>
                </div>
            </div>
            <div style="width: 50%;">
                <label>Trees/Buildings before 2008?</label>
                <div class="checkbox-group">
                    <label class="checkbox-item"><input type="checkbox" data-bind-radio="Survey.trees_2008_check" value="Yes"> Yes</label>
                    <label class="checkbox-item"><input type="checkbox" data-bind-radio="Survey.trees_2008_check" value="No"> No</label>
                </div>
            </div>
        </div>
        <div class="row-stacked" style="margin-top:5px;"><label>Deviations in Survey no, land extend, land Classification ... etc. if any.</label><div class="field-box" contenteditable="true" data-path="Survey.survey_notes"></div></div>
        <div class="img-wrapper" id="wrap_Survey_survey_notes"></div>

        <div class="section-title">III. Boundary Analysis</div>
            <table class="report-table">
                <thead>
                    <tr>
                        <th style="width: 12%;">Direction</th>
                        
                        <th style="width: 24%;">
                            <div class="header-input-wrapper">
                                <div class="field-box header-input" contenteditable="true" data-path="Boundary_analysis_property_identification.ref_doc_1_name"></div>
                            </div>
                        </th>

                        <th style="width: 24%;">
                            <div class="header-input-wrapper">
                                <div class="field-box header-input" contenteditable="true" data-path="Boundary_analysis_property_identification.ref_doc_2_name"></div>
                            </div>
                        </th>

                        <th style="width: 20%;">Translation Reason</th>
                        
                        <th>Site</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><strong>East</strong></td>
                        <td><div class="field-box" contenteditable="true" data-path="Boundary_analysis_property_identification.east_doc1"></div></td>
                        <td><div class="field-box" contenteditable="true" data-path="Boundary_analysis_property_identification.east_doc2"></div></td>
                        <td><div class="field-box" contenteditable="true" data-path="Boundary_analysis_property_identification.east_translation"></div></td>
                        <td><div class="field-box" contenteditable="true" data-path="Boundary_analysis_property_identification.east_site"></div></td>
                    </tr>
                    <tr>
                        <td><strong>North</strong></td>
                        <td><div class="field-box" contenteditable="true" data-path="Boundary_analysis_property_identification.north_doc1"></div></td>
                        <td><div class="field-box" contenteditable="true" data-path="Boundary_analysis_property_identification.north_doc2"></div></td>
                        <td><div class="field-box" contenteditable="true" data-path="Boundary_analysis_property_identification.north_translation"></div></td>
                        <td><div class="field-box" contenteditable="true" data-path="Boundary_analysis_property_identification.north_site"></div></td>
                    </tr>
                    <tr>
                        <td><strong>West</strong></td>
                        <td><div class="field-box" contenteditable="true" data-path="Boundary_analysis_property_identification.west_doc1"></div></td>
                        <td><div class="field-box" contenteditable="true" data-path="Boundary_analysis_property_identification.west_doc2"></div></td>
                        <td><div class="field-box" contenteditable="true" data-path="Boundary_analysis_property_identification.west_translation"></div></td>
                        <td><div class="field-box" contenteditable="true" data-path="Boundary_analysis_property_identification.west_site"></div></td>
                    </tr>
                    
                    <tr>
                        <td><strong>South</strong></td>
                        <td><div class="field-box" contenteditable="true" data-path="Boundary_analysis_property_identification.south_doc1"></div></td>
                        <td><div class="field-box" contenteditable="true" data-path="Boundary_analysis_property_identification.south_doc2"></div></td>
                        <td><div class="field-box" contenteditable="true" data-path="Boundary_analysis_property_identification.south_translation"></div></td>
                        <td><div class="field-box" contenteditable="true" data-path="Boundary_analysis_property_identification.south_site"></div></td>
                    </tr>
                    
                </tbody>
            </table>

<div class="row-stacked">
    <label>Deviations in boundary if any ?</label>
    <div class="field-box" contenteditable="true" data-path="Boundary_analysis_property_identification.Boundary_property_notes"></div>
</div>
<div class="img-wrapper" id="wrap_Boundary_analysis_property_identification_Boundary_property_notes"></div>
<br><br><br><br><br><br><br><br><br><br>
        <div class="section-title">IV. Demarcations</div>
        <table class="report-table">
            <tr>
                <td style="width: 50px;"><strong>North</strong></td>
                <td>
                    <div class="checkbox-group">
                        <label class="checkbox-item"><input type="checkbox" data-bind-array="Demarcation.north" value="no demarcation"> No Demarcation</label>
                        <label class="checkbox-item"><input type="checkbox" data-bind-array="Demarcation.north" value="gi sheet fence"> GI Sheet Fence</label>
                        <label class="checkbox-item"><input type="checkbox" data-bind-array="Demarcation.north" value="Foundation"> Foundation</label>
                        <label class="checkbox-item"><input type="checkbox" data-bind-array="Demarcation.north" value="barbed wire"> Barbed Wire</label>
                        <label class="checkbox-item"><input type="checkbox" data-bind-array="Demarcation.north" value="steel pegs"> Steel Pegs</label>
                        <label class="checkbox-item"><input type="checkbox" data-bind-array="Demarcation.north" value="compound wall"> Compound Wall</label>
                        <label class="checkbox-item"><input type="checkbox" data-bind-array="Demarcation.north" value="bio fence"> Bio Fence</label>
                        <label class="checkbox-item"><input type="checkbox" data-bind-array="Demarcation.north" value="survey stone"> Survey Stone</label>
                        <label class="checkbox-item"><input type="checkbox" data-bind-array="Demarcation.north" value="wooden pegs"> Wooden Pegs</label>
                    </div>
                </td>
            </tr>
            <tr>
                <td><strong>East</strong></td>
                <td>
                    <div class="checkbox-group">
                        <label class="checkbox-item"><input type="checkbox" data-bind-array="Demarcation.east" value="no demarcation"> No Demarcation</label>
                        <label class="checkbox-item"><input type="checkbox" data-bind-array="Demarcation.east" value="gi sheet fence"> GI Sheet Fence</label>
                        <label class="checkbox-item"><input type="checkbox" data-bind-array="Demarcation.east" value="Foundation"> Foundation</label>
                        <label class="checkbox-item"><input type="checkbox" data-bind-array="Demarcation.east" value="barbed wire"> Barbed Wire</label>
                        <label class="checkbox-item"><input type="checkbox" data-bind-array="Demarcation.east" value="steel pegs"> Steel Pegs</label>
                        <label class="checkbox-item"><input type="checkbox" data-bind-array="Demarcation.east" value="compound wall"> Compound Wall</label>
                        <label class="checkbox-item"><input type="checkbox" data-bind-array="Demarcation.east" value="bio fence"> Bio Fence</label>
                        <label class="checkbox-item"><input type="checkbox" data-bind-array="Demarcation.east" value="survey stone"> Survey Stone</label>
                        <label class="checkbox-item"><input type="checkbox" data-bind-array="Demarcation.east" value="wooden pegs"> Wooden Pegs</label>
                    </div>
                </td>
            </tr>
            <tr>
                <td><strong>South</strong></td>
                <td>
                    <div class="checkbox-group">
                        <label class="checkbox-item"><input type="checkbox" data-bind-array="Demarcation.south" value="no demarcation"> No Demarcation</label>
                        <label class="checkbox-item"><input type="checkbox" data-bind-array="Demarcation.south" value="gi sheet fence"> GI Sheet Fence</label>
                        <label class="checkbox-item"><input type="checkbox" data-bind-array="Demarcation.south" value="Foundation"> Foundation</label>
                        <label class="checkbox-item"><input type="checkbox" data-bind-array="Demarcation.south" value="barbed wire"> Barbed Wire</label>
                        <label class="checkbox-item"><input type="checkbox" data-bind-array="Demarcation.south" value="steel pegs"> Steel Pegs</label>
                        <label class="checkbox-item"><input type="checkbox" data-bind-array="Demarcation.south" value="compound wall"> Compound Wall</label>
                        <label class="checkbox-item"><input type="checkbox" data-bind-array="Demarcation.south" value="bio fence"> Bio Fence</label>
                        <label class="checkbox-item"><input type="checkbox" data-bind-array="Demarcation.south" value="survey stone"> Survey Stone</label>
                        <label class="checkbox-item"><input type="checkbox" data-bind-array="Demarcation.south" value="wooden pegs"> Wooden Pegs</label>
                    </div>
                </td>
            </tr>
            <tr>
                <td><strong>West</strong></td>
                <td>
                    <div class="checkbox-group">
                        <label class="checkbox-item"><input type="checkbox" data-bind-array="Demarcation.west" value="no demarcation"> No Demarcation</label>
                        <label class="checkbox-item"><input type="checkbox" data-bind-array="Demarcation.west" value="gi sheet fence"> GI Sheet Fence</label>
                        <label class="checkbox-item"><input type="checkbox" data-bind-array="Demarcation.west" value="Foundation"> Foundation</label>
                        <label class="checkbox-item"><input type="checkbox" data-bind-array="Demarcation.west" value="barbed wire"> Barbed Wire</label>
                        <label class="checkbox-item"><input type="checkbox" data-bind-array="Demarcation.west" value="steel pegs"> Steel Pegs</label>
                        <label class="checkbox-item"><input type="checkbox" data-bind-array="Demarcation.west" value="compound wall"> Compound Wall</label>
                        <label class="checkbox-item"><input type="checkbox" data-bind-array="Demarcation.west" value="bio fence"> Bio Fence</label>
                        <label class="checkbox-item"><input type="checkbox" data-bind-array="Demarcation.west" value="survey stone"> Survey Stone</label>
                        <label class="checkbox-item"><input type="checkbox" data-bind-array="Demarcation.west" value="wooden pegs"> Wooden Pegs</label>
                    </div>
                </td>
            </tr>
        </table>
        <div class="row-stacked"><label>Notes if any</label><div class="field-box" contenteditable="true" data-path="Demarcation.demarcation_notes"></div></div>
        <div class="img-wrapper" id="wrap_Demarcation_demarcation_notes"></div>

        <div class="row-stacked"><label>Encroachment of Subject building to neighbouring property?</label><div class="field-box" contenteditable="true" data-path="Demarcation.enroachment_subject_to_neighbour"></div></div>
        <div class="img-wrapper" id="wrap_Demarcation_enroachment_subject_to_neighbour"></div>

        <div class="row-stacked"><label>Encroachment of Neighbour's building to subject property?</label><div class="field-box" contenteditable="true" data-path="Demarcation.enroachment_neighbour_to_subject"></div></div>
        <div class="img-wrapper" id="wrap_Demarcation_enroachment_neighbour_to_subject"></div>
    </div> 

    <div class="pdf-sheet">
        <div class="section-title">V. Access Nature/Right of Access</div>
        <table class="report-table">
            <tr>
                <td style="width: 80px;"><strong>1.Type of access as per Title Deed</strong></td>
                <td>
                    <div class="checkbox-group">
                        <label class="checkbox-item"><input type="checkbox" data-bind-array="Access.typeofaccess_titledeed" value="footway"> Footway</label>
                        <label class="checkbox-item"><input type="checkbox" data-bind-array="Access.typeofaccess_titledeed" value="panchayat rd"> Panchayat Rd</label>
                        <label class="checkbox-item"><input type="checkbox" data-bind-array="Access.typeofaccess_titledeed" value="corporation rd"> Corporation Rd</label>
                        <label class="checkbox-item"><input type="checkbox" data-bind-array="Access.typeofaccess_titledeed" value="national highway"> National Highway</label>
                        <label class="checkbox-item"><input type="checkbox" data-bind-array="Access.typeofaccess_titledeed" value="private way"> Private Way</label>
                        <label class="checkbox-item"><input type="checkbox" data-bind-array="Access.typeofaccess_titledeed" value="municipal rd"> Muncipal Rd</label>
                        <label class="checkbox-item"><input type="checkbox" data-bind-array="Access.typeofaccess_titledeed" value="pwd road"> PWD Road</label>
                        <label class="checkbox-item"><input type="checkbox" data-bind-array="Access.typeofaccess_titledeed" value="land locked"> Land Locked</label>
                    </div>
                </td>
            </tr>
            <tr>
                <td><strong>2.Type of access as per site visit</strong></td>
                <td>
                    <div class="checkbox-group">
                        <label class="checkbox-item"><input type="checkbox" data-bind-array="Access.typeofaccess_sitevisit" value="footway"> Footway</label>
                        <label class="checkbox-item"><input type="checkbox" data-bind-array="Access.typeofaccess_sitevisit" value="panchayat rd"> Panchayat Rd</label>
                        <label class="checkbox-item"><input type="checkbox" data-bind-array="Access.typeofaccess_sitevisit" value="corporation rd"> Corporation Rd</label>
                        <label class="checkbox-item"><input type="checkbox" data-bind-array="Access.typeofaccess_sitevisit" value="national highway"> National Highway</label>
                        <label class="checkbox-item"><input type="checkbox" data-bind-array="Access.typeofaccess_sitevisit" value="private way"> Private Way</label>
                        <label class="checkbox-item"><input type="checkbox" data-bind-array="Access.typeofaccess_sitevisit" value="municipal rd"> Muncipal Rd</label>
                        <label class="checkbox-item"><input type="checkbox" data-bind-array="Access.typeofaccess_sitevisit" value="pwd road"> PWD Road</label>
                        <label class="checkbox-item"><input type="checkbox" data-bind-array="Access.typeofaccess_sitevisit" value="land locked"> Land Locked</label>
                    </div>
                </td>
            </tr>
            <tr>
                <td><strong>3.If private way, No of users..?</strong></td>
                <td>
                    <div class="checkbox-group">
                        <label class="checkbox-item"><input type="checkbox" data-bind-array="Access.private_no_user" value="self use"> Self Use</label>
                        <label class="checkbox-item"><input type="checkbox" data-bind-array="Access.private_no_user" value="self & 1 user"> Self & 1 User</label>
                        <label class="checkbox-item"><input type="checkbox" data-bind-array="Access.private_no_user" value="self & 2 user"> Self & 2 User</label>
                        <label class="checkbox-item"><input type="checkbox" data-bind-array="Access.private_no_user" value="self + family"> Self + Family</label>
                    </div>
                </td>
            </tr>
            <tr>
                <td><strong>4.Demarcation of Private road</strong></td>
                <td>
                    <div class="checkbox-group">
                        <label class="checkbox-item"><input type="checkbox" data-bind-array="Access.private_rd_demarcation" value="no demarcation"> No Demarcation</label>
                        <label class="checkbox-item"><input type="checkbox" data-bind-array="Access.private_rd_demarcation" value="gi sheet fence"> GI Sheet Fence</label>
                        <label class="checkbox-item"><input type="checkbox" data-bind-array="Access.private_rd_demarcation" value="barbed wire"> Barbed Wire</label>
                        <label class="checkbox-item"><input type="checkbox" data-bind-array="Access.private_rd_demarcation" value="steel pegs"> Steel Pegs</label>
                        <label class="checkbox-item"><input type="checkbox" data-bind-array="Access.private_rd_demarcation" value="compound wall"> Compound Wall</label>
                        <label class="checkbox-item"><input type="checkbox" data-bind-array="Access.private_rd_demarcation" value="bio fence"> Bio Fence</label>
                        <label class="checkbox-item"><input type="checkbox" data-bind-array="Access.private_rd_demarcation" value="survey stone"> Survey Stone</label>
                        <label class="checkbox-item"><input type="checkbox" data-bind-array="Access.private_rd_demarcation" value="wooden pegs"> Wooden Pegs</label>
                    </div>
                </td>
            </tr>
            <tr>
                <td><strong>5.Least Width of Main Access in M</strong></td>
                <td>
                    <div class="checkbox-group">
                        <div class="field-box" contenteditable="true" data-path="Access.main_access_width"></div>
                    </div>
                </td>
            </tr>
            <tr>
                <td><strong>6.Vehicular Access</strong></td>
                <td>
                    <div class="checkbox-group">
                        <label class="checkbox-item"><input type="checkbox" data-bind-array="Access.vehicular_access" value="pedestrian"> Pedestrian</label>
                        <label class="checkbox-item"><input type="checkbox" data-bind-array="Access.vehicular_access" value="2-wheeler"> 2-Wheeler</label>
                        <label class="checkbox-item"><input type="checkbox" data-bind-array="Access.vehicular_access" value="3-wheeler"> 3-Wheeler</label>
                        <label class="checkbox-item"><input type="checkbox" data-bind-array="Access.vehicular_access" value="4-wheeler"> 4-Wheeler</label>
                    </div>
                </td>
            </tr>
             <tr>
                <td><strong>9.Material of Road</strong></td>
                <td>
                    <div class="checkbox-group">
                        <label class="checkbox-item"><input type="checkbox" data-bind-array="Access.road_material" value="mud road"> Mud Road</label>
                        <label class="checkbox-item"><input type="checkbox" data-bind-array="Access.road_material" value="gravel road"> Gravel Road</label>
                        <label class="checkbox-item"><input type="checkbox" data-bind-array="Access.road_material" value="concrete road"> Concrete Road</label>
                        <label class="checkbox-item"><input type="checkbox" data-bind-array="Access.road_material" value="paving tile rd"> paving Tile Rd.</label>
                        <label class="checkbox-item"><input type="checkbox" data-bind-array="Access.road_material" value="tar road"> Tar Road</label>
                    </div>
                </td>
            </tr>
            <tr>
                <td><strong>7.Least Width of Internal Roads</strong></td>
                <td>
                    <div class="checkbox-group">
                        <div class="field-box" contenteditable="true" data-path="Access.internal_road_width"></div>
                    </div>
                </td>
            </tr>
            <tr>
                <td width="100px"><strong>8.Weather the Internal Rd has connectivity to Main Access?</strong></td>
                <td>
                    <div class="checkbox-group">
                        <div class="field-box" contenteditable="true" data-path="Access.internal_to_main_connectivity"></div>
                    </div>
                </td>
            </tr>
           
        </table>
        <div class="row-stacked"><label>Notes on Discrepancy if any...</label><div class="field-box" contenteditable="true" data-path="Access.access_notes"></div></div>
        <div class="img-wrapper" id="wrap_Access_access_notes"></div>
<br><br><br><br><br><br><br><br><br><br>
        <div class="section-title">VI. For Purchase and Resale cases</div>
        <div class="row">
            <label>1.Buyer name</label><div class="field-box" contenteditable="true" data-path="Purchase_resale.buyer_name"></div>
        </div>
        <div class="row">
            <label>2.Seller name</label><div class="field-box" contenteditable="true" data-path="Purchase_resale.seller_name"></div>
            <label>3.Relation b/w Buyer and Seller, if any</label><div class="field-box" contenteditable="true" data-path="Purchase_resale.buyer_seller_relation"></div>
        </div>
        <div class="row">
            <label>4.Since how long the property is up for sale..? (months)</label><div class="field-box" contenteditable="true" data-path="Purchase_resale.property_sale_duration"></div>
        </div>
        <div class="row">
            <label>5.Brokers/OLX/99acers involved or how transaction happened..?</label><div class="field-box" contenteditable="true" data-path="Purchase_resale.transaction_method"></div>
        </div>
        <div class="row">
            <label>6.Land extend proposed for purchase..?</label><div class="field-box" contenteditable="true" data-path="Purchase_resale.purchase_land_extent"></div>
        </div>
        <div class="row">
            <label>7.Price Asked</label><div class="field-box" contenteditable="true" data-path="Purchase_resale.price_asked"></div>
            <label>8.Deal Breaker Value</label><div class="field-box" contenteditable="true" data-path="Purchase_resale.deal_breaker_value"></div>
        </div>
        <div class="row-stacked">
            <label>Notes</label><div class="field-box" contenteditable="true" data-path="Purchase_resale.purchase_resale_notes"></div>
        </div>
        <div class="img-wrapper" id="wrap_Purchase_resale_purchase_resale_notes"></div>

        <div class="section-title">VII. Building Analysis</div>
            <table class="report-table">
                <thead>
                    <tr>
                        <th>Floor No</th>
                        <th>Builtup Area (Mesured at Site)</th>
                        <th>No of Rooms</th>
                        <th>No of Kitchen</th>
                        <th>No of Bathrooms</th>
                        <th>Usage (Res/Comm/Ind)</th>
                        <th>Occupancy (Owner/Rented/Vacant/Applicant)</th>
                    </tr>
                </thead>
                <tbody id="building_dynamic_body">
                    </tbody>
            </table>
            <div class="row" style="margin-top: 10px;">
                <label>Building No:</label>
                <div class="field-box" contenteditable="true" data-path="Boundary_analysis.Building_no"></div>
                
                <label>Ward No:</label>
                <div class="field-box" contenteditable="true" data-path="Boundary_analysis.Ward"></div>
            </div>

            <div class="row">
                <label>If Rented - Amount:</label>
                <div class="field-box" contenteditable="true" data-path="Building_analysis.rent_amt"></div>
                
                <label>Duration:</label>
                <div class="field-box" contenteditable="true" data-path="Building_analysis.rent_duration"></div>
            </div>
        <div class="row-stacked"><label>Notes(Discrepancy respect to BUA, occupancy, alignment, orientation etc...)</label><div class="field-box" contenteditable="true" data-path="Building_analysis.building_analysis_notes"></div></div>
        <div class="img-wrapper" id="wrap_Building_analysis_building_analysis_notes"></div>

        <table class="report-table">
            <tr>
                <th>Roof Type</th>
                <td><label class="checkbox-item"><input type="checkbox" data-bind-array="Building_analysis.roof_type" value="RCC"> RCC</label></td>
                <td><label class="checkbox-item"><input type="checkbox" data-bind-array="Building_analysis.roof_type" value="Tiled"> Tiled</label></td>
                <td><label class="checkbox-item"><input type="checkbox" data-bind-array="Building_analysis.roof_type" value="Sheet"> Sheet</label></td>
                <td><label class="checkbox-item"><input type="checkbox" data-bind-array="Building_analysis.roof_type" value="Other"> Other</label></td>
            </tr>
            <tr>
                <th>Roof Percentage</th>
                <td><div class="field-box" contenteditable="true" data-path="Building_analysis.RCC_Percentage"></div></td>
                <td><div class="field-box" contenteditable="true" data-path="Building_analysis.Tiled_Percentage"></div></td>
                <td><div class="field-box" contenteditable="true" data-path="Building_analysis.Sheet_Percentage"></div></td>
                <td><div class="field-box" contenteditable="true" data-path="Building_analysis.Other_Percentage"></div></td>
            </tr>
        </table>

        <table class="report-table">
            <thead>
                <tr>
                    <th rowspan="2">Setback (m)</th>
                    <th colspan="2">Front Yard</th>
                    <th colspan="2">Side-1 Yard</th>
                    <th colspan="2">Side-2 Yard</th>
                    <th colspan="2">Rear Yard</th>
                </tr>
                <tr>
                    <th>Min</th><th>Max</th>
                    <th>Min</th><th>Max</th>
                    <th>Min</th><th>Max</th>
                    <th>Min</th><th>Max</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td><div class="field-box" contenteditable="true" data-path="Building_analysis.setback"></div></td>
                    <td><div class="field-box" contenteditable="true" data-path="Building_analysis.front_yard_min"></div></td>
                    <td><div class="field-box" contenteditable="true" data-path="Building_analysis.front_yard_max"></div></td>
                    <td><div class="field-box" contenteditable="true" data-path="Building_analysis.side1_yard_min"></div></td>
                    <td><div class="field-box" contenteditable="true" data-path="Building_analysis.side1_yard_max"></div></td>
                    <td><div class="field-box" contenteditable="true" data-path="Building_analysis.side2_yard_min"></div></td>
                    <td><div class="field-box" contenteditable="true" data-path="Building_analysis.side2_yard_max"></div></td>
                    <td><div class="field-box" contenteditable="true" data-path="Building_analysis.rear_yard_min"></div></td>
                    <td><div class="field-box" contenteditable="true" data-path="Building_analysis.rear_yard_max"></div></td>
                </tr>
            </tbody>
        </table>

       <div class="table-container" style="margin-top: 15px;">
            <table class="report-table" id="timelineTable" style="table-layout: fixed; width: 100%;">
                <tbody>
                     <tr id="row_year">
                        <td style="width: 150px; background: #f0f0f0; font-weight: bold;">Year</td>
                        </tr>
                    <tr id="row_percent">
                        <td style="width: 150px; background: #f0f0f0; font-weight: bold;">% Area</td>
                        </tr>
                </tbody>
            </table>
        </div>
        
        <div class="row-stacked">
            <label>Notes on number of carparks, wardrobes, kitchen cabinets, flooring material, interior decorations or any other amenities...</label>
            <div class="field-box" contenteditable="true" data-path="Building_analysis.amenities_notes"></div>
        </div>
        <div class="img-wrapper" id="wrap_Building_analysis_amenities_notes"></div>

        <div class="section-title">IX. Land Inspection Details</div>

            <table class="report-table" style="margin-bottom: 10px;">
                <tr>
                    <th>Nearest City</th><td><div class="field-box" contenteditable="true" data-path="land_inspection_details.nearest_city"></div></td>
                    <th>Nearest Highway</th><td><div class="field-box" contenteditable="true" data-path="land_inspection_details.nearest_Highway"></div></td>
                </tr>
                <tr>
                    <th>Nearest School</th><td><div class="field-box" contenteditable="true" data-path="land_inspection_details.nearest_school"></div></td>
                    <th>Nearest Railway</th><td><div class="field-box" contenteditable="true" data-path="land_inspection_details.nearest_railway"></div></td>
                </tr>
                <tr>
                    <th>Nearest Bus Stop</th><td><div class="field-box" contenteditable="true" data-path="land_inspection_details.nearest_busstop"></div></td>
                    <th>Nearest Hospital</th><td><div class="field-box" contenteditable="true" data-path="land_inspection_details.nearest_hospital"></div></td>
                </tr>
            </table>

            <table class="report-table" style="margin-top: 5px;">
            <tr>
                <th>CRZ</th>
                <td>
                    <label class="checkbox-item"><input type="checkbox" data-bind-radio="land_inspection_details.crz" value="Yes"> Yes</label>
                    <label class="checkbox-item"><input type="checkbox" data-bind-radio="land_inspection_details.crz" value="No"> No</label>
                </td>
                <th>Crematoriums</th>
                <td>
                    <label class="checkbox-item"><input type="checkbox" data-bind-radio="land_inspection_details.crematoriums" value="Yes"> Yes</label>
                    <label class="checkbox-item"><input type="checkbox" data-bind-radio="land_inspection_details.crematoriums" value="No"> No</label>
                </td>
            </tr>
            <tr>
                <th>Stigma</th>
                <td>
                    <label class="checkbox-item"><input type="checkbox" data-bind-radio="land_inspection_details.stigma" value="Yes"> Yes</label>
                    <label class="checkbox-item"><input type="checkbox" data-bind-radio="land_inspection_details.stigma" value="No"> No</label>
                </td>
                <th>Slums</th>
                <td>
                    <label class="checkbox-item"><input type="checkbox" data-bind-radio="land_inspection_details.slums" value="Yes"> Yes</label>
                    <label class="checkbox-item"><input type="checkbox" data-bind-radio="land_inspection_details.slums" value="No"> No</label>
                </td>
            </tr>
            <tr>
                <th>Communial Area</th>
                <td>
                    <label class="checkbox-item"><input type="checkbox" data-bind-radio="land_inspection_details.communial_area" value="Yes"> Yes</label>
                    <label class="checkbox-item"><input type="checkbox" data-bind-radio="land_inspection_details.communial_area" value="No"> No</label>
                </td>
                <th>Factory Abutting</th>
                <td>
                    <label class="checkbox-item"><input type="checkbox" data-bind-radio="land_inspection_details.factory_abutting" value="Yes"> Yes</label>
                    <label class="checkbox-item"><input type="checkbox" data-bind-radio="land_inspection_details.factory_abutting" value="No"> No</label>
                </td>
            </tr>
            <tr>
                <th>Defence Area</th>
                <td>
                    <label class="checkbox-item"><input type="checkbox" data-bind-radio="land_inspection_details.defence_area" value="Yes"> Yes</label>
                    <label class="checkbox-item"><input type="checkbox" data-bind-radio="land_inspection_details.defence_area" value="No"> No</label>
                </td>
                <th>Heritage Property</th>
                <td>
                    <label class="checkbox-item"><input type="checkbox" data-bind-radio="land_inspection_details.heritage_property" value="Yes"> Yes</label>
                    <label class="checkbox-item"><input type="checkbox" data-bind-radio="land_inspection_details.heritage_property" value="No"> No</label>
                </td>
            </tr>
            <tr>
                <th>Rubber Plantation</th>
                <td>
                    <label class="checkbox-item"><input type="checkbox" data-bind-radio="land_inspection_details.rubber_plantations" value="Yes"> Yes</label>
                    <label class="checkbox-item"><input type="checkbox" data-bind-radio="land_inspection_details.rubber_plantations" value="No"> No</label>
                </td>
                <th>Coconut Thope</th>
                <td>
                    <label class="checkbox-item"><input type="checkbox" data-bind-radio="land_inspection_details.coconut_thope" value="Yes"> Yes</label>
                    <label class="checkbox-item"><input type="checkbox" data-bind-radio="land_inspection_details.coconut_thope" value="No"> No</label>
                </td>
            </tr>
            <tr>
                <th>Buffer Zone</th>
                <td>
                    <label class="checkbox-item"><input type="checkbox" data-bind-radio="land_inspection_details.buffer_zone" value="Yes"> Yes</label>
                    <label class="checkbox-item"><input type="checkbox" data-bind-radio="land_inspection_details.buffer_zone" value="No"> No</label>
                </td>
                <th>Telecom Tower</th>
                <td>
                    <label class="checkbox-item"><input type="checkbox" data-bind-radio="land_inspection_details.telecommunication_tower" value="Yes"> Yes</label>
                    <label class="checkbox-item"><input type="checkbox" data-bind-radio="land_inspection_details.telecommunication_tower" value="No"> No</label>
                </td>
            </tr>
            <tr>
                <th>High Tension Wire</th>
                <td>
                    <label class="checkbox-item"><input type="checkbox" data-bind-radio="land_inspection_details.high_tension_wire_electrical_line" value="Yes"> Yes</label>
                    <label class="checkbox-item"><input type="checkbox" data-bind-radio="land_inspection_details.high_tension_wire_electrical_line" value="No"> No</label>
                </td>
                <th>Religious Struct</th>
                <td>
                    <label class="checkbox-item"><input type="checkbox" data-bind-radio="land_inspection_details.STCM_in_property" value="Yes"> Yes</label>
                    <label class="checkbox-item"><input type="checkbox" data-bind-radio="land_inspection_details.STCM_in_property" value="No"> No</label>
                </td>
            </tr>
        </table>

            <div class="row" style="margin-top: 10px;">
                <label>Railway Line Passing?</label> 
                <input type="checkbox" data-bind-radio="land_inspection_details.railway_pass" value="Yes"> Yes 
                <input type="checkbox" data-bind-radio="land_inspection_details.railway_pass" value="No"> No
                <label style="margin-left: 15px;">Distance:</label>
                <div class="field-box" contenteditable="true" data-path="land_inspection_details.railway_distance"></div>
            </div>

            <div class="row" style="margin-top: 10px;">
                <label>Encroachment (Subject to Prop):</label> 
                <input type="checkbox" data-bind-radio="land_inspection_details.enroachment_subject_to_prop" value="Yes"> Yes 
                <input type="checkbox" data-bind-radio="land_inspection_details.enroachment_subject_to_prop" value="No"> No
            </div>
            <div class="row">
                <label>Intrusion (Other to Subject):</label> 
                <input type="checkbox" data-bind-radio="land_inspection_details.intrusion_other_to_subject" value="Yes"> Yes 
                <input type="checkbox" data-bind-radio="land_inspection_details.intrusion_other_to_subject" value="No"> No
            </div>

            

            <div class="row-stacked" style="margin-top: 10px;">
                <label>Inspection Notes:</label>
                <div class="field-box" contenteditable="true" data-path="land_inspection_details.inspection_notes"></div>
            </div>
            <div class="img-wrapper" id="wrap_land_inspection_details_inspection_notes"></div>

        <div class="section-title">VIII. Landmark & Layout(Hand Sketch)</div>
        <label>Landmark:</label>
        <div class="field-box" contenteditable="true" data-path="Sketch.landmark_description"></div>
        <div class="img-wrapper" id="wrap_Sketch_landmark_description"></div>
        
        <p style="margin-top: 10px; font-weight: bold; color: #777;">Hand Sketch:</p>
        <div class="img-wrapper" id="wrap_Sketch_main_layout">
            <span style="width: 50px; margin-left: 450px; margin-bottom: 70px; "><img src="{% static 'images/compass-icon.png' %}" alt="compass"></span>
            <span style="color:#ccc;">(No sketch provided)</span>
            
        </div> 
        
        <div class="row-stacked" style="margin-top: 10px;">
            <label>Overall Remarks (Comments on land extend, sold value, sold date etc... comparing with the subject property)</label>
            <div class="field-box" contenteditable="true" data-path="Building_analysis.extra_remarks"></div>
        </div>
        <div class="img-wrapper" id="wrap_Building_analysis_extra_remarks"></div>
        <div class="row" style="margin-top: 10px; border: 1px solid #000; padding: 5px;">
                <label style="font-size: 11pt;">Recommented Land Value:</label>
                <div class="field-box" contenteditable="true" data-path="land_inspection_details.land_value" style="font-weight: bold; font-size: 11pt;"></div>
        </div>
        
     
        <div class="row-stacked" style="margin-top: 10px;">
            <label>Notes on Land Value references received</label>
            <div class="field-box" contenteditable="true" data-path="Building_analysis.val_references"></div>
        </div>
        <div class="img-wrapper" id="wrap_Building_analysis_val_references"></div>
        <div class="report-section">
            <h4>IX. Property Location</h4>
            
            <div style="border: 2px solid #333; border-radius: 4px; overflow: hidden; margin-top: 10px;">
                <img id="static_map_view" 
                    style="width: 100%; height: auto; display: block;" 
                    alt="Map Preview"
                    crossorigin="anonymous"> 
            </div>
                
            <div style="margin-top: 5px; font-size: 12px; color: #666;">
                <strong>GPS Coordinates:</strong> <span id="display_lat_lng">Not Selected</span>
            </div>
        </div>
        
        <br><br><br><br><br><br>
        <div class="pdf-footer">
            <div class="footer-section">
                <div class="footer-item">File No: <span id="ft_file_no">Loading...</span></div>
                <div class="footer-item">Applicant: <span id="ft_applicant">Loading...</span></div>
            </div>
            
            <div class="footer-section" style="text-align: right;">
                <div class="footer-item">Date: <span id="ft_date">Loading...</span></div>
                <div class="footer-item">TAT Status: <span id="ft_tat" style="font-weight: bold;">Loading...</span></div>
            </div>
        </div>
    </div>
    

    <div class="floating-save">
        <button id="saveFinal" class="btn-save"> Save Final PDF</button>
    </div>

</div>

<script>
    const reportId = "{{ report_id }}"; 
    let reportData = {};

    const TAT_LIMIT = 10; // Change this to 3 or 5 based on your requirement

    document.addEventListener("DOMContentLoaded", () => {
        // 1. Fetch Report Data
        fetch(`/coreapi/api/get-report-data/${reportId}/`)
            .then(r => r.json())
            .then(data => {
                reportData = data;
                
                // Render the form fields
                renderPage(); 
                renderStaticMap();

                // 2. Fetch Folder Info (Download Date) from Server
                if (reportData.target_folder) {
                    fetchFolderMetadata(reportData.target_folder);
                } else {
                    // No folder? Just populate what we have (T+0)
                    populateFooterDetails(null);
                }
            })
            .catch(err => console.error("Error loading data:", err));
    });
    function renderStaticMap() {
        console.log(" START: Rendering Static Map...");

        // 1. Debug: Check if reportData exists
        if (!reportData || Object.keys(reportData).length === 0) {
            console.error(" Error: reportData is empty. Map cannot render.");
            return;
        }

        // 2. Safely Retrieve Coordinates
        // We try to parse them as floats to ensure they aren't empty strings
        let lat = getNested(reportData, 'land_inspection_details.latitude');
        let lng = getNested(reportData, 'land_inspection_details.longitude');

        console.log(` Raw Data from DB -> Lat: "${lat}", Lng: "${lng}"`);

        // 3. Elements
        const imgElement = document.getElementById("static_map_view");
        const textElement = document.getElementById("display_lat_lng");

        if (!imgElement) {
            console.error(" HTML Error: #static_map_view image tag not found.");
            return;
        }

        // 4. Validate Coordinates
        // Ensure they are numbers and not zero/empty
        if (lat && lng && !isNaN(parseFloat(lat)) && !isNaN(parseFloat(lng))) {
            try {
                // 5. Get API Key
                const scriptTag = document.getElementById('google_maps_api_key');
                if (!scriptTag) {
                    console.error(" Setup Error: API Key JSON script tag is missing.");
                    return;
                }
                const apiKey = JSON.parse(scriptTag.textContent);

                // 6. Build URL
                const mapUrl = `https://maps.googleapis.com/maps/api/staticmap?center=${lat},${lng}&zoom=19&size=600x300&maptype=hybrid&markers=color:red%7C${lat},${lng}&key=${apiKey}`;
                
                console.log(" Map URL generated successfully.");

                // 7. Show Image
                imgElement.src = mapUrl;
                imgElement.classList.remove("hidden");
                imgElement.style.display = "block"; // Force display
                
                // 8. Update Text
                if(textElement) {
                    textElement.innerText = `${lat}, ${lng}`;
                    textElement.style.color = "black";
                }
                
            } catch (e) {
                console.error(" Map Logic Error:", e);
            }
        } else {
            console.warn(" Coordinates missing or invalid. Hiding map.");
            // Hide map if no data
            imgElement.style.display = 'none';
            if(textElement) {
                textElement.innerText = "Location not tagged (Go back to Feedback form)";
                textElement.style.color = "red";
            }
        }
    }
    // --- API CALL TO GET SERVER DATE ---
    function fetchFolderMetadata(path) {
        // We use your existing 'get_folder_contents_api'
        fetch(`/coreapi/api/folder-contents/?path=${encodeURIComponent(path)}`)
            .then(r => r.json())
            .then(data => {
                // Your view returns: { "folder_info": { "download_date": "DD/MM/YYYY" ... } }
                let serverDate = null;
                if (data.folder_info && data.folder_info.download_date) {
                    serverDate = data.folder_info.download_date;
                    console.log("Server Download Date:", serverDate);
                }
                populateFooterDetails(serverDate);
            })
            .catch(err => {
                console.warn("Folder fetch error:", err);
                populateFooterDetails(null); // Fallback
            });
    }
// Inside pdfedit.html script
function populateFooterDetails(dateOverride = null) {
    // 1. Basic Fields
    const fileNo = getNested(reportData, "Valuers_Checklist.Office_file_no") || "N/A";
    const applicant = getNested(reportData, "Valuers_Checklist.applicant_name") || "N/A";
    
    // 2. Current Date
    const today = new Date();
    const dStr = String(today.getDate()).padStart(2, '0');
    const mStr = String(today.getMonth() + 1).padStart(2, '0');
    const yStr = today.getFullYear();
    const todayFormatted = `${dStr}/${mStr}/${yStr}`;

    // 3. TAT Calculation
    let tatText = "T + 0"; // Default fallback
    let tatColor = "#333"; 

    //  PRIORITY: Use argument if passed, otherwise use saved report data
    const savedDate = dateOverride || reportData.meta_download_date; 

    if (savedDate) {
        try {
            console.log("Calculating TAT for date:", savedDate);

            // Robust Parsing: Handles "01.02.2024", "01/02/2024", "01-02-2024"
            const parts = savedDate.split(/[\.\-\/]/); 
            
            if (parts.length === 3) {
                const day = parseInt(parts[0], 10);
                const month = parseInt(parts[1], 10) - 1; // JS Month is 0-11
                const year = parseInt(parts[2], 10);
                
                const startDate = new Date(year, month, day);
                
                // Calculate Days Difference
                const msPerDay = 1000 * 60 * 60 * 24;
                
                // Normalize 'Today' to midnight to avoid hour mismatches
                const todayMid = new Date(today.getFullYear(), today.getMonth(), today.getDate());
                const startMid = new Date(startDate.getFullYear(), startDate.getMonth(), startDate.getDate());
                
                const diffTime = todayMid - startMid;
                const diffDays = Math.floor(diffTime / msPerDay);
                
                //  SET TEXT: Simply "T + Number", no matter how big
                tatText = `T + ${diffDays}`;

                // Color Logic (Optional: Keep colors, just remove text)
                // You can change '3' to whatever your limit is
                if (diffDays > 3) {
                    tatColor = "#d32f2f"; // Red for anything > 3
                } else {
                    tatColor = "#2e7d32"; // Green for 0-3
                }
            } else {
                console.warn("Invalid Date Format received:", savedDate);
            }
        } catch (e) {
            console.error("TAT Calculation error:", e);
        }
    }

    // 4. Update HTML
    document.getElementById("ft_file_no").textContent = fileNo;
    document.getElementById("ft_applicant").textContent = applicant;
    document.getElementById("ft_date").textContent = todayFormatted;
    
    const tatSpan = document.getElementById("ft_tat");
    if(tatSpan) {
        tatSpan.textContent = tatText;
        tatSpan.style.color = tatColor;
    }
}
    // --- 2. Render Data to HTML ---
    function renderPage() {
        // A. Fill Text Fields
        renderBuildingTableDynamic();
        
        document.querySelectorAll('[data-path]').forEach(el => {
            const path = el.getAttribute('data-path');
            const val = getNested(reportData, path);
            el.innerText = val !== undefined ? val : "";
        });

        // B. Handle Arrays (Checkboxes)
        document.querySelectorAll('input[data-bind-array]').forEach(el => {
            const path = el.getAttribute('data-bind-array');
            const val = el.value;
            const arr = getNested(reportData, path);
            if (Array.isArray(arr) && arr.includes(val)) el.checked = true;
            el.onchange = function() { updateArray(path, val, this.checked); };
        });

        // C. Handle Booleans
        document.querySelectorAll('input[data-bind-bool]').forEach(el => {
            const path = el.getAttribute('data-bind-bool');
            const val = getNested(reportData, path);
            if (val === true || val === "true") el.checked = true;
            el.onchange = function() { setNested(reportData, path, this.checked); };
        });
        
        // D. Handle Radios
        document.querySelectorAll('input[data-bind-radio]').forEach(el => {
             const path = el.getAttribute('data-bind-radio');
             const dbValue = getNested(reportData, path);
             if(dbValue && dbValue.toString().toLowerCase() === el.value.toLowerCase()) el.checked = true;
             el.onchange = function() {
                 if(this.checked) {
                     document.querySelectorAll(`input[data-bind-radio="${path}"]`).forEach(other => {
                         if(other !== this) other.checked = false;
                     });
                     setNested(reportData, path, this.value);
                 } else { setNested(reportData, path, ""); }
             }
        });

        // E. Render Images
        const images = reportData.images || {};
        for (const [key, b64] of Object.entries(images)) {
            if (!b64) continue; 
            const safeKey = key.replace(/\./g, '_');
            const wrapper = document.getElementById('wrap_' + safeKey);
            if (wrapper) {
                wrapper.innerHTML = `<img src="${b64}" id="img_${safeKey}" style="max-width: 100%; max-height: 400px; display: block; margin: 0 auto;" />`;
            }
        }

        // --- F. FIXED DYNAMIC TABLE LOGIC ---
        const surveyDocs = getNested(reportData, "Survey.docs") || [];
        const surveyBody = document.getElementById("survey_dynamic_body");
        
        if(surveyBody) {
            surveyBody.innerHTML = ""; 
            surveyDocs.forEach((doc, index) => {
                const tr = document.createElement("tr");
                const basePath = `Survey.docs.${index}`;
                
                // 1. Format Land Classification (Combine separate keys into one string)
                const landClassText = formatLandData(doc);

                // 2. Ensure Name is read (Fallback to empty string)
                const docName = doc.name || "";

                tr.innerHTML = `
                    <td><div class="field-box" contenteditable="true" data-path="${basePath}.name">${docName}</div></td>
                    <td><div class="field-box" contenteditable="true" data-path="${basePath}.scedule_no">${doc.scedule_no || ''}</div></td>
                    <td><div class="field-box" contenteditable="true" data-path="${basePath}.re_sy_block_no">${doc.re_sy_block_no || ''}</div></td>
                    <td><div class="field-box" contenteditable="true" data-path="${basePath}.re_sy_no">${doc.re_sy_no || ''}</div></td>
                    <td><div class="field-box" contenteditable="true" data-path="${basePath}.re_sy_subdiv_no">${doc.re_sy_subdiv_no || ''}</div></td>
                    <td><div class="field-box" contenteditable="true" data-path="${basePath}.sy_block_no">${doc.sy_block_no || ''}</div></td>
                    <td><div class="field-box" contenteditable="true" data-path="${basePath}.sy_no">${doc.sy_no || ''}</div></td>
                    <td><div class="field-box" contenteditable="true" data-path="${basePath}.sy_subdiv_no">${doc.sy_subdiv_no || ''}</div></td>
                    <td><div class="field-box" contenteditable="true" data-path="${basePath}.land_extent">${doc.land_extent || ''}</div></td>
                    <td><div class="field-box" contenteditable="true" data-path="${basePath}.land_classification">${landClassText}</div></td>
                `;
                surveyBody.appendChild(tr);
            });
        }
        renderTimelineFromData();
        applyConditionalVisibility();
    }
    function applyConditionalVisibility() {
    // --- 1. SMART FIELD VISIBILITY ---
    document.querySelectorAll('.field-box[contenteditable="true"]').forEach(box => {
        const parentRow = box.closest('.row, .row-stacked');
        const panchayatVal = getNested(reportData, "Survey.grama_panchayat");
        const panchayatRow = document.getElementById("row_panchayat_name");
        if (panchayatRow) {
            if (!panchayatVal || panchayatVal.toString().trim() === "") {
                panchayatRow.classList.add('hidden-row');
            } else {
                panchayatRow.classList.remove('hidden-row');
            }
        }
        
        // Reset defaults (in case of re-run)
        box.style.display = 'block'; 
        if (parentRow) parentRow.classList.remove('hidden-row');

        // Check if Text is Empty
        if (!box.innerText.trim()) {
            // STEP A: Hide the empty box so it doesn't take up space
            box.style.display = 'none';

            // STEP B: Should we keep the Label visible? 
            let keepLabel = false;

            // 1. Check if there is an Image associated with this field
            const path = box.getAttribute('data-path');
            if (path) {
                const safeKey = path.replace(/\./g, '_');
                const imgWrap = document.getElementById('wrap_' + safeKey);
                // If image exists, we MUST keep the label
                if (imgWrap && imgWrap.querySelector('img')) {
                    keepLabel = true; 
                }
            }

            // 2. Check if there are other inputs (Checkboxes/Radios) in the same row
            if (parentRow) {
                const hasOptions = parentRow.querySelector('input[type="checkbox"], input[type="radio"]');
                const siblings = parentRow.querySelectorAll('.field-box');
                let siblingHasData = false;
                // Check if neighbor text boxes have data
                siblings.forEach(sib => { 
                    if (sib !== box && sib.innerText.trim()) siblingHasData = true; 
                });

                if (hasOptions || siblingHasData) keepLabel = true;
            }

            // STEP C: If no Image and no other data, hide the whole row (Label)
            if (!keepLabel && parentRow) {
                parentRow.classList.add('hidden-row');
            }
        }
    });

    // --- 2. SPECIFIC LOGIC: RAILWAY DISTANCE ---
    const railCheck = getNested(reportData, "land_inspection_details.railway_pass");
    const railDistBox = document.querySelector('[data-path="land_inspection_details.railway_distance"]');
    if (railDistBox && railCheck !== "Yes") {
        railDistBox.style.visibility = 'hidden';
        if(railDistBox.previousElementSibling && railDistBox.previousElementSibling.tagName === 'LABEL') {
            railDistBox.previousElementSibling.style.visibility = 'hidden';
        }
    }

    // --- 3. SPECIFIC LOGIC: WET LAND / TREES ---
    const paddy = getNested(reportData, "Survey.paddy_land_check");
    const trees = getNested(reportData, "Survey.trees_2008_check");
    if (!paddy && !trees) {
        const paddyInput = document.querySelector('input[data-bind-radio="Survey.paddy_land_check"]');
        if (paddyInput) {
            const container = paddyInput.closest('.row'); 
            if (container) container.classList.add('hidden-row');
        }
    }

    // --- 4. SPECIFIC LOGIC: SURVEY TOTALS ---
    const ltrTotal = getNested(reportData, "Survey.total_ltr_extent");
    const deedTotal = getNested(reportData, "Survey.total_deed_extent");
    if (!ltrTotal && !deedTotal) {
        const totalBox = document.querySelector('[data-path="Survey.total_ltr_extent"]');
        if(totalBox) {
            totalBox.closest('.row').classList.add('hidden-row');
        }
    }

    // --- 5. HIDE EMPTY IMAGE WRAPPERS ---
    document.querySelectorAll('.img-wrapper').forEach(wrap => {
        if (!wrap.querySelector('img')) {
            wrap.classList.add('hidden-row');
        }
    });
}
   // --- NEW HELPER FUNCTION TO FORMAT LAND DATA ---
    function formatLandData(doc) {
        // If the single string already exists (legacy data), use it
        if (doc.land_classification) return doc.land_classification;

        // Otherwise, construct it from the fragmented keys
        const types = [
            { key: 'dry',          label: 'Dry' },
            { key: 'wet',          label: 'Wet' },
            { key: 'sthirapunja',  label: 'Sthirapunja' },   // Updated Key
            { key: 'asthirapunja', label: 'Asthirapunja' },  // Updated Key
            { key: 'thottam',      label: 'Thottam' },
            { key: 'others',       label: 'Others' }
        ];

        let parts = [];
        types.forEach(t => {
            // Check if checkbox is true OR if area has text
            // Note: Data might be stored as boolean true or string "true"
            const isChecked = doc[`check_${t.key}`] === true || doc[`check_${t.key}`] === "true";
            const areaVal = doc[`area_${t.key}`];

            if (isChecked || (areaVal && areaVal.toString().trim() !== "")) {
                let text = t.label;
                if (areaVal && areaVal.toString().trim() !== "") {
                    text += `: ${areaVal}`;
                }
                parts.push(text);
            }
        });

        return parts.join(', '); // Result: "Dry: 5 Ares, Sthira: 2 Ares"
    }
    // --- 3. SAVE LOGIC (Trust the Python Backend) ---
    document.getElementById('saveFinal').onclick = () => {
        // 1. Sync Edits
        document.querySelectorAll('[data-path]').forEach(el => {
            setNested(reportData, el.getAttribute('data-path'), el.innerText);
        });

        const folder = reportData.target_folder || "Root";

        // 2. Simple Confirmation
        Swal.fire({
            title: 'Generate Final Report?',
            html: `This will save the PDF to: <br><b>/${folder}</b><br><br><span style="font-size:12px; color:#666">The server will automatically assign the next revision number.</span>`,
            icon: 'info',
            showCancelButton: true,
            confirmButtonColor: '#28a745',
            cancelButtonColor: '#7066e0',
            confirmButtonText: 'Yes, Save it!'
        }).then((result) => {
            if (result.isConfirmed) {
                performDirectSave();
            }
        });
    };

  //  Make this function ASYNC
    async function performDirectSave() { 
        const btn = document.getElementById('saveFinal');
        const originalText = btn.innerHTML;
        
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing Images...';
        btn.disabled = true;

        //  ADD AWAIT HERE
        const htmlSnapshot = await getPageSnapshot(); 
        
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving PDF...';

        const payload = {
            report_id: reportId,
            target_folder: reportData.target_folder || "", 
            html_content: htmlSnapshot,
            ...reportData 
        };
        fetch('/coreapi/api/finalize-pdf/', {
            method: 'POST',
            headers: {'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token }}'},
            body: JSON.stringify(payload)
        })
        .then(r => r.json())
        .then(res => {
            btn.innerHTML = originalText;
            btn.disabled = false;
            
            if(res.success) {
                // --- SUCCESS: Display what the SERVER created ---
                // 1. Get full path from response
                const fullPath = res.file_path; 
                
                // 2. Extract just the filename (e.g. "Report_123_site_report_3.pdf")
                // Works for both Windows (\) and Linux (/) separators
                const fileName = fullPath.replace(/^.*[\\\/]/, '');

                Swal.fire({
                    title: 'Saved Successfully!',
                    html: `
                        <div style="text-align:left; background:#f9f9f9; padding:10px; border-radius:5px;">
                            <strong>Filename:</strong> ${fileName}<br>
                            <span style="font-size:11px; color:#888; word-break:break-all;">${fullPath}</span>
                        </div>
                    `,
                    icon: 'success',
                    showCancelButton: true,
                    confirmButtonText: 'Do a New Site Report',
                    cancelButtonText: 'Go to Dashboard',
                    confirmButtonColor: '#3085d6',
                    cancelButtonColor: '#7066e0',
                    reverseButtons: true,
                    timer: 30000,
                    timerProgressBar: true
                }).then((result) => {
                    if (result.isConfirmed) window.location.href = "{% url 'coreapi:feedback' %}"; 
                    else if (result.dismiss === Swal.DismissReason.cancel || result.dismiss === Swal.DismissReason.timer) {
                        window.location.href = "{% url 'coreapi:dashboard' %}"; 
                    }
                });
            } else {
                Swal.fire('Error', res.error, 'error');
            }
        })
        .catch(err => {
            console.error(err);
            Swal.fire('Network Error', 'Could not save PDF', 'error');
            btn.innerHTML = originalText;
            btn.disabled = false;
        });
    }
 async function getPageSnapshot() {
    const originalContainer = document.querySelector('.paper-container');
    const clone = originalContainer.cloneNode(true);

    // 1. CLEANUP UI
    const garbage = clone.querySelectorAll('.nav-left, .floating-save, button, .crop-btn, .btn-save, .back-link');
    garbage.forEach(el => el.remove());

    // -------------------------------------------------------------
    //  NEW: CONVERT ALL IMAGES TO BASE64 (EMBEDDED DATA)
    // -------------------------------------------------------------
    const images = clone.querySelectorAll('img');
    const imagePromises = Array.from(images).map(async (img) => {
        try {
            // If it's already Base64 (sketches often are), skip fetching
            if (img.src.startsWith('data:')) return;

            // Fetch the image data using the browser's connection
            const response = await fetch(img.src);
            const blob = await response.blob();
            
            // Convert Blob to Base64 String
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onloadend = () => {
                    img.src = reader.result; // Swap URL for Data String
                    resolve();
                };
                reader.readAsDataURL(blob);
            });
        } catch (e) {
            console.warn("Could not embed image:", img.src, e);
        }
    });

    // Wait for all images to convert before continuing
    await Promise.all(imagePromises);
    // -------------------------------------------------------------

    // 2. BAKE INPUTS (Your existing Checkbox/Radio logic)
    const inputs = clone.querySelectorAll('input');
    inputs.forEach(input => {
        const type = input.type;
        const isChecked = input.hasAttribute('checked') || input.checked;
        
        const span = document.createElement('span');
        
        if (type === 'checkbox') {
            span.className = 'pdf-checkbox';
            if (isChecked) { span.innerHTML = ''; span.classList.add('checked'); }
        } else if (type === 'radio') {
            span.className = 'pdf-radio';
            if (isChecked) { span.classList.add('checked'); }
        } else {
            span.className = 'pdf-text-val';
            span.innerText = input.value;
            span.style.borderBottom = "1px solid #000";
            span.style.display = "inline-block";
            span.style.minWidth = "20px";
        }
        input.replaceWith(span);
    });

    // 3. HANDLE TEXTAREAS & CONTENTEDITABLE
    clone.querySelectorAll('textarea').forEach(t => {
        const div = document.createElement('div');
        div.innerText = t.value;
        div.className = 'field-box';
        t.replaceWith(div);
    });
    
    clone.querySelectorAll('[contenteditable]').forEach(e => {
        e.removeAttribute('contenteditable'); 
    });

    // 4. CAPTURE STYLES
    let styles = "";
    document.querySelectorAll('link[rel="stylesheet"]').forEach(link => { 
        // We still grab FontAwesome, but images are now embedded!
        if (link.href.startsWith('/')) {
            link.href = window.location.origin + link.getAttribute('href');
        }
        styles += link.outerHTML; 
    });
    document.querySelectorAll('style').forEach(style => { styles += style.outerHTML; });

    // 5. FINAL PDF TEMPLATE
    // (Keep your existing styles for "print-scale", "pdf-sheet", etc.)
    return `
        <!DOCTYPE html>
        <html>
        <head>
            <meta charset="utf-8">
            ${styles} 
            <style>
                @page { 
                    size: A4;
                    margin-top: 40px; display: flex; flex-direction: column; align-items: center; gap: 30px; 
                }

                body { background-color: white; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }

                .print-scale {
                    transform: scale(0.80); 
                    transform-origin: top left;
                    width: 125%; 
                    overflow-x: hidden; 
                }
                
                .pdf-sheet {

                    width: 100%; 

                    min-height: 100%; 

                    background: white; 

                    padding: 15mm; 

                    box-shadow: 0 0 10px rgba(0,0,0,0.5); 

                    font-size: 9pt; 

                    position: relative; 

                    box-sizing: border-box;

                    overflow: hidden; 

                }


                .pdf-checkbox {
                    display: inline-block; 
                    width: 13px; 
                    height: 13px;
                    border: 1px solid #333; 
                    background: transparent !important;
                    margin-right: 5px; 
                    vertical-align: middle; 
                    position: relative;
                    text-align: center; 
                    line-height: 13px; /* Centers the tick vertically */
                    font-size: 11px;
                    color: transparent;
                }
                .pdf-checkbox.checked { 
                    color: #008000 !important; /* Green Tick Color */
                    font-weight: bold; 
                }

                .pdf-radio {
                    display: inline-block; 
                    width: 13px; 
                    height: 13px;
                    border: 1px solid #333; 
                    border-radius: 50%; 
                    background: transparent !important;
                    margin-right: 5px; 
                    vertical-align: middle; 
                    position: relative;
                }
                .pdf-radio.checked::after {
                    content: ""; 
                    display: block; 
                    width: 7px; 
                    height: 7px;
                    background: #008000; /* Green Dot Color */
                    border-radius: 50%; 
                    margin: 2px auto; /* Centers the dot */
                }
                .row { 

                    display: flex; gap: 10px; margin-bottom: 5px; align-items: baseline; 

                }
                
                .report-table { 

                    width: 100%; 

                    border-collapse: collapse; 

                    table-layout: fixed; /* STRICT COLUMN WIDTHS */

                    margin-bottom: 10px;

                }
                            
                .report-table th, .report-table td { 

                    border: 1px solid #999; 

                    padding: 4px; 

                    text-align: center; 

                    vertical-align: middle; 

                    overflow-wrap: break-word; 

                    word-break: break-word;

                }

                .report-table th { background: #f0f0f0; font-weight: bold; }

                .header-logo {

                    position: absolute; top: 10mm; right: 15mm; width: 25mm; height: auto; object-fit: contain;

                }
               .pdf-footer {

                position: absolute;

                bottom: 15mm;       /* Align with page padding */

                left: 15mm;         /* Align with page padding */

                width: calc(100% - 30mm); /* Full width inside margins */

                border-top: 2px solid #333;

                padding-top: 5px;

                font-size: 10pt;

                font-family: 'Segoe UI', sans-serif;

                display: flex;

                justify-content: space-between;

                z-index: 10;

            }
                .floating-save, .nav-left, button, .back-link { display: none !important; }
            </style>
        </head>
        <body>
            <div class="print-scale">
                ${clone.innerHTML}
            </div>
        </body>
        </html>
    `;
}
    function getNested(obj, path) {
        if(!path) return undefined;
        return path.split('.').reduce((acc, part) => acc && acc[part], obj);
    }

    function setNested(obj, path, value) {
        if(!path) return;
        const keys = path.split('.');
        let current = obj;
        for (let i = 0; i < keys.length - 1; i++) {
            if (!current[keys[i]]) current[keys[i]] = {};
            current = current[keys[i]];
        }
        current[keys[keys.length - 1]] = value;
    }

    function updateArray(path, value, checked) {
        let arr = getNested(reportData, path);
        if (!Array.isArray(arr)) arr = [];
        if (checked) { if(!arr.includes(value)) arr.push(value); } 
        else { arr = arr.filter(item => item !== value); }
        setNested(reportData, path, arr);
    }

    function renderTimelineFromData() {
        const dataStr = getNested(reportData, "Building_analysis.construction_year");
        const rowPercent = document.getElementById('row_percent');
        const rowYear = document.getElementById('row_year');

        if (!rowPercent || !rowYear) return;

        while (rowPercent.children.length > 1) { rowPercent.removeChild(rowPercent.lastChild); }
        while (rowYear.children.length > 1) { rowYear.removeChild(rowYear.lastChild); }

        if (!dataStr) return; 

        const parts = dataStr.split(',');
        parts.forEach(part => {
            part = part.trim();
            const match = part.match(/(\d+)\s*\((\d+)%\)/);
            let year = "", percent = "";
            if (match) { year = match[1]; percent = match[2]; } else { year = part; }

            const tdP = document.createElement('td');
            tdP.innerHTML = `<div class="field-box" style="text-align:center;">${percent}</div>`;
            rowPercent.appendChild(tdP);

            const tdY = document.createElement('td');
            tdY.innerHTML = `<div class="field-box" style="text-align:center;">${year}</div>`;
            rowYear.appendChild(tdY);
        });
    }

    function renderBuildingTableDynamic() {
        const tbody = document.getElementById("building_dynamic_body");
        if (!tbody) return;
        tbody.innerHTML = "";

        const floorConfig = [
            { label: "BF-2",      key: "BF_2" },
            { label: "BF-1",      key: "BF_1" },
            { label: "GF",        key: "GF" },
            { label: "1st Floor", key: "first_flr" },
            { label: "2nd Floor", key: "second_flr" },
            { label: "3rd Floor", key: "third_flr" },
            { label: "4th Floor", key: "fourth_flr" },
            { label: "5th Floor", key: "fifth_flr" }
        ];

        floorConfig.forEach(floor => {
            const k = floor.key;
            const builtUp = getNested(reportData, `Building_analysis.${k}_Builtup_area`);
            if (k !== 'GF' && !builtUp) return; 

            const valBuiltUp = builtUp || "";
            const valRooms = getNested(reportData, `Building_analysis.${k}_Rooms_no`) || "";
            const valKitchen = getNested(reportData, `Building_analysis.${k}_Kitchen_no`) || "";
            const valBath = getNested(reportData, `Building_analysis.${k}_Bathrooms_no`) || "";
            const usageArr = getNested(reportData, `Building_analysis.${k}_Usage`) || [];
            const occArr = getNested(reportData, `Building_analysis.${k}_Occupancy`) || [];

            const makeCheck = (arr, val, label) => {
                const isChecked = Array.isArray(arr) && arr.includes(val) ? 'checked' : '';
                return `<label class="checkbox-item"><input type="checkbox" data-bind-array="Building_analysis.${k}_Usage" value="${val}" ${isChecked}> ${label}</label>`;
            };
            
            const makeOccCheck = (arr, val, label) => {
                const isChecked = Array.isArray(arr) && arr.includes(val) ? 'checked' : '';
                return `<label class="checkbox-item"><input type="checkbox" data-bind-array="Building_analysis.${k}_Occupancy" value="${val}" ${isChecked}> ${label}</label>`;
            };

            const tr = document.createElement("tr");
            tr.innerHTML = `
                <td>${floor.label}</td>
                <td><div class="field-box" contenteditable="true" data-path="Building_analysis.${k}_Builtup_area">${valBuiltUp}</div></td>
                <td><div class="field-box" contenteditable="true" data-path="Building_analysis.${k}_Rooms_no">${valRooms}</div></td>
                <td><div class="field-box" contenteditable="true" data-path="Building_analysis.${k}_Kitchen_no">${valKitchen}</div></td>
                <td><div class="field-box" contenteditable="true" data-path="Building_analysis.${k}_Bathrooms_no">${valBath}</div></td>
                <td>
                    <div class="checkbox-grid-2">
                        ${makeCheck(usageArr, 'Residential', 'Res')}
                        ${makeCheck(usageArr, 'Commercial', 'Com')}
                        ${makeCheck(usageArr, 'Industrial', 'Ind')}
                    </div>
                </td>
                <td>
                    <div class="checkbox-grid-2">
                        ${makeOccCheck(occArr, 'Owner', 'Own')}
                        ${makeOccCheck(occArr, 'Applicant', 'App')}
                        ${makeOccCheck(occArr, 'Rented', 'Rent')}
                        ${makeOccCheck(occArr, 'Vacant', 'Vac')}
                    </div>
                </td>
            `;
            tbody.appendChild(tr);
        });

        const apartments = getNested(reportData, "Building_analysis.apartments") || [];
        apartments.forEach((apt, idx) => {
            const basePath = `Building_analysis.apartments.${idx}`;
            const label = apt.label || `Apartment ${idx + 1}`;
            
            // Helpers for apartments
            const makeAptCheck = (arr, val, lbl) => {
                const isChecked = Array.isArray(arr) && arr.includes(val) ? 'checked' : '';
                return `<label class="checkbox-item"><input type="checkbox" data-bind-array="${basePath}.Usage" value="${val}" ${isChecked}> ${lbl}</label>`;
            };
            const makeAptOccCheck = (arr, val, lbl) => {
                const isChecked = Array.isArray(arr) && arr.includes(val) ? 'checked' : '';
                return `<label class="checkbox-item"><input type="checkbox" data-bind-array="${basePath}.Occupancy" value="${val}" ${isChecked}> ${lbl}</label>`;
            };

            const tr = document.createElement("tr");
            tr.style.backgroundColor = "#f9fbe7"; // Light green to distinguish apartments
            tr.innerHTML = `
                <td><div class="field-box" contenteditable="true" data-path="${basePath}.label">${label}</div></td>
                <td><div class="field-box" contenteditable="true" data-path="${basePath}.Builtup_area">${apt.Builtup_area || ''}</div></td>
                <td><div class="field-box" contenteditable="true" data-path="${basePath}.Rooms_no">${apt.Rooms_no || ''}</div></td>
                <td><div class="field-box" contenteditable="true" data-path="${basePath}.Kitchen_no">${apt.Kitchen_no || ''}</div></td>
                <td><div class="field-box" contenteditable="true" data-path="${basePath}.Bathrooms_no">${apt.Bathrooms_no || ''}</div></td>
                <td>
                    <div class="checkbox-grid-2">
                        ${makeAptCheck(apt.Usage, 'Residential', 'Res')}
                        ${makeAptCheck(apt.Usage, 'Commercial', 'Com')}
                        ${makeAptCheck(apt.Usage, 'Industrial', 'Ind')}
                    </div>
                </td>
                <td>
                    <div class="checkbox-grid-2">
                        ${makeAptOccCheck(apt.Occupancy, 'Owner', 'Own')}
                        ${makeAptOccCheck(apt.Occupancy, 'Applicant', 'App')}
                        ${makeAptOccCheck(apt.Occupancy, 'Rented', 'Rent')}
                        ${makeAptOccCheck(apt.Occupancy, 'Vacant', 'Vac')}
                    </div>
                </td>
            `;
            tbody.appendChild(tr);
        });
        tbody.querySelectorAll('input[data-bind-array]').forEach(el => {
            el.onchange = function() { 
                const path = this.getAttribute('data-bind-array');
                updateArray(path, this.value, this.checked); 
            };
        });
    }
</script>
{% endblock %}